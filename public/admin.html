<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ArtTest Admin</title>
<style>
:root{
  --bg:#fff7ed; --surface:#ffffff; --ink:#1f2937; --muted:#6b7280;
  --accent:#ff7a00; --accent2:#ffb74a; --line:#f1f5f9; --radius:16px; --shadow:0 12px 36px rgba(17,24,39,.08);
}
body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial}
.header{
  position:sticky; top:0; z-index:10; background:linear-gradient(180deg,#fff, #fff8f0);
  border-bottom:1px solid var(--line); box-shadow:0 6px 18px rgba(0,0,0,.03);
}
.header .wrap{max-width:1080px;margin:0 auto;padding:14px 24px;display:flex;align-items:center;gap:12px}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.brand .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.link{margin-left:auto}
.link a{color:#111;text-decoration:none;font-weight:800;background:linear-gradient(90deg,#ffd7b0,#ffe6c4);padding:8px 12px;border-radius:10px;border:1px solid var(--line)}
.wrap-main{max-width:1080px;margin:0 auto;padding:20px 24px 28px}
.card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
h2{margin:0 0 12px} .muted{color:var(--muted)} .small{font-size:13px}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#111;border:none;padding:10px 14px;border-radius:10px;font-weight:850;cursor:pointer}
.btn-ghost{background:#fff;color:var(--ink);border:1px solid var(--line);padding:10px 12px;border-radius:10px;font-weight:750;cursor:pointer}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
.grid{display:grid;gap:14px} .grid-2{grid-template-columns:1fr 1fr}
@media(max-width:900px){.grid-2{grid-template-columns:1fr}}
table{border-collapse:collapse;width:100%} th,td{border:1px solid var(--line);padding:8px;font-size:12px}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:800;cursor:pointer}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#111;border-color:transparent}
.section{display:none}
.section.active{display:block}
</style>
</head>
<body>
<header class="header">
  <div class="wrap">
    <div class="brand"><div class="dot"></div><span>ArtTest Admin</span></div>
    <div class="link"><a href="./index.html" target="_blank" rel="noopener">수험자 페이지 열기</a></div>
  </div>
</header>

<main class="wrap-main">
  <div class="tabs">
    <div class="tab active" data-tab="t1">결과 보기</div>
    <div class="tab" data-tab="t2">문항/이미지 교체</div>
    <div class="tab" id="signin">Google 로그인</div>
    <div class="tab" id="signout" style="display:none">로그아웃</div>
  </div>

  <!-- Results -->
  <section id="t1" class="section active card">
    <h2>Results</h2>
    <div id="results" class="small muted">로그인 후 조회됩니다.</div>
  </section>

  <!-- Questions -->
  <section id="t2" class="section card">
    <h2>Questions · 문항/이미지 교체</h2>
    <div class="grid grid-2" style="margin-top:12px">
      <div>
        <label>문항 선택</label>
        <select id="qsel"></select>
        <label style="margin-top:8px">질문</label>
        <textarea id="prompt" rows="2"></textarea>

        <label style="margin-top:8px">A label</label><input id="A_label"/>
        <label>A image URL</label><input id="A_image" placeholder="https://drive.google.com/uc?export=view&id=..."/>
        <label>A weights(JSON)</label><input id="A_weights" placeholder='{"관찰력":1}'/>

        <label style="margin-top:8px">B label</label><input id="B_label"/>
        <label>B image URL</label><input id="B_image"/><label>B weights(JSON)</label><input id="B_weights"/>
      </div>
      <div>
        <label>C label</label><input id="C_label"/>
        <label>C image URL</label><input id="C_image"/><label>C weights(JSON)</label><input id="C_weights"/>

        <label style="margin-top:8px">D label</label><input id="D_label"/>
        <label>D image URL</label><input id="D_image"/><label>D weights(JSON)</label><input id="D_weights"/>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" onclick="save()">저장</button>
          <button class="btn-ghost" onclick="reload()">다시 불러오기</button>
        </div>
        <div id="msg" class="small muted" style="margin-top:6px"></div>
      </div>
    </div>
    <p class="small muted" style="margin-top:10px">※ 시트의 해당 계정에 <b>편집권한</b>이 있어야 저장됩니다.</p>
  </section>
</main>

<!-- GIS & GAPI -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script>
/* ==================== 필수 값 (TODO) ==================== */
// 1) 브라우저 API 키 (HTTP referrer 제한 + Sheets API 제한)
const API_KEY   = 'YOUR_BROWSER_API_KEY'; // ← TODO
// 2) OAuth 클라이언트 ID (Web)
const CLIENT_ID = 'YOUR_OAUTH_CLIENT_ID.apps.googleusercontent.com'; // ← TODO
// 3) 스프레드시트 문서 ID
const SHEET_ID  = 'YOUR_SHEET_ID'; // ← TODO
/* ======================================================= */

const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

let tokenClient, gapiInited=false, gisInited=false;
function g(id){return document.getElementById(id);}

/* Tabs */
document.addEventListener('click', (e)=>{
  if(e.target.classList.contains('tab') && e.target.dataset.tab){
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t===e.target));
    document.querySelectorAll('.section').forEach(s=>s.classList.toggle('active', s.id===e.target.dataset.tab));
  }
});

window.onload = () => {
  gapi.load('client', async () => {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
    gapiInited = true; maybeEnableSignIn();
  });
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: SCOPES, callback: (resp)=>{ if(resp.access_token){ onSignedIn(); } }
  });
  gisInited = true; maybeEnableSignIn();

  g('signin').onclick = ()=> tokenClient.requestAccessToken({ prompt:'' });
  g('signout').onclick = ()=>{ const t=gapi.client.getToken(); if(t){ google.accounts.oauth2.revoke(t.access_token); gapi.client.setToken(''); } onSignedOut(); };
};

function maybeEnableSignIn(){ if(gapiInited && gisInited){ g('signin').style.pointerEvents='auto'; } }
function onSignedIn(){ g('signin').style.display='none'; g('signout').style.display='inline-block'; loadResults(); loadQuestions(); }
function onSignedOut(){
  g('signin').style.display='inline-block'; g('signout').style.display='none';
  g('results').innerHTML='-'; g('qsel').innerHTML=''; g('msg').textContent='';
}

/* Sheets helpers */
async function readRange(range){
  const r = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId:SHEET_ID, range });
  return r.result.values || [];
}
async function writeRange(range, values){
  return gapi.client.sheets.spreadsheets.values.update({
    spreadsheetId:SHEET_ID, range, valueInputOption:'RAW', resource:{ values }
  });
}

/* Results */
async function loadResults(){
  const rows = await readRange('Results!A1:K10000');
  const header = rows.shift()||[];
  const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
  const html = ['<table><tr><th>time</th><th>child</th><th>phone</th><th>top3</th></tr>'];
  (rows||[]).slice(-200).reverse().forEach(r=>{
    html.push(`<tr><td>${r[idx['timestamp']]||''}</td><td>${r[idx['child_name']]||''}</td><td>${r[idx['phone']]||''}</td><td>${r[idx['top3(csv)']]||''}</td></tr>`);
  });
  html.push('</table>');
  g('results').innerHTML = html.join('');
}

/* Questions */
let QUESTIONS=[], QIDX={};
async function loadQuestions(){
  const rows = await readRange('Questions!A1:P1000');
  const header = rows.shift()||[];
  const H = Object.fromEntries(header.map((h,i)=>[h,i]));
  QUESTIONS = rows.map((r,ri)=>({
    _row:r, _rowNum:ri+2,
    id:r[H.id], order:+(r[H.order]||0), prompt:r[H.prompt]||'',
    A_label:r[H.A_label]||'', A_image:r[H.A_image]||'', A_weights:r[H.A_weights]||'',
    B_label:r[H.B_label]||'', B_image:r[H.B_image]||'', B_weights:r[H.B_weights]||'',
    C_label:r[H.C_label]||'', C_image:r[H.C_image]||'', C_weights:r[H.C_weights]||'',
    D_label:r[H.D_label]||'', D_image:r[H.D_image]||'', D_weights:r[H.D_weights]||'',
    active:r[H.active]||'TRUE'
  })).sort((a,b)=>a.order-b.order);
  QIDX = Object.fromEntries(QUESTIONS.map(q=>[q.id,q]));
  const sel=g('qsel'); sel.innerHTML='';
  QUESTIONS.forEach(q=>{ const o=document.createElement('option'); o.value=q.id; o.textContent=`${q.order}. ${q.prompt}`; sel.appendChild(o); });
  sel.onchange=()=>fill(QIDX[sel.value]); if(QUESTIONS[0]) fill(QUESTIONS[0]);
  loadQuestions._H = H;
}
function fill(q){
  ['prompt','A_label','A_image','A_weights','B_label','B_image','B_weights','C_label','C_image','C_weights','D_label','D_image','D_weights']
   .forEach(k=> g(k).value = q[k] || '');
}
async function save(){
  const id = g('qsel').value; const q = QIDX[id]; if(!q) return;
  const H = loadQuestions._H;
  const row = q._row.slice();
  row[H['prompt']] = g('prompt').value;
  ['A','B','C','D'].forEach(k=>{
    row[H[`${k}_label`]]   = g(`${k}_label`).value;
    row[H[`${k}_image`]]   = g(`${k}_image`).value;
    row[H[`${k}_weights`]] = g(`${k}_weights`).value;
  });
  await writeRange(`Questions!A${q._rowNum}:P${q._rowNum}`, [row]);
  g('msg').textContent='저장 완료'; setTimeout(()=>g('msg').textContent='',1500);
  await loadQuestions();
}
function reload(){ loadQuestions(); }
</script>
</body>
</html>
