
<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ArtTest Admin</title>
<style>
  body{font-family:system-ui,Apple SD Gothic Neo,Segoe UI,Roboto;padding:16px}
  table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:8px;font-size:12px}
  input,textarea{width:100%;padding:8px} .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
</style>
<body>
<h2>관리자 로그인</h2>
<button id="signin">Google로 로그인</button>
<button id="signout" style="display:none">로그아웃</button>
<div id="me" style="margin:8px 0;color:#666"></div>
<hr/>

<h2>결과 리스트</h2>
<div id="results">-</div>
<hr/>

<h2>문항 수정</h2>
<div class="grid">
  <div>
    <label>문항 선택</label>
    <select id="qsel"></select>
    <label>질문</label><textarea id="prompt" rows="2"></textarea>
    <label>A label</label><input id="A_label"/><label>A image</label><input id="A_image"/>
    <label>A weights(JSON)</label><input id="A_weights" placeholder='{"관찰력":1}'/>
    <label>B label</label><input id="B_label"/><label>B image</label><input id="B_image"/>
    <label>B weights(JSON)</label><input id="B_weights"/>
  </div>
  <div>
    <label>C label</label><input id="C_label"/><label>C image</label><input id="C_image"/>
    <label>C weights(JSON)</label><input id="C_weights"/>
    <label>D label</label><input id="D_label"/><label>D image</label><input id="D_image"/>
    <label>D weights(JSON)</label><input id="D_weights"/>
    <button onclick="save()">저장</button>
    <div id="msg" style="margin-top:8px;color:#2b7"></div>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script>
const CLIENT_ID = 'YOUR_OAUTH_CLIENT_ID.apps.googleusercontent.com';  // ← 변경
const API_KEY = 'YOUR_BROWSER_API_KEY';                               // ← 변경
const SHEET_ID = 'YOUR_SHEET_ID';                                     // ← 변경
const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

let tokenClient, gapiInited=false, gisInited=false;

function g(id){return document.getElementById(id)}

window.onload = () => {
  gapi.load('client', async () => {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
    gapiInited = true; maybeEnableButtons();
  });
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: SCOPES,
    callback: (resp) => { if (resp.access_token) { onSignedIn(); } }
  });
  gisInited = true; maybeEnableButtons();
};

function maybeEnableButtons(){
  if (gapiInited && gisInited) document.getElementById('signin').disabled = false;
}
document.getElementById('signin').onclick = () => tokenClient.requestAccessToken({ prompt: '' });
document.getElementById('signout').onclick = () => { google.accounts.oauth2.revoke(gapi.client.getToken().access_token); gapi.client.setToken(''); onSignedOut(); }

async function onSignedIn(){
  g('signin').style.display='none'; g('signout').style.display='inline-block';
  g('me').textContent='로그인됨';
  await loadResults(); await loadQuestions();
}
function onSignedOut(){
  g('signin').style.display='inline-block'; g('signout').style.display='none';
  g('me').textContent=''; g('results').innerHTML='-'; g('qsel').innerHTML='';
}

async function readRange(range){
  const r = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId:SHEET_ID, range });
  return r.result.values || [];
}
async function writeRange(range, values){
  return gapi.client.sheets.spreadsheets.values.update({
    spreadsheetId:SHEET_ID, range, valueInputOption:'RAW', resource:{ values }
  });
}

/* 결과 목록 */
async function loadResults(){
  const rows = await readRange('Results!A1:K10000');
  const header = rows.shift()||[];
  const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
  const html = ['<table><tr><th>time</th><th>child</th><th>phone</th><th>top3</th></tr>'];
  (rows||[]).slice(-100).reverse().forEach(r=>{
    html.push(`<tr><td>${r[idx['timestamp']]||''}</td><td>${r[idx['child_name']]||''}</td><td>${r[idx['phone']]||''}</td><td>${r[idx['top3(csv)']]||''}</td></tr>`);
  });
  html.push('</table>'); g('results').innerHTML = html.join('');
}

/* 문항 불러오기/저장 */
let QUESTIONS=[], Q_IDX={};
async function loadQuestions(){
  const rows = await readRange('Questions!A1:P1000');
  const header = rows.shift()||[]; const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
  QUESTIONS = rows.map(r => ({
    _row: r, _rowNum: rows.indexOf(r)+2, id:r[idx.id], order:+(r[idx.order]||0), prompt:r[idx.prompt]||'',
    A_label:r[idx.A_label]||'', A_image:r[idx.A_image]||'', A_weights:r[idx.A_weights]||'',
    B_label:r[idx.B_label]||'', B_image:r[idx.B_image]||'', B_weights:r[idx.B_weights]||'',
    C_label:r[idx.C_label]||'', C_image:r[idx.C_image]||'', C_weights:r[idx.C_weights]||'',
    D_label:r[idx.D_label]||'', D_image:r[idx.D_image]||'', D_weights:r[idx.D_weights]||'',
    active:r[idx.active]||'TRUE'
  })).sort((a,b)=>a.order-b.order);
  Q_IDX = Object.fromEntries(QUESTIONS.map(q=>[q.id,q]));
  const sel = g('qsel'); sel.innerHTML='';
  QUESTIONS.forEach(q => { const o=document.createElement('option'); o.value=q.id; o.textContent=`${q.order}. ${q.prompt}`; sel.appendChild(o); });
  sel.onchange = () => fill(Q_IDX[sel.value]); fill(QUESTIONS[0]);
}
function fill(q){
  ['prompt','A_label','A_image','A_weights','B_label','B_image','B_weights','C_label','C_image','C_weights','D_label','D_image','D_weights'].forEach(k=>{
    g(k).value = q[k] || '';
  });
}
async function save(){
  const id = g('qsel').value; const q = Q_IDX[id]; if(!q) return;
  const header = (await readRange('Questions!A1:Q1'))[0];
  const map = Object.fromEntries(header.map((h,i)=>[h,i])); const row = q._row.slice();
  row[map['prompt']] = g('prompt').value;
  ['A','B','C','D'].forEach(k=>{
    row[map[`${k}_label`]] = g(`${k}_label`).value;
    row[map[`${k}_image`]] = g(`${k}_image`).value;
    row[map[`${k}_weights`]] = g(`${k}_weights`).value;
  });
  await writeRange(`Questions!A${q._rowNum}:Q${q._rowNum}`, [row]);
  g('msg').textContent='저장 완료';
  await loadQuestions();
}
</script>
</body>
</html>
