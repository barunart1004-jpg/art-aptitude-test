<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°”ë¥¸ë¯¸ìˆ í•™ì› Â· ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸ V1. BASIC</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#6b7280; --line:#e9eef5; --white:#ffffff;
  --cta1:#FFB457; --cta2:#FF8C3A; --badge:#f3f4f6;
  --radius:20px; --shadow:0 18px 60px rgba(16,24,40,.12); --soft:0 10px 28px rgba(16,24,40,.08);
}
html,body{height:100%}
body{margin:0;color:var(--ink);font-family:"Pretendard",ui-sans-serif,system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial;background:#FFF4E8}
.container{min-height:100dvh;display:flex;flex-direction:column;align-items:center}
.main{width:100%;max-width:1200px;padding:18px;display:flex;flex-direction:column;gap:16px;margin:0 auto}

/* í—¤ë” */
.header{width:100%;display:flex;justify-content:center}
.brand{width:100%;max-width:1200px;margin-top:10px;display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:999px;background:#fff;border:1px solid var(--line);box-shadow:var(--soft)}
.logo{width:28px;height:28px;border-radius:50%;background:conic-gradient(from 0deg,#FFB98A,#FFE6CF,#E6E2FF,#CFF7EE,#FFB98A)}
.brand span{font-weight:900;letter-spacing:.2px}

/* ë„¤ë¹„ + ì§„í–‰ë°” */
.sticky{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--soft);padding:8px 10px;display:flex;flex-direction:column;gap:10px}
.navbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.step{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;cursor:pointer;background:#fff;color:#374151;font-weight:850;border:1px solid var(--line);box-shadow:var(--soft);transition:transform .12s}
.step:hover{transform:translateY(-1px)}
.step .num{width:20px;height:20px;border-radius:50%;display:inline-grid;place-items:center;background:#fff;border:1px solid var(--line);font-size:12px}
.step.active{background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#111827;box-shadow:0 12px 30px rgba(255,214,176,.28)}
.step.done{background:#f2fffa;border-color:#dff7ef}
.topprogress{height:10px;background:#f6f7fb;border-radius:999px;overflow:hidden}
.topprogress>div{height:100%;width:0;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE);transition:width .35s ease}
.statusline{font-size:12px;color:#6b7280;text-align:center}

/* ì¹´ë“œ/ë²„íŠ¼ */
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);animation:fade .35s ease both}
@keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
h1{font-size:34px;margin:0 0 6px}h2{font-size:26px;margin:0 0 10px}h3{font-size:18px;margin:16px 0 8px}
p{margin:8px 0}.small{font-size:13px}.muted{color:var(--muted)}.center{text-align:center}
.btn{--bg:linear-gradient(90deg,#FFB98A,#FFD9BE);--glow:rgba(255,185,138,.35);background:var(--bg);color:#5a3f2f;border:none;padding:16px 24px;border-radius:16px;font-weight:900;cursor:pointer;box-shadow:0 16px 40px var(--glow);transition:transform .08s,filter .2s,box-shadow .2s;position:relative;overflow:hidden;font-size:18px}
.btn:hover{transform:translateY(-1px);filter:brightness(1.03)}
.btn-ghost{background:#fff;color:#111827;border:1px solid var(--line);padding:12px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:var(--soft)}
.btn-primary{background:linear-gradient(90deg,var(--cta1),var(--cta2));color:#fff;box-shadow:0 14px 36px rgba(255,140,58,.35)}
.btn-mint{background:linear-gradient(90deg,#FFE6CF,#FFD9BE)}
.btn-xl{padding:20px 30px;font-size:20px;border-radius:20px}

/* ì…ë ¥ + í¼ ê·¸ë¦¬ë“œ */
input,select,textarea{width:100%;background:#fff;color:#111;border:1px solid var(--line);border-radius:12px;padding:12px;outline:none}
input:focus,select:focus,textarea:focus{border-color:#FFD9BE;box-shadow:0 0 0 6px rgba(255,217,190,.26)}
label{font-size:14px;color:#374151;font-weight:700}
.form{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.form .field{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
@media (max-width:860px){ .form{grid-template-columns:1fr} }

/* ë°°ì§€/ë±ƒì§€ */
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f3f4f6;font-weight:800;font-size:12px}

/* ë³´ê¸° ì¹´ë“œ(4ê°œ ë” í¬ê²Œ) */
.opt{border:2px solid var(--line);border-radius:18px;overflow:hidden;cursor:pointer;background:#fff;box-shadow:var(--soft);transition:transform .12s,border-color .2s}
.opt:hover{transform:translateY(-2px)}
.opt img{width:100%;display:block;aspect-ratio:4/3;object-fit:cover}
.opt .cap{padding:12px 14px;color:#374151;font-weight:800;font-size:16px}
.opt.sel{border-color:#FFD9BE;box-shadow:0 0 0 6px rgba(255,217,190,.25)}
@media (min-width:1024px){
  .test-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
  .test-grid-4 .opt img{aspect-ratio:5/4} /* ì´ë¯¸ì§€ ì„¸ë¡œ ì¡°ê¸ˆ ë” */
  .test-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
}
@media (max-width:1023px){ .sideNav{display:none} }

/* ì„¹ì…˜/ë¸”ë¡ */
.acc{border-radius:14px;overflow:hidden;border:1px solid var(--line)}
.acc-item{border-top:1px solid var(--line)}
.acc-head{padding:14px 16px;background:#FFF4EC;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.acc-body{padding:14px 16px;display:none;background:#fff}
.acc-item.open .acc-body{display:block}
.block{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(16,24,40,.06);page-break-inside:avoid}
.block h3{margin:0 0 10px}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#5a3f2f;border:1px solid #ffe8d6;padding:8px 12px;border-radius:999px;font-weight:900}
.kpi{display:flex;align-items:flex-end;gap:10px}
.kpi .num{font-size:44px;font-weight:900;line-height:1}
.kpi .unit{font-size:14px;color:#6b7280}
.callout{position:relative;background:linear-gradient(90deg,#FFE3CC,#E7F6FF);padding:22px;border-radius:18px;border:1px solid var(--line)}
.credit{font-size:12px;color:#6b7280;text-align:center}

/* ì‹œì‘ íˆì–´ë¡œ/íŠ¹ì§• */
.heroTitle{font-size:48px;line-height:1.1;margin:6px 0 10px;font-weight:900;letter-spacing:.2px;background:linear-gradient(90deg,#111827 0%,#5a3f2f 40%,#FFB98A 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
.features{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:12px}
.feature-card{background:#fff;border:1px solid var(--line);border-radius:18px;padding:20px;box-shadow:var(--soft);text-align:center}
.feature-icon{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;margin:0 auto 10px;background:#FFEBCF}
.cta{margin-top:26px;border-radius:18px;border:1px solid var(--line);background:linear-gradient(90deg,#FFB75B,#FF983F);color:#fff;padding:30px 16px;text-align:center;box-shadow:0 16px 36px rgba(255,152,63,.25)}
.cta h3{margin:0 0 6px;font-size:26px;color:#fff}
.cta p{margin:0 0 18px;color:#fff;opacity:.95}

/* ì „ë¬¸ê°€(ì¢…í•©) */
.section-title{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:900;margin:16px 0 10px}
.expert-wrap{background:#F4F8FF;border:1px solid #dfe8fb;padding:18px;border-radius:16px}
.expert-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:900px){ .expert-grid{grid-template-columns:1fr} }
.card-lite{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
.tag-blue{background:#e8f0ff;color:#2563eb;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;display:inline-block}

/* ê²°ê³¼ ì°¨íŠ¸ 2ë¶„í• (A4 ì ˆë°˜ ì´í•˜) */
.result-row{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
@media (max-width:900px){ .result-row{grid-template-columns:1fr} }

/* PDF ëª¨ë“œ */
@media print{ .no-print{display:none !important} }
.pdf-mode .no-print{display:none !important}
.pdf-mode body{background:#fff}
.pdf-mode .card,.pdf-mode .block{box-shadow:none}
.pdf-mode .main{max-width:794px}
.pdf-mode .callout{background:#fff}
.pdf-mode canvas{background:#fff}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand"><div class="logo"></div><span>ë°”ë¥¸ë¯¸ìˆ í•™ì› Â· ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸ V1. BASIC</span></div>
  </div>

  <main class="main">
    <div class="sticky no-print">
      <nav class="navbar" id="topnav"></nav>
      <div class="topprogress"><div id="topbar"></div></div>
      <div class="statusline" id="statusline">ì§„í–‰ë¥  0%</div>
    </div>

    <section class="card" id="app"></section>
  </main>
</div>

<!-- ì‚¬ì´ë“œ ë„¤ë¹„ -->
<div class="sideNav left no-print" id="sideLeft" style="display:none;position:fixed;top:50%;left:18px;transform:translateY(-50%);z-index:20">
  <button class="btn-ghost" onclick="prev()" aria-label="ì´ì „">â€¹</button>
</div>
<div class="sideNav right no-print" id="sideRight" style="display:none;position:fixed;top:50%;right:18px;transform:translateY(-50%);z-index:20">
  <button class="btn-ghost" onclick="next()" aria-label="ë‹¤ìŒ">â€º</button>
</div>

<!-- ì´ë©”ì¼ ëª¨ë‹¬ -->
<div id="emailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:center;justify-content:center">
  <div style="width:min(560px,94vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow)">
    <h3 style="margin-top:0">ê²°ê³¼ PDF ì´ë©”ì¼ë¡œ ë³´ë‚´ê¸°</h3>
    <div class="form" style="grid-template-columns:1fr 1fr">
      <div class="field"><label>ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼</label><input id="mail_to" placeholder="you@example.com"></div>
      <div class="field"><label>ì œëª©</label><input id="mail_subject" placeholder="í™ê¸¸ë™ í…ŒìŠ¤íŠ¸ ê²°ê³¼ì…ë‹ˆë‹¤"></div>
    </div>
    <div id="mail_status" class="small muted" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
      <button class="btn-ghost" onclick="closeEmail()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="sendEmail()">ë³´ë‚´ê¸°</button>
    </div>
  </div>
</div>

<script>
/* ===== ì—°ê²°ê°’(ì‹œíŠ¸/í¼) ===== */
const SHEET_ID   = '14VLQBhDJtduxjCnfr7VEOstZ5ez8-CX3ArXy1OvYCQg';
const GVIZ_URL   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Questions&tqx=out:json`;
const FORM_ACTION= 'https://docs.google.com/forms/d/e/1FAIpQLSeRWq5YKN50zL0simiaQA6EBRsn6VXN__ZmLplAgDz1I1hyQA/formResponse';

/* í¼ í•­ëª© ë§¤í•‘ */
const F = {
  child_name:'entry.684468179',
  age:'entry.1066070471',
  grade:'entry.1812672802',
  guardian:'entry.1666083184',
  phone:'entry.89824848',
  campus:'entry.490719219',
  answers:'entry.85364862',
  scores:'entry.1455508168',
  top3:'entry.2120338430',
  resultId:'entry.532514127',
  timestamp:'entry.1261684833'
};

const ASSET_BASE = '/public/img';
const DOMAINS = ["ê´€ì°°ë ¥","ìƒ‰ê°ê°","ì„œì‚¬ë ¥","ê³µê°„ê°","ë””í…Œì¼","ë„ì „ì„±","ì†Œí†µë ¥","ê¾¸ì¤€ì„±"];
const STEPS = [{key:'start',label:'ì‹œì‘'},{key:'consent',label:'ë™ì˜'},{key:'profile',label:'í”„ë¡œí•„'},{key:'test',label:'í…ŒìŠ¤íŠ¸'},{key:'result',label:'ê²°ê³¼'}];
const STATE = { step:'start', consent:false, profile:{}, questions:[], idx:0, answers:[], result:null };

const $=id=>document.getElementById(id);
const app=()=>$('app');

/* NAV + Progress */
function renderNav(){
  const cur = STEPS.findIndex(s=>s.key===STATE.step);
  $('topnav').innerHTML = STEPS.map((s,i)=>`<div class="step ${s.key===STATE.step?'active':''} ${cur>i?'done':''}" onclick="navGo('${s.key}')"><span class="num">${i+1}</span><span>${s.label}</span></div>`).join('');
}
function updateTopProgress(){
  if(STATE.step==='test' && STATE.questions.length){
    const q = Math.round((STATE.idx)/STATE.questions.length*100);
    $('topbar').style.width=q+'%'; $('statusline').textContent=`í…ŒìŠ¤íŠ¸ ì§„í–‰ ${STATE.idx+1}/${STATE.questions.length} (${q}%)`;
    $('sideLeft').style.display='block'; $('sideRight').style.display='block'; return;
  }
  $('sideLeft').style.display='none'; $('sideRight').style.display='none';
  let pct = (STEPS.findIndex(s=>s.key===STATE.step))/(STEPS.length-1)*100;
  $('topbar').style.width=Math.round(pct)+'%'; $('statusline').textContent=`ì§„í–‰ë¥  ${Math.round(pct)}%`;
}
function navGo(step){ STATE.step=step; if(step==='test' && STATE.questions.length===0){ startTest(); return; } render(); }

/* GViz íŒŒì„œ */
function parseGViz(text){ const s=text.indexOf('{'), e=text.lastIndexOf('}'); if(s<0||e<0) return []; const obj=JSON.parse(text.slice(s,e+1)); const cols=obj.table.cols.map(c=>c.label); return obj.table.rows.map(r=>r.c.map(c=>c?(c.f??c.v):'')).map(a=>Object.fromEntries(cols.map((k,i)=>[k,a[i]]))); }
async function loadQuestions(){
  try{
    const txt=await (await fetch(GVIZ_URL)).text(); const rows=parseGViz(txt)||[];
    const act=rows.filter(r=>String(r.active).toUpperCase()==='TRUE').sort((a,b)=>(+a.order - +b.order));
    if(act.length){
      STATE.questions=act.map(r=>{
        const mkWeights = (k)=>{ try{ return JSON.parse(r[`${k}_weights`]) || {}; } catch{ return {}; } };
        const mkOpt = (k)=>({
          key:k,
          label:(r[`${k}_label`]||'').trim(),
          imageUrl:(r[`${k}_image`]||'').trim(),
          weights: mkWeights(k)
        });
        const opts = ['A','B','C','D'].map(mkOpt).filter(o=>{
          const hasLabel = o.label.length>0;
          const hasImage = o.imageUrl.length>0;
          const hasWeight = Object.values(o.weights||{}).some(v=>Number(v||0)!==0);
          return hasLabel || hasImage || hasWeight;
        });
        const safeOpts = opts.length>=2 ? opts : ['A','B'].map(mkOpt);
        return { id: r.id || `q${r.order}`, order:+r.order, prompt:r.prompt || '', options:safeOpts };
      });
      return;
    }
  }catch(e){}
  STATE.questions = localQuestions();
}

/* ===== ì‹œì‘ í™”ë©´ ===== */
function startScreen(){
  return `<div class="center">
    <h1 class="heroTitle">ë°”ë¥¸ë¯¸ìˆ í•™ì› Â· ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸ V1. BASIC</h1>
    <p class="muted" style="font-size:16px">ì•„ì´ì˜ ë¯¸ìˆ  í¥ë¯¸Â·ì„±í–¥ì„ ê°„í¸í•˜ê²Œ íŒŒì•…í•˜ê³ , ë„ì›€ì´ ë˜ëŠ” êµìœ¡ í¬ì¸íŠ¸ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.</p>

    <div class="features">
      ${[
        {icon:'âš¡',title:'ë¹ ë¥¸ í…ŒìŠ¤íŠ¸',desc:'6~8ë¶„ ë‚´ ì™„ë£Œë˜ëŠ” ê°„í¸í•œ í…ŒìŠ¤íŠ¸'},
        {icon:'ğŸ’¡',title:'ë§ì¶¤ ë¶„ì„',desc:'ê°œì¸ë³„ ê°•ì ê³¼ êµìœ¡ í¬ì¸íŠ¸ ì œì‹œ'},
        {icon:'ğŸ“±',title:'ì¦‰ì‹œ ê²°ê³¼',desc:'ë¬¸ì/ì´ë©”ì¼ë¡œ ê²°ê³¼ë¥¼ ë°”ë¡œ ë°›ì•„ë³´ì„¸ìš”'}
      ].map(f=>`
        <div class="feature-card">
          <div class="feature-icon">${f.icon}</div>
          <div style="font-weight:900">${f.title}</div>
          <div class="small muted" style="margin-top:6px">${f.desc}</div>
        </div>`).join('')}
    </div>

    <div class="cta">
      <h3>ì§€ê¸ˆ ë°”ë¡œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”</h3>
      <p>ì•„ì´ì˜ ë¯¸ìˆ  ì¬ëŠ¥ê³¼ ì„±í–¥ì„ ë°œê²¬í•˜ëŠ” ì²« ê±¸ìŒì„ ì‹œì‘í•˜ì„¸ìš”</p>
      <button class="btn btn-xl" id="startBtn">í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸° â†’</button>
    </div>
  </div>`;
}
function viewStart(){
  app().innerHTML=startScreen();
  $('startBtn').onclick=()=>navGo('consent');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ===== ë™ì˜ì„œ ===== */
function accItem(t,html){ return `<div class="acc-item open"><div class="acc-head"><span>${t}</span><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div class="acc-body small">${html}</div></div>`;}
function viewConsent(){
  app().innerHTML=`<h2 class="center">ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ì„œ</h2>
  <p class="muted small center"><b>êµìœ¡ ê°€ì´ë“œ</b> ëª©ì ì´ë©°, ì˜í•™/ì„ìƒ ì§„ë‹¨ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
  <div class="acc">
    ${accItem('<b>1) ëª©ì </b>','â‘  í…ŒìŠ¤íŠ¸ ì œê³µ ë° ê²°ê³¼ ì‚°ì¶œ â‘¡ ê²°ê³¼ ì•ˆë‚´Â·PDF ì €ì¥ ì§€ì› â‘¢ ìƒë‹´ í’ˆì§ˆ ê°œì„ ')}
    ${accItem('<b>2) ìˆ˜ì§‘ í•­ëª©</b>','ì•„ë™ ì´ë¦„Â·ë‚˜ì´Â·í•™ë…„ / ë³´í˜¸ì ì´ë¦„Â·ì—°ë½ì²˜ / ì‘ë‹µ ë‚´ìš© (ì´ë©”ì¼ì€ ì„ íƒ)')}
    ${accItem('<b>3) ë³´ê´€ ê¸°ê°„</b>','ìˆ˜ì§‘ì¼ë¡œë¶€í„° <b>12ê°œì›”</b> ë³´ê´€ í›„ íŒŒê¸°')}
    ${accItem('<b>4) ë³´ê´€/ì²˜ë¦¬</b>','Google Forms/Sheetsì— ì €ì¥Â·ì²˜ë¦¬')}
    ${accItem('<b>5) ê¶Œë¦¬</b>','ë™ì˜ ê±°ë¶€ ê°€ëŠ¥(ê±°ë¶€ ì‹œ ì„œë¹„ìŠ¤ ì œí•œ ê°€ëŠ¥)')}
    ${accItem('<b>6) ë¬¸ì˜</b>','barunart1004@gmail.com')}
  </div>

  <div class="card" style="margin-top:16px">
    <div class="badge">í•„ìˆ˜ í•­ëª© ëª¨ë‘ ë™ì˜í•´ ì£¼ì„¸ìš”</div>
    <div style="display:flex;gap:18px;align-items:center;margin-top:10px;flex-wrap:wrap">
      <label style="display:flex;gap:12px;align-items:center"><input type="checkbox" id="chk_required" style="width:20px;height:20px;accent-color:#FFB98A"> (í•„ìˆ˜) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— <b>ë™ì˜í•©ë‹ˆë‹¤</b>.</label>
      <label style="display:flex;gap:12px;align-items:center"><input type="checkbox" id="chk_minor" style="width:20px;height:20px;accent-color:#FFB98A"> (í•„ìˆ˜) ë§Œ 14ì„¸ ë¯¸ë§Œ ì•„ë™ì˜ ë²•ì •ëŒ€ë¦¬ì¸ìœ¼ë¡œì„œ <b>ë™ì˜í•©ë‹ˆë‹¤</b>.</label>
    </div>
    <div class="center" style="margin-top:16px">
      <button class="btn" id="btn_consent" disabled>ë™ì˜í•˜ê³  ì§„í–‰</button>
    </div>
  </div>`;
  const validate=()=>{ $('btn_consent').disabled=!( $('chk_required').checked && $('chk_minor').checked ); };
  $('chk_required').addEventListener('change',validate);
  $('chk_minor').addEventListener('change',validate);
  $('btn_consent').onclick=()=>{ STATE.consent=true; navGo('profile'); };
  document.querySelectorAll('.acc-head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
}

/* ===== í”„ë¡œí•„ ===== */
const AGE_TO_GRADE = {7:'ì´ˆë“±í•™êµ 1í•™ë…„',8:'ì´ˆë“±í•™êµ 2í•™ë…„',9:'ì´ˆë“±í•™êµ 3í•™ë…„',10:'ì´ˆë“±í•™êµ 4í•™ë…„',11:'ì´ˆë“±í•™êµ 5í•™ë…„',12:'ì´ˆë“±í•™êµ 6í•™ë…„'};
const GRADE_TO_AGE = Object.fromEntries(Object.entries(AGE_TO_GRADE).map(([a,g])=>[g,a]));
const CAMPUSES = ['ì••êµ¬ì •[ë³¸ì›]','ë°˜í¬ ìº í¼ìŠ¤','í•œë‚¨ ìº í¼ìŠ¤','ë°©ë°° ìº í¼ìŠ¤','ëª©ë™ ìº í¼ìŠ¤','ì†¡íŒŒ ìº í¼ìŠ¤','ì„œëŒ€ë¬¸ ìº í¼ìŠ¤','ì¼ì‚° ìº í¼ìŠ¤','íƒ„í˜„ ìº í¼ìŠ¤','ê¹€í¬ ìº í¼ìŠ¤','ì†¡ë„ ìº í¼ìŠ¤','ë¶€ì‚° ìº í¼ìŠ¤'];

function viewProfile(){
  app().innerHTML=`<h2 class="center">í”„ë¡œí•„ ì •ë³´</h2>
  <div class="form" style="margin-top:8px">
    <div class="field"><label>ì•„ë™ ì´ë¦„</label><input id="cname" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
    <div class="field"><label>ë³´í˜¸ì ì´ë¦„</label><input id="gname" placeholder="ì˜ˆ: ê¹€ë³´í˜¸ì"></div>

    <div class="field"><label>ë‚˜ì´</label><select id="age">${[7,8,9,10,11,12].map(a=>`<option value="${a}">${a}</option>`).join('')}</select></div>
    <div class="field"><label>í•™ë…„</label><select id="grade">${Object.values(AGE_TO_GRADE).map(g=>`<option>${g}</option>`).join('')}</select></div>

    <div class="field" style="grid-column:1 / span 2"><label>ì—°ë½ì²˜</label><input id="phone" placeholder="010-0000-0000"></div>
    <div class="field"><label>ìº í¼ìŠ¤</label><select id="campus">${CAMPUSES.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>
    <div class="field"><label>ì´ë©”ì¼(ì„ íƒ, ê²°ê³¼ì§€ ì „ì†¡ìš©)</label><input id="email" placeholder="example@email.com"></div>
  </div>
  <div class="center" style="margin-top:18px"><button class="btn btn-mint" id="btn_starttest">í…ŒìŠ¤íŠ¸ ì‹œì‘</button></div>`;
  $('age').addEventListener('change',e=>{ $('grade').value = AGE_TO_GRADE[e.target.value]; });
  $('grade').addEventListener('change',e=>{ $('age').value = GRADE_TO_AGE[e.target.value]; });
  $('btn_starttest').onclick=startTest;
}

async function startTest(){
  STATE.profile={
    child_name:$('cname').value.trim(),
    guardian:$('gname').value.trim(),
    age:$('age').value,
    grade:$('grade').value,
    phone:$('phone').value.trim(),
    email:$('email').value.trim(),
    campus:$('campus').value
  };
  if(!STATE.profile.child_name){ alert('ì•„ë™ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
  if(!/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(STATE.profile.phone||'')){ alert('ì—°ë½ì²˜ í˜•ì‹(010-0000-0000)ì„ í™•ì¸í•´ ì£¼ì„¸ìš”'); return; }
  await loadQuestions(); STATE.idx=0; STATE.answers=[]; STATE.step='test'; render();
}

/* ===== í…ŒìŠ¤íŠ¸ ===== */
function pcGridClassFor(optsCount){
  if (window.matchMedia('(min-width:1024px)').matches){
    return optsCount===2 ? 'test-grid-2' : 'test-grid-4';
  }
  return 'grid grid-2';
}
function optionImageUrl(q, o){
  if (o.imageUrl) return o.imageUrl;
  const num = Number(q.order)|| (STATE.idx+1);
  return `${ASSET_BASE}/${num}-${o.key}.png`;
}
function viewTest(){
  const q=STATE.questions[STATE.idx]; if(!q){ app().innerHTML='<h3 class="center">ë¬¸í•­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì— ë¬¸ì˜í•´ ì£¼ì„¸ìš”.</h3>'; return; }
  const gridCls = pcGridClassFor(q.options.length);
  app().innerHTML=`<div style="display:flex;align-items:center;gap:10px;justify-content:center" class="small muted">
      <span class="badge">Q ${STATE.idx+1} / ${STATE.questions.length}</span>
    </div>
    <h2 class="center" style="margin-top:6px">${q.prompt||''}</h2>
    <div class="${gridCls}" style="margin-top:8px">
      ${q.options.map(o=>`<div class="opt" id="opt_${o.key}" tabindex="0" role="button" aria-label="${o.label||o.key}" data-key="${o.key}">
        <img src="${optionImageUrl(q,o)}" alt="${o.label||o.key}" onerror="this.style.opacity=.2" loading="lazy">
        <div class="cap center">${o.label||o.key}</div>
      </div>`).join('')}
    </div>
    <div class="center" style="margin-top:16px;display:flex;gap:10px;justify-content:center">
      <button class="btn-ghost" id="btn_prev" ${STATE.idx===0?'disabled':''}>ì´ì „</button>
      <button class="btn" id="btn_next" disabled>ë‹¤ìŒ</button>
    </div>`;
  q.options.forEach(o=>{
    const el = document.getElementById(`opt_${o.key}`);
    el.onclick = ()=>choose(o.key);
    el.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' ') choose(o.key); };
  });
  $('btn_prev').onclick=prev;
  $('btn_next').onclick=next;
}
function choose(key){
  const q=STATE.questions[STATE.idx];
  q.options.forEach(k=>{const n=document.getElementById(`opt_${k.key}`); if(n) n.classList.remove('sel');});
  const node=document.getElementById(`opt_${key}`); if(node){ node.classList.add('sel'); node.animate([{transform:'scale(1)'},{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:160}); }
  const opt=q.options.find(o=>o.key===key);
  STATE.answers[STATE.idx]={ qid:q.id, key, weights:opt.weights||{} };
  $('btn_next').disabled=false;
}
function next(){
  if(STATE.step!=='test') return;
  if(!STATE.answers[STATE.idx]){ alert('í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”'); return; }
  if(STATE.idx<STATE.questions.length-1){ STATE.idx++; render(); }
  else{ submitAllSafe(); }
}
function prev(){ if(STATE.idx>0){ STATE.idx--; render(); } }

document.addEventListener('keydown',(e)=>{
  if(STATE.step!=='test') return;
  if(e.key==='ArrowRight'){ next(); }
  if(e.key==='ArrowLeft'){ prev(); }
  if(e.key==='Enter'){ if(!$('btn_next').disabled) next(); }
});

/* ===== ì ìˆ˜/ë©˜íŠ¸ ===== */
function aggregateScores(ans){
  const sum={}; DOMAINS.forEach(d=>sum[d]=0);
  ans.forEach(a=>Object.entries(a.weights||{}).forEach(([k,v])=>sum[k]=(sum[k]||0)+Number(v||0)));
  const n=ans.length||1; const raw={};
  DOMAINS.forEach(d=>{ const v=(sum[d]||0)/n*4; raw[d]=Math.max(0,Math.round(v*10)/10); });
  return raw;
}
const adjust=v=>Math.round((2 + v/2) * 10)/10;
function band(v){ if(v>=3.6) return 'S'; if(v>=3.2) return 'A'; if(v>=2.8) return 'A-'; if(v>=2.4) return 'B+'; if(v>=2.0) return 'B'; if(v>=1.6) return 'B-'; if(v>=1.0) return 'C+'; return 'C'; }
const DETAIL = {
  'ê´€ì°°ë ¥':(n)=>`${n}ë‹˜ì€ ëŒ€ìƒì˜ íŠ¹ì§•ì„ ìºì¹˜í•˜ëŠ” ëˆˆì´ ì¢‹ì•„ìš”. ì‘ì€ ë³€í™”ë„ í¬ì°©í•´ í‘œí˜„ì˜ ë°€ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.`,
  'ìƒ‰ê°ê°':(n)=>`${n}ë‹˜ì€ ìƒ‰ì˜ ë¶„ìœ„ê¸°ë¥¼ ì½ê³  ì¡°í•©í•˜ëŠ” ê°ì´ íƒì›”í•©ë‹ˆë‹¤. ë¯¸ë¬˜í•œ í†¤ ì°¨ì´ë„ ì•ˆì •ì ìœ¼ë¡œ ë‹¤ë£¹ë‹ˆë‹¤.`,
  'ì„œì‚¬ë ¥':(n)=>`${n}ë‹˜ì€ ì¥ë©´ ì†ì— ì´ì•¼ê¸°ë¥¼ ì‹¬ëŠ” ë° ê°•ì ì´ ìˆì–´ìš”. ê°ì •ê³¼ ì‚¬ê±´ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•©ë‹ˆë‹¤.`,
  'ê³µê°„ê°':(n)=>`${n}ë‹˜ì€ ì›ê·¼Â·ìŠ¤ì¼€ì¼ì„ í™œìš©í•´ ì…ì²´ê°ì„ ì‚´ë¦½ë‹ˆë‹¤. ì¥ë©´ì˜ ê¹Šì´ë¥¼ ì•ˆì •ì ìœ¼ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤.`,
  'ë””í…Œì¼':(n)=>`${n}ë‹˜ì€ ë§ˆê°ê³¼ ì§ˆê° í‘œí˜„ì´ ì„¬ì„¸í•´ìš”. ì‘í’ˆ ì™„ì„±ë„ë¥¼ ì˜¬ë¦¬ëŠ” ì§‘ì¤‘ë ¥ì´ ê°•ì ì…ë‹ˆë‹¤.`,
  'ë„ì „ì„±':(n)=>`${n}ë‹˜ì€ ìƒˆë¡œìš´ ë„êµ¬ì™€ ë°©ì‹ì— ë‘ë ¤ì›€ì´ ì ì–´ìš”. ì‹¤í—˜ì ì¸ í”„ë¡œì íŠ¸ì—ì„œ ì„±ì¥ ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤.`,
  'ì†Œí†µë ¥':(n)=>`${n}ë‹˜ì€ ì˜ë„ë¥¼ ì–¸ì–´ë¡œ í’€ì–´ë‚´ëŠ” í˜ì´ ì¢‹ì•„ìš”. ë°œí‘œÂ·ë¹„í‰ í™œë™ì—ì„œ ì„¤ë“ë ¥ì´ ìˆìŠµë‹ˆë‹¤.`,
  'ê¾¸ì¤€ì„±':(n)=>`${n}ë‹˜ì€ ë£¨í‹´ì„ ìœ ì§€í•˜ë©° ì™„ì„±ê¹Œì§€ ë°€ì–´ë¶™ì´ëŠ” í˜ì´ ë‹ë³´ì…ë‹ˆë‹¤. í•™ìŠµ ì§€ì†ë ¥ì´ ê°•í•©ë‹ˆë‹¤.`
};
const PRAISE = {
  'S':k=>`ì™€, ${k}ì—ì„œ <b>íƒ€ê³ ë‚œ ì¬ëŠ¥</b>ì´ ë‹ë³´ì…ë‹ˆë‹¤.`,
  'A':k=>`${k} ê°ê°ì´ <b>ë›°ì–´ë‚©ë‹ˆë‹¤</b>.`,
  'A-':k=>`${k} ì‹¤ë ¥ì´ <b>íƒ„íƒ„</b>í•©ë‹ˆë‹¤.`,
  'B+':k=>`${k}ì´ ì•ˆì •ì ì…ë‹ˆë‹¤.`,
  'B':k=>`${k} ê¸°ë³¸ê¸°ê°€ ì¢‹ìŠµë‹ˆë‹¤.`
};
const MISSIONS={
  'ê´€ì°°ë ¥':['ì§‘ ì•ˆ ì‚¬ë¬¼ 3ê°œ 5ë¶„ ê´€ì°°ìŠ¤ì¼€ì¹˜'],
  'ìƒ‰ê°ê°':['í•œì • íŒ”ë ˆíŠ¸ 3ìƒ‰ìœ¼ë¡œ ì†Œí’ˆ ì¹ í•˜ê¸°'],
  'ì„œì‚¬ë ¥':['3ì»· ë§Œí™”ë¡œ ì˜¤ëŠ˜ ì‚¬ê±´'],
  'ê³µê°„ê°':['ì•-ì¤‘-ë’¤ ë‚˜ëˆ  ë°°ì¹˜í•˜ê¸°'],
  'ë””í…Œì¼':['ì¬ì§ˆ 3ì¢…(ê¸ˆì†/ì²œ/ë‚˜ë¬´) í‘œí˜„'],
  'ë„ì „ì„±':['ìƒˆ ë„êµ¬ 1ê°œ ì²´í—˜ ê¸°ë¡'],
  'ì†Œí†µë ¥':['ì‘ê°€ë…¸íŠ¸ 3ë¬¸ì¥ ì“°ê¸°'],
  'ê¾¸ì¤€ì„±':['5ì¼ ì—°ì† 15ë¶„ ì²´í¬']
};

/* ===== ì œì¶œ & ê²°ê³¼ ===== */
function nowKST(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())} KST`; }

async function submitAllSafe(){
  const raw=aggregateScores(STATE.answers);
  const scores=Object.fromEntries(Object.entries(raw).map(([k,v])=>[k,adjust(v)]));
  const top3=Object.keys(scores).sort((a,b)=>scores[b]-scores[a]).slice(0,3);
  const resultId=crypto.randomUUID();

  const form=new FormData();
  form.append(F.child_name,STATE.profile.child_name); form.append(F.age,STATE.profile.age); form.append(F.grade,STATE.profile.grade);
  form.append(F.guardian,STATE.profile.guardian); form.append(F.phone,STATE.profile.phone); form.append(F.campus,STATE.profile.campus||'');
  form.append(F.answers,JSON.stringify({profile:STATE.profile,questions:STATE.answers,top3}));
  form.append(F.scores,JSON.stringify(scores));
  form.append(F.top3,top3.join(','));
  form.append(F.resultId,resultId);
  form.append(F.timestamp,nowKST());
  try{ await fetch(FORM_ACTION,{method:'POST',mode:'no-cors',body:form}); }catch(e){}

  STATE.result={scores,top3,resultId}; STATE.step='result'; render();
}

let CHARTS=[];
function destroyCharts(){ CHARTS.forEach(c=>c.destroy?.()); CHARTS=[]; }

/* ì „ë¬¸ê°€(ì¢…í•©) ì„¹ì…˜ */
function expertSection(childName, scores, top3){
  return `
    <div class="section-title">ğŸ§¾ ì „ë¬¸ê°€ í‰ê°€ ë° ì´ë¡ ì  ë°°ê²½</div>
    ${top3.map((k,i)=>`
      <div class="expert-wrap">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <div class="badge">${i+1}. ${k}</div>
          <span class="small muted">í˜„ì¬ ìˆ˜ì¤€: <b>${(scores[k]||0).toFixed(1)}</b></span>
          <span class="tag-blue">ê°•ì  ì˜ì—­</span>
        </div>
        <div class="expert-grid">
          <div class="card-lite">
            <div style="font-weight:900;margin-bottom:6px">ğŸ“ ì´ë¡ ì  ê·¼ê±°</div>
            <p class="small">${k}ì€(ëŠ”) ì‘í’ˆì˜ ì™„ì„±ë„ì™€ í‘œí˜„ë ¥ì„ ê²°ì •í•˜ëŠ” ì¤‘ìš”í•œ ì§€í‘œì…ë‹ˆë‹¤.</p>
          </div>
          <div class="card-lite" style="background:#F8F1FF">
            <div style="font-weight:900;margin-bottom:6px;color:#7c3aed">ğŸ‘©â€âš•ï¸ ì „ë¬¸ê°€ ì˜ê²¬</div>
            <p class="small">â€œ${childName}ì€(ëŠ”) <b>${k}</b>ì—ì„œ ë‹ë³´ì´ë©°, ì°½ì˜ì  ì‚¬ê³ ë ¥ê³¼ í‘œí˜„ì˜ ê· í˜•ì´ ì¢‹ìŠµë‹ˆë‹¤.â€</p>
          </div>
          <div class="card-lite">
            <div style="font-weight:900;margin-bottom:6px">â¬† ë°œë‹¬ ë°©í–¥</div>
            <p class="small">ë£¨í‹´ ì† ì‹¤í—˜ì„ ëŠ˜ë¦¬ê³  ì‘ì€ ì™„ì„±ì„ ìì£¼ ë§Œë“œëŠ” í•™ìŠµ íŒ¨í„´ì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>
          </div>
          <div class="card-lite"></div>
        </div>
      </div>
    `).join('')}
  `;
}

function viewResult(){
  const r=STATE.result, s=r?.scores||{};
  const overall = Math.round((Object.values(s).reduce((a,b)=>a+(+b||0),0))*10)/10 || 0;
  const T = r.top3;
  const summary = `${STATE.profile.child_name}ë‹˜ì€ <b>${T[0]}</b>ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ <b>${T[1]}</b>, <b>${T[2]}</b>ì—ì„œ ê°•ì ì´ ëšœë ·í•©ë‹ˆë‹¤.`;

  app().innerHTML=`<div id="resultCard">
    <div class="block callout center">
      <div class="chip" style="margin:0 auto 8px;display:inline-block">í…ŒìŠ¤íŠ¸ ì™„ë£Œ</div>
      <h2 style="margin:0 0 10px"><b>${STATE.profile.child_name}</b>ë‹˜, ë©‹ì§„ ì§‘ì¤‘ë ¥ì´ì—ˆìŠµë‹ˆë‹¤!</h2>
      <div class="kpi" style="justify-content:center"><div class="num" style="font-size:52px">${overall.toFixed(1)}</div><div class="unit">/ 32 (8ì˜ì—­ í•©ì‚°)</div></div>
      <div class="chips" style="margin-top:10px;justify-content:center">${r.top3.map(t=>`<span class="chip">ë›°ì–´ë‚œ ì˜ì—­: ${t}</span>`).join('')}</div>
    </div>

    <div class="result-row">
      <div class="block"><h3 class="center">ì˜ì—­ë³„ ê´€ì‹¬ë„(ë ˆì´ë‹¤)</h3><canvas id="radar" height="220"></canvas></div>
      <div class="block"><h3 class="center">ë›°ì–´ë‚œ ì˜ì—­(ë§‰ëŒ€)</h3><canvas id="bars" height="220"></canvas></div>
    </div>

    <div class="block">
      <h3>ì´í‰</h3>
      <p class="small" style="color:#0f172a;line-height:1.7">${summary}</p>
    </div>

    <div class="block">
      <h3>í•­ëª©ë³„ í•´ì„ & ì¼ì¼ 15ë¶„ í›ˆë ¨</h3>
      <div class="form" style="grid-template-columns:1fr 1fr">
        ${DOMAINS.map(k=>{
          const v=+(s[k]||0), b=band(v), w=Math.min(100,(v/4)*100);
          const mission = (MISSIONS[k]||[])[0] || 'ê´€ì°°Â·ìŠ¤ì¼€ì¹˜ 1ì¥';
          return `<div class="card-lite">
            <div style="display:flex;justify-content:space-between;align-items:flex-end">
              <strong>${k}</strong>
              <div class="kpi"><div class="num" style="font-size:26px">${v.toFixed(1)}</div><div class="unit">/ 4.0</div></div>
            </div>
            <div class="topprogress" style="height:10px;margin:8px 0 10px"><div style="width:${w}%;height:100%;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE)"></div></div>
            <div class="small" style="color:#0f172a">${DETAIL[k](STATE.profile.child_name)}</div>
            <div class="small" style="margin-top:4px">ì˜¤ëŠ˜ì˜ 15ë¶„: <b>${mission}</b> â€” ë“±ê¸‰ ${b}</div>
          </div>`;
        }).join('')}
      </div>
    </div>

    ${expertSection(STATE.profile.child_name, s, T)}

    <p class="credit">â€» ë³¸ ê²°ê³¼ëŠ” êµìœ¡ ê°€ì´ë“œ ëª©ì ì´ë©° ì˜í•™Â·ì„ìƒ ì§„ë‹¨ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
  </div>

  <div class="center no-print" style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button class="btn-ghost" onclick="STATE.step='start'; render()">ì²˜ìŒìœ¼ë¡œ</button>
    <button class="btn btn-mint" id="btn_pdf">PDF ì €ì¥</button>
    <button class="btn btn-primary" id="btn_email">ì´ë©”ì¼ë¡œ ë³´ë‚´ê¸°</button>
  </div>`;

  // ì°¨íŠ¸
  destroyCharts();
  const rctx=document.getElementById('radar').getContext('2d');
  CHARTS.push(new Chart(rctx,{type:'radar',
    data:{labels:DOMAINS, datasets:[{data:DOMAINS.map(k=>s[k]||0), borderColor:'#FF8C3A', backgroundColor:'rgba(255,140,58,.22)', borderWidth:2, pointRadius:2, fill:true}]},
    options:{animation:false, scales:{r:{suggestedMin:0,suggestedMax:4,ticks:{stepSize:1},grid:{color:'#eef2f7'},angleLines:{color:'#eef2f7'}}}, plugins:{legend:{display:false}}}
  }));
  const bctx=document.getElementById('bars').getContext('2d');
  CHARTS.push(new Chart(bctx,{type:'bar',
    data:{labels:r.top3, datasets:[{data:r.top3.map(k=>s[k]||0), borderRadius:10, borderSkipped:false, backgroundColor:['#FFD9BE','#E6E2FF','#CFF7EE']}]},
    options:{animation:false, scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{stepSize:1},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}, plugins:{legend:{display:false}}}
  }));

  $('btn_pdf').onclick = savePDF;
  $('btn_email').onclick = openEmail;
}

/* ===== PDF ì €ì¥ ===== */
async function savePDF(){
  document.documentElement.classList.add('pdf-mode');
  // ì°¨íŠ¸ â†’ ì´ë¯¸ì§€ë¡œ êµì²´
  const replaced = [];
  CHARTS.forEach((c)=>{
    const canvas = c.canvas;
    const img = new Image();
    img.src = c.toBase64Image();
    img.style.width = canvas.style.width || '100%';
    img.style.height = canvas.style.height || '220px';
    img.className = 'chart-export';
    canvas.parentNode.insertBefore(img, canvas);
    canvas.style.display='none';
    replaced.push({canvas,img});
  });

  const node = $('app');
  const opt = {
    filename: `${STATE.profile.child_name}_ë¯¸ìˆ ì ì„±_ê²°ê³¼.pdf`,
    margin: [10,10,10,10],
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, background:'#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['css','legacy'] }
  };
  await html2pdf().from(node).set(opt).save();

  // ë³µêµ¬
  replaced.forEach(({canvas,img})=>{ img.remove(); canvas.style.display=''; });
  document.documentElement.classList.remove('pdf-mode');
}

/* ===== ì´ë©”ì¼ ì „ì†¡ ===== */
function openEmail(){
  $('mail_subject').value = `${STATE.profile.child_name} í…ŒìŠ¤íŠ¸ ê²°ê³¼ì…ë‹ˆë‹¤`;
  $('mail_to').value = STATE.profile.email || '';
  $('mail_status').textContent='';
  $('emailModal').style.display='flex';
}
function closeEmail(){ $('emailModal').style.display='none'; }

async function sendEmail(){
  const to = $('mail_to').value.trim();
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(to)){ $('mail_status').textContent='ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; return; }

  document.documentElement.classList.add('pdf-mode');
  const node = $('app');
  const opt = {
    margin: [10,10,10,10],
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, background:'#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
  };
  const dataUri = await html2pdf().from(node).set(opt).outputPdf('datauristring');
  document.documentElement.classList.remove('pdf-mode');

  const base64 = dataUri.split(',')[1];
  $('mail_status').textContent='ì „ì†¡ ì¤‘â€¦';

  try{
    const res = await fetch('/.netlify/functions/send-email', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        to,
        subject:$('mail_subject').value.trim() || `${STATE.profile.child_name} í…ŒìŠ¤íŠ¸ ê²°ê³¼ì…ë‹ˆë‹¤`,
        fileName:`${STATE.profile.child_name}_ê²°ê³¼.pdf`,
        pdfBase64: base64,
        childName: STATE.profile.child_name,
        campus: STATE.profile.campus
      })
    });
    const data = await res.json();
    if(!res.ok){ throw new Error(data?.error || 'ì „ì†¡ ì‹¤íŒ¨'); }
    $('mail_status').textContent='ì „ì†¡ ì„±ê³µ!';
    setTimeout(closeEmail, 900);
  }catch(e){
    $('mail_status').textContent='ì „ì†¡ ì‹¤íŒ¨: ' + e.message;
  }
}

/* ===== Router ===== */
function render(){ renderNav(); updateTopProgress();
  if(STATE.step==='start') return viewStart();
  if(STATE.step==='consent') return viewConsent();
  if(STATE.step==='profile') return viewProfile();
  if(STATE.step==='test') return viewTest();
  if(STATE.step==='result') return viewResult();
}
render();

/* ===== Fallback ë¬¸í•­ ===== */
function W(w){ const o={}; DOMAINS.forEach(k=>o[k]=0); Object.entries(w).forEach(([k,v])=>o[k]=v); return o; }
function localQuestions(){
  const S=(q,p,a,b,c,d)=>({id:q,order:+q.replace('q',''),prompt:p,options:[
    {key:'A',label:a[0],imageUrl:a[1],weights:W(a[2])},
    {key:'B',label:b[0],imageUrl:b[1],weights:W(b[2])},
    {key:'C',label:c[0],imageUrl:c[1],weights:W(c[2])},
    {key:'D',label:d[0],imageUrl:d[1],weights:W(d[2])},
  ]});
  const IMG=(kw)=>`https://images.unsplash.com/photo-150${Math.floor(Math.random()*899+100)}?auto=format&fit=crop&w=1000&q=70&${encodeURIComponent(kw)}`;

  return [
    S('q1','ìƒˆë¡œìš´ ë¯¸ìˆ  ë„êµ¬ë¥¼ ë°œê²¬í–ˆì–´ìš”! ë¬´ì—‡ì„ ë¨¼ì € í•´ë³¼ê¹Œìš”?',
      ['ì„¤ëª…ì„œë¥¼ ê¼¼ê¼¼íˆ ì½ì–´ë³¸ë‹¤', IMG('paper'), {ë””í…Œì¼:1, ê¾¸ì¤€ì„±:0.6}],
      ['ì¢…ì´ì— íƒìƒ‰Â·ì‹¤í—˜í•œë‹¤', IMG('sketch'), {ë„ì „ì„±:1}],
      ['ì¹œêµ¬ë“¤ê³¼ ì•„ì´ë””ì–´ ë‚˜ëˆˆë‹¤', IMG('kids'), {ì†Œí†µë ¥:1, ì„œì‚¬ë ¥:0.6}],
      ['ê°€ì¥ íŠ¹ì´í•œ ê²°ê³¼ ìƒìƒ', IMG('idea'), {ë„ì „ì„±:1, ì„œì‚¬ë ¥:0.5}]
    ),
    S('q2','ê·¸ë¦¼ì— ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‹´ê³  ì‹¶ë‚˜ìš”?',
      ['ëª¨í—˜ ì´ì•¼ê¸°', IMG('adventure'), {ì„œì‚¬ë ¥:1}],
      ['ê°ì •ì„ ìƒ‰ê³¼ í˜•íƒœë¡œ', IMG('abstract'), {ìƒ‰ê°ê°:0.8, ì„œì‚¬ë ¥:0.6}],
      ['í˜„ì‹¤ ê±´ë¬¼ ìƒˆë¡œ ë””ìì¸', IMG('architecture'), {ê³µê°„ê°:1, ë””í…Œì¼:0.4}],
      ['ì‘ì€ ìƒëª…ì²´ì˜ ìˆ¨ì€ ì„¸ê³„', IMG('mini world'), {ê´€ì°°ë ¥:0.8, ì„œì‚¬ë ¥:0.6}]
    ),
    S('q3','ë‘ ê·¸ë¦¼ ì¤‘ ìƒ‰ì´ ë” ì¡°í™”ë¡œìš´ ê²ƒì€?',
      ['ì¡°í™”ë¡œìš´ íŒ”ë ˆíŠ¸', IMG('palette'), {ìƒ‰ê°ê°:1}],
      ['ëŒ€ë¹„ ê°•í•œ íŒ”ë ˆíŠ¸', IMG('contrast'), {ë„ì „ì„±:0.6}],
      ['íŒŒìŠ¤í…” í¸ì•ˆí•¨', IMG('pastel'), {ìƒ‰ê°ê°:0.8}],
      ['ê°•í•œ ë³´ìƒ‰', IMG('vivid'), {ë„ì „ì„±:0.6}]
    ),
    S('q4','ê·¸ë¦¬ë‹¤ ì‹¤ìˆ˜ë¥¼ í–ˆì–´ìš”. ì–´ë–»ê²Œ í• ê¹Œìš”?',
      ['ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦°ë‹¤', IMG('erase'), {ë””í…Œì¼:0.8, ê¾¸ì¤€ì„±:0.8}],
      ['ì‹¤ìˆ˜ë¥¼ ì‘í’ˆ ì¼ë¶€ë¡œ ë°”ê¾¼ë‹¤', IMG('mix'), {ë„ì „ì„±:0.6}],
      ['ì‰¬ê³  ì¬ë„ì „Â·ì™„ì„±', IMG('focus'), {ê¾¸ì¤€ì„±:1}],
      ['ë„ì›€ì„ ìš”ì²­', IMG('help'), {ì†Œí†µë ¥:0.8}]
    ),
    S('q5','ë¯¸ìˆ ê´€ì—ì„œ ë¬´ì—‡ì„ ì˜¤ë˜ ë³´ë‚˜ìš”?',
      ['ë¹›/ê·¸ë¦¼ì ë¶„ìœ„ê¸°', IMG('light'), {ê³µê°„ê°:0.6, ìƒ‰ê°ê°:0.6}],
      ['ìˆ¨ê²¨ì§„ ì‘ì€ ìš”ì†Œ', IMG('detail'), {ê´€ì°°ë ¥:0.8, ë””í…Œì¼:0.8}],
      ['ì‘ê°€ì˜ ë§ˆìŒ ìƒìƒ', IMG('emotion'), {ì„œì‚¬ë ¥:0.7, ì†Œí†µë ¥:0.4}],
      ['ì¬ë£Œ/ê¸°ë²•ì´ ê¶ê¸ˆ', IMG('material'), {ë„ì „ì„±:0.6, ê´€ì°°ë ¥:0.6}]
    ),
    S('q6','ë¯¸ë˜ì˜ ë„ì‹œë¥¼ ê·¸ë¦°ë‹¤ë©´, ì–´ë–»ê²Œ ì‹œì‘í• ê¹Œìš”?',
      ['ì‚¬ì§„ ì¡°ì‚¬Â·ê³„íš', IMG('city plan'), {ë””í…Œì¼:0.7, ê³µê°„ê°:0.8}],
      ['ì•„ë¬´ë„ ë³¸ ì  ì—†ëŠ” ê±´ë¬¼', IMG('scifi'), {ë„ì „ì„±:1}],
      ['ì•„ì´ë””ì–´ ëª¨ìœ¼ê¸°', IMG('team'), {ì†Œí†µë ¥:0.8}],
      ['ì¬ë£Œ ì‹¤í—˜', IMG('paint'), {ë„ì „ì„±:0.8, ìƒ‰ê°ê°:0.5}]
    ),
    S('q7','ì¹œêµ¬ê°€ ìŠ¬í¼ ë³´ì—¬ìš”. ì–´ë–¤ ê·¸ë¦¼ì„ ê·¸ë ¤ì¤„ê¹Œìš”?',
      ['ê·€ì—¬ìš´ ë™ë¬¼', IMG('cute'), {ì„œì‚¬ë ¥:0.5}],
      ['ì¶”ìƒì  ê°ì •', IMG('blue'), {ìƒ‰ê°ê°:0.6}],
      ['ì¦ê±°ìš´ ì¶”ì–µ', IMG('memory'), {ì„œì‚¬ë ¥:0.8, ì†Œí†µë ¥:0.5}],
      ['ë°ê³  í¬ë§ì°¬ ê·¸ë¦¼', IMG('bright'), {ìƒ‰ê°ê°:0.7}]
    ),
    S('q8','í¸ì•ˆí•œ ìƒ‰ ì¡°í•©ì€?',
      ['ë”°ëœ»í•œ ê³„ì—´', IMG('warm'), {ìƒ‰ê°ê°:0.8}],
      ['ì°¨ê°€ìš´ ê³„ì—´', IMG('cool'), {ìƒ‰ê°ê°:0.8}],
      ['ë³´ìƒ‰ ëŒ€ë¹„', IMG('complementary'), {ë„ì „ì„±:0.6}],
      ['íŒŒìŠ¤í…”', IMG('pastel soft'), {ìƒ‰ê°ê°:0.8}]
    ),
    S('q9','ì˜ ì•ˆë  ë•Œ ëª‡ ë²ˆ ì‹œë„í• ê¹Œìš”?',
      ['ë°”ê¾¼ë‹¤', IMG('switch'), {ë„ì „ì„±:0.4}],
      ['ëª‡ ë²ˆ í›„ í¬ê¸°', IMG('try'), {ê¾¸ì¤€ì„±:0.5}],
      ['ë  ë•Œê¹Œì§€ + ë„ì›€ìš”ì²­', IMG('keep'), {ê¾¸ì¤€ì„±:1, ì†Œí†µë ¥:0.5}],
      ['ì›ì¸ ë¶„ì„Â·ìƒˆ ë°©ë²•', IMG('analyze'), {ë„ì „ì„±:0.6}]
    ),
    S('q10','ì´ ê·¸ë¦¼ì—ì„œ ê°€ì¥ ëˆˆì— ë„ëŠ” ê²ƒì€?',
      ['ì „ì²´ êµ¬ë„', IMG('layout'), {ê³µê°„ê°:0.9}],
      ['ì‘ì€ íŒ¨í„´/ì§ˆê°', IMG('texture'), {ë””í…Œì¼:0.9}],
      ['ì¸ë¬¼ í‘œì •/ê°ì •', IMG('face'), {ì„œì‚¬ë ¥:0.7}],
      ['ë…íŠ¹í•œ ì¬ë£Œ/ê¸°ë²•', IMG('tech'), {ë„ì „ì„±:0.7}]
    ),
    S('q11','ë‚´ ê·¸ë¦¼ì˜ ì œëª©ì€?',
      ['ë³´ì´ëŠ” ëŒ€ë¡œ', IMG('see'), {ê´€ì°°ë ¥:0.6}],
      ['ìƒìƒì„ ë¶€ë¥´ëŠ” ì œëª©', IMG('title'), {ì„œì‚¬ë ¥:0.9, ì†Œí†µë ¥:0.5}],
      ['ê¸°ë¶„ ì¢‹ì•„ì§€ëŠ” ì œëª©', IMG('happy'), {ì„œì‚¬ë ¥:0.3}],
      ['ìƒ‰/í˜•íƒœ ê°•ì¡°', IMG('shape'), {ìƒ‰ê°ê°:0.7, ë””í…Œì¼:0.5}]
    ),
    S('q12','ì„¸ìƒì— ì—†ëŠ” ë™ë¬¼, ì–´ë–¤ ë™ë¬¼?',
      ['ì„ì–´ì„œ ë§Œë“  ë™ë¬¼', IMG('hybrid'), {ê´€ì°°ë ¥:0.6, ë””í…Œì¼:0.6}],
      ['ì™„ì „íˆ ìƒˆë¡œìš´ í˜•íƒœ', IMG('new'), {ë„ì „ì„±:0.9}],
      ['ê°ì • í‘œí˜„Â·ëŒ€í™”', IMG('talk'), {ì„œì‚¬ë ¥:0.7, ì†Œí†µë ¥:0.6}],
      ['íŠ¹ë³„í•œ ì¬ë£Œë¡œ ê¾¸ë¯¸ê¸°', IMG('craft'), {ìƒ‰ê°ê°:0.6, ë””í…Œì¼:0.6}]
    ),
    S('q13','ê·¸ë¦¼ì„ ë³´ì—¬ì¤„ ë•Œ ë“£ê³  ì‹¶ì€ ë§ì€?',
      ['ì¹­ì°¬', IMG('praise'), {}],
      ['êµ¬ì²´ì  ì¡°ì–¸', IMG('advice'), {}],
      ['ì´ì•¼ê¸°ê°€ ë– ì˜¬ë¼', IMG('story'), {}],
      ['ì¬ë£Œê°€ ê¶ê¸ˆ', IMG('curious'), {}]
    ),
    S('q14','ë‘ í’ê²½ ì¤‘ ë” ì•ˆì •ì ì¸ êµ¬ë„ëŠ”?',
      ['ê· í˜• ì¡íŒ êµ¬ë„', IMG('balance'), {ê³µê°„ê°:0.9}],
      ['ì¹˜ìš°ì¹œ êµ¬ë„', IMG('tilt'), {ë„ì „ì„±:0.4}],
      ['ë‹¤ì±„ë¡œìš´ ìƒ‰ ë°°ì¹˜', IMG('colors'), {ìƒ‰ê°ê°:0.5}],
      ['ì „ê²½-ì¤‘ê²½-í›„ê²½', IMG('depth'), {ê³µê°„ê°:0.6}]
    ),
    S('q15','ë‹µë‹µí•  ë•Œ ì–´ë–¤ ìƒê°ì„ í•˜ë‚˜ìš”?',
      ['ì¬ëŠ¥ì´ ì—†ë‚˜â€¦', IMG('sad'), {ê¾¸ì¤€ì„±:0.2}],
      ['ì¡°ê¸ˆë§Œ ë”! ìì‹ ê°', IMG('cheer'), {ê¾¸ì¤€ì„±:0.9}],
      ['ë‹¤ë¥¸ ë°©ë²• ë– ì˜¬ë¦¬ê¸°', IMG('newway'), {ë„ì „ì„±:0.6}],
      ['ì™„ì„± ìƒìƒìœ¼ë¡œ ë™ê¸°', IMG('finish'), {ì„œì‚¬ë ¥:0.5, ê¾¸ì¤€ì„±:0.7}]
    )
  ];
}
</script>
</body>
</html>
