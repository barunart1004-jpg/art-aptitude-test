<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>바른미술학원 · 미술적성테스트 V1. BASIC</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<!-- 차트 / 캡처 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#6b7280; --bg:#FFF4EC;
  --card:#ffffff; --line:#eef2f7; --o1:#FFE6CF; --o2:#FFD9BE;
  --mint:#CFF7EE; --vio:#E6E2FF; --radius:22px;
  --shadow:0 18px 60px rgba(16,24,40,.12); --soft:0 12px 30px rgba(16,24,40,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;color:var(--ink);font-family:"Pretendard",ui-sans-serif,system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial;background:var(--bg);font-size:17px}
.container{min-height:100dvh;display:flex;flex-direction:column;align-items:center}
.main{width:100%;max-width:1100px;padding:18px;display:flex;flex-direction:column;gap:16px;margin:0 auto}
.header{width:100%;display:flex;justify-content:center}
.brand{width:100%;max-width:1100px;margin-top:10px;display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:999px;background:#fff;border:1px solid var(--line);box-shadow:var(--soft)}
.logo{width:28px;height:28px;border-radius:50%;background:conic-gradient(from 0deg,#FFB98A,#FFE6CF,#E6E2FF,#CFF7EE,#FFB98A);animation:spin 9s linear infinite paused}
.brand:hover .logo{animation-play-state:running}@keyframes spin{to{transform:rotate(360deg)}}
.brand span{font-weight:900;letter-spacing:.2px;display:flex;align-items:center;gap:8px}
.badge{font-size:12px;font-weight:900;padding:4px 8px;border-radius:999px;background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#5a3f2f;border:1px solid #ffe0c9}

/* 진행바 & 네비 */
.sticky{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.95);border:1px solid var(--line);border-radius:16px;box-shadow:var(--soft);padding:8px 10px;display:flex;flex-direction:column;gap:10px}
.navbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.step{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;cursor:pointer;background:#fff;color:#374151;font-weight:850;border:1px solid var(--line);box-shadow:var(--soft);transition:transform .12s}
.step:hover{transform:translateY(-1px)}
.step .num{width:20px;height:20px;border-radius:50%;display:inline-grid;place-items:center;background:#fff;border:1px solid var(--line);font-size:13px}
.step.active{background:linear-gradient(90deg,#FFE6CF,#E6E2FF);color:#111827;box-shadow:0 12px 30px rgba(255,214,176,.28)}
.step.done{background:#f2fffa;border-color:#dff7ef}

.topprogress{--steps:15;position:relative;height:30px;background:#f6f7fb;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
.topprogress .bar{position:absolute;inset:0 auto 0 0;width:0;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE);border-radius:999px;z-index:1;transition:width .35s ease}
.topprogress::before{
  content:"";position:absolute;inset:0;z-index:2;pointer-events:none;
  background-image:linear-gradient(to right, rgba(17,24,39,.08) 0, rgba(17,24,39,.08) 1px, transparent 1px, transparent calc(100%/var(--steps)));
  background-size:calc(100%/var(--steps)) 100%;
}
.topprogress .toplabel{position:absolute;inset:0;display:grid;place-items:center;z-index:3;font-weight:900;font-size:15px;color:#111827;text-shadow:0 1px 0 rgba(255,255,255,.85),0 0 6px rgba(255,255,255,.9)}
.statusline{font-size:13px;color:var(--muted);text-align:center}

.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);animation:fade .35s ease both}
@keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
h1{font-size:35px;margin:0 0 6px}h2{font-size:25px;margin:0 0 10px}h3{font-size:19px;margin:16px 0 8px}
p{margin:8px 0}.small{font-size:14px}.muted{color:var(--muted)}.center{text-align:center}

/* Hero */
.hero{position:relative;padding:44px 22px;border-radius:22px;border:1px solid var(--line);
  background:radial-gradient(900px 260px at 15% -40%, #FFE6CF 0%, transparent 60%),radial-gradient(900px 260px at 85% -40%, #E6E2FF 0%, transparent 60%),linear-gradient(180deg,#ffffff 0%, #fff9f3 100%)}
.hero .title{font-size:45px;font-weight:900;letter-spacing:.2px;margin:2px 0 6px;color:#111827}
.hero .sub{color:#6b7280;margin-bottom:18px}
.hero .ctaRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* 버튼 */
.btn{--bg:linear-gradient(90deg,#FFB98A,#FFD9BE);--glow:rgba(255,185,138,.35);background:var(--bg);color:#5a3f2f;border:none;padding:18px 28px;border-radius:18px;font-weight:900;cursor:pointer;box-shadow:0 16px 40px var(--glow);transition:transform .08s,filter .2s;font-size:21px}
.btn:hover{transform:translateY(-1px);filter:brightness(1.03)}
.btn-ghost{background:#fff;color:#111827;border:1px solid var(--line);padding:12px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:var(--soft)}
.btn-mint{--bg:linear-gradient(90deg,#FFE6CF,#FFD9BE)}.btn-accent{--bg:linear-gradient(90deg,#B9C8FF,#9DE5D5)}.btn-xl{padding:22px 34px;font-size:23px;border-radius:22px}

/* 입력/폼 카드 */
input,select,textarea{width:100%;background:#fff;color:#111;border:1px solid var(--line);border-radius:12px;padding:13px;outline:none}
input:focus,select:focus,textarea:focus{border-color:#FFD9BE;box-shadow:0 0 0 6px rgba(255,217,190,.26)}
label{font-size:15px;color:#374151}
.section{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}

.grid{display:grid;gap:14px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:1020px){.grid-4{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.grid-4{grid-template-columns:1fr}}

/* 보기 카드 */
.opt{border:2px solid var(--line);border-radius:18px;overflow:hidden;cursor:pointer;background:#fff;box-shadow:var(--soft);transition:transform .12s,border-color .2s}
.opt:hover{transform:translateY(-2px)}
/* ⇩ 이미지 확대(PC/모바일 모두) */
.opt .thumb{width:74%;max-width:220px;aspect-ratio:1/1;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#fafafa;margin:18px auto 10px;display:flex;align-items:center;justify-content:center}
@media (max-width:640px){.opt .thumb{width:88%;max-width:280px}}
.opt .thumb img{width:100%;height:100%;object-fit:cover;display:block;user-select:none;-webkit-user-drag:none}
.opt .cap{padding:10px 12px 16px;color:#374151;font-weight:800;font-size:17px;line-height:1.35}

@media (min-width:1024px){
  .test-grid-4{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  .test-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  .sideNav{position:fixed;top:50%;transform:translateY(-50%);z-index:20}
  .sideNav.left{left:18px}.sideNav.right{right:18px}
  .sideBtn{background:linear-gradient(90deg,#fff,#FFF4EC);border:1px solid var(--line);width:48px;height:48px;border-radius:50%;display:grid;place-items:center;box-shadow:0 12px 26px rgba(16,24,40,.08);cursor:pointer;font-weight:900}
  .sideBtn:hover{transform:translateY(-1px)}
}
@media (max-width:1023px){.sideNav{display:none}}
.opt.sel{border-color:#FFD9BE;box-shadow:0 0 0 6px rgba(255,217,190,.25)}

/* 동의 아코디언 */
.acc{border-radius:14px;overflow:hidden;border:1px solid var(--line)}
.acc-item{border-top:1px solid var(--line)}
.acc-head{padding:15px 16px;background:#FFF4EC;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.acc-head span{font-weight:900;font-size:18px}
.acc-body{padding:14px 16px;display:none;background:#fff}
.acc-item.open .acc-body{display:block}
.agreeList{display:grid;gap:10px;margin-top:10px}
.agree-row{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:13px 14px;border:1px solid var(--line);border-radius:12px;background:#fff}
.agree-row .txt{font-size:16px;color:#0f172a;line-height:1.55;font-weight:700}
.agree-row input[type="checkbox"]{width:21px;height:21px;accent-color:#FFB98A}

/* 결과 레이아웃 */
.block{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(16,24,40,.06);page-break-inside:avoid;break-inside:avoid}
.block h3{margin:0 0 10px}
.result-grid{display:grid;grid-template-columns:3fr 2fr;gap:16px}
.result-right{display:grid;grid-template-rows:1fr 1fr;gap:16px}
.chartBox{height:420px;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
.result-right .chartBox{height:200px}
.chartBox canvas{width:100% !important;height:100% !important;display:block}
.chartCaption{font-weight:900;margin:0 0 6px;color:#111827}

.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#5a3f2f;border:1px solid #ffe8d6;padding:8px 12px;border-radius:999px;font-weight:900}
.callout{position:relative;background:linear-gradient(135deg,#FFF2E6,#F8FBFF);padding:22px;border-radius:18px;border:1px solid var(--line);box-shadow:0 12px 34px rgba(255,185,138,.25)}
.callout:before{content:"";position:absolute;inset:-1px;border-radius:18px;padding:1px;background:linear-gradient(90deg,#FFD9BE,#E6E2FF,#CFF7EE);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}

/* 자세한 결과 */
.detail-hero{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:8px}
.detail-hero .ic{width:50px;height:50px;border-radius:999px;background:#e9efff;border:1px solid #dbe7ff;display:grid;place-items:center;font-weight:900;color:#3b61ff}
.detail-title{font-size:29px;font-weight:900}
.detail-sub{color:#6b7280;text-align:center;margin:-4px 0 10px}
.theoryWrap{background:#f5f8ff;border:1px solid #e6eeff;border-radius:18px;padding:16px}
.tgrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.tcard{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;line-height:1.7}
.tcard.hint{background:#f9fbff}
.tchip{background:#e6eeff;color:#2f5aff;border:1px solid #d9e3ff;padding:7px 11px;border-radius:999px;font-weight:800;font-size:13px}

/* 상담 예약 */
.reserve{margin-top:14px;text-align:center;background:linear-gradient(180deg,#fff7ec,#ffe7d1);border:1px solid #ffd9be;border-radius:18px;padding:18px}
.reserve .title{font-weight:900;font-size:23px;color:#5a3f2f}
.reserve .items{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:16px 0;justify-items:center}
.reserve .pill{width:100%;max-width:360px;background:#fff;border:1px solid #ffe1c9;border-radius:14px;padding:12px}
.reserve .pill .pt{font-weight:900;margin-bottom:6px}.reserve .note{font-size:13px;color:#6b7280;margin-top:8px}

/* 푸터(저작권) */
.footer{width:100%;max-width:1100px;margin:18px auto 30px auto;color:#6b7280;font-size:13px;text-align:center}
.footer small{display:block;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}

/* 프린트 */
@media print{.header,.sticky,.btn,.btn-ghost,.sideNav,.no-pdf{display:none !important}.card{box-shadow:none;border:1px solid #ddd}.block{break-inside:avoid-page}}
.pdf-screen-width{width:794px;max-width:none;margin:0 auto}

/* 이메일 모달 */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:999}
.modal-backdrop.show{display:flex}
.modal{width:min(520px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 18px 60px rgba(16,24,40,.18);padding:18px}
.modal h3{margin:0 0 10px}.modal .row{display:grid;gap:8px;margin:10px 0}.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* 기본 UX */
img,canvas{pointer-events:none}
</style>
</head>
<body>
<div class="container" id="appRoot">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <span>바른미술학원 · 미술적성테스트 <span class="badge">V1. BASIC</span></span>
    </div>
  </div>

  <main class="main" aria-live="polite">
    <div class="sticky">
      <nav class="navbar" id="topnav"></nav>
      <div class="topprogress" id="topprogress">
        <div id="topbar" class="bar"></div>
        <div id="toplabel" class="toplabel"></div>
      </div>
      <div class="statusline" id="statusline">진행률 0%</div>
    </div>
    <section class="card" id="app"></section>

    <!-- 저작권 표기 -->
    <footer class="footer">
      <small id="copyrightText">© 바른미술학원. All rights reserved.</small>
    </footer>
  </main>
</div>

<div class="sideNav left" id="sideLeft" style="display:none"><button class="sideBtn" onclick="prev()" aria-label="이전">‹</button></div>
<div class="sideNav right" id="sideRight" style="display:none"><button class="sideBtn" onclick="next()" aria-label="다음">›</button></div>

<!-- 이메일 모달 -->
<div class="modal-backdrop" id="emailModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>이메일로 결과 보내기</h3>
    <div class="row">
      <label>받는 사람 이메일</label>
      <input type="email" id="emailTo" placeholder="example@email.com">
    </div>
    <div class="row">
      <label>제목</label>
      <input type="text" id="emailSubject" value="">
    </div>
    <div class="actions">
      <button class="btn-ghost" id="emailCancel">취소</button>
      <button class="btn btn-accent" id="emailSend">보내기</button>
    </div>
    <div class="small muted" id="emailMsg" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* ===== 상수 ===== */
const APP_TITLE='바른미술학원 · 미술적성테스트 V1. BASIC';
const SHEET_ID='14VLQBhDJtduxjCnfr7VEOstZ5ez8-CX3ArXy1OvYCQg';
const GVIZ_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Questions&tqx=out:json`;
const FORM_ACTION='https://docs.google.com/forms/d/e/1FAIpQLSeRWq5YKN50zL0simiaQA6EBRsn6VXN__ZmLplAgDz1I1hyQA/formResponse';
const EMAIL_FUNCTION_URL='/.netlify/functions/send-email';

/* Google Form 항목 매핑 */
const F={child_name:'entry.684468179',age:'entry.1066070471',grade:'entry.1812672802',guardian:'entry.1666083184',phone:'entry.89824848',campus:'entry.490719219',answers:'entry.85364862',scores:'entry.1455508168',top3:'entry.2120338430',resultId:'entry.532514127',timestamp:'entry.1261684833'};

const ASSET_BASE='/img';
const DOMAINS=["관찰력","색감각","서사력","공간감","디테일","도전성","소통력","꾸준성"];
const STEPS=[
  {key:'start',label:'시작'},
  {key:'consent',label:'동의'},
  {key:'profile',label:'프로필'},
  {key:'test',label:'테스트'},
  {key:'result',label:'결과'},
  {key:'details',label:'자세한 결과'}
];
const STATE={step:'start',consent:false,profile:{},questions:[],idx:0,answers:[],result:null};

const $=id=>document.getElementById(id);
const app=()=>$('app');

/* ===== 가중치 보강기 ===== */
function boostAllWeights(w){
  const out={};
  const base=0.22; // 모든 영역 기본치 (낮게 나오지 않도록)
  DOMAINS.forEach(d=>out[d]=base);
  Object.entries(w||{}).forEach(([k,v])=>{
    const val=Math.max(0,Number(v)||0);
    let bonus=0;
    if(val>=0.9) bonus=0.35;
    else if(val>=0.7) bonus=0.28;
    else if(val>=0.5) bonus=0.20;
    else if(val>0)  bonus=0.12;
    out[k]=Math.min(1.5, base + val*1.10 + bonus);
  });
  return out;
}

/* ===== 결과 표시용 대비 강화(그래프 전용) =====
   내부 저장(scores)은 기존 로직 유지, 차트/막대/진행바에만 적용 */
function enhanceScoresDisplay(scores, contrast=1.3){
  const keys=Object.keys(scores||{});
  if(!keys.length) return {};
  const vals=keys.map(k=>scores[k]);
  const m=vals.reduce((a,b)=>a+b,0)/vals.length;
  const out={};
  for(const k of keys){
    let v=scores[k];                // 0..4
    let e=m + (v - m) * contrast;   // 평균 중심 확대
    e=Math.max(0, Math.min(4, e));  // 0..4 클램프
    out[k]=+e.toFixed(2);
  }
  return out;
}

/* NAV + Progress */
function renderNav(){
  const cur=STEPS.findIndex(s=>s.key===STATE.step);
  $('topnav').innerHTML=STEPS.map((s,i)=>`<div class="step ${s.key===STATE.step?'active':''} ${cur>i?'done':''}" onclick="navGo('${s.key}')"><span class="num">${i+1}</span><span>${s.label}</span></div>`).join('');
}
function updateTopProgress(){
  const topbar=$('topbar'); const toplabel=$('toplabel'); const tp=$('topprogress'); const status=$('statusline');
  if(STATE.step==='test'&&STATE.questions.length){
    status.style.display='none';
    const total=STATE.questions.length;
    const curIndex=STATE.idx+1;
    const pct=Math.max(0, Math.min(100, Math.round((STATE.idx)/total*100)));
    topbar.style.width=pct+'%';
    toplabel.textContent=`(${curIndex}/${total})`;
    tp.style.setProperty('--steps', String(total));
    $('sideLeft').style.display='block';
    $('sideRight').style.display='block';
    return;
  }
  $('sideLeft').style.display='none';
  $('sideRight').style.display='none';
  toplabel.textContent='';
  status.style.display='block';
  let pct=(STEPS.findIndex(s=>s.key===STATE.step))/(STEPS.length-1)*100;
  topbar.style.width=Math.round(pct)+'%';
  $('statusline').textContent=`진행률 ${Math.round(pct)}%`;
}
function navGo(step){STATE.step=step;if(step==='test'&&STATE.questions.length===0){startTest();return;}render();}

/* GViz 파서 */
function parseGViz(text){const s=text.indexOf('{'),e=text.lastIndexOf('}');if(s<0||e<0)return[];const obj=JSON.parse(text.slice(s,e+1));const cols=obj.table.cols.map(c=>c.label);return obj.table.rows.map(r=>r.c.map(c=>c?(c.f??c.v):'')).map(a=>Object.fromEntries(cols.map((k,i)=>[k,a[i]])))}
async function loadQuestions(){
  try{
    const txt=await(await fetch(GVIZ_URL)).text();
    const rows=parseGViz(txt)||[];
    const act=rows.filter(r=>String(r.active).toUpperCase()==='TRUE').sort((a,b)=>(+a.order-+b.order));
    if(act.length){
      STATE.questions=act.map(r=>{
        const mkWeights=k=>{
          try{
            const raw=JSON.parse(r[`${k}_weights`])||{};
            return boostAllWeights(raw);
          }catch{return boostAllWeights({})}
        };
        const mkOpt=k=>({key:k,label:(r[`${k}_label`]||'').trim(),imageUrl:(r[`${k}_image`]||'').trim(),weights:mkWeights(k)});
        const opts=['A','B','C','D'].map(mkOpt).filter(o=>{
          const hasLabel=o.label.length>0;const hasImage=o.imageUrl.length>0;
          return hasLabel||hasImage;
        });
        const safeOpts=opts.length>=2?opts:['A','B'].map(mkOpt);
        return{id:r.id||`q${r.order}`,order:+r.order,prompt:r.prompt||'',options:safeOpts};
      });
      return;
    }
  }catch(e){}
  STATE.questions=localQuestions();
}

/* 시작 화면 */
function startScreen(){
  return `
    <div class="hero">
      <div class="title center">${APP_TITLE}</div>
      <div class="sub center">아이의 미술 적성과 잠재력을 간단히 확인하고, 바로 결과를 저장·이메일 전송할 수 있어요.</div>
      <div class="ctaRow">
        <button class="btn btn-xl" id="startBtn">테스트 시작하기 →</button>
        <a class="btn-ghost btn-xl" href="index2.html" style="text-decoration:none">ADVANCE 테스트</a>
      </div>
    </div>
    <section class="features" style="margin:20px auto 8px;max-width:980px">
      <h2 style="text-align:center;font-weight:900">테스트 특징</h2>
      <p class="sub" style="text-align:center;color:#6b7280;margin:0 0 16px">아이의 미술 흥미·성향을 파악해 도움 되는 교육 포인트를 제시합니다</p>
      <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:14px">
        <div class="card" style="display:flex;align-items:center;gap:12px"><div class="badge" style="font-size:19px">⏱</div><div><b>빠른 테스트</b><div class="small muted">5–8분 내 완료</div></div></div>
        <div class="card" style="display:flex;align-items:center;gap:12px"><div class="badge" style="font-size:19px">🎯</div><div><b>맞춤 분석</b><div class="small muted">강점/교육 포인트</div></div></div>
        <div class="card" style="display:flex;align-items:center;gap:12px"><div class="badge" style="font-size:19px">⚡</div><div><b>즉시 결과</b><div class="small muted">저장/이메일 전송</div></div></div>
      </div>
      <div class="small muted center" style="margin-top:12px">※ 본 테스트는 <b>교육 가이드</b> 목적이며, 의학/임상 진단이 아닙니다.</div>
    </section>`;
}
function viewStart(){app().innerHTML=startScreen();$('startBtn').onclick=()=>navGo('consent');window.scrollTo({top:0,behavior:'smooth'})}

/* 동의서 */
function accItem(t,html){return `<div class="acc-item"><div class="acc-head"><span>${t}</span><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div class="acc-body small">${html}</div></div>`}
function viewConsent(){
  app().innerHTML=`<h2 class="center">개인정보 수집·이용 동의서</h2>
  <div class="acc">
    ${accItem('<b>1) 목적</b>','① 테스트 제공 및 결과 산출 ② 결과 안내·PDF 저장 지원 ③ 상담 품질 개선')}
    ${accItem('<b>2) 수집 항목</b>','아동 이름·나이·학년 / 보호자 이름·연락처 / 응답 내용 (이메일은 선택)')}
    ${accItem('<b>3) 보관 기간</b>','수집일로부터 <b>12개월</b> 보관 후 파기')}
    ${accItem('<b>4) 보관/처리</b>','Google Forms/Sheets에 저장·처리')}
    ${accItem('<b>5) 권리</b>','동의 거부 가능(거부 시 서비스 제한 가능)')}
    ${accItem('<b>6) 문의</b>','barunart1004@gmail.com')}
  </div>
  <div class="section" style="margin-top:16px">
    <div class="agreeList">
      <div class="agree-row"><div class="txt">(필수) 개인정보 수집·이용에 <b>동의합니다.</b></div><input type="checkbox" id="chk_required" /></div>
      <div class="agree-row"><div class="txt">(필수) 만 14세 미만 아동의 법정대리인으로서 <b>동의합니다.</b></div><input type="checkbox" id="chk_minor" /></div>
    </div>
  </div>
  <div class="center" style="margin-top:16px;display:flex;gap:8px;justify-content:center">
    <button class="btn" id="btn_consent" disabled>동의하고 진행</button>
    <button class="btn-ghost" id="btn_expand">전문 펼치기</button>
    <button class="btn-ghost" id="btn_collapse">모두 접기</button>
  </div>`;
  const validate=()=>{$('btn_consent').disabled=!( $('chk_required').checked && $('chk_minor').checked )};
  $('chk_required').addEventListener('change',validate);$('chk_minor').addEventListener('change',validate);
  $('btn_consent').onclick=()=>{STATE.consent=true;navGo('profile')};
  $('btn_expand').onclick=()=>document.querySelectorAll('.acc-item').forEach(it=>it.classList.add('open'));
  $('btn_collapse').onclick=()=>document.querySelectorAll('.acc-item').forEach(it=>it.classList.remove('open'));
  document.querySelectorAll('.acc-head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
}

/* 프로필 */
const AGE_TO_GRADE={7:'초등학교 1학년',8:'초등학교 2학년',9:'초등학교 3학년',10:'초등학교 4학년',11:'초등학교 5학년',12:'초등학교 6학년'};
const GRADE_TO_AGE=Object.fromEntries(Object.entries(AGE_TO_GRADE).map(([a,g])=>[g,a]));
const CAMPUSES=['압구정[본원]','반포 캠퍼스','한남 캠퍼스','방배 캠퍼스','목동 캠퍼스','송파 캠퍼스','서대문 캠퍼스','일산 캠퍼스','탄현 캠퍼스','김포 캠퍼스','송도 캠퍼스','부산 캠퍼스'];

function viewProfile(){
  app().innerHTML=`<h2 class="center">프로필 정보</h2>
  <div class="grid grid-4" style="margin-top:8px">
    <div class="section"><label>아동 이름</label><input id="cname" placeholder="예: 홍길동"></div>
    <div class="section"><label>보호자 이름</label><input id="gname" placeholder="예: 김보호자"></div>
    <div class="section"><label>나이</label><select id="age">${[7,8,9,10,11,12].map(a=>`<option value="${a}">${a}</option>`).join('')}</select></div>
    <div class="section"><label>학년</label><select id="grade">${Object.values(AGE_TO_GRADE).map(g=>`<option>${g}</option>`).join('')}</select></div>
    <div class="section"><label>연락처</label><input id="phone" placeholder="010-0000-0000"></div>
    <div class="section"><label>이메일(선택, 결과지 전송용)</label><input id="email" placeholder="example@email.com"></div>
    <div class="section"><label>캠퍼스</label><select id="campus">${CAMPUSES.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>
  </div>
  <div class="center" style="margin-top:16px"><button class="btn btn-mint" id="btn_starttest">테스트 시작</button></div>`;
  $('age').addEventListener('change',e=>{$('grade').value=AGE_TO_GRADE[e.target.value]});
  $('grade').addEventListener('change',e=>{$('age').value=GRADE_TO_AGE[e.target.value]});
  $('btn_starttest').onclick=startTest;
}
async function startTest(){
  STATE.profile={child_name:$('cname').value.trim(),guardian:$('gname').value.trim(),age:$('age').value,grade:$('grade').value,phone:$('phone').value.trim(),email:$('email').value.trim(),campus:$('campus').value};
  if(!STATE.profile.child_name){alert('아동 이름을 입력해 주세요');return;}
  if(!/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(STATE.profile.phone||'')){alert('연락처 형식(010-0000-0000)을 확인해 주세요');return;}
  await loadQuestions();STATE.idx=0;STATE.answers=[];STATE.step='test';render();
}

/* 테스트 */
function pcGridClassFor(n){if(window.matchMedia('(min-width:1024px)').matches){return n===2?'test-grid-2':'test-grid-4'}return'grid grid-2'}
function optionImageUrl(q,o){if(o.imageUrl)return o.imageUrl;const num=Number(q.order)||(STATE.idx+1);return `${ASSET_BASE}/${num}-${o.key}.png`}
function viewTest(){
  const q=STATE.questions[STATE.idx];if(!q){app().innerHTML='<h3 class="center">문항을 불러오지 못했습니다. 관리자에 문의해 주세요.</h3>';return;}
  const gridCls=pcGridClassFor(q.options.length);
  app().innerHTML=`<div class="center small muted"><span class="chip">Q ${STATE.idx+1} / ${STATE.questions.length}</span></div>
    <h2 class="center" style="margin-top:10px">${q.prompt||''}</h2>
    <div class="${gridCls}" style="margin-top:12px">
      ${q.options.map(o=>`<div class="opt" id="opt_${o.key}" tabindex="0" role="button" aria-label="${o.label||o.key}" data-key="${o.key}">
        <div class="thumb"><img src="${optionImageUrl(q,o)}" alt="${o.label||o.key}" onerror="this.style.opacity=.2" loading="lazy"></div>
        <div class="cap center">${o.label||o.key}</div>
      </div>`).join('')}
    </div>
    <div class="center" style="margin-top:18px;display:flex;gap:10px;justify-content:center">
      <button class="btn-ghost" id="btn_prev" ${STATE.idx===0?'disabled':''}>이전</button>
      <button class="btn" id="btn_next" disabled>다음</button>
    </div>`;
  q.options.forEach(o=>{const el=document.getElementById(`opt_${o.key}`);el.onclick=()=>choose(o.key);el.onkeydown=e=>{if(e.key==='Enter'||e.key===' ')choose(o.key)}});
  $('btn_prev').onclick=prev;$('btn_next').onclick=next;
}
function choose(key){
  const q=STATE.questions[STATE.idx];
  q.options.forEach(k=>{const n=document.getElementById(`opt_${k.key}`);if(n)n.classList.remove('sel')});
  const node=document.getElementById(`opt_${key}`);if(node){node.classList.add('sel');node.animate([{transform:'scale(1)'},{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:160})}
  const opt=q.options.find(o=>o.key===key);STATE.answers[STATE.idx]={qid:q.id,key,weights:opt.weights||{}};$('btn_next').disabled=false;
}
function next(){if(STATE.step!=='test')return;if(!STATE.answers[STATE.idx]){alert('하나를 선택해 주세요');return;}if(STATE.idx<STATE.questions.length-1){STATE.idx++;render();}else{submitAllSafe();}}
function prev(){if(STATE.idx>0){STATE.idx--;render();}}
document.addEventListener('keydown',e=>{if(STATE.step!=='test')return;if(e.key==='ArrowRight')next();if(e.key==='ArrowLeft')prev();if(e.key==='Enter'){if(!$('btn_next').disabled)next();}});

/* 점수/멘트(숫자·등급 비공개) */
function aggregateScores(ans){
  const sum={};DOMAINS.forEach(d=>sum[d]=0);
  ans.forEach(a=>Object.entries(a.weights||{}).forEach(([k,v])=>sum[k]=(sum[k]||0)+Number(v||0)));
  const n=ans.length||1;
  const raw={};DOMAINS.forEach(d=>{const v=(sum[d]||0)/n*4;raw[d]=Math.max(0,Math.round(v*10)/10)});
  return raw;
}
const adjust=v=>Math.round((2+v/2)*10)/10; // 내부 저장용만 사용(기존 유지)

/* 영역별 설명 + 칭찬(비등급) */
const DETAIL={
  '관찰력':n=>`${n}님은 대상의 구조를 파악하고 작은 변화를 포착하는 힘이 좋아요. 반복 관찰 후 표현으로 이어지는 과정이 매끄럽고, 묘사할 때 핵심을 빠르게 찾는 편입니다.`,
  '색감각':n=>`${n}님은 색의 온도·채도를 읽고 조합하는 감각이 자연스럽습니다. 분위기를 색으로 전환하는 과정이 안정적이며, 대비·조화에 대한 판단이 빠릅니다.`,
  '서사력':n=>`${n}님은 장면에 이야기를 심고 인물·배경·사건을 연결하는 능력이 좋습니다. 감정의 결을 이해하고 장면 전개를 설득력 있게 구성합니다.`,
  '공간감':n=>`${n}님은 비율·원근·스케일을 다루는 과정이 안정적이에요. 화면 속 깊이와 무게를 조절해 입체적인 장면을 만들 줄 압니다.`,
  '디테일':n=>`${n}님은 질감·마감 등 작은 요소에 집중하여 완성도를 끌어올립니다. 계획적으로 수정하고 마무리 단계까지 힘이 이어집니다.`,
  '도전성':n=>`${n}님은 새로운 도구·기법에 거침이 적고 실험을 즐깁니다. 예상치 못한 결과를 학습으로 연결하는 태도가 좋아 성장 속도가 빠릅니다.`,
  '소통력':n=>`${n}님은 작품의 의도를 말과 시각 언어로 풀어내는 능력이 좋아요. 피드백을 정리해 다음 작업에 반영하는 과정이 매끄럽습니다.`,
  '꾸준성':n=>`${n}님은 루틴을 유지하고 완성까지 밀어붙이는 힘이 돋보여요. 일정한 작업량을 확보하는 데 강점이 있습니다.`
};
function praiseMessage(v){
  if(v>=3.2) return '이 영역의 강점이 분명해요. 난이도 있는 과제에서도 흐름이 안정적으로 유지됩니다.';
  if(v>=2.6) return '기반이 탄탄합니다. 활동량을 늘리면 성취가 빠르게 올라갑니다.';
  return '기초가 형성되는 단계예요. 짧고 반복적인 경험을 통해 감각을 빠르게 끌어올릴 수 있어요.';
}

/* 제출 & 결과 */
function nowKST(){const d=new Date(),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())} KST`}
async function submitAllSafe(){
  const raw=aggregateScores(STATE.answers);
  const scores=Object.fromEntries(Object.entries(raw).map(([k,v])=>[k,adjust(v)])); // 내부 저장용 유지
  const top3=Object.keys(scores).sort((a,b)=>scores[b]-scores[a]).slice(0,3);
  const resultId=crypto.randomUUID();
  const form=new FormData();
  form.append(F.child_name,STATE.profile.child_name);form.append(F.age,STATE.profile.age);form.append(F.grade,STATE.profile.grade);
  form.append(F.guardian,STATE.profile.guardian);form.append(F.phone,STATE.profile.phone);form.append(F.campus,STATE.profile.campus||'');
  form.append(F.answers,JSON.stringify({profile:STATE.profile,questions:STATE.answers,top3}));
  form.append(F.scores,JSON.stringify(scores));form.append(F.top3,top3.join(','));form.append(F.resultId,resultId);form.append(F.timestamp,nowKST());
  try{await fetch(FORM_ACTION,{method:'POST',mode:'no-cors',body:form});}catch(e){}
  STATE.result={scores,scoresRaw:raw,top3,resultId};STATE.step='result';render();
}

let CHARTS=[];function destroyCharts(){CHARTS.forEach(c=>c.destroy?.());CHARTS=[]}

/* 결과 */
function viewResult(){
  const r=STATE.result,s=r?.scores||{}; // 내부 점수(저장용)
  const disp=enhanceScoresDisplay(s, 1.3); // 그래프 표시용 대비 강화
  const ordered=Object.keys(disp).sort((a,b)=>disp[b]-disp[a]); // 시각화 기준
  const top4=ordered.slice(0,4);
  const next4=ordered.slice(4,8);

  const longSummary=[
    `${STATE.profile.child_name}님은 <b>${top4[0]}</b>를 중심으로 <b>${top4[1]}</b>, <b>${top4[2]}</b>에서 강점이 잘 드러납니다.`,
    `선택 과정에서 주의집중이 안정적이고, 과제의 핵심을 빠르게 파악하는 경향이 보여 학습 효율이 높습니다.`
  ].join(' ');

  app().innerHTML=`<div id="pdfArea" class="pdf-screen-width">
    <div class="block callout" style="text-align:center">
      <div class="chip" style="margin:0 auto 8px;display:inline-block">테스트 완료</div>
      <h2 style="margin:0 0 10px"><b>${STATE.profile.child_name}</b>님, 멋진 집중력이었습니다!</h2>
      <div class="chips" style="margin-top:10px;justify-content:center">${top4.slice(0,3).map(t=>`<span class="chip">뛰어난 영역: ${t}</span>`).join('')}</div>
    </div>

    <div class="block">
      <h3 class="center">프로파일 & 주요 지표</h3>
      <div class="result-grid" style="margin-top:8px">
        <div>
          <p class="chartCaption center">전 영역 프로파일</p>
          <div class="chartBox"><canvas id="radar" height="200"></canvas></div>
        </div>
        <div class="result-right">
          <div>
            <p class="chartCaption center">뛰어난 영역 (TOP4)</p>
            <div class="chartBox"><canvas id="barsTop4" height="200"></canvas></div>
          </div>
          <div>
            <p class="chartCaption center">잠재적인 영역</p>
            <div class="chartBox"><canvas id="barsNext" height="200"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <div class="block"><h3>총평</h3><p style="color:#0f172a;font-size:16px;line-height:1.8">${longSummary}</p></div>

    <div class="block"><h3>항목별 해석</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        ${DOMAINS.map(k=>{
          const vText = +(s[k]||0);          // 텍스트/멘트는 내부 점수 기준
          const vDisp = +(disp[k]||0);       // 그래프/게이지는 표시용 대비 강화
          const w = Math.min(100,(vDisp/4)*100);
          return `
            <div style="border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff;box-shadow:0 10px 26px rgba(16,24,40,.06)">
              <div style="font-weight:900;margin-bottom:8px">${k}</div>
              <div class="topprogress" style="height:10px;margin:8px 0 12px" aria-label="${k} 진행도">
                <div style="width:${w}%;height:100%;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE)"></div>
              </div>
              <div class="small" style="color:#0f172a">${DETAIL[k](STATE.profile.child_name)}</div>
              <div class="small" style="margin-top:6px;color:#0f172a">${praiseMessage(vText)}</div>
            </div>`;
        }).join('')}
      </div>
    </div>
  </div>

  <div class="center no-pdf" style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button class="btn-ghost" onclick="STATE.step='start'; render()">처음으로</button>
    <button class="btn btn-mint" id="btn_pdf">PDF 저장</button>
    <button class="btn btn-accent" id="btn_email">이메일로 보내기</button>
    <button class="btn-ghost" onclick="STATE.step='details'; render()">자세한 결과 보기</button>
  </div>`;

  destroyCharts();

  const rctx=document.getElementById('radar').getContext('2d',{willReadFrequently:true});
  CHARTS.push(new Chart(rctx,{type:'radar',
    data:{labels:DOMAINS,datasets:[{data:DOMAINS.map(k=>disp[k]||0),borderColor:'#FFB98A',backgroundColor:'rgba(255,185,138,.22)',borderWidth:2,pointRadius:3,fill:true}]},
    options:{maintainAspectRatio:false,animation:{duration:800},scales:{r:{suggestedMin:0,suggestedMax:4,ticks:{display:false},grid:{color:'#eef2f7'},angleLines:{color:'#eef2f7'}}},plugins:{legend:{display:false}}}
  }));

  const b1=document.getElementById('barsTop4').getContext('2d',{willReadFrequently:true});
  CHARTS.push(new Chart(b1,{type:'bar',
    data:{labels:top4,datasets:[{data:top4.map(k=>disp[k]||0),borderRadius:12,borderSkipped:false,backgroundColor:['#FFD9BE','#E6E2FF','#CFF7EE','#FFD9BE']}]},
    options:{maintainAspectRatio:false,animation:{duration:700},scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{display:false},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}},plugins:{legend:{display:false}}}
  }));

  const b2=document.getElementById('barsNext').getContext('2d',{willReadFrequently:true});
  CHARTS.push(new Chart(b2,{type:'bar',
    data:{labels:next4,datasets:[{data:next4.map(k=>disp[k]||0),borderRadius:12,borderSkipped:false,backgroundColor:['#E6E2FF','#CFF7EE','#FFD9BE','#E6E2FF']}]},
    options:{maintainAspectRatio:false,animation:{duration:700},scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{display:false},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}},plugins:{legend:{display:false}}}
  }));

  $('btn_pdf').onclick=handleSavePdf;$('btn_email').onclick=openEmailModal;
}

/* 자세한 결과 – 이론/전문가/발달방향 */
const THEORY={
  '색감각':{theoryTitle:'Itten의 색채이론',
    theory:'색상·명도·채도의 상호작용을 지각하고 상황에 맞게 조합하는 능력입니다. 서로 다른 색의 대비가 주는 심리·환경적 효과를 이해하고, 색의 온도감과 채도 조절을 통해 장면의 분위기를 설계합니다. 반복 노출로 형성된 시각 기억이 팔레트 선택의 일관성을 높입니다.',
    expert:'색을 통해 감정·시간·기후를 설명하는 방식이 자연스럽습니다. 선호 팔레트가 명확해 작품 간 톤의 통일성이 보이고, 강한 대비도 어색하지 않게 통제합니다. 관찰한 색을 단순히 복제하지 않고 의도에 맞게 변환하는 점이 인상적입니다.',
    direction:'색상환 기반의 유사·보색 조합 실험을 주기적으로 진행해 보세요. 주변광 환경을 바꿔가며 사진과 실제 관찰을 교차 적용하면 색의 체감이 더 선명해집니다. 중명도·중채 영역에서 미세한 차이를 구분하는 훈련이 전체 완성도를 끌어올립니다.'},
  '디테일':{theoryTitle:'몰입과 실행 기능',
    theory:'작업 기억과 주의 조절이 결합되어 세부요소를 오래 유지하는 특성입니다. 미세 단위의 패턴을 인식하고 재현하는 과정에서 절차적 기억이 강화되며, 계획-검토-수정 사이클이 자연스러운 루틴으로 형성됩니다.',
    expert:'질감·마감 단계에서 힘이 빠지지 않고 마지막까지 집중이 유지됩니다. 도구 사용법을 빠르게 체득하고, 작은 오류를 발견하면 즉시 교정하는 편입니다. 작업 시간이 길어도 산만해지지 않아 결과물의 일관성이 높습니다.',
    direction:'관찰 스케치에 시간 제한을 주고, 이후 마감 전용 세션을 따로 두면 효율이 좋아집니다. 동일 대상을 다른 재질로 재해석하는 연습(금속·유리·천 등)이 표현 라이브러리를 확장합니다.'},
  '서사력':{theoryTitle:'서사적 사고와 시각언어',
    theory:'사건의 인과와 감정선을 구성해 장면으로 번역하는 능력입니다. 인물의 동기·관계를 상상하여 장면 간 연결을 만드는 데 강점이 있으며, 기호·메타포를 활용해 함축적 의미를 전달합니다.',
    expert:'짧은 설정에도 동기가 살아 있어 보는 사람이 이야기 흐름을 쉽게 따라갑니다. 프레임 안에서 시선 이동 경로를 설계하려는 시도가 보이며, 제목·대사 선택도 장면의 정서를 잘 지탱합니다.',
    direction:'3컷(도입-전개-전환) 스토리보드로 장면 전개를 압축해 보세요. 같은 사건을 정서 톤만 바꿔 재연출하는 훈련이 표현의 폭을 넓힙니다.'},
  '공간감':{theoryTitle:'지각심리와 원근',
    theory:'상대 크기·거리·각도를 통합해 2D 화면에 3D 인상을 만드는 능력입니다. 좌표계 상에서 요소를 배치하는 동안 시선의 리듬과 무게중심을 조절하여 안정감을 만듭니다.',
    expert:'형태의 틀을 먼저 잡고 디테일을 얹는 순서를 선호해 완성 과정이 흔들리지 않습니다. 구도 변화에 대한 적응이 빠르며, 과감한 크롭도 안정적으로 처리합니다.',
    direction:'박스 드로잉과 소실점 드릴을 짧게 자주 반복하세요. 실제 소품을 다양한 높이에서 촬영해 관찰-전환을 번갈아 하면 공간 해상도가 빨라집니다.'},
  '관찰력':{theoryTitle:'게슈탈트와 특징 포착',
    theory:'전체-부분을 오가며 차이를 감지하고 특징을 추출하는 능력입니다. 실루엣, 경계, 반복 규칙을 빠르게 감지해 핵심 형태를 안정적으로 기록합니다.',
    expert:'대상의 핵심을 빠르게 요약하고, 필요 없는 요소는 과감히 덜어냅니다. 실제와 상상 사이를 오가며 변형하는 능력도 좋아 창작으로의 전환이 자연스럽습니다.',
    direction:'광원 변화를 의도적으로 바꿔가며 같은 대상을 스케치하세요. 확대 관찰(크롭) 후 원화에 다시 통합하는 훈련이 변형 능력을 키웁니다.'},
  '도전성':{theoryTitle:'성장 마인드셋',
    theory:'새로운 시도에 대한 심리적 개방성과 실패를 학습으로 환원하는 태도입니다. 탐색 단계에서의 불확실성을 견디며, 결과보다 발견에 초점을 맞춥니다.',
    expert:'재료·방식의 전환을 두려워하지 않아 실험이 자연스럽습니다. 예상 밖의 흔적을 의도적으로 살려 작품으로 끌고 가는 능력이 돋보입니다.',
    direction:'낯선 도구 하나를 정해 3회 연속 실험 후, 가장 흥미로운 우발적 결과를 확장해 보세요. 리메이크 과제가 특히 효과적입니다.'},
  '소통력':{theoryTitle:'비주얼 리터러시',
    theory:'시각 요소를 언어와 연결해 의미를 전달하는 능력입니다. 맥락·의도를 설명할 수 있어 피드백 순환이 빠르고, 협업에서 역할 조정이 수월합니다.',
    expert:'작가노트가 간결하며 핵심을 놓치지 않습니다. 질문을 통해 타인의 관점을 끌어내는 능력도 좋아 비평 시간이 생산적입니다.',
    direction:'작업 후 “의도-선택-결과” 3문장을 습관처럼 정리하세요. 제목 3안 만들기는 메시지 선명도를 높여줍니다.'},
  '꾸준성':{theoryTitle:'자기조절 학습',
    theory:'계획-실행-점검의 루틴을 반복해 학습량을 유지하는 능력입니다. 완성 경험이 자주 쌓여 자기효능감이 상승합니다.',
    expert:'긴 작업에서도 에너지가 일정하게 유지됩니다. 중단 후 재개가 빨라 누적 결과물이 꾸준히 늘어납니다.',
    direction:'15~20분 짧은 세션을 자주 누적하세요. 진행 사진을 기록하면 동기 유지에 큰 도움이 됩니다.'}
};
function theoryItem(i,key){
  const t=THEORY[key]||{theoryTitle:'이론',theory:'-',expert:'-',direction:'-'};
  return `<div class="theoryWrap">
    <div style="font-weight:900;margin-bottom:8px">${i}. ${key} <span class="tchip">강점 영역</span></div>
    <div class="tgrid">
      <div class="tcard hint"><div style="font-weight:900;margin-bottom:6px">📍 이론적 근거</div>${t.theory}</div>
      <div class="tcard"><div style="font-weight:900;margin-bottom:6px">🧑‍🏫 전문가 의견</div>${t.expert}</div>
      <div class="tcard"><div style="font-weight:900;margin-bottom:6px">🡅 발달 방향</div>${t.direction}</div>
    </div>
  </div>`;
}
function viewDetails(){
  const r=STATE.result,s=r?.scores||{};const ordered=Object.keys(s).sort((a,b)=>s[b]-s[a]);
  const T=ordered.slice(0,3);
  const topBlocks=T.map((k,i)=>theoryItem(i+1,k)).join('');
  const overview=`<b>${STATE.profile.child_name}</b>(${STATE.profile.age}세, ${STATE.profile.grade}) 아동은 <b>${T[0]||'-'}</b>를 중심으로 <b>${T[1]||'-'}</b>, <b>${T[2]||'-'}</b>에서 강점이 확인됩니다.`;

  app().innerHTML=`<div class="detail-hero"><div class="ic">📘</div><div class="detail-title">전문가 평가 및 이론적 배경</div></div><p class="detail-sub"><b>${STATE.profile.child_name}</b>의 미술적성 심화 분석 보고서</p>
  <div class="block" style="background:#f5f8ff;border-color:#e6eeff">
    <div style="font-weight:900;margin-bottom:6px;display:flex;align-items:center;gap:8px">🧩 강점 영역 이론적 배경 분석</div>
    ${topBlocks}
  </div>

  <div class="block" style="margin-top:14px">
    <div style="font-weight:900;margin-bottom:10px;display:flex;align-items:center;gap:8px">🧠 종합 전문가 소견</div>
    <div class="small" style="line-height:1.8">${overview} 학습 루틴과 실험적 과제를 균형 있게 배치하면 성장 곡선이 가장 가파르게 올라옵니다. 강점을 발판으로 삼아 약점을 보완하는 통합형 활동(관찰·디테일·공간)을 병행하는 것이 좋습니다.</div>
  </div>

  <div class="reserve">
    <div style="display:flex;align-items:center;gap:8px;justify-content:center">
      <div class="badge" style="width:36px;height:36px;display:grid;place-items:center;border-radius:999px;font-size:18px">🗓</div>
      <div class="title">전문가 방문 상담 예약</div>
    </div>
    <div class="small" style="margin-top:6px">테스트 결과 기반 <b>맞춤 교육 계획</b>과 <b>포트폴리오</b> 진단을 제공합니다.</div>
    <div class="items">
      <div class="pill"><div class="pt">전문가 진단</div><div class="small muted">미술교육 전문가의 1:1 개별 진단</div></div>
      <div class="pill"><div class="pt">맞춤 계획</div><div class="small muted">특성에 맞는 교육 로드맵 제시</div></div>
      <div class="pill"><div class="pt">주기적 관리</div><div class="small muted">3개월마다 발전상황 점검</div></div>
    </div>
    <button class="btn btn-mint no-pdf" onclick="alert('상담 예약은 곧 준비됩니다!')">상담 예약하기</button>
    <div class="note">상담료: 무료 | 소요시간: 60분</div>
  </div>

  <div class="center no-pdf" style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button class="btn-ghost" onclick="STATE.step='result'; render()">결과로 돌아가기</button>
    <button class="btn" onclick="STATE.step='start'; render()">처음으로</button>
  </div>`;
}

/* PDF/이메일 */
function buildPdfWrapperFrom(node){
  const wrap=document.createElement('div');
  wrap.style.position='fixed';wrap.style.left='-10000px';wrap.style.top='0';
  wrap.style.width='794px';wrap.style.background='#fff';wrap.style.zIndex='-1';
  const clone=node.cloneNode(true);
  clone.querySelectorAll('img').forEach(img=>{
    img.setAttribute('crossorigin','anonymous'); img.referrerPolicy='no-referrer'; img.src=img.src;
  });
  const srcC=node.querySelectorAll('canvas');const dstC=clone.querySelectorAll('canvas');
  srcC.forEach((src,i)=>{const dst=dstC[i];if(!dst)return;dst.width=src.width;dst.height=src.height;dst.getContext('2d',{willReadFrequently:true}).drawImage(src,0,0)});
  wrap.appendChild(clone);document.body.appendChild(wrap);
  return wrap;
}
function waitForAssets(root){
  const imgs=[...root.querySelectorAll('img')];
  const imgPromises=imgs.map(img=>img.complete?Promise.resolve():new Promise(res=>{img.onload=()=>res();img.onerror=()=>res()}));
  const fontsReady=('fonts'in document)?document.fonts.ready:Promise.resolve();
  return Promise.all([fontsReady,...imgPromises]);
}
async function html2pdfBlob(wrapper){
  const opt={margin:[8,8,8,8],
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff',removeContainer:true,windowWidth:wrapper.scrollWidth,windowHeight:wrapper.scrollHeight},
    pagebreak:{mode:['css','legacy']},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
  return await html2pdf().set(opt).from(wrapper).output('blob');
}
async function canvasSlicerBlob(wrapper){
  const h2c=window.html2canvas;
  const canvas=await h2c(wrapper,{scale:2,useCORS:true,allowTaint:true,backgroundColor:'#ffffff',scrollX:0,scrollY:0,windowWidth:wrapper.scrollWidth,windowHeight:wrapper.scrollHeight});
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const pxToMm=210/canvas.width;
  const pageHeightPx=Math.floor(297/pxToMm);
  let y=0,page=0;
  while(y<canvas.height){
    const sliceHeight=Math.min(pageHeightPx,canvas.height-y);
    const pageCanvas=document.createElement('canvas');
    pageCanvas.width=canvas.width;pageCanvas.height=sliceHeight;
    const ctx=pageCanvas.getContext('2d',{willReadFrequently:true});
    ctx.drawImage(canvas,0,y,canvas.width,sliceHeight,0,0,canvas.width,sliceHeight);
    const img=pageCanvas.toDataURL('image/jpeg',0.98);
    const mmHeight=sliceHeight*pxToMm;
    if(page>0) pdf.addPage();
    pdf.addImage(img,'JPEG',0,0,210,mmHeight);
    y+=sliceHeight;page++;
  }
  return pdf.output('blob');
}
async function exportPdfBlob(node){
  const wrapper=buildPdfWrapperFrom(node);
  await waitForAssets(wrapper);
  try{
    let blob=await html2pdfBlob(wrapper);
    if(!blob || blob.size<5000){blob=await canvasSlicerBlob(wrapper);}
    return blob;
  }catch(e){
    try{ return await canvasSlicerBlob(wrapper); }
    catch(e2){ throw e2; }
  }finally{ wrapper.remove(); }
}
async function handleSavePdf(){
  const node=$('pdfArea')||document.body;
  node.classList.add('pdf-screen-width');
  await new Promise(r=>setTimeout(r,50));
  try{
    const blob=await exportPdfBlob(node);
    const filename=`${STATE.profile.child_name}_미술적성테스트_V1_BASIC.pdf`;
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
  }catch(e){console.error(e);alert('PDF 저장 중 오류가 발생했습니다.')}
  finally{node.classList.remove('pdf-screen-width');}
}

/* 이메일 */
function setModalVisible(show){const m=$('emailModal');if(show){m.classList.add('show');m.setAttribute('aria-hidden','false');document.body.style.overflow='hidden'}else{m.classList.remove('show');m.setAttribute('aria-hidden','true');document.body.style.overflow=''}}
function openEmailModal(){setModalVisible(true);$('emailSubject').value=`${STATE.profile.child_name} 테스트 결과입니다`;$('emailTo').value=STATE.profile.email||'';$('emailMsg').textContent=''}
$('emailCancel').onclick=()=>setModalVisible(false);document.addEventListener('keydown',e=>{if(e.key==='Escape')setModalVisible(false)})
function blobToBase64(blob){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onloadend=()=>resolve(reader.result.split(',')[1]);reader.onerror=reject;reader.readAsDataURL(blob)})}
$('emailSend').onclick=async()=>{
  const to=$('emailTo').value.trim();if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(to)){ $('emailMsg').textContent='이메일 형식을 확인해 주세요.'; return; }
  $('emailMsg').textContent='PDF 생성 중...';
  let base64='';try{const blob=await exportPdfBlob($('pdfArea')||document.body);base64=await blobToBase64(blob)}catch(e){$('emailMsg').textContent='PDF 생성에 실패했습니다.';return}
  $('emailMsg').textContent='이메일 전송 중...';
  const subject=$('emailSubject').value.trim()||`${STATE.profile.child_name} 테스트 결과입니다`;
  const htmlBody=`<div style="font-family:Pretendard,Apple SD Gothic Neo,Segoe UI,Arial"><h2 style="margin:0 0 8px">${APP_TITLE}</h2><p><b>${STATE.profile.child_name}</b> 님의 결과지를 첨부했습니다.</p><p>캠퍼스: ${STATE.profile.campus||'-'} / 연락처: ${STATE.profile.phone||'-'}</p><p style="color:#6b7280;font-size:12px;margin-top:12px">본 메일은 자동 발송되었습니다.</p></div>`;
  try{
    const res=await fetch(EMAIL_FUNCTION_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to,subject,html:htmlBody,attachmentName:`${STATE.profile.child_name}_미술적성테스트_V1_BASIC.pdf`,attachmentBase64:base64})});
    const ok=res.ok;const data=await res.json().catch(()=>({}));
    if(ok){$('emailMsg').textContent='전송 완료! 메일함을 확인해 주세요.';setTimeout(()=>setModalVisible(false),1200)}
    else{$('emailMsg').textContent='전송 실패: '+(data.error||res.statusText)}
  }catch(err){$('emailMsg').textContent='전송 중 오류가 발생했습니다.'}
}

/* Router */
function render(){renderNav();updateTopProgress();if(STATE.step==='start')return viewStart();if(STATE.step==='consent')return viewConsent();if(STATE.step==='profile')return viewProfile();if(STATE.step==='test')return viewTest();if(STATE.step==='result')return viewResult();if(STATE.step==='details')return viewDetails()}
render();

/* Fallback 문항 */
function W(w){const o={};DOMAINS.forEach(k=>o[k]=0);Object.entries(w).forEach(([k,v])=>o[k]=v);return boostAllWeights(o)}
function localQuestions(){
  const S=(q,p,a,b,c,d)=>({id:q,order:+q.replace('q',''),prompt:p,options:[{key:'A',label:a[0],imageUrl:a[1],weights:W(a[2])},{key:'B',label:b[0],imageUrl:b[1],weights:W(b[2])},{key:'C',label:c[0],imageUrl:c[1],weights:W(c[2])},{key:'D',label:d[0],imageUrl:d[1],weights:W(d[2])}]});
  const IMG=kw=>`https://images.unsplash.com/photo-150${Math.floor(Math.random()*899+100)}?auto=format&fit=crop&w=900&q=60&${encodeURIComponent(kw)}`;
  return [
    S('q1','새로운 미술 도구를 발견했어요! 무엇을 먼저 해볼까요?',['설명서를 꼼꼼히 읽어본다',IMG('paper'),{디테일:1,꾸준성:0.6}],['종이에 탐색·실험한다',IMG('sketch'),{도전성:1}],['친구들과 아이디어 나눈다',IMG('kids'),{소통력:1,서사력:0.6}],['가장 특이한 결과 상상',IMG('idea'),{도전성:1,서사력:0.5}]),
    S('q2','그림에 어떤 이야기를 담고 싶나요?',['모험 이야기',IMG('adventure'),{서사력:1}],['감정을 색과 형태로',IMG('abstract'),{색감각:0.8,서사력:0.6}],['현실 건물 새로 디자인',IMG('architecture'),{공간감:1,디테일:0.4}],['작은 생명체의 숨은 세계',IMG('mini world'),{관찰력:0.8,서사력:0.6}]),
    S('q3','두 그림 중 색이 더 조화로운 것은?',['조화로운 팔레트',IMG('palette'),{색감각:1}],['대비 강한 팔레트',IMG('contrast'),{도전성:0.6}],['파스텔 편안함',IMG('pastel'),{색감각:0.8}],['강한 보색',IMG('vivid'),{도전성:0.6}]),
    S('q4','그리다 실수를 했어요. 어떻게 할까요?',['지우고 다시 그린다',IMG('erase'),{디테일:0.8,꾸준성:0.8}],['실수를 작품 일부로 바꾼다',IMG('mix'),{도전성:0.6}],['쉬고 재도전·완성',IMG('focus'),{꾸준성:1}],['도움을 요청',IMG('help'),{소통력:0.8}]),
    S('q5','미술관에서 무엇을 오래 보나요?',['빛/그림자 분위기',IMG('light'),{공간감:0.6,색감각:0.6}],['숨겨진 작은 요소',IMG('detail'),{관찰력:0.8,디테일:0.8}],['작가의 마음 상상',IMG('emotion'),{서사력:0.7,소통력:0.4}],['재료/기법이 궁금',IMG('material'),{도전성:0.6,관찰력:0.6}]),
    S('q6','미래의 도시를 그린다면, 어떻게 시작할까요?',['사진 조사·계획',IMG('city plan'),{디테일:0.7,공간감:0.8}],['아무도 본 적 없는 건물',IMG('scifi'),{도전성:1}],['아이디어 모으기',IMG('team'),{소통력:0.8}],['재료 실험',IMG('paint'),{도전성:0.8,색감각:0.5}]),
    S('q7','친구가 슬퍼 보여요. 어떤 그림을 그려줄까요?',['귀여운 동물',IMG('cute'),{서사력:0.5}],['추상적 감정',IMG('blue'),{색감각:0.6}],['즐거운 추억',IMG('memory'),{서사력:0.8,소통력:0.5}],['밝고 희망찬 그림',IMG('bright'),{색감각:0.7}]),
    S('q8','편안한 색 조합은?',['따뜻한 계열',IMG('warm'),{색감각:0.8}],['차가운 계열',IMG('cool'),{색감각:0.8}],['보색 대비',IMG('complementary'),{도전성:0.6}],['파스텔',IMG('pastel soft'),{색감각:0.8}]),
    S('q9','잘 안될 때 몇 번 시도할까요?',['바꾼다',IMG('switch'),{도전성:0.4}],['몇 번 후 포기',IMG('try'),{꾸준성:0.5}],['될 때까지 + 도움요청',IMG('keep'),{꾸준성:1,소통력:0.5}],['원인 분석·새 방법',IMG('analyze'),{도전성:0.6}]),
    S('q10','이 그림에서 가장 눈에 띄는 것은?',['전체 구도',IMG('layout'),{공간감:0.9}],['작은 패턴/질감',IMG('texture'),{디테일:0.9}],['인물 표정/감정',IMG('face'),{서사력:0.7}],['독특한 재료/기법',IMG('tech'),{도전성:0.7}]),
    S('q11','내 그림의 제목은?',['보이는 대로',IMG('see'),{관찰력:0.6}],['상상을 부르는 제목',IMG('title'),{서사력:0.9,소통력:0.5}],['기분 좋아지는 제목',IMG('happy'),{서사력:0.3}],['색/형태 강조',IMG('shape'),{색감각:0.7,디테일:0.5}]),
    S('q12','세상에 없는 동물, 어떤 동물?',['섞어서 만든 동물',IMG('hybrid'),{관찰력:0.6,디테일:0.6}],['완전히 새로운 형태',IMG('new'),{도전성:0.9}],['감정 표현·대화',IMG('talk'),{서사력:0.7,소통력:0.6}],['특별한 재료로 꾸미기',IMG('craft'),{색감각:0.6,디테일:0.6}]),
    S('q13','그림을 보여줄 때 듣고 싶은 말은?',['칭찬',IMG('praise'),{}],['구체적 조언',IMG('advice'),{}],['이야기가 떠올라',IMG('story'),{}],['재료가 궁금',IMG('curious'),{}]),
    S('q14','두 풍경 중 더 안정적인 구도는?',['균형 잡힌 구도',IMG('balance'),{공간감:0.9}],['치우친 구도',IMG('tilt'),{도전성:0.4}],['','',{}],['','',{}]),
    S('q15','답답할 때 어떤 생각을 하나요?',['재능이 없나…',IMG('sad'),{꾸준성:0.2}],['조금만 더! 자신감',IMG('cheer'),{꾸준성:0.9}],['다른 방법 떠올리기',IMG('newway'),{도전성:0.6}],['완성 상상으로 동기',IMG('finish'),{서사력:0.5,꾸준성:0.7}])
  ].map(q=>{q.options=q.options.filter(o=>(o.label||o.imageUrl));if(q.options.length<2)q.options=q.options.slice(0,2);return q});
}

/* 우클릭/드래그 방지 */
document.addEventListener('contextmenu',e=>e.preventDefault(),{passive:false});
document.addEventListener('dragstart',e=>e.preventDefault(),{passive:false});

/* 저작권 연도 출력 */
(function(){ const y=new Date().getFullYear(); const el=$('copyrightText'); if(el) el.textContent=`© ${y} 바른미술학원. All rights reserved.`; })();
</script>
</body>
</html>
