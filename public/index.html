<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>바른미술학원 · 미술적성테스트 V1. BASIC</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<!-- 차트 / 캡처 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#6b7280; --bg:#FFF4EC;
  --card:#ffffff; --line:#eef2f7; --o1:#FFE6CF; --o2:#FFD9BE;
  --mint:#CFF7EE; --vio:#E6E2FF; --radius:22px;
  --shadow:0 18px 60px rgba(16,24,40,.12); --soft:0 12px 30px rgba(16,24,40,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;color:var(--ink);font-family:"Pretendard",ui-sans-serif,system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial;background:var(--bg);font-size:17px}
.container{min-height:100dvh;display:flex;flex-direction:column;align-items:center}
.main{width:100%;max-width:1100px;padding:18px;display:flex;flex-direction:column;gap:16px;margin:0 auto}
.header{width:100%;display:flex;justify-content:center}
.brand{width:100%;max-width:1100px;margin-top:10px;display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:999px;background:#fff;border:1px solid var(--line);box-shadow:var(--soft)}
.logo{width:28px;height:28px;border-radius:50%;background:conic-gradient(from 0deg,#FFB98A,#FFE6CF,#E6E2FF,#CFF7EE,#FFB98A);animation:spin 9s linear infinite paused}
.brand:hover .logo{animation-play-state:running}@keyframes spin{to{transform:rotate(360deg)}}
.brand span{font-weight:900;letter-spacing:.2px;display:flex;align-items:center;gap:8px}
.badge{font-size:12px;font-weight:900;padding:4px 8px;border-radius:999px;background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#5a3f2f;border:1px solid #ffe0c9}

/* 진행바 & 네비 */
.sticky{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.95);border:1px solid var(--line);border-radius:16px;box-shadow:var(--soft);padding:8px 10px;display:flex;flex-direction:column;gap:10px}
.navbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.step{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;cursor:pointer;background:#fff;color:#374151;font-weight:850;border:1px solid var(--line);box-shadow:var(--soft);transition:transform .12s}
.step:hover{transform:translateY(-1px)}
.step .num{width:20px;height:20px;border-radius:50%;display:inline-grid;place-items:center;background:#fff;border:1px solid var(--line);font-size:13px}
.step.active{background:linear-gradient(90deg,#FFE6CF,#E6E2FF);color:#111827;box-shadow:0 12px 30px rgba(255,214,176,.28)}
.step.done{background:#f2fffa;border-color:#dff7ef}

.topprogress{--steps:15;position:relative;height:30px;background:#f6f7fb;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
.topprogress .bar{position:absolute;inset:0 auto 0 0;width:0;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE);border-radius:999px;z-index:1;transition:width .35s ease}
.topprogress::before{
  content:"";position:absolute;inset:0;z-index:2;pointer-events:none;
  background-image:linear-gradient(to right, rgba(17,24,39,.08) 0, rgba(17,24,39,.08) 1px, transparent 1px, transparent calc(100%/var(--steps)));
  background-size:calc(100%/var(--steps)) 100%;
}
.topprogress .toplabel{position:absolute;inset:0;display:grid;place-items:center;z-index:3;font-weight:900;font-size:15px;color:#111827;text-shadow:0 1px 0 rgba(255,255,255,.85),0 0 6px rgba(255,255,255,.9)}
.statusline{font-size:13px;color:var(--muted);text-align:center}

.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);animation:fade .35s ease both}
@keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
h1{font-size:35px;margin:0 0 6px}h2{font-size:25px;margin:0 0 10px}h3{font-size:19px;margin:16px 0 8px}
p{margin:8px 0}.small{font-size:14px}.muted{color:var(--muted)}.center{text-align:center}

/* Hero */
.hero{position:relative;padding:44px 22px;border-radius:22px;border:1px solid var(--line);
  background:radial-gradient(900px 260px at 15% -40%, #FFE6CF 0%, transparent 60%),radial-gradient(900px 260px at 85% -40%, #E6E2FF 0%, transparent 60%),linear-gradient(180deg,#ffffff 0%, #fff9f3 100%)}
.hero .title{font-size:45px;font-weight:900;letter-spacing:.2px;margin:2px 0 6px;color:#111827}
.hero .sub{color:#6b7280;margin-bottom:18px}
.hero .ctaRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* 버튼 */
.btn{--bg:linear-gradient(90deg,#FFB98A,#FFD9BE);--glow:rgba(255,185,138,.35);background:var(--bg);color:#5a3f2f;border:none;padding:18px 28px;border-radius:18px;font-weight:900;cursor:pointer;box-shadow:0 16px 40px var(--glow);transition:transform .08s,filter .2s;font-size:21px}
.btn:hover{transform:translateY(-1px);filter:brightness(1.03)}
.btn-ghost{background:#fff;color:#111827;border:1px solid var(--line);padding:12px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:var(--soft)}
.btn-mint{--bg:linear-gradient(90deg,#FFE6CF,#FFD9BE)}.btn-accent{--bg:linear-gradient(90deg,#B9C8FF,#9DE5D5)}.btn-xl{padding:22px 34px;font-size:23px;border-radius:22px}

/* 입력/폼 카드 */
input,select,textarea{width:100%;background:#fff;color:#111;border:1px solid var(--line);border-radius:12px;padding:13px;outline:none}
input:focus,select:focus,textarea:focus{border-color:#FFD9BE;box-shadow:0 0 0 6px rgba(255,217,190,.26)}
label{font-size:15px;color:#374151}
.section{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}

.grid{display:grid;gap:14px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:1020px){.grid-4{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.grid-4{grid-template-columns:1fr}}

/* 보기 카드 – 정사각 썸네일(동일 크기) */
.opt{border:2px solid var(--line);border-radius:18px;overflow:hidden;cursor:pointer;background:#fff;box-shadow:var(--soft);transition:transform .12s,border-color .2s}
.opt:hover{transform:translateY(-2px)}
.opt .thumb{width:58%;max-width:160px;aspect-ratio:1/1;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#fafafa;margin:14px auto 8px;display:flex;align-items:center;justify-content:center}
.opt .thumb img{width:100%;height:100%;object-fit:cover;display:block}
.opt .cap{padding:10px 12px 14px;color:#374151;font-weight:800;font-size:16px;line-height:1.35}

@media (min-width:1024px){
  .test-grid-4{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  .test-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  .sideNav{position:fixed;top:50%;transform:translateY(-50%);z-index:20}
  .sideNav.left{left:18px}.sideNav.right{right:18px}
  .sideBtn{background:linear-gradient(90deg,#fff,#FFF4EC);border:1px solid var(--line);width:48px;height:48px;border-radius:50%;display:grid;place-items:center;box-shadow:0 12px 26px rgba(16,24,40,.08);cursor:pointer;font-weight:900}
  .sideBtn:hover{transform:translateY(-1px)}
}
@media (max-width:1023px){.sideNav{display:none}}
.opt.sel{border-color:#FFD9BE;box-shadow:0 0 0 6px rgba(255,217,190,.25)}

/* 동의 아코디언(기본 접힘) */
.acc{border-radius:14px;overflow:hidden;border:1px solid var(--line)}
.acc-item{border-top:1px solid var(--line)}
.acc-head{padding:15px 16px;background:#FFF4EC;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.acc-head span{font-weight:900;font-size:18px}
.acc-body{padding:14px 16px;display:none;background:#fff}
.acc-item.open .acc-body{display:block}
.agreeList{display:grid;gap:10px;margin-top:10px}
.agree-row{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:13px 14px;border:1px solid var(--line);border-radius:12px;background:#fff}
.agree-row .txt{font-size:16px;color:#0f172a;line-height:1.55;font-weight:700}
.agree-row input[type="checkbox"]{width:21px;height:21px;accent-color:#FFB98A}

/* 결과 레이아웃(그래프 3개) */
.block{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(16,24,40,.06);page-break-inside:avoid;break-inside:avoid}
.block h3{margin:0 0 10px}
.result-grid{display:grid;grid-template-columns:3fr 2fr;gap:16px}
.result-right{display:grid;grid-template-rows:1fr 1fr;gap:16px}
.chartBox{height:420px;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
.result-right .chartBox{height:200px}
.chartBox canvas{width:100% !important;height:100% !important;display:block}
.chartCaption{font-weight:900;margin:0 0 6px;color:#111827}

.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#5a3f2f;border:1px solid #ffe8d6;padding:8px 12px;border-radius:999px;font-weight:900}
.callout{position:relative;background:linear-gradient(135deg,#FFF2E6,#F8FBFF);padding:22px;border-radius:18px;border:1px solid var(--line);box-shadow:0 12px 34px rgba(255,185,138,.25)}
.callout:before{content:"";position:absolute;inset:-1px;border-radius:18px;padding:1px;background:linear-gradient(90deg,#FFD9BE,#E6E2FF,#CFF7EE);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}

/* 자세한 결과 카드 */
.detail-hero{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:8px}
.detail-hero .ic{width:50px;height:50px;border-radius:999px;background:#e9efff;border:1px solid #dbe7ff;display:grid;place-items:center;font-weight:900;color:#3b61ff}
.detail-title{font-size:29px;font-weight:900}
.detail-sub{color:#6b7280;text-align:center;margin:-4px 0 10px}
.theoryWrap{background:#f5f8ff;border:1px solid #e6eeff;border-radius:18px;padding:16px}
.tgrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.tcard{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;line-height:1.7}
.tcard.hint{background:#f9fbff}
.tchip{background:#e6eeff;color:#2f5aff;border:1px solid #d9e3ff;padding:7px 11px;border-radius:999px;font-weight:800;font-size:13px}

/* 상담 예약 */
.reserve{margin-top:14px;text-align:center;background:linear-gradient(180deg,#fff7ec,#ffe7d1);border:1px solid #ffd9be;border-radius:18px;padding:18px}
.reserve .title{font-weight:900;font-size:23px;color:#5a3f2f}
.reserve .items{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:16px 0;justify-items:center}
.reserve .pill{width:100%;max-width:360px;background:#fff;border:1px solid #ffe1c9;border-radius:14px;padding:12px}
.reserve .pill .pt{font-weight:900;margin-bottom:6px}.reserve .note{font-size:13px;color:#6b7280;margin-top:8px}

/* 프린트 */
@media print{.header,.sticky,.btn,.btn-ghost,.sideNav,.no-pdf{display:none !important}.card{box-shadow:none;border:1px solid #ddd}.block{break-inside:avoid-page}}
.pdf-screen-width{width:794px;max-width:none;margin:0 auto}

/* 이메일 모달 */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:999}
.modal-backdrop.show{display:flex}
.modal{width:min(520px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 18px 60px rgba(16,24,40,.18);padding:18px}
.modal h3{margin:0 0 10px}.modal .row{display:grid;gap:8px;margin:10px 0}.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<div class="container" id="appRoot">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <span>바른미술학원 · 미술적성테스트 <span class="badge">V1. BASIC</span></span>
    </div>
  </div>

  <main class="main" aria-live="polite">
    <div class="sticky">
      <nav class="navbar" id="topnav"></nav>
      <div class="topprogress" id="topprogress">
        <div id="topbar" class="bar"></div>
        <div id="toplabel" class="toplabel"></div>
      </div>
      <div class="statusline" id="statusline">진행률 0%</div>
    </div>
    <section class="card" id="app"></section>
  </main>
</div>

<div class="sideNav left" id="sideLeft" style="display:none"><button class="sideBtn" onclick="prev()" aria-label="이전">‹</button></div>
<div class="sideNav right" id="sideRight" style="display:none"><button class="sideBtn" onclick="next()" aria-label="다음">›</button></div>

<!-- 이메일 모달 -->
<div class="modal-backdrop" id="emailModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>이메일로 결과 보내기</h3>
    <div class="row">
      <label>받는 사람 이메일</label>
      <input type="email" id="emailTo" placeholder="example@email.com">
    </div>
    <div class="row">
      <label>제목</label>
      <input type="text" id="emailSubject" value="">
    </div>
    <div class="actions">
      <button class="btn-ghost" id="emailCancel">취소</button>
      <button class="btn btn-accent" id="emailSend">보내기</button>
    </div>
    <div class="small muted" id="emailMsg" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* ===== 상수 ===== */
const APP_TITLE='바른미술학원 · 미술적성테스트 V1. BASIC';
const SHEET_ID='14VLQBhDJtduxjCnfr7VEOstZ5ez8-CX3ArXy1OvYCQg';
const GVIZ_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Questions&tqx=out:json`;
const FORM_ACTION='https://docs.google.com/forms/d/e/1FAIpQLSeRWq5YKN50zL0simiaQA6EBRsn6VXN__ZmLplAgDz1I1hyQA/formResponse';
const EMAIL_FUNCTION_URL='/.netlify/functions/send-email';

/* Google Form 항목 매핑 */
const F={child_name:'entry.684468179',age:'entry.1066070471',grade:'entry.1812672802',guardian:'entry.1666083184',phone:'entry.89824848',campus:'entry.490719219',answers:'entry.85364862',scores:'entry.1455508168',top3:'entry.2120338430',resultId:'entry.532514127',timestamp:'entry.1261684833'};

const ASSET_BASE='/img';
const DOMAINS=["관찰력","색감각","서사력","공간감","디테일","도전성","소통력","꾸준성"];
const STEPS=[
  {key:'start',label:'시작'},
  {key:'consent',label:'동의'},
  {key:'profile',label:'프로필'},
  {key:'test',label:'테스트'},
  {key:'result',label:'결과'},
  {key:'details',label:'자세한 결과'}
];
const STATE={step:'start',consent:false,profile:{},questions:[],idx:0,answers:[],result:null};

const $=id=>document.getElementById(id);
const app=()=>$('app');

/* NAV + Progress */
function renderNav(){
  const cur=STEPS.findIndex(s=>s.key===STATE.step);
  $('topnav').innerHTML=STEPS.map((s,i)=>`<div class="step ${s.key===STATE.step?'active':''} ${cur>i?'done':''}" onclick="navGo('${s.key}')"><span class="num">${i+1}</span><span>${s.label}</span></div>`).join('')
}
function updateTopProgress(){
  const topbar=$('topbar'); const toplabel=$('toplabel'); const tp=$('topprogress'); const status=$('statusline');
  if(STATE.step==='test'&&STATE.questions.length){
    status.style.display='none';
    const total=STATE.questions.length;
    const curIndex=STATE.idx+1;
    const pct=Math.max(0, Math.min(100, Math.round((STATE.idx)/total*100)));
    topbar.style.width=pct+'%';
    toplabel.textContent=`(${curIndex}/${total})`;
    tp.style.setProperty('--steps', String(total));
    $('sideLeft').style.display='block';
    $('sideRight').style.display='block';
    return;
  }
  $('sideLeft').style.display='none';
  $('sideRight').style.display='none';
  toplabel.textContent='';
  status.style.display='block';
  let pct=(STEPS.findIndex(s=>s.key===STATE.step))/(STEPS.length-1)*100;
  topbar.style.width=Math.round(pct)+'%';
  $('statusline').textContent=`진행률 ${Math.round(pct)}%`;
}
function navGo(step){STATE.step=step;if(step==='test'&&STATE.questions.length===0){startTest();return;}render();}

/* GViz 파서 */
function parseGViz(text){const s=text.indexOf('{'),e=text.lastIndexOf('}');if(s<0||e<0)return[];const obj=JSON.parse(text.slice(s,e+1));const cols=obj.table.cols.map(c=>c.label);return obj.table.rows.map(r=>r.c.map(c=>c?(c.f??c.v):'')).map(a=>Object.fromEntries(cols.map((k,i)=>[k,a[i]])))}
async function loadQuestions(){
  try{
    const txt=await(await fetch(GVIZ_URL)).text();
    const rows=parseGViz(txt)||[];
    const act=rows.filter(r=>String(r.active).toUpperCase()==='TRUE').sort((a,b)=>(+a.order-+b.order));
    if(act.length){
      STATE.questions=act.map(r=>{
        const mkWeights=k=>{try{return JSON.parse(r[`${k}_weights`])||{}}catch{return{}}};
        const mkOpt=k=>({key:k,label:(r[`${k}_label`]||'').trim(),imageUrl:(r[`${k}_image`]||'').trim(),weights:mkWeights(k)});
        const opts=['A','B','C','D'].map(mkOpt).filter(o=>{
          const hasLabel=o.label.length>0;const hasImage=o.imageUrl.length>0;
          const hasWeight=Object.values(o.weights||{}).some(v=>Number(v||0)!==0);
          return hasLabel||hasImage||hasWeight;
        });
        const safeOpts=opts.length>=2?opts:['A','B'].map(mkOpt);
        return{id:r.id||`q${r.order}`,order:+r.order,prompt:r.prompt||'',options:safeOpts}
      });
      return;
    }
  }catch(e){}
  STATE.questions=localQuestions()
}

/* 시작 화면 */
function startScreen(){
  return `
    <div class="hero">
      <div class="title center">${APP_TITLE}</div>
      <div class="sub center">아이의 미술 적성과 잠재력을 간단히 확인하고, 바로 결과를 저장·이메일 전송할 수 있어요.</div>
      <div class="ctaRow">
        <button class="btn btn-xl" id="startBtn">테스트 시작하기 →</button>
        <a class="btn-ghost btn-xl" href="index2.html" style="text-decoration:none">ADVANCE 테스트</a>
      </div>
    </div>
    <section class="features" style="margin:20px auto 8px;max-width:980px">
      <h2 style="text-align:center;font-weight:900">테스트 특징</h2>
      <p class="sub" style="text-align:center;color:#6b7280;margin:0 0 16px">아이의 미술 흥미·성향을 파악해 도움 되는 교육 포인트를 제시합니다</p>
      <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:14px">
        <div class="card" style="display:flex;align-items:center;gap:12px"><div class="badge" style="font-size:19px">⏱</div><div><b>빠른 테스트</b><div class="small muted">5–8분 내 완료</div></div></div>
        <div class="card" style="display:flex;align-items:center;gap:12px"><div class="badge" style="font-size:19px">🎯</div><div><b>맞춤 분석</b><div class="small muted">강점/교육 포인트</div></div></div>
        <div class="card" style="display:flex;align-items:center;gap:12px"><div class="badge" style="font-size:19px">⚡</div><div><b>즉시 결과</b><div class="small muted">저장/이메일 전송</div></div></div>
      </div>
      <div class="small muted center" style="margin-top:12px">※ 본 테스트는 <b>교육 가이드</b> 목적이며, 의학/임상 진단이 아닙니다.</div>
    </section>`;
}
function viewStart(){app().innerHTML=startScreen();$('startBtn').onclick=()=>navGo('consent');window.scrollTo({top:0,behavior:'smooth'})}

/* 동의서 (기본 접힘) */
function accItem(t,html){return `<div class="acc-item"><div class="acc-head"><span>${t}</span><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div class="acc-body small">${html}</div></div>`}
function viewConsent(){
  app().innerHTML=`<h2 class="center">개인정보 수집·이용 동의서</h2>
  <div class="acc">
    ${accItem('<b>1) 목적</b>','① 테스트 제공 및 결과 산출 ② 결과 안내·PDF 저장 지원 ③ 상담 품질 개선')}
    ${accItem('<b>2) 수집 항목</b>','아동 이름·나이·학년 / 보호자 이름·연락처 / 응답 내용 (이메일은 선택)')}
    ${accItem('<b>3) 보관 기간</b>','수집일로부터 <b>12개월</b> 보관 후 파기')}
    ${accItem('<b>4) 보관/처리</b>','Google Forms/Sheets에 저장·처리')}
    ${accItem('<b>5) 권리</b>','동의 거부 가능(거부 시 서비스 제한 가능)')}
    ${accItem('<b>6) 문의</b>','barunart1004@gmail.com')}
  </div>
  <div class="section" style="margin-top:16px">
    <div class="agreeList">
      <div class="agree-row"><div class="txt">(필수) 개인정보 수집·이용에 <b>동의합니다.</b></div><input type="checkbox" id="chk_required" /></div>
      <div class="agree-row"><div class="txt">(필수) 만 14세 미만 아동의 법정대리인으로서 <b>동의합니다.</b></div><input type="checkbox" id="chk_minor" /></div>
    </div>
  </div>
  <div class="center" style="margin-top:16px;display:flex;gap:8px;justify-content:center">
    <button class="btn" id="btn_consent" disabled>동의하고 진행</button>
    <button class="btn-ghost" id="btn_expand">전문 펼치기</button>
    <button class="btn-ghost" id="btn_collapse">모두 접기</button>
  </div>`;
  const validate=()=>{$('btn_consent').disabled=!( $('chk_required').checked && $('chk_minor').checked )};
  $('chk_required').addEventListener('change',validate);$('chk_minor').addEventListener('change',validate);
  $('btn_consent').onclick=()=>{STATE.consent=true;navGo('profile')};
  $('btn_expand').onclick=()=>document.querySelectorAll('.acc-item').forEach(it=>it.classList.add('open'));
  $('btn_collapse').onclick=()=>document.querySelectorAll('.acc-item').forEach(it=>it.classList.remove('open'));
  document.querySelectorAll('.acc-head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
}

/* 프로필 – 4열 그리드 */
const AGE_TO_GRADE={7:'초등학교 1학년',8:'초등학교 2학년',9:'초등학교 3학년',10:'초등학교 4학년',11:'초등학교 5학년',12:'초등학교 6학년'};
const GRADE_TO_AGE=Object.fromEntries(Object.entries(AGE_TO_GRADE).map(([a,g])=>[g,a]));
const CAMPUSES=['압구정[본원]','반포 캠퍼스','한남 캠퍼스','방배 캠퍼스','목동 캠퍼스','송파 캠퍼스','서대문 캠퍼스','일산 캠퍼스','탄현 캠퍼스','김포 캠퍼스','송도 캠퍼스','부산 캠퍼스'];

function viewProfile(){
  app().innerHTML=`<h2 class="center">프로필 정보</h2>
  <div class="grid grid-4" style="margin-top:8px">
    <div class="section"><label>아동 이름</label><input id="cname" placeholder="예: 홍길동"></div>
    <div class="section"><label>보호자 이름</label><input id="gname" placeholder="예: 김보호자"></div>
    <div class="section"><label>나이</label><select id="age">${[7,8,9,10,11,12].map(a=>`<option value="${a}">${a}</option>`).join('')}</select></div>
    <div class="section"><label>학년</label><select id="grade">${Object.values(AGE_TO_GRADE).map(g=>`<option>${g}</option>`).join('')}</select></div>
    <div class="section"><label>연락처</label><input id="phone" placeholder="010-0000-0000"></div>
    <div class="section"><label>이메일(선택, 결과지 전송용)</label><input id="email" placeholder="example@email.com"></div>
    <div class="section"><label>캠퍼스</label><select id="campus">${CAMPUSES.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>
  </div>
  <div class="center" style="margin-top:16px"><button class="btn btn-mint" id="btn_starttest">테스트 시작</button></div>`;
  $('age').addEventListener('change',e=>{$('grade').value=AGE_TO_GRADE[e.target.value]});
  $('grade').addEventListener('change',e=>{$('age').value=GRADE_TO_AGE[e.target.value]});
  $('btn_starttest').onclick=startTest;
}
async function startTest(){
  STATE.profile={child_name:$('cname').value.trim(),guardian:$('gname').value.trim(),age:$('age').value,grade:$('grade').value,phone:$('phone').value.trim(),email:$('email').value.trim(),campus:$('campus').value};
  if(!STATE.profile.child_name){alert('아동 이름을 입력해 주세요');return;}
  if(!/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(STATE.profile.phone||'')){alert('연락처 형식(010-0000-0000)을 확인해 주세요');return;}
  await loadQuestions();STATE.idx=0;STATE.answers=[];STATE.step='test';render();
}

/* 테스트 – 정사각 썸네일 통일 */
function pcGridClassFor(n){if(window.matchMedia('(min-width:1024px)').matches){return n===2?'test-grid-2':'test-grid-4'}return'grid grid-2'}
function optionImageUrl(q,o){if(o.imageUrl)return o.imageUrl;const num=Number(q.order)||(STATE.idx+1);return `${ASSET_BASE}/${num}-${o.key}.png`}
function viewTest(){
  const q=STATE.questions[STATE.idx];if(!q){app().innerHTML='<h3 class="center">문항을 불러오지 못했습니다. 관리자에 문의해 주세요.</h3>';return;}
  const gridCls=pcGridClassFor(q.options.length);
  app().innerHTML=`<div class="center small muted"><span class="chip">Q ${STATE.idx+1} / ${STATE.questions.length}</span></div>
    <h2 class="center" style="margin-top:10px">${q.prompt||''}</h2>
    <div class="${gridCls}" style="margin-top:12px">
      ${q.options.map(o=>`<div class="opt" id="opt_${o.key}" tabindex="0" role="button" aria-label="${o.label||o.key}" data-key="${o.key}">
        <div class="thumb"><img src="${optionImageUrl(q,o)}" alt="${o.label||o.key}" onerror="this.style.opacity=.2" loading="lazy"></div>
        <div class="cap center">${o.label||o.key}</div>
      </div>`).join('')}
    </div>
    <div class="center" style="margin-top:18px;display:flex;gap:10px;justify-content:center">
      <button class="btn-ghost" id="btn_prev" ${STATE.idx===0?'disabled':''}>이전</button>
      <button class="btn" id="btn_next" disabled>다음</button>
    </div>`;
  q.options.forEach(o=>{const el=document.getElementById(`opt_${o.key}`);el.onclick=()=>choose(o.key);el.onkeydown=e=>{if(e.key==='Enter'||e.key===' ')choose(o.key)}});
  $('btn_prev').onclick=prev;$('btn_next').onclick=next;
}
function choose(key){
  const q=STATE.questions[STATE.idx];
  q.options.forEach(k=>{const n=document.getElementById(`opt_${k.key}`);if(n)n.classList.remove('sel')});
  const node=document.getElementById(`opt_${key}`);if(node){node.classList.add('sel');node.animate([{transform:'scale(1)'},{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:160})}
  const opt=q.options.find(o=>o.key===key);STATE.answers[STATE.idx]={qid:q.id,key,weights:opt.weights||{}};$('btn_next').disabled=false;
}
function next(){if(STATE.step!=='test')return;if(!STATE.answers[STATE.idx]){alert('하나를 선택해 주세요');return;}if(STATE.idx<STATE.questions.length-1){STATE.idx++;render();}else{submitAllSafe();}}
function prev(){if(STATE.idx>0){STATE.idx--;render();}}
document.addEventListener('keydown',e=>{if(STATE.step!=='test')return;if(e.key==='ArrowRight')next();if(e.key==='ArrowLeft')prev();if(e.key==='Enter'){if(!$('btn_next').disabled)next();}});

/* 점수/멘트 – 강화된 가중치/곡선 보정 */
function aggregateScores(ans){
  const sum={}, touch={};
  DOMAINS.forEach(d=>{sum[d]=0;touch[d]=0});
  ans.forEach(a=>{
    Object.entries(a.weights||{}).forEach(([k,v])=>{
      const w=Math.max(0,Number(v||0));
      if(w<=0) return;
      const amplified=Math.pow(Math.min(1,w),1.35)*1.3; // 증폭
      sum[k]+=amplified;
      touch[k]+=1;
    });
  });
  const n=ans.length||1;
  const raw={};
  DOMAINS.forEach(d=>{
    const base=(sum[d]/n)*4;
    const consistency=(touch[d]/n)*0.6; // 일관성 보너스
    const v=Math.min(4,Math.max(0,Math.round((base+consistency)*10)/10));
    raw[d]=v;
  });
  return raw;
}
// 상위 구간 부각
const adjust=v=>{
  const ratio=v/4;
  const curved = v*1.12 + Math.pow(Math.max(0,ratio-0.5),1.2)*1.0;
  return Math.max(0, Math.min(4, Math.round(curved*10)/10));
};
function band(v){if(v>=3.6)return'S';if(v>=3.2)return'A';if(v>=2.8)return'A-';if(v>=2.4)return'B+';if(v>=2.0)return'B';if(v>=1.6)return'B-';if(v>=1.0)return'C+';return'C'}

const DETAIL={
  '관찰력':n=>`${n}님은 구조·형태의 핵심을 빠르게 포착합니다. 작은 차이와 규칙을 읽어 표현 밀도를 높이는 능력이 돋보입니다.`,
  '색감각':n=>`${n}님은 색의 분위기·온도·명도 대비를 안정적으로 다룹니다. 미묘한 톤 차이까지 섬세하게 감지합니다.`,
  '서사력':n=>`${n}님은 장면 속 감정과 사건을 자연스럽게 연결해 이야기를 설계합니다. 보는 이를 끌어당기는 힘이 있어요.`,
  '공간감':n=>`${n}님은 원근·스케일·시점 전환을 유연하게 사용하여 장면의 깊이를 설득력 있게 구성합니다.`,
  '디테일':n=>`${n}님은 질감·패턴·마감에 집중하여 완성도를 끌어올립니다. 몰입과 집중지속이 강점입니다.`,
  '도전성':n=>`${n}님은 새 재료·방식을 주저하지 않고 실험합니다. 실패를 학습으로 전환하는 태도가 뛰어납니다.`,
  '소통력':n=>`${n}님은 의도·과정을 말과 시각 요소로 설득력 있게 설명합니다. 피드백 수용력도 좋은 편입니다.`,
  '꾸준성':n=>`${n}님은 루틴을 유지하고 끝까지 밀어붙이는 힘이 있습니다. 점진적 향상에 최적화된 유형입니다.`
};

/* 이론/전문가/발달방향 — 각 영역별 5~6줄 분량, 전부 상이한 내용 */
const THEORY={
  '색감각':{
    theoryTitle:'Itten 색채이론',
    theory:'색채지각은 색상·명도·채도의 3요소 상호작용으로 성립합니다. 특히 동시에 배치된 색은 상호 대비를 일으켜 주관적 밝기와 채도 체감이 달라지며, 이 효과는 화면의 무게중심과 심리적 온도를 함께 바꿉니다. 따뜻함/차가움의 축과 보색관계는 시선의 흐름을 설계하는 데 핵심 지렛대가 됩니다. 또한 채도 제한과 중간색 혼합은 과도한 자극을 정리해 주제를 부각시킵니다. 결국 좋은 팔레트는 ‘선택’과 ‘절제’의 규칙을 통해 맥락을 만드는 일입니다.',
    expert:'색을 잘 쓰는 학생은 관찰된 정보를 감정적 언어로 번역하는 속도가 빠릅니다. 팔레트가 간결할수록 주제와 배경이 자연스럽게 분리되어, 전달력이 높아지는 경향이 있습니다. 과제 초반에는 주조색과 보조색을 먼저 고르고, 나머지는 이 두 색의 변주로 해결해 보세요. 이 방식은 탐색 시간을 줄이고 일관된 분위기를 유지하게 도와줍니다. 색의 성격을 말로 설명하게 하면 스스로의 선택 기준도 정교해집니다.',
    direction:'1) 3색 제한 팔레트로 시작해 톤 변주만으로 장면을 완성해 봅니다. 2) 사진이나 실물을 색칩으로 분해해 명도 스케일을 먼저 정하고, 채도는 절반만 사용합니다. 3) 동일 피사체를 따뜻/차가운 버전으로 각각 제작하여 심리적 온도 차이를 비교합니다. 4) 보색을 쓸 때는 면적을 7:3 정도로 비대칭 배치하여 주조색의 힘을 지키세요. 5) 작업 후 색 조합 의도를 한 문장으로 기록해 다음 작업에 재사용합니다.'
  },
  '디테일':{
    theoryTitle:'몰입과 주의집중',
    theory:'세부 묘사는 형태·빛·재질의 상호작용을 미시적으로 파악하는 능력에서 출발합니다. 인간의 주의는 제한적이므로, 큰 구조를 확정한 뒤 세부로 내려가는 ‘위계적 처리’가 효율적입니다. 또한 동일 패턴의 반복은 리듬을 만들지만, 간격과 크기의 미세한 변주가 없으면 기계적 인상만 남습니다. 디테일은 많고 적음의 문제가 아니라, 강조점 주변에서의 ‘밀도 대비’를 통해 의미를 만들 때 힘을 갖습니다.',
    expert:'세밀함이 강점인 학생은 완성도와 신뢰감을 동시에 전달합니다. 다만 전체와 부분의 균형이 흔들리면 흐름이 끊길 수 있기에, 확대 전 반드시 3단계(큰 면→중간 블록→세부) 체크를 습관화하세요. 질감 표현은 광원 방향, 반사광의 경도, 엣지의 날/무 구분만 정확하면 70%가 해결됩니다. 마감 시 불필요한 정보는果断히 비워 대비를 확보해야 핵심이 살아납니다.',
    direction:'1) 시작 10분 동안은 세부 금지, 큰 톤과 실루엣만 확정합니다. 2) 주제 주변 1/3 영역에만 고밀도 디테일을 집중하고, 주변부는 의도적으로 단순화합니다. 3) 재질 노트(매트/글로시/거칠기)를 만들어 같은 피사체라도 광원에 따라 어떻게 달라지는지 기록합니다. 4) 마지막 5분에는 “지울 디테일 3개”를 찾아 제거해 중심을 정리하세요. 5) 전/후 사진을 비교해 밀도 대비가 시선을 안내하는지 점검합니다.'
  },
  '서사력':{
    theoryTitle:'서사적 시각화',
    theory:'이야기는 목표를 가진 인물이 갈등을 겪고 변화를 맞는 구조를 가집니다. 시각 서사는 프레임 구성, 카메라 시점, 시간 압축·확장, 시선 유도 장치로 의미를 만듭니다. 텍스트 없이도 인과가 읽히려면 ‘전·중·후’의 단서가 화면에 분명해야 합니다. 또 상징과 메타포의 사용은 과잉 설명을 줄이면서 감정의 여운을 남깁니다. 좋은 서사는 관객이 빈칸을 채우도록 자리를 비워둡니다.',
    expert:'장면을 만들 때 “누가/무엇을/왜”를 먼저 결정하면 선택이 빨라집니다. 주인공의 감정선이 명확할수록 색·구도·질감 같은 형식 요소도 자연히 통일됩니다. 컷 전환은 이동·시점·시간 변화 중 한 가지 이유만으로도 충분합니다. 설명을 줄이고 행동과 결과의 단서로 말하도록 연습해 보세요. 발표 때는 의도를 한 문장으로 요약해 말하면 또래의 피드백 품질도 높아집니다.',
    direction:'1) 4컷 구성으로 시작하되, 각 컷에 “갈등→행동→결과→여운”을 배치합니다. 2) 주인공의 감정 변화를 3단계 색 스케일로 약속해 일관성을 유지합니다. 3) 상징 오브젝트 1개를 정해 반복 등장시키며 의미를 축적합니다. 4) 최종 발표 전, 본인이 없는 상태에서도 이야기 흐름이 읽히는지 친구에게 테스트합니다. 5) 다음 작업을 위한 “한 줄 로그라인”을 반드시 기록합니다.'
  },
  '공간감':{
    theoryTitle:'지각심리와 원근',
    theory:'공간감은 크기·겹침·선형 원근·공기 원근 등 복합적 단서의 통합으로 형성됩니다. 지평선과 소실점의 위치는 관람자의 눈높이를 규정하고, 전경/중경/후경의 대비는 깊이를 체감시키는 핵심 장치입니다. 또한 값의 대비가 거리 판단에 결정적이어서, 멀수록 명도 대비가 줄고 색채가 무채화되는 경향을 보입니다. 카메라 렌즈에 따른 왜곡 이해는 과장된 시점 연출에도 유용합니다.',
    expert:'공간을 설득력 있게 만들려면 “먼저 바닥을 깐다”는 마음으로 큰 면을 정리하세요. 그 다음에 구조선을 최소한으로만 사용해 방향성을 제시하면 과도한 선맛을 피할 수 있습니다. 전경의 디테일은 강조하되, 중·후경은 형태만 암시해 시선의 도착점을 확보합니다. 실내라면 눈높이와 수직의 수평 여부를 먼저 체크하고, 실외라면 대기 원근을 색으로 통제해 보세요. 구도 선택은 이야기가 요구하는 감정과 직결됩니다.',
    direction:'1) 1·2소실점 박스 드로잉으로 가구/건물 블록을 빠르게 세웁니다. 2) 전·중·후를 60:30:10 비율로 면적 분배하여 시선 동선을 설계합니다. 3) 대기 원근을 위해 후경 채도를 30~50% 낮추고, 엣지는 부드럽게 처리합니다. 4) 같은 장면을 높은 시점·낮은 시점으로 각각 그려 감정 차이를 비교합니다. 5) 사진 참고 시 렌즈 초점거리 정보를 함께 기록해 왜곡을 의식적으로 활용하세요.'
  },
  '관찰력':{
    theoryTitle:'게슈탈트와 구조 인지',
    theory:'게슈탈트 원리는 인간이 부분보다 전체 패턴을 우선 인식한다는 관점을 제시합니다. 미술에서 관찰력은 전체 형을 먼저 감지한 뒤 핵심 특징을 추려 구조화하는 과정입니다. 명암의 큰 덩어리를 구분하고, 기준 각과 비례를 빠르게 잡는 습관이 정확도의 8할을 좌우합니다. 또한 관찰은 단순한 복제가 아니라, 중요한 것과 부차적인 것을 분리하는 판단 행위입니다.',
    expert:'관찰이 좋은 학생은 “보이는 대로 그리기”를 넘어 “보여줄 것을 고르는” 힘이 있습니다. 실물 관찰 시에는 시선을 고정하고, 펜을 종이에서 떼지 않는 연속선 스케치를 2~3분 유지해 보세요. 이렇게 하면 형태 단순화와 리듬이 동시에 생깁니다. 동일 대상을 다른 광원에서 반복 관찰하는 훈련은 입체 사고를 강화합니다. 관찰 노트에 숫자·화살표·간단한 단어를 곁들여 시각-언어 연결을 만들어 보세요.',
    direction:'1) 시작 3분 제스처 스케치로 전체 비례를 잡습니다. 2) 명암을 3단계로만 나누어 큰 덩어리부터 칠합니다. 3) 기준 각 3개(수직/수평/대각)를 먼저 표시해 틀어짐을 줄입니다. 4) 같은 대상을 아침/정오/저녁 빛에서 각각 스케치합니다. 5) 마지막에 “핵심 특징 3개”를 글로 요약해 다음 관찰에 참고하세요.'
  },
  '도전성':{
    theoryTitle:'성장 마인드셋',
    theory:'성장형 마인드셋은 능력을 고정값이 아닌 가변값으로 보며, 노력·전략·피드백을 통해 개선된다고 믿는 태도입니다. 미술에서 도전성은 새로운 도구·재료·방법을 탐색하는 행동으로 드러납니다. 실패의 원인을 기록하고 다음 시도에서 변인을 통제하는 습관은 학습 효율을 크게 높입니다. 실험은 무작위가 아니라 가설→테스트→정리의 구조를 가질 때 의미가 생깁니다.',
    expert:'도전성이 높은 학생은 작업 초반의 모호함을 잘 견딥니다. 중요한 것은 “실험의 목적”을 한 줄로 적고 시작하는 것입니다. 실험 결과가 마음에 들지 않더라도 얻은 규칙을 메모하면, 다음 과제에서 시행착오가 줄어듭니다. 또한 폭넓은 탐색과 집중적 개선을 교차시키는 페이스가 번아웃을 막습니다. 팀 작업에서는 실험 기록을 공유해 동료의 학습 속도를 함께 끌어올릴 수 있습니다.',
    direction:'1) 과제를 시작할 때 “이번 시도에서 확인할 1가지”를 명시합니다. 2) 테스트 페이지를 만들어 붓/펜/재료 조합을 먼저 시험합니다. 3) 실패 사례를 사진과 한 문장으로 기록하여 다음 작업 브리핑의 근거로 사용합니다. 4) 한 주는 폭넓게 탐색, 다음 주는 선택한 방법의 완성도에 집중하는 2주 사이클을 추천합니다. 5) 발표 때 실험 목표와 배운 점을 짧게 공유하세요.'
  },
  '소통력':{
    theoryTitle:'비주얼 리터러시',
    theory:'비주얼 리터러시는 이미지가 담는 정보·감정·맥락을 해석하고 재구성하는 능력입니다. 메시지와 형식이 일치할 때 설득력이 생기며, 제목·주석·과정 노트는 관객의 길잡이가 됩니다. 또래 비평은 단순 반응이 아니라 기준을 공유하는 훈련일 때 효과가 큽니다. 시선 유도 장치(대비, 방향성, 반복)는 설명 없이도 의도를 전달하는 언어가 됩니다.',
    expert:'소통력이 좋은 학생은 자신의 선택을 논리와 감각으로 동시에 설명합니다. 작업 의도, 선택 기준, 대안 비교를 짧게 말해보는 습관은 발표의 긴장을 줄입니다. 피드백을 받을 때는 “유지/수정/추가” 3분류로 정리하면 다음 시도가 선명해집니다. 팀 과제에서는 역할과 기대 결과를 시각적으로 정리해 오해를 줄이세요. 말하기와 보기, 그리기가 하나의 과정으로 묶일 때 작품의 일관성이 커집니다.',
    direction:'1) 시작 전에 의도를 한 문장으로 적고, 완성 후에도 같은 문장으로 점검합니다. 2) 작업 과정 사진을 3컷만 골라 설명문을 붙입니다. 3) 피드백 노트를 “유지/수정/추가”로 나누어 정리합니다. 4) 제목 3안을 만들어 뜻·톤·관객 반응을 비교해 선택합니다. 5) 다음 과제 브리핑에서 선택 이유를 30초 내로 말해보세요.'
  },
  '꾸준성':{
    theoryTitle:'자기조절 학습',
    theory:'꾸준성은 동기·습관·환경 3요소의 균형에서 나옵니다. 짧고 빈번한 완성 경험은 자기효능감을 높여 다시 행동을 낳는 선순환을 만듭니다. 시간 고정과 과제 축소는 시작 장벽을 낮추며, 체크리스트는 진행 상황을 가시화합니다. 회고는 실패의 원인을 개인의 성향 탓이 아니라 전략의 조정 대상으로 바라보게 해줍니다.',
    expert:'루틴이 좋은 학생은 큰 목표를 작은 단위로 쪼개는 감각이 있습니다. 매일 같은 시간·장소에서 시작 신호(책상 정리, 타이머, 음악)를 고정하면 의지 소모를 줄일 수 있습니다. 완성까지의 중간 이정표를 작게 두어 “완료” 체크 경험을 자주 만들면 동기가 유지됩니다. 휴식 또한 계획의 일부로 포함해 에너지를 회복하세요. 꾸준함은 성취뿐 아니라 표현의 안정감으로도 드러납니다.',
    direction:'1) 하루 10~15분, 주 5회 작게 완성하는 과제를 정합니다. 2) 시작 의식(책상 정리→타이머 ON→첫 선 긋기)을 고정합니다. 3) 진행/완료 칸만 있는 단순 체크리스트를 사용합니다. 4) 주 1회 5분 회고로 “잘한 1가지/다음 수정 1가지”를 기록합니다. 5) 4주 단위로 전/후 작업을 나란히 놓고 변화 포인트를 확인합니다.'
  }
};

/* 제출 & 결과 */
function nowKST(){const d=new Date(),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())} KST`}
async function submitAllSafe(){
  const raw=aggregateScores(STATE.answers);
  const scores=Object.fromEntries(Object.entries(raw).map(([k,v])=>[k,adjust(v)]));
  const ordered=Object.keys(scores).sort((a,b)=>scores[b]-scores[a]);
  const top3=ordered.slice(0,3);
  const resultId=crypto.randomUUID();
  const form=new FormData();
  form.append(F.child_name,STATE.profile.child_name);form.append(F.age,STATE.profile.age);form.append(F.grade,STATE.profile.grade);
  form.append(F.guardian,STATE.profile.guardian);form.append(F.phone,STATE.profile.phone);form.append(F.campus,STATE.profile.campus||'');
  form.append(F.answers,JSON.stringify({profile:STATE.profile,questions:STATE.answers,top3}));
  form.append(F.scores,JSON.stringify(scores));form.append(F.top3,top3.join(','));form.append(F.resultId,resultId);form.append(F.timestamp,nowKST()));
  try{await fetch(FORM_ACTION,{method:'POST',mode:'no-cors',body:form});}catch(e){}
  STATE.result={scores,scoresRaw:raw,top3,resultId};STATE.step='result';render();
}

let CHARTS=[];function destroyCharts(){CHARTS.forEach(c=>c.destroy?.());CHARTS=[]}

/* 결과 */
function viewResult(){
  const r=STATE.result,s=r?.scores||{};const ordered=Object.keys(s).sort((a,b)=>s[b]-s[a]);
  const top4=ordered.slice(0,4);
  const next4=ordered.slice(4,8);
  const longSummary=[
    `${STATE.profile.child_name}님은 <b>${top4[0]||'-'}</b>를 중심으로 <b>${top4[1]||'-'}</b>, <b>${top4[2]||'-'}</b>, <b>${top4[3]||'-'}</b>에서 강점이 뚜렷합니다.`,
    `선택 과정에서 주의집중과 판단이 안정적이며, 과제를 빠르게 파악해 핵심을 잡는 유형입니다.`
  ].join(' ');

  app().innerHTML=`<div id="pdfArea" class="pdf-screen-width">
    <div class="block callout" style="text-align:center">
      <div class="chip" style="margin:0 auto 8px;display:inline-block">테스트 완료</div>
      <h2 style="margin:0 0 10px"><b>${STATE.profile.child_name}</b>님, 멋진 집중력이었습니다!</h2>
      <div class="chips" style="margin-top:10px;justify-content:center">${top4.slice(0,3).map(t=>`<span class="chip">뛰어난 영역: ${t}</span>`).join('')}</div>
    </div>

    <div class="block">
      <h3 class="center">프로파일 & 주요 지표</h3>
      <div class="result-grid" style="margin-top:8px">
        <div class="chartBox">
          <div class="chartCaption">전체 프로파일(Radar)</div>
          <canvas id="radar" height="200"></canvas>
        </div>
        <div class="result-right">
          <div class="chartBox">
            <div class="chartCaption">뛰어난 영역 (TOP4)</div>
            <canvas id="barsTop4" height="200"></canvas>
          </div>
          <div class="chartBox">
            <div class="chartCaption">잠재적인 영역 (하위 4)</div>
            <canvas id="barsNext" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="block"><h3>총평</h3><p style="color:#0f172a;font-size:16px;line-height:1.8">${longSummary}</p></div>

    <div class="block"><h3>항목별 한 줄 해석</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        ${DOMAINS.map(k=>{
          const v = +(s[k]||0);
          const w = Math.min(100,(v/4)*100);
          const b = band(v);
          return `
            <div style="border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff;box-shadow:0 10px 26px rgba(16,24,40,.06)">
              <div style="font-weight:900;margin-bottom:8px">${k} <span class="small" style="color:#6b7280">(${b} · ${v.toFixed(1)})</span></div>
              <div class="topprogress" style="height:10px;margin:8px 0 12px" aria-label="${k} 진행도">
                <div style="width:${w}%;height:100%;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE)"></div>
              </div>
              <div class="small" style="color:#0f172a">${DETAIL[k](STATE.profile.child_name)}</div>
            </div>`;
        }).join('')}
      </div>
    </div>
  </div>

  <div class="center no-pdf" style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button class="btn-ghost" onclick="STATE.step='start'; render()">처음으로</button>
    <button class="btn btn-mint" id="btn_pdf">PDF 저장</button>
    <button class="btn btn-accent" id="btn_email">이메일로 보내기</button>
    <button class="btn-ghost" onclick="STATE.step='details'; render()">자세한 결과 보기</button>
  </div>`;

  destroyCharts();

  const rctx=document.getElementById('radar').getContext('2d',{willReadFrequently:true});
  CHARTS.push(new Chart(rctx,{type:'radar',
    data:{labels:DOMAINS,datasets:[{data:DOMAINS.map(k=>s[k]||0),borderColor:'#FFB98A',backgroundColor:'rgba(255,185,138,.22)',borderWidth:2,pointRadius:3,fill:true}]},
    options:{maintainAspectRatio:false,animation:{duration:800},scales:{r:{suggestedMin:0,suggestedMax:4,ticks:{display:false},grid:{color:'#eef2f7'},angleLines:{color:'#eef2f7'}}},plugins:{legend:{display:false}}}
  }));

  const b1=document.getElementById('barsTop4').getContext('2d',{willReadFrequently:true});
  CHARTS.push(new Chart(b1,{type:'bar',
    data:{labels:top4,datasets:[{data:top4.map(k=>s[k]||0),borderRadius:12,borderSkipped:false,backgroundColor:['#FFD9BE','#E6E2FF','#CFF7EE','#FFD9BE']}]},
    options:{maintainAspectRatio:false,animation:{duration:700},scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{display:false},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}},plugins:{legend:{display:false}}}
  }));

  const b2=document.getElementById('barsNext').getContext('2d',{willReadFrequently:true});
  CHARTS.push(new Chart(b2,{type:'bar',
    data:{labels:next4,datasets:[{data:next4.map(k=>s[k]||0),borderRadius:12,borderSkipped:false,backgroundColor:['#E6E2FF','#CFF7EE','#FFD9BE','#E6E2FF']}]},
    options:{maintainAspectRatio:false,animation:{duration:700},scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{display:false},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}},plugins:{legend:{display:false}}}
  }));

  $('btn_pdf').onclick=handleSavePdf;$('btn_email').onclick=openEmailModal;
}

/* 자세한 결과 – 강점(TOP4) / 잠재(하위4) 모두 이론·전문가·발달방향(긴 문장)만 표시 */
function theoryCard(i,key,tag){
  const t=THEORY[key]||{theoryTitle:'이론',theory:'-',expert:'-',direction:'-'};
  const chipColor = tag==='강점' ? '' : 'style="background:#fff0d9;color:#9a5c27;border-color:#ffd9ae"';
  return `<div class="theoryWrap">
    <div style="font-weight:900;margin-bottom:8px">${i}. ${key} <span class="tchip" ${chipColor}>${tag} 영역</span></div>
    <div class="tgrid">
      <div class="tcard hint">
        <div style="font-weight:900;margin-bottom:6px">📍 이론적 근거 — ${t.theoryTitle}</div>
        <div class="" style="font-size:15px">${t.theory}</div>
      </div>
      <div class="tcard">
        <div style="font-weight:900;margin-bottom:6px">🧑‍🏫 전문가 의견</div>
        <div style="font-size:15px">${t.expert}</div>
      </div>
      <div class="tcard">
        <div style="font-weight:900;margin-bottom:6px">🡅 발달 방향</div>
        <div style="font-size:15px">${t.direction}</div>
      </div>
    </div>
  </div>`;
}

function viewDetails(){
  const r=STATE.result||{};const s=r.scores||{};
  const ordered=Object.keys(s).sort((a,b)=>s[b]-s[a]);
  const top4=ordered.slice(0,4);
  const next4=ordered.slice(4,8);

  const topBlocks=top4.map((k,i)=>theoryCard(i+1,k,'강점')).join('');
  const potBlocks=next4.map((k,i)=>theoryCard(i+1,k,'잠재')).join('');
  const overview=`<b>${STATE.profile.child_name}</b>(${STATE.profile.age}세, ${STATE.profile.grade}) 아동은
  <b>${top4[0]||'-'}</b> 중심의 강점을 바탕으로 <b>${top4.slice(1).join(', ')||'-'}</b>가 유기적으로 결합되어 있습니다. 
  향후 <b>${next4.join(', ')||'-'}</b> 영역을 보완하면 표현 폭이 크게 넓어질 것으로 기대됩니다.`;

  app().innerHTML=`
  <div class="detail-hero"><div class="ic">📘</div><div class="detail-title">전문가 평가 및 심화 분석</div></div>
  <p class="detail-sub"><b>${STATE.profile.child_name}</b>의 미술적성 심화 분석 보고서</p>

  <div class="block" style="background:#f5f8ff;border-color:#e6eeff">
    <div style="font-weight:900;margin-bottom:6px;display:flex;align-items:center;gap:8px">🧩 강점 영역(TOP4)</div>
    ${topBlocks || '<div class="small muted">강점 영역 데이터가 없습니다.</div>'}
  </div>

  <div class="block" style="background:#fffdfa;border-color:#ffecd2">
    <div style="font-weight:900;margin-bottom:6px;display:flex;align-items:center;gap:8px">🌱 잠재적 영역(하위 4)</div>
    ${potBlocks || '<div class="small muted">잠재 영역 데이터가 없습니다.</div>'}
  </div>

  <div class="block expertBox" style="margin-top:14px">
    <div class="expertHeader" style="display:flex;align-items:center;gap:10px;font-weight:900;font-size:19px;margin-bottom:10px">
      <div class="ic" style="width:34px;height:34px;border-radius:999px;display:grid;place-items:center;background:#ffefe5;border:1px solid #ffd9be">🧠</div>
      <div>종합 전문가 소견</div>
    </div>
    <ul class="ticks">
      <li><b>바른미술학원 전문 평가팀</b> — ${overview}</li>
      <li><b>개별화 전략</b>: 강점 기반 과제 난이도 상향 + 잠재 영역의 핵심 원리 재학습</li>
      <li><b>과정 중심</b>: 결과물뿐 아니라 의도·선택 기준·회고를 함께 기록하는 습관 형성</li>
      <li><b>리듬 설계</b>: 탐색 주간과 완성 주간을 번갈아 배치해 동기와 완성도를 동시에 확보</li>
    </ul>
  </div>

  <div class="reserve">
    <div style="display:flex;align-items:center;gap:8px;justify-content:center">
      <div class="badge" style="width:36px;height:36px;display:grid;place-items:center;border-radius:999px;font-size:18px">🗓</div>
      <div class="title">전문가 방문 상담 예약</div>
    </div>
    <div class="small" style="margin-top:6px">테스트 결과 기반 <b>맞춤 교육 계획</b>과 <b>포트폴리오</b> 진단을 제공합니다.</div>
    <div class="items">
      <div class="pill"><div class="pt">전문가 진단</div><div class="small muted">미술교육 전문가의 1:1 개별 진단</div></div>
      <div class="pill"><div class="pt">맞춤 계획</div><div class="small muted">특성에 맞는 교육 로드맵 제시</div></div>
      <div class="pill"><div class="pt">주기적 관리</div><div class="small muted">2주/4주 단위 루틴 코칭</div></div>
    </div>
    <button class="btn btn-mint no-pdf" onclick="alert('상담 예약은 곧 준비됩니다!')">상담 예약하기</button>
    <div class="note">상담료: 무료 | 소요시간: 60분</div>
  </div>

  <div class="center no-pdf" style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button class="btn-ghost" onclick="STATE.step='result'; render()">결과로 돌아가기</button>
    <button class="btn" onclick="STATE.step='start'; render()">처음으로</button>
  </div>`;
}

/* PDF/이메일 */
function buildPdfWrapperFrom(node){
  const wrap=document.createElement('div');
  wrap.style.position='fixed';wrap.style.left='-10000px';wrap.style.top='0';
  wrap.style.width='794px';wrap.style.background='#fff';wrap.style.zIndex='-1';
  const clone=node.cloneNode(true);
  clone.querySelectorAll('img').forEach(img=>{
    img.setAttribute('crossorigin','anonymous'); img.referrerPolicy='no-referrer'; img.src=img.src;
  });
  const srcC=node.querySelectorAll('canvas');const dstC=clone.querySelectorAll('canvas');
  srcC.forEach((src,i)=>{const dst=dstC[i];if(!dst)return;dst.width=src.width;dst.height=src.height;dst.getContext('2d',{willReadFrequently:true}).drawImage(src,0,0)});
  wrap.appendChild(clone);document.body.appendChild(wrap);
  return wrap;
}
function waitForAssets(root){
  const imgs=[...root.querySelectorAll('img')];
  const imgPromises=imgs.map(img=>img.complete?Promise.resolve():new Promise(res=>{img.onload=()=>res();img.onerror=()=>res()}));
  const fontsReady=('fonts'in document)?document.fonts.ready:Promise.resolve();
  return Promise.all([fontsReady,...imgPromises]);
}
async function html2pdfBlob(wrapper){
  const opt={margin:[8,8,8,8],
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff',removeContainer:true,windowWidth:wrapper.scrollWidth,windowHeight:wrapper.scrollHeight},
    pagebreak:{mode:['css','legacy']},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
  return await html2pdf().set(opt).from(wrapper).output('blob');
}
async function canvasSlicerBlob(wrapper){
  const h2c=window.html2canvas;
  const canvas=await h2c(wrapper,{scale:2,useCORS:true,allowTaint:true,backgroundColor:'#ffffff',scrollX:0,scrollY:0,windowWidth:wrapper.scrollWidth,windowHeight:wrapper.scrollHeight});
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const pxToMm=210/canvas.width;
  const pageHeightPx=Math.floor(297/pxToMm);
  let y=0,page=0;
  while(y<canvas.height){
    const sliceHeight=Math.min(pageHeightPx,canvas.height-y);
    const pageCanvas=document.createElement('canvas');
    pageCanvas.width=canvas.width;pageCanvas.height=sliceHeight;
    const ctx=pageCanvas.getContext('2d',{willReadFrequently:true});
    ctx.drawImage(canvas,0,y,canvas.width,sliceHeight,0,0,canvas.width,sliceHeight);
    const img=pageCanvas.toDataURL('image/jpeg',0.98);
    const mmHeight=sliceHeight*pxToMm;
    if(page>0) pdf.addPage();
    pdf.addImage(img,'JPEG',0,0,210,mmHeight);
    y+=sliceHeight;page++;
  }
  return pdf.output('blob');
}
async function exportPdfBlob(node){
  const wrapper=buildPdfWrapperFrom(node);
  await waitForAssets(wrapper);
  try{
    let blob=await html2pdfBlob(wrapper);
    if(!blob || blob.size<5000){blob=await canvasSlicerBlob(wrapper);}
    return blob;
  }catch(e){
    try{ return await canvasSlicerBlob(wrapper); }
    catch(e2){ throw e2; }
  }finally{ wrapper.remove(); }
}
async function handleSavePdf(){
  const node=$('pdfArea')||document.body;
  node.classList.add('pdf-screen-width');
  await new Promise(r=>setTimeout(r,50));
  try{
    const blob=await exportPdfBlob(node);
    const filename=`${STATE.profile.child_name}_미술적성테스트_V1_BASIC.pdf`;
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
  }catch(e){console.error(e);alert('PDF 저장 중 오류가 발생했습니다.')}
  finally{node.classList.remove('pdf-screen-width');}
}

/* 이메일 */
function setModalVisible(show){const m=$('emailModal');if(show){m.classList.add('show');m.setAttribute('aria-hidden','false');document.body.style.overflow='hidden'}else{m.classList.remove('show');m.setAttribute('aria-hidden','true');document.body.style.overflow=''}}
function openEmailModal(){setModalVisible(true);$('emailSubject').value=`${STATE.profile.child_name} 테스트 결과입니다`;$('emailTo').value=STATE.profile.email||'';$('emailMsg').textContent=''}
$('emailCancel').onclick=()=>setModalVisible(false);document.addEventListener('keydown',e=>{if(e.key==='Escape')setModalVisible(false)})
function blobToBase64(blob){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onloadend=()=>resolve(reader.result.split(',')[1]);reader.onerror=reject;reader.readAsDataURL(blob)})}
$('emailSend').onclick=async()=>{
  const to=$('emailTo').value.trim();if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(to)){ $('emailMsg').textContent='이메일 형식을 확인해 주세요.'; return; }
  $('emailMsg').textContent='PDF 생성 중...';
  let base64='';try{const blob=await exportPdfBlob($('pdfArea')||document.body);base64=await blobToBase64(blob)}catch(e){$('emailMsg').textContent='PDF 생성에 실패했습니다.';return}
  $('emailMsg').textContent='이메일 전송 중...';
  const subject=$('emailSubject').value.trim()||`${STATE.profile.child_name} 테스트 결과입니다`;
  const htmlBody=`<div style="font-family:Pretendard,Apple SD Gothic Neo,Segoe UI,Arial"><h2 style="margin:0 0 8px">${APP_TITLE}</h2><p><b>${STATE.profile.child_name}</b> 님의 결과지를 첨부했습니다.</p><p>캠퍼스: ${STATE.profile.campus||'-'} / 연락처: ${STATE.profile.phone||'-'}</p><p style="color:#6b7280;font-size:12px;margin-top:12px">본 메일은 자동 발송되었습니다.</p></div>`;
  try{
    const res=await fetch(EMAIL_FUNCTION_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to,subject,html:htmlBody,attachmentName:`${STATE.profile.child_name}_미술적성테스트_V1_BASIC.pdf`,attachmentBase64:base64})});
    const ok=res.ok;const data=await res.json().catch(()=>({}));
    if(ok){$('emailMsg').textContent='전송 완료! 메일함을 확인해 주세요.';setTimeout(()=>setModalVisible(false),1200)}
    else{$('emailMsg').textContent='전송 실패: '+(data.error||res.statusText)}
  }catch(err){$('emailMsg').textContent='전송 중 오류가 발생했습니다.'}
}

/* Router */
function render(){renderNav();updateTopProgress();if(STATE.step==='start')return viewStart();if(STATE.step==='consent')return viewConsent();if(STATE.step==='profile')return viewProfile();if(STATE.step==='test')return viewTest();if(STATE.step==='result')return viewResult();if(STATE.step==='details')return viewDetails()}
render();

/* Fallback 문항 */
function W(w){const o={};DOMAINS.forEach(k=>o[k]=0);Object.entries(w).forEach(([k,v])=>o[k]=v);return o}
function localQuestions(){
  const S=(q,p,a,b,c,d)=>({id:q,order:+q.replace('q',''),prompt:p,options:[{key:'A',label:a[0],imageUrl:a[1],weights:W(a[2])},{key:'B',label:b[0],imageUrl:b[1],weights:W(b[2])},{key:'C',label:c[0],imageUrl:c[1],weights:W(c[2])},{key:'D',label:d[0],imageUrl:d[1],weights:W(d[2])}]});
  const IMG=kw=>`https://images.unsplash.com/photo-150${Math.floor(Math.random()*899+100)}?auto=format&fit=crop&w=900&q=60&${encodeURIComponent(kw)}`;
  return [
    S('q1','새로운 미술 도구를 발견했어요! 무엇을 먼저 해볼까요?',['설명서를 꼼꼼히 읽어본다',IMG('paper'),{디테일:1,꾸준성:0.6}],['종이에 탐색·실험한다',IMG('sketch'),{도전성:1}],['친구들과 아이디어 나눈다',IMG('kids'),{소통력:1,서사력:0.6}],['가장 특이한 결과 상상',IMG('idea'),{도전성:1,서사력:0.5}]),
    S('q2','그림에 어떤 이야기를 담고 싶나요?',['모험 이야기',IMG('adventure'),{서사력:1}],['감정을 색과 형태로',IMG('abstract'),{색감각:0.8,서사력:0.6}],['현실 건물 새로 디자인',IMG('architecture'),{공간감:1,디테일:0.4}],['작은 생명체의 숨은 세계',IMG('mini world'),{관찰력:0.8,서사력:0.6}]),
    S('q3','두 그림 중 색이 더 조화로운 것은?',['조화로운 팔레트',IMG('palette'),{색감각:1}],['대비 강한 팔레트',IMG('contrast'),{도전성:0.6}],['파스텔 편안함',IMG('pastel'),{색감각:0.8}],['강한 보색',IMG('vivid'),{도전성:0.6}]),
    S('q4','그리다 실수를 했어요. 어떻게 할까요?',['지우고 다시 그린다',IMG('erase'),{디테일:0.8,꾸준성:0.8}],['실수를 작품 일부로 바꾼다',IMG('mix'),{도전성:0.6}],['쉬고 재도전·완성',IMG('focus'),{꾸준성:1}],['도움을 요청',IMG('help'),{소통력:0.8}]),
    S('q5','미술관에서 무엇을 오래 보나요?',['빛/그림자 분위기',IMG('light'),{공간감:0.6,색감각:0.6}],['숨겨진 작은 요소',IMG('detail'),{관찰력:0.8,디테일:0.8}],['작가의 마음 상상',IMG('emotion'),{서사력:0.7,소통력:0.4}],['재료/기법이 궁금',IMG('material'),{도전성:0.6,관찰력:0.6}]),
    S('q6','미래의 도시를 그린다면, 어떻게 시작할까요?',['사진 조사·계획',IMG('city plan'),{디테일:0.7,공간감:0.8}],['아무도 본 적 없는 건물',IMG('scifi'),{도전성:1}],['아이디어 모으기',IMG('team'),{소통력:0.8}],['재료 실험',IMG('paint'),{도전성:0.8,색감각:0.5}]),
    S('q7','친구가 슬퍼 보여요. 어떤 그림을 그려줄까요?',['귀여운 동물',IMG('cute'),{서사력:0.5}],['추상적 감정',IMG('blue'),{색감각:0.6}],['즐거운 추억',IMG('memory'),{서사력:0.8,소통력:0.5}],['밝고 희망찬 그림',IMG('bright'),{색감각:0.7}]),
    S('q8','편안한 색 조합은?',['따뜻한 계열',IMG('warm'),{색감각:0.8}],['차가운 계열',IMG('cool'),{색감각:0.8}],['보색 대비',IMG('complementary'),{도전성:0.6}],['파스텔',IMG('pastel soft'),{색감각:0.8}]),
    S('q9','잘 안될 때 몇 번 시도할까요?',['바꾼다',IMG('switch'),{도전성:0.4}],['몇 번 후 포기',IMG('try'),{꾸준성:0.5}],['될 때까지 + 도움요청',IMG('keep'),{꾸준성:1,소통력:0.5}],['원인 분석·새 방법',IMG('analyze'),{도전성:0.6}]),
    S('q10','이 그림에서 가장 눈에 띄는 것은?',['전체 구도',IMG('layout'),{공간감:0.9}],['작은 패턴/질감',IMG('texture'),{디테일:0.9}],['인물 표정/감정',IMG('face'),{서사력:0.7}],['독특한 재료/기법',IMG('tech'),{도전성:0.7}]),
    S('q11','내 그림의 제목은?',['보이는 대로',IMG('see'),{관찰력:0.6}],['상상을 부르는 제목',IMG('title'),{서사력:0.9,소통력:0.5}],['기분 좋아지는 제목',IMG('happy'),{서사력:0.3}],['색/형태 강조',IMG('shape'),{색감각:0.7,디테일:0.5}]),
    S('q12','세상에 없는 동물, 어떤 동물?',['섞어서 만든 동물',IMG('hybrid'),{관찰력:0.6,디테일:0.6}],['완전히 새로운 형태',IMG('new'),{도전성:0.9}],['감정 표현·대화',IMG('talk'),{서사력:0.7,소통력:0.6}],['특별한 재료로 꾸미기',IMG('craft'),{색감각:0.6,디테일:0.6}]),
    S('q13','그림을 보여줄 때 듣고 싶은 말은?',['칭찬',IMG('praise'),{}],['구체적 조언',IMG('advice'),{}],['이야기가 떠올라',IMG('story'),{}],['재료가 궁금',IMG('curious'),{}]),
    S('q14','두 풍경 중 더 안정적인 구도는?',['균형 잡힌 구도',IMG('balance'),{공간감:0.9}],['치우친 구도',IMG('tilt'),{도전성:0.4}],['','',{}],['','',{}]),
    S('q15','답답할 때 어떤 생각을 하나요?',['재능이 없나…',IMG('sad'),{꾸준성:0.2}],['조금만 더! 자신감',IMG('cheer'),{꾸준성:0.9}],['다른 방법 떠올리기',IMG('newway'),{도전성:0.6}],['완성 상상으로 동기',IMG('finish'),{서사력:0.5,꾸준성:0.7}])
  ].map(q=>{q.options=q.options.filter(o=>(o.label||o.imageUrl));if(q.options.length<2)q.options=q.options.slice(0,2);return q});
}
</script>
</body>
</html>
