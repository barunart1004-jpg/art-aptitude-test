<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>바른미술학원 · 미술적성테스트 V1. BASIC</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#6b7280; --line:#e9eef5; --white:#ffffff;
  --cta1:#FFB457; --cta2:#FF8C3A; --badge:#f3f4f6;
  --radius:20px; --shadow:0 18px 60px rgba(16,24,40,.12); --soft:0 10px 28px rgba(16,24,40,.08);
}
html,body{height:100%}
body{margin:0;color:var(--ink);font-family:"Pretendard",ui-sans-serif,system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial;background:#FFF4E8}
.container{min-height:100dvh;display:flex;flex-direction:column;align-items:center}
.main{width:100%;max-width:1200px;padding:18px;display:flex;flex-direction:column;gap:16px;margin:0 auto}

/* 헤더 */
.header{width:100%;display:flex;justify-content:center}
.brand{width:100%;max-width:1200px;margin-top:10px;display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:999px;background:#fff;border:1px solid var(--line);box-shadow:var(--soft)}
.logo{width:28px;height:28px;border-radius:50%;background:conic-gradient(from 0deg,#FFB98A,#FFE6CF,#E6E2FF,#CFF7EE,#FFB98A)}
.brand span{font-weight:900;letter-spacing:.2px}

/* 네비 + 진행바 */
.sticky{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--soft);padding:8px 10px;display:flex;flex-direction:column;gap:10px}
.navbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.step{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;cursor:pointer;background:#fff;color:#374151;font-weight:850;border:1px solid var(--line);box-shadow:var(--soft);transition:transform .12s}
.step:hover{transform:translateY(-1px)}
.step .num{width:20px;height:20px;border-radius:50%;display:inline-grid;place-items:center;background:#fff;border:1px solid var(--line);font-size:12px}
.step.active{background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#111827;box-shadow:0 12px 30px rgba(255,214,176,.28)}
.step.done{background:#f2fffa;border-color:#dff7ef}
.topprogress{height:10px;background:#f6f7fb;border-radius:999px;overflow:hidden}
.topprogress>div{height:100%;width:0;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE);transition:width .35s ease}
.statusline{font-size:12px;color:#6b7280;text-align:center}

/* 카드/버튼 */
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);animation:fade .35s ease both}
@keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
h1{font-size:34px;margin:0 0 6px}h2{font-size:26px;margin:0 0 10px}h3{font-size:18px;margin:16px 0 8px}
p{margin:8px 0}.small{font-size:13px}.muted{color:var(--muted)}.center{text-align:center}
.btn{--bg:linear-gradient(90deg,#FFB98A,#FFD9BE);--glow:rgba(255,185,138,.35);background:var(--bg);color:#5a3f2f;border:none;padding:16px 24px;border-radius:16px;font-weight:900;cursor:pointer;box-shadow:0 16px 40px var(--glow);transition:transform .08s,filter .2s,box-shadow .2s;position:relative;overflow:hidden;font-size:18px}
.btn:hover{transform:translateY(-1px);filter:brightness(1.03)}
.btn-ghost{background:#fff;color:#111827;border:1px solid var(--line);padding:12px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:var(--soft)}
.btn-primary{background:linear-gradient(90deg,var(--cta1),var(--cta2));color:#fff;box-shadow:0 14px 36px rgba(255,140,58,.35)}
.btn-mint{background:linear-gradient(90deg,#FFE6CF,#FFD9BE)}
.btn-xl{padding:20px 30px;font-size:20px;border-radius:20px}

/* 입력 + 폼 그리드 */
input,select,textarea{width:100%;background:#fff;color:#111;border:1px solid var(--line);border-radius:12px;padding:12px;outline:none}
input:focus,select:focus,textarea:focus{border-color:#FFD9BE;box-shadow:0 0 0 6px rgba(255,217,190,.26)}
label{font-size:14px;color:#374151;font-weight:700}
.form{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.form .field{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
@media (max-width:860px){ .form{grid-template-columns:1fr} }

/* 배지/뱃지 */
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f3f4f6;font-weight:800;font-size:12px}

/* 보기 카드(4개 더 크게) */
.opt{border:2px solid var(--line);border-radius:18px;overflow:hidden;cursor:pointer;background:#fff;box-shadow:var(--soft);transition:transform .12s,border-color .2s}
.opt:hover{transform:translateY(-2px)}
.opt img{width:100%;display:block;aspect-ratio:4/3;object-fit:cover}
.opt .cap{padding:12px 14px;color:#374151;font-weight:800;font-size:16px}
.opt.sel{border-color:#FFD9BE;box-shadow:0 0 0 6px rgba(255,217,190,.25)}
@media (min-width:1024px){
  .test-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
  .test-grid-4 .opt img{aspect-ratio:5/4} /* 이미지 세로 조금 더 */
  .test-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
}
@media (max-width:1023px){ .sideNav{display:none} }

/* 섹션/블록 */
.acc{border-radius:14px;overflow:hidden;border:1px solid var(--line)}
.acc-item{border-top:1px solid var(--line)}
.acc-head{padding:14px 16px;background:#FFF4EC;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.acc-body{padding:14px 16px;display:none;background:#fff}
.acc-item.open .acc-body{display:block}
.block{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(16,24,40,.06);page-break-inside:avoid}
.block h3{margin:0 0 10px}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#5a3f2f;border:1px solid #ffe8d6;padding:8px 12px;border-radius:999px;font-weight:900}
.kpi{display:flex;align-items:flex-end;gap:10px}
.kpi .num{font-size:44px;font-weight:900;line-height:1}
.kpi .unit{font-size:14px;color:#6b7280}
.callout{position:relative;background:linear-gradient(90deg,#FFE3CC,#E7F6FF);padding:22px;border-radius:18px;border:1px solid var(--line)}
.credit{font-size:12px;color:#6b7280;text-align:center}

/* 시작 히어로/특징 */
.heroTitle{font-size:48px;line-height:1.1;margin:6px 0 10px;font-weight:900;letter-spacing:.2px;background:linear-gradient(90deg,#111827 0%,#5a3f2f 40%,#FFB98A 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
.features{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:12px}
.feature-card{background:#fff;border:1px solid var(--line);border-radius:18px;padding:20px;box-shadow:var(--soft);text-align:center}
.feature-icon{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;margin:0 auto 10px;background:#FFEBCF}
.cta{margin-top:26px;border-radius:18px;border:1px solid var(--line);background:linear-gradient(90deg,#FFB75B,#FF983F);color:#fff;padding:30px 16px;text-align:center;box-shadow:0 16px 36px rgba(255,152,63,.25)}
.cta h3{margin:0 0 6px;font-size:26px;color:#fff}
.cta p{margin:0 0 18px;color:#fff;opacity:.95}

/* 전문가(종합) */
.section-title{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:900;margin:16px 0 10px}
.expert-wrap{background:#F4F8FF;border:1px solid #dfe8fb;padding:18px;border-radius:16px}
.expert-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:900px){ .expert-grid{grid-template-columns:1fr} }
.card-lite{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
.tag-blue{background:#e8f0ff;color:#2563eb;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;display:inline-block}

/* 결과 차트 2분할(A4 절반 이하) */
.result-row{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
@media (max-width:900px){ .result-row{grid-template-columns:1fr} }

/* PDF 모드 */
@media print{ .no-print{display:none !important} }
.pdf-mode .no-print{display:none !important}
.pdf-mode body{background:#fff}
.pdf-mode .card,.pdf-mode .block{box-shadow:none}
.pdf-mode .main{max-width:794px}
.pdf-mode .callout{background:#fff}
.pdf-mode canvas{background:#fff}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand"><div class="logo"></div><span>바른미술학원 · 미술적성테스트 V1. BASIC</span></div>
  </div>

  <main class="main">
    <div class="sticky no-print">
      <nav class="navbar" id="topnav"></nav>
      <div class="topprogress"><div id="topbar"></div></div>
      <div class="statusline" id="statusline">진행률 0%</div>
    </div>

    <section class="card" id="app"></section>
  </main>
</div>

<!-- 사이드 네비 -->
<div class="sideNav left no-print" id="sideLeft" style="display:none;position:fixed;top:50%;left:18px;transform:translateY(-50%);z-index:20">
  <button class="btn-ghost" onclick="prev()" aria-label="이전">‹</button>
</div>
<div class="sideNav right no-print" id="sideRight" style="display:none;position:fixed;top:50%;right:18px;transform:translateY(-50%);z-index:20">
  <button class="btn-ghost" onclick="next()" aria-label="다음">›</button>
</div>

<!-- 이메일 모달 -->
<div id="emailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:center;justify-content:center">
  <div style="width:min(560px,94vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow)">
    <h3 style="margin-top:0">결과 PDF 이메일로 보내기</h3>
    <div class="form" style="grid-template-columns:1fr 1fr">
      <div class="field"><label>받는 사람 이메일</label><input id="mail_to" placeholder="you@example.com"></div>
      <div class="field"><label>제목</label><input id="mail_subject" placeholder="홍길동 테스트 결과입니다"></div>
    </div>
    <div id="mail_status" class="small muted" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
      <button class="btn-ghost" onclick="closeEmail()">취소</button>
      <button class="btn btn-primary" onclick="sendEmail()">보내기</button>
    </div>
  </div>
</div>

<script>
/* ===== 연결값(시트/폼) ===== */
const SHEET_ID   = '14VLQBhDJtduxjCnfr7VEOstZ5ez8-CX3ArXy1OvYCQg';
const GVIZ_URL   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Questions&tqx=out:json`;
const FORM_ACTION= 'https://docs.google.com/forms/d/e/1FAIpQLSeRWq5YKN50zL0simiaQA6EBRsn6VXN__ZmLplAgDz1I1hyQA/formResponse';

/* 폼 항목 매핑 */
const F = {
  child_name:'entry.684468179',
  age:'entry.1066070471',
  grade:'entry.1812672802',
  guardian:'entry.1666083184',
  phone:'entry.89824848',
  campus:'entry.490719219',
  answers:'entry.85364862',
  scores:'entry.1455508168',
  top3:'entry.2120338430',
  resultId:'entry.532514127',
  timestamp:'entry.1261684833'
};

const ASSET_BASE = '/public/img';
const DOMAINS = ["관찰력","색감각","서사력","공간감","디테일","도전성","소통력","꾸준성"];
const STEPS = [{key:'start',label:'시작'},{key:'consent',label:'동의'},{key:'profile',label:'프로필'},{key:'test',label:'테스트'},{key:'result',label:'결과'}];
const STATE = { step:'start', consent:false, profile:{}, questions:[], idx:0, answers:[], result:null };

const $=id=>document.getElementById(id);
const app=()=>$('app');

/* NAV + Progress */
function renderNav(){
  const cur = STEPS.findIndex(s=>s.key===STATE.step);
  $('topnav').innerHTML = STEPS.map((s,i)=>`<div class="step ${s.key===STATE.step?'active':''} ${cur>i?'done':''}" onclick="navGo('${s.key}')"><span class="num">${i+1}</span><span>${s.label}</span></div>`).join('');
}
function updateTopProgress(){
  if(STATE.step==='test' && STATE.questions.length){
    const q = Math.round((STATE.idx)/STATE.questions.length*100);
    $('topbar').style.width=q+'%'; $('statusline').textContent=`테스트 진행 ${STATE.idx+1}/${STATE.questions.length} (${q}%)`;
    $('sideLeft').style.display='block'; $('sideRight').style.display='block'; return;
  }
  $('sideLeft').style.display='none'; $('sideRight').style.display='none';
  let pct = (STEPS.findIndex(s=>s.key===STATE.step))/(STEPS.length-1)*100;
  $('topbar').style.width=Math.round(pct)+'%'; $('statusline').textContent=`진행률 ${Math.round(pct)}%`;
}
function navGo(step){ STATE.step=step; if(step==='test' && STATE.questions.length===0){ startTest(); return; } render(); }

/* GViz 파서 */
function parseGViz(text){ const s=text.indexOf('{'), e=text.lastIndexOf('}'); if(s<0||e<0) return []; const obj=JSON.parse(text.slice(s,e+1)); const cols=obj.table.cols.map(c=>c.label); return obj.table.rows.map(r=>r.c.map(c=>c?(c.f??c.v):'')).map(a=>Object.fromEntries(cols.map((k,i)=>[k,a[i]]))); }
async function loadQuestions(){
  try{
    const txt=await (await fetch(GVIZ_URL)).text(); const rows=parseGViz(txt)||[];
    const act=rows.filter(r=>String(r.active).toUpperCase()==='TRUE').sort((a,b)=>(+a.order - +b.order));
    if(act.length){
      STATE.questions=act.map(r=>{
        const mkWeights = (k)=>{ try{ return JSON.parse(r[`${k}_weights`]) || {}; } catch{ return {}; } };
        const mkOpt = (k)=>({
          key:k,
          label:(r[`${k}_label`]||'').trim(),
          imageUrl:(r[`${k}_image`]||'').trim(),
          weights: mkWeights(k)
        });
        const opts = ['A','B','C','D'].map(mkOpt).filter(o=>{
          const hasLabel = o.label.length>0;
          const hasImage = o.imageUrl.length>0;
          const hasWeight = Object.values(o.weights||{}).some(v=>Number(v||0)!==0);
          return hasLabel || hasImage || hasWeight;
        });
        const safeOpts = opts.length>=2 ? opts : ['A','B'].map(mkOpt);
        return { id: r.id || `q${r.order}`, order:+r.order, prompt:r.prompt || '', options:safeOpts };
      });
      return;
    }
  }catch(e){}
  STATE.questions = localQuestions();
}

/* ===== 시작 화면 ===== */
function startScreen(){
  return `<div class="center">
    <h1 class="heroTitle">바른미술학원 · 미술적성테스트 V1. BASIC</h1>
    <p class="muted" style="font-size:16px">아이의 미술 흥미·성향을 간편하게 파악하고, 도움이 되는 교육 포인트를 제시합니다.</p>

    <div class="features">
      ${[
        {icon:'⚡',title:'빠른 테스트',desc:'6~8분 내 완료되는 간편한 테스트'},
        {icon:'💡',title:'맞춤 분석',desc:'개인별 강점과 교육 포인트 제시'},
        {icon:'📱',title:'즉시 결과',desc:'문자/이메일로 결과를 바로 받아보세요'}
      ].map(f=>`
        <div class="feature-card">
          <div class="feature-icon">${f.icon}</div>
          <div style="font-weight:900">${f.title}</div>
          <div class="small muted" style="margin-top:6px">${f.desc}</div>
        </div>`).join('')}
    </div>

    <div class="cta">
      <h3>지금 바로 테스트해보세요</h3>
      <p>아이의 미술 재능과 성향을 발견하는 첫 걸음을 시작하세요</p>
      <button class="btn btn-xl" id="startBtn">테스트 시작하기 →</button>
    </div>
  </div>`;
}
function viewStart(){
  app().innerHTML=startScreen();
  $('startBtn').onclick=()=>navGo('consent');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ===== 동의서 ===== */
function accItem(t,html){ return `<div class="acc-item open"><div class="acc-head"><span>${t}</span><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div class="acc-body small">${html}</div></div>`;}
function viewConsent(){
  app().innerHTML=`<h2 class="center">개인정보 수집·이용 동의서</h2>
  <p class="muted small center"><b>교육 가이드</b> 목적이며, 의학/임상 진단이 아닙니다.</p>
  <div class="acc">
    ${accItem('<b>1) 목적</b>','① 테스트 제공 및 결과 산출 ② 결과 안내·PDF 저장 지원 ③ 상담 품질 개선')}
    ${accItem('<b>2) 수집 항목</b>','아동 이름·나이·학년 / 보호자 이름·연락처 / 응답 내용 (이메일은 선택)')}
    ${accItem('<b>3) 보관 기간</b>','수집일로부터 <b>12개월</b> 보관 후 파기')}
    ${accItem('<b>4) 보관/처리</b>','Google Forms/Sheets에 저장·처리')}
    ${accItem('<b>5) 권리</b>','동의 거부 가능(거부 시 서비스 제한 가능)')}
    ${accItem('<b>6) 문의</b>','barunart1004@gmail.com')}
  </div>

  <div class="card" style="margin-top:16px">
    <div class="badge">필수 항목 모두 동의해 주세요</div>
    <div style="display:flex;gap:18px;align-items:center;margin-top:10px;flex-wrap:wrap">
      <label style="display:flex;gap:12px;align-items:center"><input type="checkbox" id="chk_required" style="width:20px;height:20px;accent-color:#FFB98A"> (필수) 개인정보 수집·이용에 <b>동의합니다</b>.</label>
      <label style="display:flex;gap:12px;align-items:center"><input type="checkbox" id="chk_minor" style="width:20px;height:20px;accent-color:#FFB98A"> (필수) 만 14세 미만 아동의 법정대리인으로서 <b>동의합니다</b>.</label>
    </div>
    <div class="center" style="margin-top:16px">
      <button class="btn" id="btn_consent" disabled>동의하고 진행</button>
    </div>
  </div>`;
  const validate=()=>{ $('btn_consent').disabled=!( $('chk_required').checked && $('chk_minor').checked ); };
  $('chk_required').addEventListener('change',validate);
  $('chk_minor').addEventListener('change',validate);
  $('btn_consent').onclick=()=>{ STATE.consent=true; navGo('profile'); };
  document.querySelectorAll('.acc-head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
}

/* ===== 프로필 ===== */
const AGE_TO_GRADE = {7:'초등학교 1학년',8:'초등학교 2학년',9:'초등학교 3학년',10:'초등학교 4학년',11:'초등학교 5학년',12:'초등학교 6학년'};
const GRADE_TO_AGE = Object.fromEntries(Object.entries(AGE_TO_GRADE).map(([a,g])=>[g,a]));
const CAMPUSES = ['압구정[본원]','반포 캠퍼스','한남 캠퍼스','방배 캠퍼스','목동 캠퍼스','송파 캠퍼스','서대문 캠퍼스','일산 캠퍼스','탄현 캠퍼스','김포 캠퍼스','송도 캠퍼스','부산 캠퍼스'];

function viewProfile(){
  app().innerHTML=`<h2 class="center">프로필 정보</h2>
  <div class="form" style="margin-top:8px">
    <div class="field"><label>아동 이름</label><input id="cname" placeholder="예: 홍길동"></div>
    <div class="field"><label>보호자 이름</label><input id="gname" placeholder="예: 김보호자"></div>

    <div class="field"><label>나이</label><select id="age">${[7,8,9,10,11,12].map(a=>`<option value="${a}">${a}</option>`).join('')}</select></div>
    <div class="field"><label>학년</label><select id="grade">${Object.values(AGE_TO_GRADE).map(g=>`<option>${g}</option>`).join('')}</select></div>

    <div class="field" style="grid-column:1 / span 2"><label>연락처</label><input id="phone" placeholder="010-0000-0000"></div>
    <div class="field"><label>캠퍼스</label><select id="campus">${CAMPUSES.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>
    <div class="field"><label>이메일(선택, 결과지 전송용)</label><input id="email" placeholder="example@email.com"></div>
  </div>
  <div class="center" style="margin-top:18px"><button class="btn btn-mint" id="btn_starttest">테스트 시작</button></div>`;
  $('age').addEventListener('change',e=>{ $('grade').value = AGE_TO_GRADE[e.target.value]; });
  $('grade').addEventListener('change',e=>{ $('age').value = GRADE_TO_AGE[e.target.value]; });
  $('btn_starttest').onclick=startTest;
}

async function startTest(){
  STATE.profile={
    child_name:$('cname').value.trim(),
    guardian:$('gname').value.trim(),
    age:$('age').value,
    grade:$('grade').value,
    phone:$('phone').value.trim(),
    email:$('email').value.trim(),
    campus:$('campus').value
  };
  if(!STATE.profile.child_name){ alert('아동 이름을 입력해 주세요'); return; }
  if(!/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(STATE.profile.phone||'')){ alert('연락처 형식(010-0000-0000)을 확인해 주세요'); return; }
  await loadQuestions(); STATE.idx=0; STATE.answers=[]; STATE.step='test'; render();
}

/* ===== 테스트 ===== */
function pcGridClassFor(optsCount){
  if (window.matchMedia('(min-width:1024px)').matches){
    return optsCount===2 ? 'test-grid-2' : 'test-grid-4';
  }
  return 'grid grid-2';
}
function optionImageUrl(q, o){
  if (o.imageUrl) return o.imageUrl;
  const num = Number(q.order)|| (STATE.idx+1);
  return `${ASSET_BASE}/${num}-${o.key}.png`;
}
function viewTest(){
  const q=STATE.questions[STATE.idx]; if(!q){ app().innerHTML='<h3 class="center">문항을 불러오지 못했습니다. 관리자에 문의해 주세요.</h3>'; return; }
  const gridCls = pcGridClassFor(q.options.length);
  app().innerHTML=`<div style="display:flex;align-items:center;gap:10px;justify-content:center" class="small muted">
      <span class="badge">Q ${STATE.idx+1} / ${STATE.questions.length}</span>
    </div>
    <h2 class="center" style="margin-top:6px">${q.prompt||''}</h2>
    <div class="${gridCls}" style="margin-top:8px">
      ${q.options.map(o=>`<div class="opt" id="opt_${o.key}" tabindex="0" role="button" aria-label="${o.label||o.key}" data-key="${o.key}">
        <img src="${optionImageUrl(q,o)}" alt="${o.label||o.key}" onerror="this.style.opacity=.2" loading="lazy">
        <div class="cap center">${o.label||o.key}</div>
      </div>`).join('')}
    </div>
    <div class="center" style="margin-top:16px;display:flex;gap:10px;justify-content:center">
      <button class="btn-ghost" id="btn_prev" ${STATE.idx===0?'disabled':''}>이전</button>
      <button class="btn" id="btn_next" disabled>다음</button>
    </div>`;
  q.options.forEach(o=>{
    const el = document.getElementById(`opt_${o.key}`);
    el.onclick = ()=>choose(o.key);
    el.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' ') choose(o.key); };
  });
  $('btn_prev').onclick=prev;
  $('btn_next').onclick=next;
}
function choose(key){
  const q=STATE.questions[STATE.idx];
  q.options.forEach(k=>{const n=document.getElementById(`opt_${k.key}`); if(n) n.classList.remove('sel');});
  const node=document.getElementById(`opt_${key}`); if(node){ node.classList.add('sel'); node.animate([{transform:'scale(1)'},{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:160}); }
  const opt=q.options.find(o=>o.key===key);
  STATE.answers[STATE.idx]={ qid:q.id, key, weights:opt.weights||{} };
  $('btn_next').disabled=false;
}
function next(){
  if(STATE.step!=='test') return;
  if(!STATE.answers[STATE.idx]){ alert('하나를 선택해 주세요'); return; }
  if(STATE.idx<STATE.questions.length-1){ STATE.idx++; render(); }
  else{ submitAllSafe(); }
}
function prev(){ if(STATE.idx>0){ STATE.idx--; render(); } }

document.addEventListener('keydown',(e)=>{
  if(STATE.step!=='test') return;
  if(e.key==='ArrowRight'){ next(); }
  if(e.key==='ArrowLeft'){ prev(); }
  if(e.key==='Enter'){ if(!$('btn_next').disabled) next(); }
});

/* ===== 점수/멘트 ===== */
function aggregateScores(ans){
  const sum={}; DOMAINS.forEach(d=>sum[d]=0);
  ans.forEach(a=>Object.entries(a.weights||{}).forEach(([k,v])=>sum[k]=(sum[k]||0)+Number(v||0)));
  const n=ans.length||1; const raw={};
  DOMAINS.forEach(d=>{ const v=(sum[d]||0)/n*4; raw[d]=Math.max(0,Math.round(v*10)/10); });
  return raw;
}
const adjust=v=>Math.round((2 + v/2) * 10)/10;
function band(v){ if(v>=3.6) return 'S'; if(v>=3.2) return 'A'; if(v>=2.8) return 'A-'; if(v>=2.4) return 'B+'; if(v>=2.0) return 'B'; if(v>=1.6) return 'B-'; if(v>=1.0) return 'C+'; return 'C'; }
const DETAIL = {
  '관찰력':(n)=>`${n}님은 대상의 특징을 캐치하는 눈이 좋아요. 작은 변화도 포착해 표현의 밀도를 높입니다.`,
  '색감각':(n)=>`${n}님은 색의 분위기를 읽고 조합하는 감이 탁월합니다. 미묘한 톤 차이도 안정적으로 다룹니다.`,
  '서사력':(n)=>`${n}님은 장면 속에 이야기를 심는 데 강점이 있어요. 감정과 사건을 자연스럽게 연결합니다.`,
  '공간감':(n)=>`${n}님은 원근·스케일을 활용해 입체감을 살립니다. 장면의 깊이를 안정적으로 구성합니다.`,
  '디테일':(n)=>`${n}님은 마감과 질감 표현이 섬세해요. 작품 완성도를 올리는 집중력이 강점입니다.`,
  '도전성':(n)=>`${n}님은 새로운 도구와 방식에 두려움이 적어요. 실험적인 프로젝트에서 성장 속도가 빠릅니다.`,
  '소통력':(n)=>`${n}님은 의도를 언어로 풀어내는 힘이 좋아요. 발표·비평 활동에서 설득력이 있습니다.`,
  '꾸준성':(n)=>`${n}님은 루틴을 유지하며 완성까지 밀어붙이는 힘이 돋보입니다. 학습 지속력이 강합니다.`
};
const PRAISE = {
  'S':k=>`와, ${k}에서 <b>타고난 재능</b>이 돋보입니다.`,
  'A':k=>`${k} 감각이 <b>뛰어납니다</b>.`,
  'A-':k=>`${k} 실력이 <b>탄탄</b>합니다.`,
  'B+':k=>`${k}이 안정적입니다.`,
  'B':k=>`${k} 기본기가 좋습니다.`
};
const MISSIONS={
  '관찰력':['집 안 사물 3개 5분 관찰스케치'],
  '색감각':['한정 팔레트 3색으로 소품 칠하기'],
  '서사력':['3컷 만화로 오늘 사건'],
  '공간감':['앞-중-뒤 나눠 배치하기'],
  '디테일':['재질 3종(금속/천/나무) 표현'],
  '도전성':['새 도구 1개 체험 기록'],
  '소통력':['작가노트 3문장 쓰기'],
  '꾸준성':['5일 연속 15분 체크']
};

/* ===== 제출 & 결과 ===== */
function nowKST(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())} KST`; }

async function submitAllSafe(){
  const raw=aggregateScores(STATE.answers);
  const scores=Object.fromEntries(Object.entries(raw).map(([k,v])=>[k,adjust(v)]));
  const top3=Object.keys(scores).sort((a,b)=>scores[b]-scores[a]).slice(0,3);
  const resultId=crypto.randomUUID();

  const form=new FormData();
  form.append(F.child_name,STATE.profile.child_name); form.append(F.age,STATE.profile.age); form.append(F.grade,STATE.profile.grade);
  form.append(F.guardian,STATE.profile.guardian); form.append(F.phone,STATE.profile.phone); form.append(F.campus,STATE.profile.campus||'');
  form.append(F.answers,JSON.stringify({profile:STATE.profile,questions:STATE.answers,top3}));
  form.append(F.scores,JSON.stringify(scores));
  form.append(F.top3,top3.join(','));
  form.append(F.resultId,resultId);
  form.append(F.timestamp,nowKST());
  try{ await fetch(FORM_ACTION,{method:'POST',mode:'no-cors',body:form}); }catch(e){}

  STATE.result={scores,top3,resultId}; STATE.step='result'; render();
}

let CHARTS=[];
function destroyCharts(){ CHARTS.forEach(c=>c.destroy?.()); CHARTS=[]; }

/* 전문가(종합) 섹션 */
function expertSection(childName, scores, top3){
  return `
    <div class="section-title">🧾 전문가 평가 및 이론적 배경</div>
    ${top3.map((k,i)=>`
      <div class="expert-wrap">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <div class="badge">${i+1}. ${k}</div>
          <span class="small muted">현재 수준: <b>${(scores[k]||0).toFixed(1)}</b></span>
          <span class="tag-blue">강점 영역</span>
        </div>
        <div class="expert-grid">
          <div class="card-lite">
            <div style="font-weight:900;margin-bottom:6px">📍 이론적 근거</div>
            <p class="small">${k}은(는) 작품의 완성도와 표현력을 결정하는 중요한 지표입니다.</p>
          </div>
          <div class="card-lite" style="background:#F8F1FF">
            <div style="font-weight:900;margin-bottom:6px;color:#7c3aed">👩‍⚕️ 전문가 의견</div>
            <p class="small">“${childName}은(는) <b>${k}</b>에서 돋보이며, 창의적 사고력과 표현의 균형이 좋습니다.”</p>
          </div>
          <div class="card-lite">
            <div style="font-weight:900;margin-bottom:6px">⬆ 발달 방향</div>
            <p class="small">루틴 속 실험을 늘리고 작은 완성을 자주 만드는 학습 패턴을 추천합니다.</p>
          </div>
          <div class="card-lite"></div>
        </div>
      </div>
    `).join('')}
  `;
}

function viewResult(){
  const r=STATE.result, s=r?.scores||{};
  const overall = Math.round((Object.values(s).reduce((a,b)=>a+(+b||0),0))*10)/10 || 0;
  const T = r.top3;
  const summary = `${STATE.profile.child_name}님은 <b>${T[0]}</b>를 중심으로 <b>${T[1]}</b>, <b>${T[2]}</b>에서 강점이 뚜렷합니다.`;

  app().innerHTML=`<div id="resultCard">
    <div class="block callout center">
      <div class="chip" style="margin:0 auto 8px;display:inline-block">테스트 완료</div>
      <h2 style="margin:0 0 10px"><b>${STATE.profile.child_name}</b>님, 멋진 집중력이었습니다!</h2>
      <div class="kpi" style="justify-content:center"><div class="num" style="font-size:52px">${overall.toFixed(1)}</div><div class="unit">/ 32 (8영역 합산)</div></div>
      <div class="chips" style="margin-top:10px;justify-content:center">${r.top3.map(t=>`<span class="chip">뛰어난 영역: ${t}</span>`).join('')}</div>
    </div>

    <div class="result-row">
      <div class="block"><h3 class="center">영역별 관심도(레이다)</h3><canvas id="radar" height="220"></canvas></div>
      <div class="block"><h3 class="center">뛰어난 영역(막대)</h3><canvas id="bars" height="220"></canvas></div>
    </div>

    <div class="block">
      <h3>총평</h3>
      <p class="small" style="color:#0f172a;line-height:1.7">${summary}</p>
    </div>

    <div class="block">
      <h3>항목별 해석 & 일일 15분 훈련</h3>
      <div class="form" style="grid-template-columns:1fr 1fr">
        ${DOMAINS.map(k=>{
          const v=+(s[k]||0), b=band(v), w=Math.min(100,(v/4)*100);
          const mission = (MISSIONS[k]||[])[0] || '관찰·스케치 1장';
          return `<div class="card-lite">
            <div style="display:flex;justify-content:space-between;align-items:flex-end">
              <strong>${k}</strong>
              <div class="kpi"><div class="num" style="font-size:26px">${v.toFixed(1)}</div><div class="unit">/ 4.0</div></div>
            </div>
            <div class="topprogress" style="height:10px;margin:8px 0 10px"><div style="width:${w}%;height:100%;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE)"></div></div>
            <div class="small" style="color:#0f172a">${DETAIL[k](STATE.profile.child_name)}</div>
            <div class="small" style="margin-top:4px">오늘의 15분: <b>${mission}</b> — 등급 ${b}</div>
          </div>`;
        }).join('')}
      </div>
    </div>

    ${expertSection(STATE.profile.child_name, s, T)}

    <p class="credit">※ 본 결과는 교육 가이드 목적이며 의학·임상 진단이 아닙니다.</p>
  </div>

  <div class="center no-print" style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button class="btn-ghost" onclick="STATE.step='start'; render()">처음으로</button>
    <button class="btn btn-mint" id="btn_pdf">PDF 저장</button>
    <button class="btn btn-primary" id="btn_email">이메일로 보내기</button>
  </div>`;

  // 차트
  destroyCharts();
  const rctx=document.getElementById('radar').getContext('2d');
  CHARTS.push(new Chart(rctx,{type:'radar',
    data:{labels:DOMAINS, datasets:[{data:DOMAINS.map(k=>s[k]||0), borderColor:'#FF8C3A', backgroundColor:'rgba(255,140,58,.22)', borderWidth:2, pointRadius:2, fill:true}]},
    options:{animation:false, scales:{r:{suggestedMin:0,suggestedMax:4,ticks:{stepSize:1},grid:{color:'#eef2f7'},angleLines:{color:'#eef2f7'}}}, plugins:{legend:{display:false}}}
  }));
  const bctx=document.getElementById('bars').getContext('2d');
  CHARTS.push(new Chart(bctx,{type:'bar',
    data:{labels:r.top3, datasets:[{data:r.top3.map(k=>s[k]||0), borderRadius:10, borderSkipped:false, backgroundColor:['#FFD9BE','#E6E2FF','#CFF7EE']}]},
    options:{animation:false, scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{stepSize:1},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}, plugins:{legend:{display:false}}}
  }));

  $('btn_pdf').onclick = savePDF;
  $('btn_email').onclick = openEmail;
}

/* ===== PDF 저장 ===== */
async function savePDF(){
  document.documentElement.classList.add('pdf-mode');
  // 차트 → 이미지로 교체
  const replaced = [];
  CHARTS.forEach((c)=>{
    const canvas = c.canvas;
    const img = new Image();
    img.src = c.toBase64Image();
    img.style.width = canvas.style.width || '100%';
    img.style.height = canvas.style.height || '220px';
    img.className = 'chart-export';
    canvas.parentNode.insertBefore(img, canvas);
    canvas.style.display='none';
    replaced.push({canvas,img});
  });

  const node = $('app');
  const opt = {
    filename: `${STATE.profile.child_name}_미술적성_결과.pdf`,
    margin: [10,10,10,10],
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, background:'#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['css','legacy'] }
  };
  await html2pdf().from(node).set(opt).save();

  // 복구
  replaced.forEach(({canvas,img})=>{ img.remove(); canvas.style.display=''; });
  document.documentElement.classList.remove('pdf-mode');
}

/* ===== 이메일 전송 ===== */
function openEmail(){
  $('mail_subject').value = `${STATE.profile.child_name} 테스트 결과입니다`;
  $('mail_to').value = STATE.profile.email || '';
  $('mail_status').textContent='';
  $('emailModal').style.display='flex';
}
function closeEmail(){ $('emailModal').style.display='none'; }

async function sendEmail(){
  const to = $('mail_to').value.trim();
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(to)){ $('mail_status').textContent='올바른 이메일 주소를 입력해 주세요.'; return; }

  document.documentElement.classList.add('pdf-mode');
  const node = $('app');
  const opt = {
    margin: [10,10,10,10],
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, background:'#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
  };
  const dataUri = await html2pdf().from(node).set(opt).outputPdf('datauristring');
  document.documentElement.classList.remove('pdf-mode');

  const base64 = dataUri.split(',')[1];
  $('mail_status').textContent='전송 중…';

  try{
    const res = await fetch('/.netlify/functions/send-email', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        to,
        subject:$('mail_subject').value.trim() || `${STATE.profile.child_name} 테스트 결과입니다`,
        fileName:`${STATE.profile.child_name}_결과.pdf`,
        pdfBase64: base64,
        childName: STATE.profile.child_name,
        campus: STATE.profile.campus
      })
    });
    const data = await res.json();
    if(!res.ok){ throw new Error(data?.error || '전송 실패'); }
    $('mail_status').textContent='전송 성공!';
    setTimeout(closeEmail, 900);
  }catch(e){
    $('mail_status').textContent='전송 실패: ' + e.message;
  }
}

/* ===== Router ===== */
function render(){ renderNav(); updateTopProgress();
  if(STATE.step==='start') return viewStart();
  if(STATE.step==='consent') return viewConsent();
  if(STATE.step==='profile') return viewProfile();
  if(STATE.step==='test') return viewTest();
  if(STATE.step==='result') return viewResult();
}
render();

/* ===== Fallback 문항 ===== */
function W(w){ const o={}; DOMAINS.forEach(k=>o[k]=0); Object.entries(w).forEach(([k,v])=>o[k]=v); return o; }
function localQuestions(){
  const S=(q,p,a,b,c,d)=>({id:q,order:+q.replace('q',''),prompt:p,options:[
    {key:'A',label:a[0],imageUrl:a[1],weights:W(a[2])},
    {key:'B',label:b[0],imageUrl:b[1],weights:W(b[2])},
    {key:'C',label:c[0],imageUrl:c[1],weights:W(c[2])},
    {key:'D',label:d[0],imageUrl:d[1],weights:W(d[2])},
  ]});
  const IMG=(kw)=>`https://images.unsplash.com/photo-150${Math.floor(Math.random()*899+100)}?auto=format&fit=crop&w=1000&q=70&${encodeURIComponent(kw)}`;

  return [
    S('q1','새로운 미술 도구를 발견했어요! 무엇을 먼저 해볼까요?',
      ['설명서를 꼼꼼히 읽어본다', IMG('paper'), {디테일:1, 꾸준성:0.6}],
      ['종이에 탐색·실험한다', IMG('sketch'), {도전성:1}],
      ['친구들과 아이디어 나눈다', IMG('kids'), {소통력:1, 서사력:0.6}],
      ['가장 특이한 결과 상상', IMG('idea'), {도전성:1, 서사력:0.5}]
    ),
    S('q2','그림에 어떤 이야기를 담고 싶나요?',
      ['모험 이야기', IMG('adventure'), {서사력:1}],
      ['감정을 색과 형태로', IMG('abstract'), {색감각:0.8, 서사력:0.6}],
      ['현실 건물 새로 디자인', IMG('architecture'), {공간감:1, 디테일:0.4}],
      ['작은 생명체의 숨은 세계', IMG('mini world'), {관찰력:0.8, 서사력:0.6}]
    ),
    S('q3','두 그림 중 색이 더 조화로운 것은?',
      ['조화로운 팔레트', IMG('palette'), {색감각:1}],
      ['대비 강한 팔레트', IMG('contrast'), {도전성:0.6}],
      ['파스텔 편안함', IMG('pastel'), {색감각:0.8}],
      ['강한 보색', IMG('vivid'), {도전성:0.6}]
    ),
    S('q4','그리다 실수를 했어요. 어떻게 할까요?',
      ['지우고 다시 그린다', IMG('erase'), {디테일:0.8, 꾸준성:0.8}],
      ['실수를 작품 일부로 바꾼다', IMG('mix'), {도전성:0.6}],
      ['쉬고 재도전·완성', IMG('focus'), {꾸준성:1}],
      ['도움을 요청', IMG('help'), {소통력:0.8}]
    ),
    S('q5','미술관에서 무엇을 오래 보나요?',
      ['빛/그림자 분위기', IMG('light'), {공간감:0.6, 색감각:0.6}],
      ['숨겨진 작은 요소', IMG('detail'), {관찰력:0.8, 디테일:0.8}],
      ['작가의 마음 상상', IMG('emotion'), {서사력:0.7, 소통력:0.4}],
      ['재료/기법이 궁금', IMG('material'), {도전성:0.6, 관찰력:0.6}]
    ),
    S('q6','미래의 도시를 그린다면, 어떻게 시작할까요?',
      ['사진 조사·계획', IMG('city plan'), {디테일:0.7, 공간감:0.8}],
      ['아무도 본 적 없는 건물', IMG('scifi'), {도전성:1}],
      ['아이디어 모으기', IMG('team'), {소통력:0.8}],
      ['재료 실험', IMG('paint'), {도전성:0.8, 색감각:0.5}]
    ),
    S('q7','친구가 슬퍼 보여요. 어떤 그림을 그려줄까요?',
      ['귀여운 동물', IMG('cute'), {서사력:0.5}],
      ['추상적 감정', IMG('blue'), {색감각:0.6}],
      ['즐거운 추억', IMG('memory'), {서사력:0.8, 소통력:0.5}],
      ['밝고 희망찬 그림', IMG('bright'), {색감각:0.7}]
    ),
    S('q8','편안한 색 조합은?',
      ['따뜻한 계열', IMG('warm'), {색감각:0.8}],
      ['차가운 계열', IMG('cool'), {색감각:0.8}],
      ['보색 대비', IMG('complementary'), {도전성:0.6}],
      ['파스텔', IMG('pastel soft'), {색감각:0.8}]
    ),
    S('q9','잘 안될 때 몇 번 시도할까요?',
      ['바꾼다', IMG('switch'), {도전성:0.4}],
      ['몇 번 후 포기', IMG('try'), {꾸준성:0.5}],
      ['될 때까지 + 도움요청', IMG('keep'), {꾸준성:1, 소통력:0.5}],
      ['원인 분석·새 방법', IMG('analyze'), {도전성:0.6}]
    ),
    S('q10','이 그림에서 가장 눈에 띄는 것은?',
      ['전체 구도', IMG('layout'), {공간감:0.9}],
      ['작은 패턴/질감', IMG('texture'), {디테일:0.9}],
      ['인물 표정/감정', IMG('face'), {서사력:0.7}],
      ['독특한 재료/기법', IMG('tech'), {도전성:0.7}]
    ),
    S('q11','내 그림의 제목은?',
      ['보이는 대로', IMG('see'), {관찰력:0.6}],
      ['상상을 부르는 제목', IMG('title'), {서사력:0.9, 소통력:0.5}],
      ['기분 좋아지는 제목', IMG('happy'), {서사력:0.3}],
      ['색/형태 강조', IMG('shape'), {색감각:0.7, 디테일:0.5}]
    ),
    S('q12','세상에 없는 동물, 어떤 동물?',
      ['섞어서 만든 동물', IMG('hybrid'), {관찰력:0.6, 디테일:0.6}],
      ['완전히 새로운 형태', IMG('new'), {도전성:0.9}],
      ['감정 표현·대화', IMG('talk'), {서사력:0.7, 소통력:0.6}],
      ['특별한 재료로 꾸미기', IMG('craft'), {색감각:0.6, 디테일:0.6}]
    ),
    S('q13','그림을 보여줄 때 듣고 싶은 말은?',
      ['칭찬', IMG('praise'), {}],
      ['구체적 조언', IMG('advice'), {}],
      ['이야기가 떠올라', IMG('story'), {}],
      ['재료가 궁금', IMG('curious'), {}]
    ),
    S('q14','두 풍경 중 더 안정적인 구도는?',
      ['균형 잡힌 구도', IMG('balance'), {공간감:0.9}],
      ['치우친 구도', IMG('tilt'), {도전성:0.4}],
      ['다채로운 색 배치', IMG('colors'), {색감각:0.5}],
      ['전경-중경-후경', IMG('depth'), {공간감:0.6}]
    ),
    S('q15','답답할 때 어떤 생각을 하나요?',
      ['재능이 없나…', IMG('sad'), {꾸준성:0.2}],
      ['조금만 더! 자신감', IMG('cheer'), {꾸준성:0.9}],
      ['다른 방법 떠올리기', IMG('newway'), {도전성:0.6}],
      ['완성 상상으로 동기', IMG('finish'), {서사력:0.5, 꾸준성:0.7}]
    )
  ];
}
</script>
</body>
</html>
