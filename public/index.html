<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°”ë¥¸ë¯¸ìˆ í•™ì› Â· ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --ink:#0f172a; --muted:#6b7280;
  --bg1:#fff7f1; --bg2:#f7f3ff;
  --card:#ffffff; --line:#eef2f7;
  --o1:#FFE6CF; --o2:#FFD9BE; --o3:#FFC9A3; --o4:#FFB98A;
  --mint:#CFF7EE; --vio:#E6E2FF;
  --radius:22px; --shadow:0 18px 60px rgba(16,24,40,.12); --soft:0 12px 30px rgba(16,24,40,.08);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:"Pretendard",ui-sans-serif,system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial;
  background:
   radial-gradient(900px 600px at 10% -10%, var(--vio), transparent 55%),
   radial-gradient(900px 600px at 90% 110%, var(--mint), transparent 55%),
   linear-gradient(180deg,var(--bg1),var(--bg2));
  background-attachment:fixed;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2; pointer-events:none;
  background:linear-gradient(rgba(255,255,255,.82), rgba(255,255,255,.82)), url("/bg.png") center/cover no-repeat fixed;
  filter:saturate(1.02);
}
.container{min-height:100dvh; display:flex; flex-direction:column; align-items:center}
.main{width:100%; max-width:1100px; padding:18px; display:flex; flex-direction:column; gap:16px; margin:0 auto}

/* í—¤ë” & ë„¤ë¹„ */
.header{width:100%; display:flex; justify-content:center}
.brand{width:100%; max-width:1100px; margin-top:10px; display:flex; align-items:center; gap:12px; padding:12px 16px;
  border-radius:999px; background:rgba(255,255,255,.65); backdrop-filter:blur(8px); border:1px solid var(--line); box-shadow:var(--soft)}
.logo{width:28px;height:28px;border-radius:50%;background:conic-gradient(from 0deg,#FFB98A,#FFE6CF,#E6E2FF,#CFF7EE,#FFB98A);animation:spin 9s linear infinite paused}
.brand:hover .logo{animation-play-state:running} @keyframes spin{to{transform:rotate(360deg)}}
.brand span{font-weight:900; letter-spacing:.2px}

.sticky{position:sticky; top:0; z-index:10; backdrop-filter:blur(8px);
  background:rgba(255,255,255,.6); border:1px solid var(--line); border-radius:16px; box-shadow:var(--soft);
  padding:8px 10px; display:flex; flex-direction:column; gap:10px;}
.navbar{display:flex; flex-wrap:wrap; gap:10px; justify-content:center}
.step{display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; cursor:pointer;
  background:#fff; color:#374151; font-weight:850; border:1px solid var(--line); box-shadow:var(--soft); transition:transform .12s}
.step:hover{transform:translateY(-1px)}
.step .num{width:20px;height:20px;border-radius:50%;display:inline-grid;place-items:center;background:#fff;border:1px solid var(--line);font-size:12px}
.step.active{background:linear-gradient(90deg,var(--o1),var(--vio)); color:#111827; box-shadow:0 12px 30px rgba(255,214,176,.28)}
.step.done{background:#f2fffa; border-color:#dff7ef}
.topprogress{height:10px; background:#f6f7fb; border-radius:999px; overflow:hidden}
.topprogress>div{height:100%; width:0; background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE); transition:width .35s ease}
.statusline{font-size:12px; color:#6b7280; text-align:center}

/* ì¹´ë“œ/íƒ€ì´í¬/ë²„íŠ¼ */
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:24px; box-shadow:var(--shadow); animation:fade .35s ease both}
@keyframes fade{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:translateY(0)}}
h1{font-size:34px; margin:0 0 6px} h2{font-size:24px; margin:0 0 10px} h3{font-size:18px; margin:16px 0 8px}
p{margin:8px 0} .small{font-size:13px} .muted{color:var(--muted)} .center{text-align:center}

.btn{
  --bg:linear-gradient(90deg,#FFB98A,#FFD9BE); --glow:rgba(255,185,138,.35);
  background:var(--bg); color:#5a3f2f; border:none; padding:14px 22px; border-radius:16px; font-weight:900; cursor:pointer;
  box-shadow:0 12px 32px var(--glow); transition:transform .08s, filter .2s, box-shadow .2s; position:relative; overflow:hidden}
.btn:hover{transform:translateY(-1px); filter:brightness(1.03)}
.btn:after{content:""; position:absolute; inset:0; background:radial-gradient(120px 120px at var(--x,50%) var(--y,50%), rgba(255,255,255,.6), transparent 40%); opacity:.0; transition:opacity .25s}
.btn:hover:after{opacity:.6}
.btn-ghost{background:#fff; color:#111827; border:1px solid var(--line); padding:12px 14px; border-radius:12px; font-weight:800; cursor:pointer; box-shadow:var(--soft)}
.btn-mint{--bg:linear-gradient(90deg,#FFE6CF,#FFD9BE); --glow:rgba(255,214,190,.4)}

input,select,textarea{width:100%; background:#fff; color:#111; border:1px solid var(--line); border-radius:12px; padding:12px; outline:none}
input:focus,select:focus,textarea:focus{border-color:#FFD9BE; box-shadow:0 0 0 6px rgba(255,217,190,.26)}
label{font-size:14px; color:#374151}
.section{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}

.grid{display:grid; gap:14px}
.grid-2{grid-template-columns:1fr 1fr}
@media (max-width:860px){ .grid-2{grid-template-columns:1fr} }

/* ë³´ê¸° */
.opt{border:2px solid var(--line); border-radius:18px; overflow:hidden; cursor:pointer; background:#fff; box-shadow:var(--soft); transition:transform .12s, border-color .2s}
.opt:hover{transform:translateY(-2px)} .opt img{width:100%; display:block; aspect-ratio:3/2; object-fit:cover}
.opt .cap{padding:10px; color:#374151; font-weight:700} .opt.sel{border-color:#FFD9BE; box-shadow:0 0 0 6px rgba(255,217,190,.25)}

/* PC - í•œ í™”ë©´ 4ê°œ + ì‚¬ì´ë“œ ë²„íŠ¼ */
@media (min-width:1024px){
  .test-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:14px}
  .opt img{aspect-ratio:4/3}
  .sideNav{position:fixed; top:50%; transform:translateY(-50%); z-index:20}
  .sideNav.left{left:18px} .sideNav.right{right:18px}
  .sideBtn{background:linear-gradient(90deg,#fff,#FFF4EC); border:1px solid var(--line); width:46px; height:46px; border-radius:50%; display:grid; place-items:center; box-shadow:0 12px 26px rgba(16,24,40,.08); cursor:pointer; font-weight:900}
  .sideBtn:hover{transform:translateY(-1px)}
}
@media (max-width:1023px){ .sideNav{display:none} }

/* ì•„ì½”ë””ì–¸ Â· ê²°ê³¼ ë¸”ë¡ */
.acc{border-radius:14px; overflow:hidden; border:1px solid var(--line)}
.acc-item{border-top:1px solid var(--line)}
.acc-head{padding:14px 16px; background:#FFF4EC; cursor:pointer; display:flex; justify-content:space-between; align-items:center}
.acc-body{padding:14px 16px; display:none; background:#fff}
.acc-item.open .acc-body{display:block}
.block{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(16,24,40,.06);page-break-inside:avoid}
.block h3{margin:0 0 10px}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#5a3f2f;border:1px solid #ffe8d6;padding:8px 12px;border-radius:999px;font-weight:900}
.kpi{display:flex;align-items:flex-end;gap:10px}
.kpi .num{font-size:44px;font-weight:900;line-height:1}
.kpi .unit{font-size:14px;color:#6b7280}
.callout{position:relative;background:linear-gradient(135deg,#FFF2E6,#F8FBFF);padding:22px;border-radius:18px;border:1px solid var(--line);box-shadow:0 12px 34px rgba(255,185,138,.25)}
.callout:before{content:"";position:absolute;inset:-1px;border-radius:18px;padding:1px;background:linear-gradient(90deg,#FFD9BE,#E6E2FF,#CFF7EE);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
.credit{font-size:12px;color:#6b7280;text-align:center}
.skel{border-radius:12px; background:linear-gradient(90deg,#f3f4f6,#eaeef3,#f3f4f6); background-size:200% 100%; animation:sh 1.2s infinite}@keyframes sh{to{background-position:-200% 0}}

.checkRow{display:flex;gap:16px;align-items:center;flex-wrap:wrap}

/* ì¸ì‡„ */
@media print{
  .header,.sticky,.btn,.btn-ghost,.sideNav{display:none !important}
  .card{box-shadow:none;border:1px solid #ddd}
  .block{break-inside:avoid-page}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand"><div class="logo"></div><span>ë°”ë¥¸ë¯¸ìˆ í•™ì› Â· ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸</span></div>
  </div>

  <main class="main">
    <div class="sticky">
      <nav class="navbar" id="topnav"></nav>
      <div class="topprogress"><div id="topbar"></div></div>
      <div class="statusline" id="statusline">ì§„í–‰ë¥  0%</div>
    </div>
    <section class="card" id="app"></section>
  </main>
</div>

<div class="sideNav left" id="sideLeft" style="display:none"><button class="sideBtn" onclick="prev()" aria-label="ì´ì „">â€¹</button></div>
<div class="sideNav right" id="sideRight" style="display:none"><button class="sideBtn" onclick="next()" aria-label="ë‹¤ìŒ">â€º</button></div>

<script>
/* ===== ì—°ê²°ê°’(ì‹œíŠ¸/í¼) ===== */
const SHEET_ID   = '14VLQBhDJtduxjCnfr7VEOstZ5ez8-CX3ArXy1OvYCQg';
const FORM_ACTION= 'https://docs.google.com/forms/d/e/1FAIpQLSeRWq5YKN50zL0simiaQA6EBRsn6VXN__ZmLplAgDz1I1hyQA/formResponse';
const F = { child_name:'entry.684468179', age:'entry.1066070471', grade:'entry.1812672802', guardian:'entry.1666083184', phone:'entry.89824848', campus:'entry.490719219', answers:'entry.85364862', scores:'entry.1455508168', top3:'entry.1261684833', resultId:'entry.2120338430', timestamp:'entry.532514127' };
/* ========================= */

const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Questions&tqx=out:json`;
const DOMAINS = ["ê´€ì°°ë ¥","ì„œì‚¬ë ¥","ë””í…Œì¼","êµ¬ì„±ë ¥","ìƒ‰ê°ê°","ê³µê°„ê°","ë„ì „ì„±","ì†Œí†µë ¥"];
const STEPS = [{key:'start',label:'ì‹œì‘'},{key:'consent',label:'ë™ì˜'},{key:'profile',label:'í”„ë¡œí•„'},{key:'test',label:'í…ŒìŠ¤íŠ¸'},{key:'result',label:'ê²°ê³¼'}];
const STATE = { step:'start', consent:false, consentMeta:null, profile:{}, questions:[], idx:0, answers:[], result:null };

const $=id=>document.getElementById(id); const v=id=>$(id)?.value?.trim()??''; const app=()=>$('app');

/* NAV + Progress */
function renderNav(){
  const cur = STEPS.findIndex(s=>s.key===STATE.step);
  $('topnav').innerHTML = STEPS.map((s,i)=>`<div class="step ${s.key===STATE.step?'active':''} ${cur>i?'done':''}" onclick="navGo('${s.key}')"><span class="num">${i+1}</span><span>${s.label}</span></div>`).join('')
}
function updateTopProgress(){
  if(STATE.step==='test' && STATE.questions.length){
    const q = Math.round(STATE.idx/STATE.questions.length*100);
    $('topbar').style.width=q+'%'; $('statusline').textContent=`í…ŒìŠ¤íŠ¸ ì§„í–‰ ${STATE.idx+1}/${STATE.questions.length} (${q}%)`;
    $('sideLeft').style.display='block'; $('sideRight').style.display='block'; return;
  }
  $('sideLeft').style.display='none'; $('sideRight').style.display='none';
  let pct = (STEPS.findIndex(s=>s.key===STATE.step))/(STEPS.length-1)*100;
  $('topbar').style.width=Math.round(pct)+'%'; $('statusline').textContent=`ì§„í–‰ë¥  ${Math.round(pct)}%`;
}
function navGo(step){ STATE.step=step; if(step==='test' && STATE.questions.length===0){ startTest(); return; } render(); }
const go=navGo;

/* GViz íŒŒì„œ */
function parseGViz(text){ const s=text.indexOf('{'), e=text.lastIndexOf('}'); if(s<0||e<0) return []; const obj=JSON.parse(text.slice(s,e+1)); const cols=obj.table.cols.map(c=>c.label); return obj.table.rows.map(r=>r.c.map(c=>c?(c.f??c.v):'')).map(a=>Object.fromEntries(cols.map((k,i)=>[k,a[i]]))); }
async function loadQuestions(){
  const txt=await (await fetch(GVIZ_URL)).text(); const rows=parseGViz(txt)||[];
  const act=rows.filter(r=>String(r.active).toUpperCase()==='TRUE').sort((a,b)=>(+a.order - +b.order));
  STATE.questions=act.map(r=>({ id:r.id, order:+r.order, prompt:r.prompt,
    options:['A','B','C','D'].map(k=>({ key:k, label:r[`${k}_label`]||'', imageUrl:r[`${k}_image`]||'', alt:r[`${k}_label`]||'',
      weights:(()=>{try{return JSON.parse(r[`${k}_weights`])||{}}catch{return{}}})() })) }));
}

/* START â€“ ì¸í„°ë ‰í‹°ë¸Œ ì¹´ë“œ/ë²„íŠ¼ */
function startScreen(){
  return `<div class="center">
    <div style="display:inline-flex;gap:10px;align-items:center;transform:translateZ(0)">
      <div class="chip" style="box-shadow:0 10px 26px rgba(255,185,138,.35)">ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸ Basic</div>
    </div>
    <h1 style="margin-top:8px">ë°”ë¥¸ë¯¸ìˆ í•™ì› Â· ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸</h1>
    <p class="muted">ì†Œìš”ì‹œê°„ <b>ì•½ 6~8ë¶„</b> Â· ê²°ê³¼ëŠ” ì¦‰ì‹œ í™•ì¸í•˜ê³  <b>ë©”ì¼/PDF ì €ì¥</b>í•  ìˆ˜ ìˆì–´ìš”</p>
    <div style="height:8px"></div>
    <div style="display:flex;gap:14px;justify-content:center;flex-wrap:wrap">
      ${[
        {title:'ë¹ ë¥¸ í…ŒìŠ¤íŠ¸',desc:'6â€“8ë¶„ì´ë©´ ì¶©ë¶„í•´ìš”',emoji:'âš¡'},
        {title:'ë§ì¶¤ ë¶„ì„',desc:'ê°•ì ê³¼ êµìœ¡ í¬ì¸íŠ¸',emoji:'ğŸ¯'},
        {title:'ì¦‰ì‹œ ê²°ê³¼',desc:'ë°”ë¡œ í™•ì¸Â·ì €ì¥',emoji:'ğŸ“©'}
      ].map((f,i)=>`
        <div class="featureCard" style="width:min(320px,92vw);background:#fff;border:1px solid var(--line);border-radius:18px;padding:14px 16px;box-shadow:0 14px 36px rgba(16,24,40,.08);position:relative;overflow:hidden">
          <div style="position:absolute; inset:-1px; padding:1px; border-radius:18px; background:linear-gradient(90deg,#FFE6CF,#E6E2FF,#CFF7EE); -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude"></div>
          <div style="font-size:22px"> ${f.emoji} <b>${f.title}</b></div>
          <div class="small muted">${f.desc}</div>
        </div>`).join('')}
    </div>
    <div style="height:14px"></div>
    <button class="btn btn-mint" onclick="go('consent')" onmousemove="this.style.setProperty('--x', event.offsetX+'px'); this.style.setProperty('--y', event.offsetY+'px')">ì‹œì‘í•˜ê¸°</button>
  </div>`;
}
function viewStart(){ app().innerHTML=startScreen(); window.scrollTo({top:0,behavior:'smooth'}); }

/* CONSENT */
function accItem(t,html){ return `<div class="acc-item open"><div class="acc-head"><span>${t}</span><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div class="acc-body small">${html}</div></div>`;}
function viewConsent(){
  app().innerHTML=`<h2 class="center">ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ì„œ</h2>
  <p class="muted small center">ë³¸ í…ŒìŠ¤íŠ¸ëŠ” <b>êµìœ¡ ê°€ì´ë“œ</b> ëª©ì ì´ë©°, ì˜í•™/ì„ìƒ ì§„ë‹¨ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
  <div class="acc">
    ${accItem('1) ìˆ˜ì§‘Â·ì´ìš© ëª©ì ','â‘  í…ŒìŠ¤íŠ¸ ì œê³µ/ê²°ê³¼ ì‚°ì¶œ â‘¡ ê²°ê³¼ì§€Â·ì½”ì¹­ ê°€ì´ë“œ ì œê³µ â‘¢ ìƒë‹´ í’ˆì§ˆ ê°œì„  â‘£ (ì„ íƒ) ê²°ê³¼ì§€ ì´ë©”ì¼ ë°œì†¡')}
    ${accItem('2) ìˆ˜ì§‘ í•­ëª©','<b>í•„ìˆ˜</b>: ì•„ë™ ì´ë¦„Â·ë‚˜ì´Â·í•™ë…„ / ë³´í˜¸ì ì´ë¦„Â·ì—°ë½ì²˜ / ë¬¸í•­ ì‘ë‹µ<br><b>ì„ íƒ</b>: ì´ë©”ì¼(ê²°ê³¼ ì „ì†¡), ê´€ì‹¬ ìº í¼ìŠ¤')}
    ${accItem('3) ë³´ê´€ ê¸°ê°„','ìˆ˜ì§‘ì¼ë¡œë¶€í„° <b>12ê°œì›”</b> ë³´ê´€ í›„ íŒŒê¸°')}
    ${accItem('4) ì²˜ë¦¬/ë³´ê´€','Google Forms/Sheetsì— ì €ì¥Â·ì²˜ë¦¬')}
    ${accItem('5) ê¶Œë¦¬','ë™ì˜ ê±°ë¶€ ê°€ëŠ¥(ê±°ë¶€ ì‹œ ì„œë¹„ìŠ¤ ì œí•œ ê°€ëŠ¥)')}
    ${accItem('6) ë¬¸ì˜','barunart1004@gmail.com')}
  </div>
  <div class="section" style="margin-top:16px">
    <div class="grid grid-2">
      <div><label>ë³´í˜¸ì ì„±ëª…(ì„œëª…)</label><input id="consent_guardian" placeholder="ì˜ˆ: í™ê¸¸ë™(ì„œëª…)"></div>
      <div><label>ì—°ë½ì²˜</label><input id="consent_phone" placeholder="010-0000-0000"></div>
      <div><label>ì•„ë™ê³¼ì˜ ê´€ê³„</label><select id="consent_relation"><option>ë¶€ëª¨</option><option>ë²•ì •ëŒ€ë¦¬ì¸</option><option>ê¸°íƒ€</option></select></div>
      <div><label>(ì„ íƒ) ê²°ê³¼ì§€ ì´ë©”ì¼ ìˆ˜ì‹  ë™ì˜</label><select id="consent_email_ok"><option value="ë™ì˜">ë™ì˜</option><option value="ë¯¸ë™ì˜" selected>ë¯¸ë™ì˜</option></select></div>
    </div>
    <div class="checkRow" style="margin-top:12px">
      <label><input type="checkbox" id="chk_required"> (í•„ìˆ˜) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤</label>
      <label><input type="checkbox" id="chk_minor"> (í•„ìˆ˜) ë§Œ 14ì„¸ ë¯¸ë§Œ ì•„ë™ì˜ ë²•ì •ëŒ€ë¦¬ì¸ìœ¼ë¡œì„œ ë™ì˜í•©ë‹ˆë‹¤</label>
    </div>
  </div>
  <div class="center" style="margin-top:16px; display:flex; gap:8px; justify-content:center">
    <button class="btn" id="btn_consent" disabled>ë™ì˜í•˜ê³  ì§„í–‰</button>
    <button class="btn-ghost" onclick="document.querySelectorAll('.acc-item').forEach(it=>it.classList.add('open'))">ì „ë¬¸ í¼ì¹˜ê¸°</button>
    <button class="btn-ghost" onclick="document.querySelectorAll('.acc-item').forEach(it=>it.classList.remove('open'))">ëª¨ë‘ ì ‘ê¸°</button>
  </div>`;
  const validate=()=>{ const ok=$('chk_required').checked&&$('chk_minor').checked; const g=$('consent_guardian').value.trim(); const p=$('consent_phone').value.trim(); const okp=/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(p); $('btn_consent').disabled=!(ok&&g.length>=2&&okp); };
  ['chk_required','chk_minor','consent_guardian','consent_phone'].forEach(id=>{$(id).addEventListener('input',validate);$(id).addEventListener('change',validate);});
  $('btn_consent').onclick=()=>{ STATE.consent=true; STATE.consentMeta={guardian:$('consent_guardian').value.trim(),phone:$('consent_phone').value.trim(),relation:$('consent_relation').value,email_ok:$('consent_email_ok').value,ver:'v1.7'}; go('profile'); };
  document.querySelectorAll('.acc-head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
}

/* PROFILE */
function viewProfile(){
  app().innerHTML=`<h2 class="center">í”„ë¡œí•„ ì •ë³´</h2>
  <div class="grid grid-2" style="margin-top:8px">
    <div><label>ì•„ë™ ì´ë¦„</label><input id="cname" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
    <div><label>ë‚˜ì´</label><select id="age"><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
    <div><label>í•™ë…„</label><select id="grade">
      <option>ì´ˆë“±í•™êµ 1í•™ë…„</option><option>ì´ˆë“±í•™êµ 2í•™ë…„</option><option>ì´ˆë“±í•™êµ 3í•™ë…„</option>
      <option>ì´ˆë“±í•™êµ 4í•™ë…„</option><option>ì´ˆë“±í•™êµ 5í•™ë…„</option><option>ì´ˆë“±í•™êµ 6í•™ë…„</option></select></div>
    <div><label>ë³´í˜¸ì ì´ë¦„</label><input id="gname"></div>
    <div><label>ì—°ë½ì²˜</label><input id="phone" placeholder="010-0000-0000"></div>
    <div><label>ì´ë©”ì¼(ì„ íƒ, ê²°ê³¼ì§€ ì „ì†¡)</label><input id="email" placeholder="example@email.com"></div>
    <div><label>ê´€ì‹¬ ìº í¼ìŠ¤(ì„ íƒ)</label><input id="campus" placeholder="ì˜ˆ: ë¶„ë‹¹ì "></div>
  </div>
  <div class="center" style="margin-top:16px"><button class="btn btn-mint" onclick="startTest()">í…ŒìŠ¤íŠ¸ ì‹œì‘</button></div>`;
}
async function startTest(){
  STATE.profile={child_name:v('cname'),age:v('age'),grade:v('grade'),guardian:v('gname'),phone:v('phone'),email:v('email'),campus:v('campus')};
  if(!STATE.profile.child_name || !/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(STATE.profile.phone||'')){ alert('ì´ë¦„/ì—°ë½ì²˜ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”'); return; }
  await loadQuestions(); STATE.idx=0; STATE.answers=[]; STATE.step='test'; render();
}

/* TEST */
function viewTest(){
  const q=STATE.questions[STATE.idx]; if(!q){ app().innerHTML='<h3 class="center">ë¬¸í•­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì— ë¬¸ì˜í•´ ì£¼ì„¸ìš”.</h3>'; return; }
  const gridCls = (window.matchMedia('(min-width:1024px)').matches?'test-grid':'grid grid-2');
  app().innerHTML=`<div class="center small muted">Q${STATE.idx+1} / ${STATE.questions.length}</div>
    <h2 class="center" style="margin-top:6px">${q.prompt||''}</h2>
    <div class="${gridCls}" style="margin-top:10px">
      ${q.options.map(o=>`<div class="opt" id="opt_${o.key}" tabindex="0" role="button" aria-label="${o.label}" onclick="choose('${o.key}')" onkeydown="if(event.key==='Enter'||event.key===' '){choose('${o.key}')}">
        <img src="${o.imageUrl}" alt="${o.label}" onerror="this.style.opacity=.2" loading="lazy"><div class="cap center">${o.label}</div></div>`).join('')}
    </div>
    <div class="center" style="margin-top:18px; display:flex; gap:8px; justify-content:center">
      <button class="btn-ghost" onclick="prev()" ${STATE.idx===0?'disabled':''}>ì´ì „</button>
      <button class="btn" id="nextBtn" onclick="next()" disabled>ë‹¤ìŒ</button>
    </div>`;
  document.addEventListener('keydown',e=>{ if(e.key==='ArrowRight'){ next(); } if(e.key==='ArrowLeft'){ prev(); } if(e.key==='Enter'){ if(!$('nextBtn').disabled) next(); } },{once:true});
}
function choose(key){ const q=STATE.questions[STATE.idx]; ['A','B','C','D'].forEach(k=>{const n=document.getElementById(`opt_${k}`); if(n) n.classList.remove('sel');}); const node=document.getElementById(`opt_${key}`); if(node){ node.classList.add('sel'); node.animate([{transform:'scale(1)'},{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:160}); } const opt=q.options.find(o=>o.key===key); STATE.answers[STATE.idx]={ qid:q.id, key, weights:opt.weights }; document.getElementById('nextBtn').disabled=false; }
function next(){ if(!STATE.answers[STATE.idx]){ alert('í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”'); return; } if(STATE.idx<STATE.questions.length-1){ STATE.idx++; render(); } else submitAll(); }
function prev(){ if(STATE.idx>0){ STATE.idx--; render(); } }

/* ì ìˆ˜ ë³´ì • / ë©˜íŠ¸ */
function aggregateScores(ans){ const sum={}; DOMAINS.forEach(d=>sum[d]=0); ans.forEach(a=>Object.entries(a.weights||{}).forEach(([k,v])=>sum[k]=(sum[k]||0)+Number(v||0))); const n=ans.length||1; const raw={}; DOMAINS.forEach(d=>{ const v=(sum[d]||0)/n*4; raw[d]=Math.max(0,Math.round(v*10)/10); }); return raw; }
const adjust=v=>Math.round((2 + v/2) * 10)/10; // 0â†’2.0, 4â†’4.0
function band(v){ if(v>=3.6) return 'S'; if(v>=3.2) return 'A'; if(v>=2.8) return 'A-'; if(v>=2.4) return 'B+'; if(v>=2.0) return 'B'; if(v>=1.6) return 'B-'; if(v>=1.0) return 'C+'; return 'C'; }

const DETAIL = {
  'ê´€ì°°ë ¥':(n)=>`${n}ë‹˜ì€ ëŒ€ìƒì„ ì˜¤ë˜ ë°”ë¼ë³´ê³  íŠ¹ì§•ì„ ë½‘ì•„ë‚´ëŠ” í˜ì´ ë›°ì–´ë‚˜ìš”. ì‘ì€ ë³€í™”ë„ ë†“ì¹˜ì§€ ì•Šì•„ í‘œí˜„ì˜ ë°€ë„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤. ì •êµí•œ ê´€ì°° ë“œë¡œì‰ì—ì„œ ì¦ê±°ì›€ì„ ëŠë‚„ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤.`,
  'ì„œì‚¬ë ¥':(n)=>`${n}ë‹˜ì€ ì¥ë©´ ì†ì— ì´ì•¼ê¸°ë¥¼ ì‹¬ëŠ” ë° ê°•ì ì´ ìˆì–´ìš”. ìºë¦­í„°ì˜ ê°ì •ê³¼ ì‚¬ê±´ì˜ íë¦„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•©ë‹ˆë‹¤. ìŠ¤í† ë¦¬ ê¸°ë°˜ í”„ë¡œì íŠ¸ì—ì„œ ëª°ì…ë„ê°€ ë†’ìŠµë‹ˆë‹¤.`,
  'ë””í…Œì¼':(n)=>`${n}ë‹˜ì€ ë§ˆê°ê³¼ í‘œí˜„ì˜ ì„¬ì„¸í•¨ì´ ë‹ë³´ì—¬ìš”. ì§ˆê°Â·ë¬´ëŠ¬Â·ì‘ì€ ìš”ì†Œê¹Œì§€ ì±™ê¸°ëŠ” ì§‘ì¤‘ë ¥ì´ ê°•ì ì…ë‹ˆë‹¤. ì‘í’ˆì˜ ì™„ì„±ë„ë¥¼ í•œ ë‹¨ê³„ ëŒì–´ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.`,
  'êµ¬ì„±ë ¥':(n)=>`${n}ë‹˜ì€ í™”ë©´ì—ì„œ ì‹œì„ ì´ íë¥´ëŠ” ê¸¸ì„ ì˜ ì„¤ê³„í•´ìš”. ì¤‘ì‹¬ê³¼ ì—¬ë°±ì˜ ê· í˜•ì„ ì•ˆì •ì ìœ¼ë¡œ ì¡ìŠµë‹ˆë‹¤. í¬ìŠ¤í„°/ë ˆì´ì•„ì›ƒ ì‘ì—…ì—ì„œ íƒì›”í•¨ì´ ë“œëŸ¬ë‚©ë‹ˆë‹¤.`,
  'ìƒ‰ê°ê°':(n)=>`${n}ë‹˜ì€ ìƒ‰ì˜ ë¶„ìœ„ê¸°ë¥¼ ì½ê³  ì¡°í•©í•˜ëŠ” ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ìš”. ë¯¸ë¬˜í•œ í†¤ ì°¨ì´ë„ ê°ê°ì ìœ¼ë¡œ ì¡ì•„ëƒ…ë‹ˆë‹¤. íŒ”ë ˆíŠ¸ ì œì•½ ì†ì—ì„œë„ ë©‹ì§„ ê²°ê³¼ë¥¼ ëƒ…ë‹ˆë‹¤.`,
  'ê³µê°„ê°':(n)=>`${n}ë‹˜ì€ ì›ê·¼Â·ìŠ¤ì¼€ì¼ì„ í™œìš©í•´ ì…ì²´ê°ì„ ì‚´ë¦¬ëŠ” ë° ê°•í•©ë‹ˆë‹¤. ì¥ë©´ì˜ ê¹Šì´ë¥¼ ì•ˆì •ì ìœ¼ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤. ê±´ì¶•/í’ê²½ ê°™ì€ ì£¼ì œì—ì„œ ì¥ì ì„ ë³´ì…ë‹ˆë‹¤.`,
  'ë„ì „ì„±':(n)=>`${n}ë‹˜ì€ ìƒˆë¡œìš´ ë„êµ¬ì™€ ë°©ì‹ì— ë‘ë ¤ì›€ì´ ì ì–´ìš”. ì‹¤íŒ¨ë¥¼ ê²½í—˜ìœ¼ë¡œ ë°”ê¾¸ë©° ì‹œë„ë¥¼ ì´ì–´ê°‘ë‹ˆë‹¤. ì‹¤í—˜ì ì¸ í”„ë¡œì íŠ¸ì—ì„œ ì„±ì¥ ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤.`,
  'ì†Œí†µë ¥':(n)=>`${n}ë‹˜ì€ ìì‹ ì˜ ì˜ë„ë¥¼ ì–¸ì–´ë¡œ í’€ì–´ë‚´ëŠ” í˜ì´ ì¢‹ì•„ìš”. ì‘í’ˆì˜ í•µì‹¬ì„ ë˜ë˜ì—ê²Œ ì„¤ë“ë ¥ ìˆê²Œ ì „ë‹¬í•©ë‹ˆë‹¤. ë°œí‘œÂ·ë¹„í‰ í™œë™ì—ì„œ ìì‹ ê°ì„ ì–»ìŠµë‹ˆë‹¤.`
};
const PRAISE={
  'S':k=>`ì™€, ${k}ì—ì„œ <b>íƒ€ê³ ë‚œ ì¬ëŠ¥</b>ì´ ë‹ë³´ì—¬ìš”! ìŠ¤ìŠ¤ë¡œ ê¸°íší•˜ëŠ” ìˆ˜ì¤€ê¹Œì§€ ë…¸ë ¤ë³¼ ìˆ˜ ìˆì–´ìš”.`,
  'A':k=>`${k} ê°ê°ì´ <b>ë›°ì–´ë‚©ë‹ˆë‹¤</b>. ë‚œì´ë„ë¥¼ ì˜¬ë ¤ë„ ì¶©ë¶„íˆ ì†Œí™”í•´ìš”.`,
  'A-':k=>`${k} ì‹¤ë ¥ì´ <b>íƒ„íƒ„</b>í•´ìš”. ì¡°ê¸ˆë§Œ ë‹¤ë“¬ìœ¼ë©´ ê¸ˆë°© ìƒìœ„ê¶Œ!`,
  'B+':k=>`${k}ì´ ì•ˆì •ì ì´ì—ìš”. ìƒˆë¡œìš´ ì‹œë„ì—ë„ ì˜ ì ì‘í•©ë‹ˆë‹¤.`,
  'B':k=>`${k} ê¸°ë³¸ê¸°ê°€ ì¢‹ì•„ìš”. ë£¨í‹´ì„ ë„“íˆë©´ <b>ì„±ì¥ ì†ë„ ê°€ì†</b>!`
};
const MISSIONS={
  'ê´€ì°°ë ¥':{'S':'ì¬ì§ˆ 3ì¢… ì—°êµ¬','A':'ê´‘ì› ê´€ì°° ë“œë¡œì‰','A-':'ë””í…Œì¼ ìŠ¤ì¼€ì¹˜','B+':'5ë¶„ ê´€ì°° 3ì¥','B':'ì‹¤ë£¨ì—£ ë¶„í•´'},
  'ì„œì‚¬ë ¥':{'S':'6ì»· ì‹œí€€ìŠ¤','A':'3ì»· ë§Œí™”','A-':'ì¥ë©´ ì „í™˜','B+':'ë§í’ì„  ì„¤ëª…','B':'í•œ ë¬¸ì¥ ìŠ¤í† ë¦¬'},
  'ë””í…Œì¼':{'S':'í…ìŠ¤ì²˜ ë¼ì´íŒ…','A':'í´ë¦°ì—…','A-':'ì¬ì§ˆ 3ì¢…','B+':'ì„  êµµê¸° ê³„ì¸µí™”','B':'ë‹¨ê³„ë³„ ë§ˆê°'},
  'êµ¬ì„±ë ¥':{'S':'í¬ìŠ¤í„° 2ì•ˆ','A':'ê·¸ë¦¬ë“œ ë¦¬íŒ©í„°','A-':'ì¸ë„¤ì¼ 6ì¥','B+':'ì£¼/ë¶€ ì‹œì„ ','B':'3Ã—3 ê²©ì'},
  'ìƒ‰ê°ê°':{'S':'í•œì • íŒ”ë ˆíŠ¸','A':'ë³´ìƒ‰ í¬ì¸íŠ¸','A-':'í†¤ ë°¸ëŸ°ìŠ¤','B+':'ì˜¨/ëƒ‰ ë¶„ë¦¬','B':'2ìƒ‰ ë³€ì£¼'},
  'ê³µê°„ê°':{'S':'1Â·2Â·3ì  íˆ¬ì‹œ','A':'ì›ê·¼ ê³¼ì¥','A-':'íšŒì „ íˆ¬ì‹œ','B+':'ì•-ì¤‘-ë’¤ ë ˆì´ì–´','B':'ë°”ë‹¥/ìˆ˜í‰ì„ '},
  'ë„ì „ì„±':{'S':'ë§¤ì²´ ë¯¹ìŠ¤','A':'ìƒˆ ì†Œì¬ 2ê°œ','A-':'ëŒ€ë‹´ ë³€í˜•','B+':'ì‹¤íŒ¨ì‘ ë¦¬í„°ì¹˜','B':'ë‚¯ì„  ë„êµ¬ 1ê°œ'},
  'ì†Œí†µë ¥':{'S':'ì‘ê°€ë…¸íŠ¸','A':'ë¹„í‰ë¬¸ 5ë¬¸ì¥','A-':'ì˜ë„ 3ë¬¸ì¥','B+':'í”¼ë“œë°± ë¼ìš´ë“œ','B':'ì‘í’ˆ ì œëª©'}
};

function nowKST(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())} KST`; }
async function submitAll(){
  const raw=aggregateScores(STATE.answers);
  const scores=Object.fromEntries(Object.entries(raw).map(([k,v])=>[k,adjust(v)])); // 2.0~4.0 ë³´ì •
  const top3=Object.keys(scores).sort((a,b)=>scores[b]-scores[a]).slice(0,3);
  const resultId=crypto.randomUUID();

  const form=new FormData();
  const answersWithMeta={consent:STATE.consentMeta,profile:STATE.profile,questions:STATE.answers};
  form.append(F.child_name,STATE.profile.child_name); form.append(F.age,STATE.profile.age); form.append(F.grade,STATE.profile.grade);
  form.append(F.guardian,STATE.profile.guardian); form.append(F.phone,STATE.profile.phone); form.append(F.campus,STATE.profile.campus||'');
  form.append(F.answers,JSON.stringify(answersWithMeta)); form.append(F.scores,JSON.stringify(scores));
  form.append(F.top3,top3.join(',')); form.append(F.resultId,resultId); form.append(F.timestamp,nowKST());
  try{ fetch(FORM_ACTION,{method:'POST',mode:'no-cors',body:form}); }catch(e){}
  STATE.result={scores,top3,resultId}; STATE.step='result'; render();
}

/* RESULT */
let CHARTS=[];
function destroyCharts(){ CHARTS.forEach(c=>c.destroy?.()); CHARTS=[]; }
function viewResult(){
  const r=STATE.result, s=r?.scores||{};
  const overall = Math.round((Object.values(s).reduce((a,b)=>a+(+b||0),0))*10)/10 || 0;

  app().innerHTML=`<div id="resultCard">
    <div class="block callout" style="text-align:center">
      <div class="chip" style="margin:0 auto 8px;display:inline-block">í…ŒìŠ¤íŠ¸ ì™„ë£Œ</div>
      <h2 style="margin:0 0 10px"><b>${STATE.profile.child_name}</b>ë‹˜, ì˜¤ëŠ˜ ì •ë§ ë©‹ì¡Œì–´ìš”!</h2>
      <div class="kpi" style="justify-content:center"><div class="num" style="font-size:52px">${overall.toFixed(1)}</div><div class="unit">/ 32 (8ì˜ì—­ í•©ì‚°)</div></div>
      <p class="small" style="margin-top:10px;color:#0f172a;font-size:15px">
        íŠ¹íˆ <b>${r.top3.join(', ')}</b>ì—ì„œ ì¬ëŠ¥ì´ ë˜ë ·í•©ë‹ˆë‹¤. ì¦ê±°ìš´ ë£¨í‹´ìœ¼ë¡œ ê¸°íšŒë¥¼ ìì£¼ ë§Œë“¤ì–´ ë³¼ê²Œìš”.
      </p>
      <div class="chips" style="margin-top:10px;justify-content:center">${r.top3.map(t=>`<span class="chip">${t} ì¬ëŠ¥</span>`).join('')}</div>
    </div>

    <div class="grid grid-2">
      <div class="block"><h3 class="center">ì˜ì—­ë³„ ê´€ì‹¬ë„</h3><canvas id="radar" height="320"></canvas></div>
      <div class="block"><h3 class="center">ìƒìœ„ 3ê°œ ë§‰ëŒ€</h3><canvas id="bars" height="320"></canvas></div>
    </div>

    <div class="block">
      <h3>ì´í‰</h3>
      <p style="color:#0f172a;font-size:15px;line-height:1.7">ì•„ì´ì˜ ê°•ì ì´ ì„ ëª…í•˜ê²Œ ë“œëŸ¬ë‚œ ê²°ê³¼ì˜ˆìš”. ìŠ¤ìŠ¤ë¡œ ì„ íƒí•˜ê³  ëª°ì…í•  ë•Œ ì„±ì¥ì´ í¬ê²Œ ì¼ì–´ë‚©ë‹ˆë‹¤. â€œì˜í•  ìˆ˜ ìˆë‹¤â€ëŠ” ê²½í—˜ì„ ê¾¸ì¤€íˆ ìŒ“ì„ ìˆ˜ ìˆë„ë¡ ì‘ê³  ìì£¼ í•˜ëŠ” ë¯¸ì…˜ì„ ì œì•ˆí•©ë‹ˆë‹¤.</p>
    </div>

    <div class="block">
      <h3>í•­ëª©ë³„ í•´ì„ & ì¼ì¼ 15ë¶„ í›ˆë ¨</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        ${DOMAINS.map(k=>{
          const v=+(s[k]||0), b=band(v), w=Math.min(100,(v/4)*100);
          return `<div style="border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff;box-shadow:0 10px 26px rgba(16,24,40,.06)">
            <div style="display:flex;justify-content:space-between;align-items:flex-end">
              <strong>${k}</strong>
              <div class="kpi"><div class="num" style="font-size:28px">${v.toFixed(1)}</div><div class="unit">/ 4.0</div></div>
            </div>
            <div class="topprogress" style="height:10px;margin:8px 0 10px"><div style="width:${w}%;height:100%;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE)"></div></div>
            <div class="small" style="color:#0f172a">${DETAIL[k](STATE.profile.child_name)}</div>
            <div class="small" style="margin-top:6px;color:#0f172a">${PRAISE[b](k)}</div>
            <div class="small" style="margin-top:4px">ì˜¤ëŠ˜ì˜ 15ë¶„: <b>${MISSIONS[k][b]||MISSIONS[k]['B']}</b></div>
          </div>`;
        }).join('')}
      </div>
    </div>

    <p class="credit">â€» ë³¸ ê²°ê³¼ëŠ” êµìœ¡ ê°€ì´ë“œ ëª©ì ì´ë©° ì˜í•™Â·ì„ìƒ ì§„ë‹¨ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
  </div>

  <div class="center" style="margin-top:16px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
    <button class="btn-ghost" onclick="STATE.step='start'; render()">ì²˜ìŒìœ¼ë¡œ</button>
    <button class="btn btn-mint" onclick="window.print()">PDF ì €ì¥</button>
  </div>`;

  destroyCharts();
  const rctx=document.getElementById('radar').getContext('2d');
  CHARTS.push(new Chart(rctx,{type:'radar',
    data:{labels:DOMAINS, datasets:[{data:DOMAINS.map(k=>s[k]||0), borderColor:'#FFB98A', backgroundColor:'rgba(255,185,138,.22)', borderWidth:2, pointRadius:3, fill:true}]},
    options:{animation:{duration:900}, scales:{r:{suggestedMin:0,suggestedMax:4,ticks:{stepSize:1},grid:{color:'#eef2f7'},angleLines:{color:'#eef2f7'}}}, plugins:{legend:{display:false}}}
  }));
  const bctx=document.getElementById('bars').getContext('2d');
  CHARTS.push(new Chart(bctx,{type:'bar',
    data:{labels:r.top3, datasets:[{data:r.top3.map(k=>s[k]||0), borderRadius:12, borderSkipped:false, backgroundColor:'#FFE6CF'}]},
    options:{animation:{duration:800}, scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{stepSize:1},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}, plugins:{legend:{display:false}}}
  }));
}

/* Router */
function render(){ renderNav(); updateTopProgress();
  if(STATE.step==='start') return viewStart();
  if(STATE.step==='consent') return viewConsent();
  if(STATE.step==='profile') return viewProfile();
  if(STATE.step==='test') return viewTest();
  if(STATE.step==='result') return viewResult();
}
render();
</script>
</body>
</html>
