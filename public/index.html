<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>바른미술학원 · 미술적성테스트</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --ink:#0f172a; --muted:#6b7280;
  --bg1:#fff7f1; --bg2:#f7f3ff;
  --card:#ffffff; --line:#eef2f7;
  --o1:#FFE6CF; --o2:#FFD9BE; --o3:#FFC9A3; --o4:#FFB98A;
  --mint:#CFF7EE; --vio:#E6E2FF;
  --radius:22px; --shadow:0 18px 60px rgba(16,24,40,.12); --soft:0 12px 30px rgba(16,24,40,.08);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:"Pretendard",ui-sans-serif,system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial;
  background:
   radial-gradient(900px 600px at 10% -10%, var(--vio), transparent 55%),
   radial-gradient(900px 600px at 90% 110%, var(--mint), transparent 55%),
   linear-gradient(180deg,var(--bg1),var(--bg2));
  background-attachment:fixed;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2; pointer-events:none;
  background:linear-gradient(rgba(255,255,255,.82), rgba(255,255,255,.82)), url("/bg.png") center/cover no-repeat fixed;
  filter:saturate(1.02);
}
.container{min-height:100dvh; display:flex; flex-direction:column; align-items:center}
.main{width:100%; max-width:1100px; padding:18px; display:flex; flex-direction:column; gap:16px; margin:0 auto}

/* 헤더 & 네비 */
.header{width:100%; display:flex; justify-content:center}
.brand{width:100%; max-width:1100px; margin-top:10px; display:flex; align-items:center; gap:12px; padding:12px 16px;
  border-radius:999px; background:rgba(255,255,255,.65); backdrop-filter:blur(8px); border:1px solid var(--line); box-shadow:var(--soft)}
.logo{width:28px;height:28px;border-radius:50%;background:conic-gradient(from 0deg,#FFB98A,#FFE6CF,#E6E2FF,#CFF7EE,#FFB98A);animation:spin 9s linear infinite paused}
.brand:hover .logo{animation-play-state:running} @keyframes spin{to{transform:rotate(360deg)}}
.brand span{font-weight:900; letter-spacing:.2px}

.sticky{position:sticky; top:0; z-index:10; backdrop-filter:blur(8px);
  background:rgba(255,255,255,.6); border:1px solid var(--line); border-radius:16px; box-shadow:var(--soft);
  padding:8px 10px; display:flex; flex-direction:column; gap:10px;}
.navbar{display:flex; flex-wrap:wrap; gap:10px; justify-content:center}
.step{display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; cursor:pointer;
  background:#fff; color:#374151; font-weight:850; border:1px solid var(--line); box-shadow:var(--soft); transition:transform .12s}
.step:hover{transform:translateY(-1px)}
.step .num{width:20px;height:20px;border-radius:50%;display:inline-grid;place-items:center;background:#fff;border:1px solid var(--line);font-size:12px}
.step.active{background:linear-gradient(90deg,var(--o1),var(--vio)); color:#111827; box-shadow:0 12px 30px rgba(255,214,176,.28)}
.step.done{background:#f2fffa; border-color:#dff7ef}
.topprogress{height:10px; background:#f6f7fb; border-radius:999px; overflow:hidden}
.topprogress>div{height:100%; width:0; background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE); transition:width .35s ease}
.statusline{font-size:12px; color:#6b7280; text-align:center}

/* 카드/타이포/버튼 */
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:24px; box-shadow:var(--shadow); animation:fade .35s ease both}
@keyframes fade{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:translateY(0)}}
h1{font-size:34px; margin:0 0 6px} h2{font-size:24px; margin:0 0 10px} h3{font-size:18px; margin:16px 0 8px}
p{margin:8px 0} .small{font-size:13px} .muted{color:var(--muted)} .center{text-align:center}

.btn{
  --bg:linear-gradient(90deg,#FFB98A,#FFD9BE); --glow:rgba(255,185,138,.35);
  background:var(--bg); color:#5a3f2f; border:none; padding:14px 22px; border-radius:16px; font-weight:900; cursor:pointer;
  box-shadow:0 12px 32px var(--glow); transition:transform .08s, filter .2s, box-shadow .2s; position:relative; overflow:hidden}
.btn:hover{transform:translateY(-1px); filter:brightness(1.03)}
.btn:after{content:""; position:absolute; inset:0; background:radial-gradient(120px 120px at var(--x,50%) var(--y,50%), rgba(255,255,255,.6), transparent 40%); opacity:.0; transition:opacity .25s}
.btn:hover:after{opacity:.6}
.btn-ghost{background:#fff; color:#111827; border:1px solid var(--line); padding:12px 14px; border-radius:12px; font-weight:800; cursor:pointer; box-shadow:var(--soft)}
.btn-mint{--bg:linear-gradient(90deg,#FFE6CF,#FFD9BE); --glow:rgba(255,214,190,.4)}

input,select,textarea{width:100%; background:#fff; color:#111; border:1px solid var(--line); border-radius:12px; padding:12px; outline:none}
input:focus,select:focus,textarea:focus{border-color:#FFD9BE; box-shadow:0 0 0 6px rgba(255,217,190,.26)}
label{font-size:14px; color:#374151}
.section{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
input[type=checkbox],input[type=radio]{accent-color:#FFB98A}

/* 보기 */
.opt{border:2px solid var(--line); border-radius:18px; overflow:hidden; cursor:pointer; background:#fff; box-shadow:var(--soft); transition:transform .12s, border-color .2s}
.opt:hover{transform:translateY(-2px)} .opt img{width:100%; display:block; aspect-ratio:3/2; object-fit:cover}
.opt .cap{padding:10px; color:#374151; font-weight:700} .opt.sel{border-color:#FFD9BE; box-shadow:0 0 0 6px rgba(255,217,190,.25)}

/* PC - 한 화면 4개 + 사이드 버튼 */
@media (min-width:1024px){
  .test-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:14px}
  .opt img{aspect-ratio:4/3}
  .sideNav{position:fixed; top:50%; transform:translateY(-50%); z-index:20}
  .sideNav.left{left:18px} .sideNav.right{right:18px}
  .sideBtn{background:linear-gradient(90deg,#fff,#FFF4EC); border:1px solid var(--line); width:46px; height:46px; border-radius:50%; display:grid; place-items:center; box-shadow:0 12px 26px rgba(16,24,40,.08); cursor:pointer; font-weight:900}
  .sideBtn:hover{transform:translateY(-1px)}
}
@media (max-width:1023px){ .sideNav{display:none} }

/* 공통 블록 */
.block{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(16,24,40,.06);page-break-inside:avoid}
.block h3{margin:0 0 10px}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{background:linear-gradient(90deg,#FFE6CF,#FFD9BE);color:#5a3f2f;border:1px solid #ffe8d6;padding:8px 12px;border-radius:999px;font-weight:900}
.kpi{display:flex;align-items:flex-end;gap:10px}
.kpi .num{font-size:44px;font-weight:900;line-height:1}
.kpi .unit{font-size:14px;color:#6b7280}
.callout{position:relative;background:linear-gradient(135deg,#FFF2E6,#F8FBFF);padding:22px;border-radius:18px;border:1px solid var(--line);box-shadow:0 12px 34px rgba(255,185,138,.25)}
.callout:before{content:"";position:absolute;inset:-1px;border-radius:18px;padding:1px;background:linear-gradient(90deg,#FFD9BE,#E6E2FF,#CFF7EE);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
.credit{font-size:12px;color:#6b7280;text-align:center}
.skel{border-radius:12px; background:linear-gradient(90deg,#f3f4f6,#eaeef3,#f3f4f6); background-size:200% 100%; animation:sh 1.2s infinite}@keyframes sh{to{background-position:-200% 0}}
.checkRow{display:flex;gap:16px;align-items:center;flex-wrap:wrap}

/* 첫 화면 – 히어로 */
.heroWrap{position:relative; padding:48px 16px 30px; text-align:center; perspective:1000px;}
.heroTitle{
  font-size:40px; font-weight:900; letter-spacing:.2px; margin:6px 0 8px;
  background:linear-gradient(90deg,#FFB98A 0%, #FFCCAA 35%, #E6E2FF 70%, #CFF7EE 100%);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  background-size:200% 100%; animation:shine 6s linear infinite;
}
@keyframes shine{0%{background-position:0%}100%{background-position:200%}}
.heroSub{color:#475467; font-size:15px}

.glows{
  position:absolute; inset:-40px -20px auto -20px; height:240px; pointer-events:none; opacity:.85; filter:blur(26px);
  background:
    radial-gradient(160px 110px at 18% 65%, rgba(255,197,153,.55), transparent 60%),
    radial-gradient(200px 140px at 84% 35%, rgba(240,220,255,.55), transparent 60%),
    radial-gradient(280px 180px at 52% 88%, rgba(207,247,238,.55), transparent 60%);
}

.heroBadges{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-bottom:8px}
.badge{
  display:inline-flex; align-items:center; gap:6px;
  background:linear-gradient(90deg,#FFF4EC,#FFFFFF);
  border:1px solid var(--line); padding:8px 12px; border-radius:999px;
  font-weight:800; box-shadow:0 10px 28px rgba(16,24,40,.08)
}
.badge svg{width:16px;height:16px}

.heroGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:16px; max-width:980px; margin:16px auto 0}
@media(max-width:900px){ .heroGrid{grid-template-columns:1fr} }
.fcard{
  position:relative; background:#fff; border:1px solid var(--line); padding:20px 16px; border-radius:20px;
  box-shadow:0 20px 46px rgba(16,24,40,.12); overflow:hidden; transform-style:preserve-3d;
  transform:rotateX(var(--rx,0deg)) rotateY(var(--ry,0deg)) translateZ(0);
  transition:transform .15s ease, box-shadow .2s ease;
}
.fcard:before{
  content:""; position:absolute; inset:-1px; border-radius:20px; padding:1px;
  background:linear-gradient(90deg,#FFE6CF,#FFD9BE,#E6E2FF,#CFF7EE);
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor; mask-composite:exclude;
}
.fcard:hover{box-shadow:0 26px 60px rgba(255,185,138,.25)}
.fhead{font-weight:900; font-size:18px; display:flex; align-items:center; gap:8px}
.fdesc{font-size:13px; color:var(--muted); margin-top:4px}
.ficon{
  width:30px;height:30px;border-radius:10px;display:grid;place-items:center;margin-right:4px;
  background:linear-gradient(180deg,#FFF1E6,#FFFFFF); border:1px solid #ffe3cd; box-shadow:0 10px 20px rgba(255,185,138,.15)
}

.ctaRow{margin-top:20px; display:flex; justify-content:center}
.ctaHelp{font-size:12px; color:#6b7280; margin-top:12px}
.orb{position:absolute; border-radius:50%; filter:blur(10px); opacity:.25; pointer-events:none}
.orb.a{width:180px;height:180px; left:6%; top:22%; background:#FFD9BE; animation:float 8s ease-in-out infinite}
.orb.b{width:140px;height:140px; right:10%; top:30%; background:#E6E2FF; animation:float 10s ease-in-out infinite reverse}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(14px)}}

/* 동의 아코디언 + 동의 체크(문장 왼쪽, 체크박스 오른쪽) */
.acc{border-radius:14px; overflow:hidden; border:1px solid var(--line)}
.acc-item{border-top:1px solid var(--line)}
.acc-head{padding:14px 16px; background:#FFF4EC; cursor:pointer; display:flex; justify-content:space-between; align-items:center}
.acc-body{padding:14px 16px; display:none; background:#fff}
.acc-item.open .acc-body{display:block}
.ul{margin:6px 0 0 18px; padding:0} .ul li{margin:4px 0; color:#374151; font-size:14px}

.agreeList{display:flex; flex-direction:column; gap:10px; margin-top:8px}
.agreeItem{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; background:#fff; border:1px solid var(--line); border-radius:12px}
.agreeItem input{width:20px;height:20px}

/* 인쇄 */
@media print{
  .header,.sticky,.btn,.btn-ghost,.sideNav{display:none !important}
  .card{box-shadow:none;border:1px solid #ddd}
  .block{break-inside:avoid-page}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand"><div class="logo"></div><span>바른미술학원 · 미술적성테스트</span></div>
  </div>

  <main class="main">
    <div class="sticky">
      <nav class="navbar" id="topnav"></nav>
      <div class="topprogress"><div id="topbar"></div></div>
      <div class="statusline" id="statusline">진행률 0%</div>
    </div>
    <section class="card" id="app"></section>
  </main>
</div>

<div class="sideNav left" id="sideLeft" style="display:none"><button class="sideBtn" onclick="prev()" aria-label="이전">‹</button></div>
<div class="sideNav right" id="sideRight" style="display:none"><button class="sideBtn" onclick="next()" aria-label="다음">›</button></div>

<script>
/* ===== 연결값(시트/폼) ===== */
const SHEET_ID   = '14VLQBhDJtduxjCnfr7VEOstZ5ez8-CX3ArXy1OvYCQg';
const FORM_ACTION= 'https://docs.google.com/forms/d/e/1FAIpQLSeRWq5YKN50zL0simiaQA6EBRsn6VXN__ZmLplAgDz1I1hyQA/formResponse';

/* ⚠️ top3와 resultId가 뒤바뀌지 않도록 아래 매핑을 사용하세요. */
const F = {
  child_name:'entry.684468179',
  age:'entry.1066070471',
  grade:'entry.1812672802',
  guardian:'entry.1666083184',
  phone:'entry.89824848',
  campus:'entry.490719219',
  answers:'entry.85364862',
  scores:'entry.1455508168',
  /* 기존과 반대로 지정: top3 → 2120338430, resultId → 1261684833 */
  top3:'entry.2120338430',
  resultId:'entry.1261684833',
  timestamp:'entry.532514127'
};
/* ========================= */

const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Questions&tqx=out:json`;
const DOMAINS = ["관찰력","서사력","디테일","구성력","색감각","공간감","도전성","소통력"];
const STEPS = [{key:'start',label:'시작'},{key:'consent',label:'동의'},{key:'profile',label:'프로필'},{key:'test',label:'테스트'},{key:'result',label:'결과'}];
const STATE = { step:'start', consent:false, consentMeta:null, profile:{}, questions:[], idx:0, answers:[], result:null };

const $=id=>document.getElementById(id);
const v=id=>$(id)?.value?.trim()??'';

/* NAV + Progress */
function renderNav(){
  const cur = STEPS.findIndex(s=>s.key===STATE.step);
  $('topnav').innerHTML = STEPS.map((s,i)=>`<div class="step ${s.key===STATE.step?'active':''} ${cur>i?'done':''}" onclick="navGo('${s.key}')"><span class="num">${i+1}</span><span>${s.label}</span></div>`).join('')
}
function updateTopProgress(){
  if(STATE.step==='test' && STATE.questions.length){
    const q = Math.round(STATE.idx/STATE.questions.length*100);
    $('topbar').style.width=q+'%'; $('statusline').textContent=`테스트 진행 ${STATE.idx+1}/${STATE.questions.length} (${q}%)`;
    $('sideLeft').style.display='block'; $('sideRight').style.display='block'; return;
  }
  $('sideLeft').style.display='none'; $('sideRight').style.display='none';
  let pct = (STEPS.findIndex(s=>s.key===STATE.step))/(STEPS.length-1)*100;
  $('topbar').style.width=Math.round(pct)+'%'; $('statusline').textContent=`진행률 ${Math.round(pct)}%`;
}
function navGo(step){ STATE.step=step; if(step==='test' && STATE.questions.length===0){ startTest(); return; } render(); }
const go=navGo;

/* GViz 파서 */
function parseGViz(text){
  const s=text.indexOf('{'), e=text.lastIndexOf('}');
  if(s<0||e<0) return [];
  const obj=JSON.parse(text.slice(s,e+1));
  const cols=obj.table.cols.map(c=>c.label);
  return obj.table.rows.map(r=>r.c.map(c=>c?(c.f??c.v):'')).map(a=>Object.fromEntries(cols.map((k,i)=>[k,a[i]])));
}
async function loadQuestions(){
  const txt=await (await fetch(GVIZ_URL)).text(); const rows=parseGViz(txt)||[];
  const act=rows.filter(r=>String(r.active).toUpperCase()==='TRUE').sort((a,b)=>(+a.order - +b.order));
  STATE.questions=act.map(r=>({ id:r.id, order:+r.order, prompt:r.prompt,
    options:['A','B','C','D'].map(k=>({ key:k, label:r[`${k}_label`]||'', imageUrl:r[`${k}_image`]||'', alt:r[`${k}_label`]||'',
      weights:(()=>{try{return JSON.parse(r[`${k}_weights`])||{}}catch{return{}}})() })) }));
}

/* START – 히어로 */
function startScreen(){
  return `
  <div class="heroWrap">
    <div class="glows"></div>
    <div class="orb a"></div><div class="orb b"></div>

    <div class="heroBadges">
      <span class="badge">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 3l2.7 5.5 6.1.9-4.4 4.3 1 6.1L12 17l-5.4 2.8 1-6.1-4.4-4.3 6.1-.9L12 3z" stroke="#FFB98A" stroke-width="1.5" stroke-linejoin="round"/></svg>
        미술적성테스트 Basic
      </span>
      <span class="badge">
        <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#FFB98A" stroke-width="1.5"/><path d="M12 7v6l4 2" stroke="#FFB98A" stroke-width="1.5" stroke-linecap="round"/></svg>
        약 6–8분
      </span>
      <span class="badge">
        <svg viewBox="0 0 24 24" fill="none"><path d="M7 10h10M7 14h7" stroke="#FFB98A" stroke-width="1.6" stroke-linecap="round"/><rect x="4" y="4" width="16" height="16" rx="3" stroke="#FFB98A" stroke-width="1.5"/></svg>
        즉시 결과·PDF 저장
      </span>
    </div>

    <div class="heroTitle">바른미술학원 · 미술적성테스트</div>
    <p class="heroSub">
      아이의 <b>미술 적성</b>과 <b>잠재력</b>을 가볍게 확인하고, 항목별 결과를 즉시 확인하는 테스트입니다.
    </p>

    <div class="heroGrid">
      ${[
        {head:'부담 없이 빠르게',desc:'12문항으로 핵심만 체크합니다.',icon:'<path d="M3 12h18M12 3v18" stroke="#FFB98A" stroke-width="1.6" stroke-linecap="round"/>'},
        {head:'정확하고 보기 쉬운 결과',desc:'8개 영역 점수와 영역별 해석을 제공합니다.',icon:'<circle cx="12" cy="12" r="7" stroke="#FFB98A" stroke-width="1.6"/><path d="M12 8v5l3 2" stroke="#FFB98A" stroke-width="1.6" stroke-linecap="round"/>'},
        {head:'저장·공유 간편',desc:'결과 화면에서 바로 인쇄/PDF 저장.',icon:'<path d="M6 9V5a2 2 0 0 1 2-2h8v6H6z" stroke="#FFB98A" stroke-width="1.6"/><path d="M6 14h12v5H6z" stroke="#FFB98A" stroke-width="1.6"/>'},
      ].map(c=>`
        <div class="fcard tilt">
          <div class="fhead">
            <span class="ficon"><svg viewBox="0 0 24 24" fill="none">${c.icon}</svg></span>
            ${c.head}
          </div>
          <div class="fdesc">${c.desc}</div>
        </div>`).join('')}
    </div>

    <div class="ctaRow">
      <button class="btn btn-mint" onclick="go('consent')" 
        onmousemove="this.style.setProperty('--x', event.offsetX+'px'); this.style.setProperty('--y', event.offsetY+'px')">시작하기</button>
    </div>
    <div class="ctaHelp">※ 본 테스트는 <b>교육 가이드</b> 목적이며 의학/임상 진단이 아닙니다.</div>
  </div>`;
}
function viewStart(){
  $('app').innerHTML = startScreen();
  attachTilt('.tilt');
  window.scrollTo({top:0,behavior:'smooth'});
}
function attachTilt(sel){
  document.querySelectorAll(sel).forEach(el=>{
    const r=12;
    el.addEventListener('mousemove',e=>{
      const b=el.getBoundingClientRect(), x=e.clientX-b.left, y=e.clientY-b.top;
      const px=(x/b.width-.5)*2, py=(y/b.height-.5)*2;
      el.style.setProperty('--rx',(-py*r)+'deg');
      el.style.setProperty('--ry',( px*r)+'deg');
    });
    el.addEventListener('mouseleave',()=>{ el.style.setProperty('--rx','0deg'); el.style.setProperty('--ry','0deg'); });
  });
}

/* CONSENT – 아코디언 + 동의문장 오른쪽 체크 */
function accItem(head,body){return `
  <div class="acc-item open">
    <div class="acc-head"><span><b>${head}</b></span>
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div class="acc-body small">${body}</div>
  </div>`}
function viewConsent(){
  $('app').innerHTML=`
    <h2 class="center">개인정보 수집·이용 동의서</h2>
    <p class="muted small center" style="margin-top:4px">
      본 테스트는 <b>교육 가이드</b> 제공을 목적으로 하며, 의학·임상 진단이 아닙니다.
    </p>
    <div class="acc">
      ${accItem('1) 처리 목적',
        '<ul class="ul"><li>미술적성테스트 제공 및 결과 산출</li><li>영역별 결과 및 코칭 포인트 제공</li><li>서비스 품질 개선을 위한 통계 분석</li></ul>')}
      ${accItem('2) 수집 항목',
        '<ul class="ul"><li><b>필수</b>: 아동 이름·나이·학년, 보호자 이름·연락처, 문항 응답</li><li><b>선택</b>: 관심 캠퍼스</li></ul>')}
      ${accItem('3) 보관 기간',
        '수집일로부터 <b>12개월</b> 보관 후 안전하게 파기합니다.')}
      ${accItem('4) 보관/처리',
        'Google Forms/Sheets에 안전하게 저장·처리합니다.')}
      ${accItem('5) 권리 및 유의사항',
        '<ul class="ul"><li>동의는 거부할 수 있으며, 미동의 시 서비스 이용이 제한될 수 있습니다.</li><li>열람·정정·삭제 등 권리 행사가 가능합니다.</li></ul>')}
      ${accItem('6) 문의',
        '관리자 이메일: <b>barunart1004@gmail.com</b>')}
    </div>

    <div class="section" style="margin-top:16px">
      <div class="grid grid-2">
        <div><label>보호자 성명(서명)</label><input id="consent_guardian" placeholder="예: 홍길동(서명)"></div>
        <div><label>연락처</label><input id="consent_phone" placeholder="010-0000-0000"></div>
        <div><label>아동과의 관계</label>
          <select id="consent_relation"><option>부모</option><option>법정대리인</option><option>기타</option></select>
        </div>
      </div>

      <div class="agreeList">
        <label class="agreeItem">
          <span>(필수) 개인정보 수집·이용에 동의합니다.</span>
          <input type="checkbox" id="chk_required">
        </label>
        <label class="agreeItem">
          <span>(필수) 만 14세 미만 아동의 법정대리인으로서 동의합니다.</span>
          <input type="checkbox" id="chk_minor">
        </label>
      </div>
    </div>

    <div class="center" style="margin-top:16px; display:flex; gap:8px; justify-content:center">
      <button class="btn" id="btn_consent" disabled>동의하고 진행</button>
      <button class="btn-ghost" onclick="document.querySelectorAll('.acc-item').forEach(it=>it.classList.add('open'))">전문 펼치기</button>
      <button class="btn-ghost" onclick="document.querySelectorAll('.acc-item').forEach(it=>it.classList.remove('open'))">모두 접기</button>
    </div>`;

  const validate=()=>{
    const ok=$('chk_required').checked&&$('chk_minor').checked;
    const g=$('consent_guardian').value.trim();
    const p=$('consent_phone').value.trim();
    const okp=/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(p);
    $('btn_consent').disabled=!(ok&&g.length>=2&&okp);
  };
  ['chk_required','chk_minor','consent_guardian','consent_phone'].forEach(id=>{
    $(id).addEventListener('input',validate); $(id).addEventListener('change',validate);
  });
  $('btn_consent').onclick=()=>{
    STATE.consent=true;
    STATE.consentMeta={guardian:$('consent_guardian').value.trim(),phone:$('consent_phone').value.trim(),relation:$('consent_relation').value,ver:'v2.2'};
    go('profile');
  };
  document.querySelectorAll('.acc-head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
}

/* PROFILE */
function viewProfile(){
  $('app').innerHTML=`<h2 class="center">프로필 정보</h2>
  <div class="grid grid-2" style="margin-top:8px">
    <div><label>아동 이름</label><input id="cname" placeholder="예: 홍길동"></div>
    <div><label>나이</label><select id="age"><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
    <div><label>학년</label><select id="grade">
      <option>초등학교 1학년</option><option>초등학교 2학년</option><option>초등학교 3학년</option>
      <option>초등학교 4학년</option><option>초등학교 5학년</option><option>초등학교 6학년</option></select></div>
    <div><label>보호자 이름</label><input id="gname"></div>
    <div><label>연락처</label><input id="phone" placeholder="010-0000-0000"></div>
    <div><label>관심 캠퍼스(선택)</label><input id="campus" placeholder="예: 분당점"></div>
  </div>
  <div class="center" style="margin-top:16px"><button class="btn btn-mint" onclick="startTest()">테스트 시작</button></div>`;
}
async function startTest(){
  STATE.profile={child_name:v('cname'),age:v('age'),grade:v('grade'),guardian:v('gname'),phone:v('phone'),campus:v('campus')};
  if(!STATE.profile.child_name || !/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(STATE.profile.phone||'')){ alert('이름/연락처를 확인해 주세요'); return; }
  await loadQuestions(); STATE.idx=0; STATE.answers=[]; STATE.step='test'; render();
}

/* TEST */
function viewTest(){
  const q=STATE.questions[STATE.idx]; if(!q){ $('app').innerHTML='<h3 class="center">문항을 불러오지 못했습니다. 관리자에 문의해 주세요.</h3>'; return; }
  const gridCls = (window.matchMedia('(min-width:1024px)').matches?'test-grid':'grid grid-2');
  $('app').innerHTML=`<div class="center small muted">Q${STATE.idx+1} / ${STATE.questions.length}</div>
    <h2 class="center" style="margin-top:6px">${q.prompt||''}</h2>
    <div class="${gridCls}" style="margin-top:10px">
      ${q.options.map(o=>`<div class="opt" id="opt_${o.key}" tabindex="0" role="button" aria-label="${o.label}" onclick="choose('${o.key}')" onkeydown="if(event.key==='Enter'||event.key===' '){choose('${o.key}')}">
        <img src="${o.imageUrl}" alt="${o.label}" onerror="this.style.opacity=.2" loading="lazy"><div class="cap center">${o.label}</div></div>`).join('')}
    </div>
    <div class="center" style="margin-top:18px; display:flex; gap:8px; justify-content:center">
      <button class="btn-ghost" onclick="prev()" ${STATE.idx===0?'disabled':''}>이전</button>
      <button class="btn" id="nextBtn" onclick="next()" disabled>다음</button>
    </div>`;
  document.addEventListener('keydown',e=>{ if(e.key==='ArrowRight'){ next(); } if(e.key==='ArrowLeft'){ prev(); } if(e.key==='Enter'){ if(!$('nextBtn').disabled) next(); } },{once:true});
}
function choose(key){
  const q=STATE.questions[STATE.idx];
  ['A','B','C','D'].forEach(k=>{const n=document.getElementById(`opt_${k}`); if(n) n.classList.remove('sel');});
  const node=document.getElementById(`opt_${key}`); if(node){ node.classList.add('sel'); node.animate([{transform:'scale(1)'},{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:160}); }
  const opt=q.options.find(o=>o.key===key);
  STATE.answers[STATE.idx]={ qid:q.id, key, weights:opt.weights };
  document.getElementById('nextBtn').disabled=false;
}
function next(){ if(!STATE.answers[STATE.idx]){ alert('하나를 선택해 주세요'); return; } if(STATE.idx<STATE.questions.length-1){ STATE.idx++; render(); } else submitAll(); }
function prev(){ if(STATE.idx>0){ STATE.idx--; render(); } }

/* 점수 보정 / 멘트 */
function aggregateScores(ans){
  const sum={}; DOMAINS.forEach(d=>sum[d]=0);
  ans.forEach(a=>Object.entries(a.weights||{}).forEach(([k,v])=>sum[k]=(sum[k]||0)+Number(v||0)));
  const n=ans.length||1; const raw={};
  DOMAINS.forEach(d=>{ const v=(sum[d]||0)/n*4; raw[d]=Math.max(0,Math.round(v*10)/10); });
  return raw;
}
const adjust=v=>Math.round((2 + v/2) * 10)/10; // 0→2.0, 4→4.0
function band(v){ if(v>=3.6) return 'S'; if(v>=3.2) return 'A'; if(v>=2.8) return 'A-'; if(v>=2.4) return 'B+'; if(v>=2.0) return 'B'; if(v>=1.6) return 'B-'; if(v>=1.0) return 'C+'; return 'C'; }

const DETAIL = {
  '관찰력':(n)=>`${n}님은 대상을 오래 바라보고 특징을 뽑아내는 힘이 뛰어나요. 작은 변화도 놓치지 않아 표현의 밀도가 높아집니다.`,
  '서사력':(n)=>`${n}님은 장면 속에 이야기를 심는 데 강점이 있어요. 사건의 흐름과 감정을 자연스럽게 연결합니다.`,
  '디테일':(n)=>`${n}님은 마감과 표현의 섬세함이 돋보여요. 질감·무늬·작은 요소까지 챙기는 집중력이 강점입니다.`,
  '구성력':(n)=>`${n}님은 화면에서 시선이 흐르는 길을 잘 설계해요. 중심과 여백의 균형을 안정적으로 잡습니다.`,
  '색감각':(n)=>`${n}님은 색의 분위기를 읽고 조합하는 능력이 뛰어나요. 미묘한 톤 차이도 감각적으로 잡아냅니다.`,
  '공간감':(n)=>`${n}님은 원근·스케일을 활용해 입체감을 살리는 데 강합니다. 장면의 깊이를 안정적으로 구성합니다.`,
  '도전성':(n)=>`${n}님은 새로운 도구와 방식에 두려움이 적어요. 실패를 경험으로 바꾸며 시도를 이어갑니다.`,
  '소통력':(n)=>`${n}님은 자신의 의도를 언어로 설명하는 힘이 좋아요. 작품의 핵심을 또래에게 설득력 있게 전달합니다.`
};
const PRAISE={
  'S':k=>`와, ${k}에서 <b>타고난 재능</b>이 돋보여요! 스스로 기획하는 수준까지 노려볼 수 있어요.`,
  'A':k=>`${k} 감각이 <b>뛰어납니다</b>. 난이도를 올려도 충분히 소화해요.`,
  'A-':k=>`${k} 실력이 <b>탄탄</b>해요. 조금만 다듬으면 금방 상위권!`,
  'B+':k=>`${k}이 안정적이에요. 새로운 시도에도 잘 적응합니다.`,
  'B':k=>`${k} 기본기가 좋아요. 루틴을 넓히면 <b>성장 속도 가속</b>!`
};
/* 실생활 15분 루틴 – 구체/쉽게 */
const MISSIONS={
  '관찰력':{'S':'집에 있는 과일 1개를 5분 관찰 → 특징 3가지 말하기 → 10분 스케치','A':'창밖 풍경에서 물체 3개 골라 1분씩 연속 스케치','A-':'가위·빗·컵 등 생활 물건 3개를 윤곽선만 빠르게 그리기','B+':'거울 보고 표정 3가지, 각 2분 드로잉','B':'집안 물건 한 가지를 10개 형태로 단순화해보기'},
  '서사력':{'S':'오늘 있었던 일로 4컷 이야기 만들기(말풍선 최소 1개)','A':'주인공·장소·문제를 정해 3컷 구성 → 핵심 문장 1개 쓰기','A-':'앞·중간·끝 3장면 썸네일(각 2분)','B+':'그림 속 인물에게 질문 3개 만들고 답 상상하기','B':'좋아하는 동물 하루 일기를 한 문장+그림으로'},
  '디테일':{'S':'집 주변 재질(나무·금속·천) 중 1개 선택 → 10분 질감 표현','A':'소지품 하나 확대해서 무늬/단추/바느질 등 표현','A-':'라인 두께 3단계로 같은 사물 정리해서 그리기','B+':'지우개로 하이라이트 살리기 연습(동전/과일)','B':'색연필 3색만으로 명암 3단계 만들기'},
  '구성력':{'S':'잡지/전단지 잘라 A4에 포스터처럼 재배치하기','A':'주제 1개로 썸네일 6장(각 1분) – 시선 흐름 표시','A-':'가장 중요한 것 1개 크게/덜 중요한 것 작게 배치','B+':'3×3 격자 속에 물건 배치해 그리기','B':'여백 1/3 남기는 구성으로 간단한 정물'},
  '색감각':{'S':'한정 팔레트(2색+화이트)로 장면 색 바꾸기','A':'따뜻한색/차가운색으로 같은 사물 두 번 칠하기','A-':'보색 한 쌍 골라 포인트 한 곳만 강조','B+':'연필로 명암 넣고 마커 1색만 덧칠','B':'원색 3개를 서로 섞어 5가지 파생색 만들기'},
  '공간감':{'S':'책상 위 물건을 위에서 본 시점으로 배치 후 그리기','A':'방 한쪽을 1점투시로 간단 스케치','A-':'앞/중/뒤 3단 레이어로 거리감 표현','B+':'작은 장난감을 멀/가까이 놓고 크기 차 표시','B':'바닥에 테이프 가로줄 붙이고 박스 올려 그리기'},
  '도전성':{'S':'안 써본 도구 1개(면봉/스펀지 등)로 10분 실험','A':'평소와 다른 손(왼손)으로 5분 드로잉','A-':'실패작 1장 골라 10분 리터치해서 살리기','B+':'사진 1장을 20개 선으로만 표현하기','B':'다른 종이(영수증/신문)에 그려보기'},
  '소통력':{'S':'완성작에 제목·설명 2문장 쓰기(의도/느낀점)','A':'그림 보여주고 친구/가족에게 한 문장 설명 연습','A-':'핵심 단어 3개 뽑아 옆에 적기','B+':'작품 바꾸어 칭찬 3가지 적기','B':'그림 속 소리/냄새/감촉 한 단어씩 쓰기'}
};

function nowKST(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())} KST`; }
async function submitAll(){
  const raw=aggregateScores(STATE.answers);
  const scores=Object.fromEntries(Object.entries(raw).map(([k,v])=>[k,adjust(v)])); // 2.0~4.0 보정
  const top3=Object.keys(scores).sort((a,b)=>scores[b]-scores[a]).slice(0,3);   // ["관찰력","색감각","..."]
  const resultId=(crypto.randomUUID?crypto.randomUUID():Date.now().toString(36));

  const form=new FormData();
  const answersWithMeta={consent:STATE.consentMeta,profile:STATE.profile,questions:STATE.answers};
  form.append(F.child_name,STATE.profile.child_name); form.append(F.age,STATE.profile.age); form.append(F.grade,STATE.profile.grade);
  form.append(F.guardian,STATE.profile.guardian); form.append(F.phone,STATE.profile.phone); form.append(F.campus,STATE.profile.campus||'');
  form.append(F.answers,JSON.stringify(answersWithMeta)); form.append(F.scores,JSON.stringify(scores));
  form.append(F.top3,top3.join(','));                       // ✅ 영역명 3개가 들어감
  form.append(F.resultId,resultId);                         // ✅ uuid는 resultId로
  form.append(F.timestamp,nowKST());
  try{ fetch(FORM_ACTION,{method:'POST',mode:'no-cors',body:form}); }catch(e){}
  STATE.result={scores,top3,resultId}; STATE.step='result'; render();
}

/* RESULT – 레이더(왼쪽) + 막대(오른쪽) 한 줄 */
let CHARTS=[];
function destroyCharts(){ CHARTS.forEach(c=>c.destroy?.()); CHARTS=[]; }
function viewResult(){
  const r=STATE.result, s=r?.scores||{};
  const overall = Math.round((Object.values(s).reduce((a,b)=>a+(+b||0),0))*10)/10 || 0;

  $('app').innerHTML=`<div id="resultCard">
    <div class="block callout" style="text-align:center">
      <div class="chips" style="justify-content:center;gap:6px;margin-bottom:6px">
        <span class="chip">${STATE.profile.child_name}</span>
        <span class="chip">${STATE.profile.age}세</span>
        <span class="chip">${STATE.profile.grade}</span>
      </div>
      <h2 style="margin:4px 0 8px"><b>${STATE.profile.child_name}</b>님, 수고 많았어요!</h2>
      <div class="kpi" style="justify-content:center"><div class="num" style="font-size:50px">${overall.toFixed(1)}</div><div class="unit">/ 32 (8영역 합산)</div></div>
      <p class="small" style="margin-top:8px;color:#0f172a;font-size:15px">
        특히 <b>${r.top3.join(', ')}</b> 영역에서 강점이 또렷합니다. 즐거운 일상 15분 루틴으로 잠재력을 크게 키워 볼게요.
      </p>
    </div>

    <div class="grid grid-2">
      <div class="block" style="overflow:hidden"><h3 class="center">영역별 관심도</h3><canvas id="radar" height="240"></canvas></div>
      <div class="block" style="overflow:hidden"><h3 class="center">뛰어난 영역(Top3)</h3><canvas id="bars" height="240"></canvas></div>
    </div>

    <div class="block">
      <h3>총평</h3>
      <p style="color:#0f172a;font-size:15px;line-height:1.7">
        아이의 강점이 선명하게 드러난 결과예요. 스스로 선택하고 몰입할 때 성장이 크게 일어납니다.
        “잘할 수 있다”는 경험을 꾸준히 쌓도록, 집에서도 바로 할 수 있는 15분 루틴을 제안합니다.
      </p>
      <div class="chips" style="margin-top:6px">${r.top3.map(t=>`<span class="chip">${t} 우수</span>`).join('')}</div>
    </div>

    <div class="block">
      <h3>항목별 해석 & 일일 15분 훈련</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        ${DOMAINS.map(k=>{
          const v=+(s[k]||0), b=band(v), w=Math.min(100,(v/4)*100);
          return `<div style="border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff;box-shadow:0 10px 26px rgba(16,24,40,.06)">
            <div style="display:flex;justify-content:space-between;align-items:flex-end">
              <strong>${k}</strong>
              <div class="kpi"><div class="num" style="font-size:28px">${v.toFixed(1)}</div><div class="unit">/ 4.0</div></div>
            </div>
            <div class="topprogress" style="height:10px;margin:8px 0 10px"><div style="width:${w}%;height:100%;background:linear-gradient(90deg,#B9C8FF,#9DE5D5,#FFD9BE)"></div></div>
            <div class="small" style="color:#0f172a">${DETAIL[k](STATE.profile.child_name)}</div>
            <div class="small" style="margin-top:6px;color:#0f172a">${PRAISE[b](k)}</div>
            <div class="small" style="margin-top:6px"><b>오늘의 15분</b> · ${MISSIONS[k][b]||MISSIONS[k]['B']}</div>
          </div>`;
        }).join('')}
      </div>
    </div>

    <p class="credit">※ 본 결과는 교육 가이드 목적이며 의학·임상 진단이 아닙니다.</p>
  </div>

  <div class="center" style="margin-top:16px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
    <button class="btn-ghost" onclick="STATE.step='start'; render()">처음으로</button>
    <button class="btn btn-mint" onclick="window.print()">PDF 저장</button>
  </div>`;

  destroyCharts();
  const rctx=document.getElementById('radar').getContext('2d');
  CHARTS.push(new Chart(rctx,{type:'radar',
    data:{labels:DOMAINS, datasets:[{data:DOMAINS.map(k=>s[k]||0), borderColor:'#FFB98A', backgroundColor:'rgba(255,185,138,.22)', borderWidth:2, pointRadius:3, fill:true}]},
    options:{animation:{duration:900}, scales:{r:{suggestedMin:0,suggestedMax:4,ticks:{stepSize:1},grid:{color:'#eef2f7'},angleLines:{color:'#eef2f7'}}}, plugins:{legend:{display:false}}}
  }));
  const bctx=document.getElementById('bars').getContext('2d');
  CHARTS.push(new Chart(bctx,{type:'bar',
    data:{labels:r.top3, datasets:[{data:r.top3.map(k=>s[k]||0), borderRadius:12, borderSkipped:false, backgroundColor:'#FFE6CF'}]},
    options:{animation:{duration:800}, scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{stepSize:1},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}, plugins:{legend:{display:false}}}
  }));
}

/* Router */
function render(){
  renderNav(); updateTopProgress();
  if(STATE.step==='start') return viewStart();
  if(STATE.step==='consent') return viewConsent();
  if(STATE.step==='profile') return viewProfile();
  if(STATE.step==='test') return viewTest();
  if(STATE.step==='result') return viewResult();
}
render();
</script>
</body>
</html>
