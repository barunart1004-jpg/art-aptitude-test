<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>미술적성테스트 · Basic</title>
<meta name="theme-color" content="#ff7a00" />
<style>
/* ===== Design Tokens : Orange & White (Illustrative) ===== */
:root{
  --bg:#fff7ed;            /* 따뜻한 크림 */
  --surface:#ffffff;
  --ink:#1f2937;
  --muted:#6b7280;
  --accent:#ff7a00;        /* 비비드 오렌지 */
  --accent2:#ffb74a;       /* 소프트 오렌지 */
  --line:#f1f5f9;
  --radius:18px;
  --shadow:0 16px 44px rgba(17,24,39,.08);
  --step-dim:#f9fafb;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family: ui-sans-serif, system-ui, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
  line-height:1.55;
}

/* ===== Decorative Header (Illustration vibe) ===== */
.hero{
  position:relative; overflow:hidden; background:linear-gradient(180deg,#fff 0%, #fff8f0 100%);
  border-bottom:1px solid var(--line);
}
.hero .wrap{max-width:1080px; margin:0 auto; padding:24px 24px 10px 24px}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.brand .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.brand span{letter-spacing:.2px}
.hero-art{
  position:absolute; right:-60px; top:-60px; width:320px; height:320px; pointer-events:none; opacity:.9;
  background:
    radial-gradient(closest-side at 35% 40%, #ffe6c4 0%, transparent 70%),
    radial-gradient(closest-side at 65% 60%, #fff2e1 0%, transparent 70%);
  border-radius:50%;
  filter: saturate(1.15);
}
.hero-wave{
  position:relative; width:100%; height:70px; margin-top:8px;
  background:
    radial-gradient(120px 70px at 15% 0, #ffd7b0 0, transparent 70%),
    radial-gradient(160px 80px at 45% 0, #ffe6c4 0, transparent 70%),
    radial-gradient(140px 70px at 75% 0, #fff2e1 0, transparent 70%);
  mask: radial-gradient(200% 70px at 50% -10px, #0000 55%, #000 56%);
}

/* ===== Global wrapper ===== */
.main{max-width:980px; margin:0 auto; padding:20px 24px 32px}

/* ===== Card ===== */
.card{
  background:var(--surface); border:1px solid var(--line);
  border-radius:var(--radius); padding:22px; box-shadow:var(--shadow);
}

/* ===== Typography ===== */
h1{font-size:38px; line-height:1.2; margin:0 0 6px}
h2{font-size:26px; margin:0 0 12px}
h3{font-size:18px; margin:18px 0 8px}
p{margin:10px 0} .small{font-size:13px} .muted{color:var(--muted)}

/* ===== Layout ===== */
.row{display:flex; align-items:center; justify-content:space-between; gap:12px}
.grid{display:grid; gap:16px}
.grid-2{grid-template-columns:1fr 1fr}
@media (max-width:860px){ .grid-2{grid-template-columns:1fr} h1{font-size:32px} }

/* ===== Buttons ===== */
.btn{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#111; border:none; padding:14px 18px; border-radius:12px; font-weight:850; cursor:pointer;
  box-shadow:0 10px 30px rgba(255,122,0,.28);
  transition:transform .08s ease, filter .2s ease;
}
.btn:hover{transform:translateY(-1px)}
.btn:disabled{opacity:.5; cursor:not-allowed}
.btn-ghost{
  background:#fff; color:var(--ink); border:1px solid var(--line);
  padding:12px 14px; border-radius:12px; font-weight:750; cursor:pointer;
}

/* ===== Inputs ===== */
input,select,textarea{
  width:100%; background:#fff; color:var(--ink);
  border:1px solid var(--line); border-radius:12px; padding:12px; outline:none;
}
input:focus,select:focus,textarea:focus{border-color:#ffd7b0; box-shadow:0 0 0 4px rgba(255,122,0,.15)}
label{font-size:14px; color:#374151}
.section{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}

/* ===== Step Navigation (Top) ===== */
.navbar{
  display:flex; align-items:center; gap:12px; flex-wrap:wrap;
  background:#fff; border:1px solid var(--line); border-radius:14px; padding:10px 12px; box-shadow:var(--shadow);
}
.step{
  display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
  background:var(--step-dim); color:#374151; font-weight:800; cursor:pointer; border:1px solid var(--line);
}
.step .num{width:22px;height:22px;border-radius:50%;display:inline-grid;place-items:center;background:#fff;border:1px solid var(--line);font-size:12px}
.step.active{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#111; border-color:transparent}
.step.active .num{background:#fff}
.step.done{background:#eafff2; border-color:#b6f3c9}
.spacer{flex:1}
.link-admin{font-weight:800; color:#111; background:linear-gradient(90deg,#ffd7b0,#ffe6c4); padding:8px 12px; border-radius:10px; border:1px solid var(--line); text-decoration:none}

/* ===== Progress ===== */
.progress{height:10px; background:#f3f4f6; border-radius:999px; overflow:hidden}
.progress>div{height:100%; width:0; background:linear-gradient(90deg,#60a5fa,#22d3ee); transition:width .25s}

/* ===== Options ===== */
.opt{border:2px solid var(--line); border-radius:14px; overflow:hidden; cursor:pointer; background:#fff}
.opt img{width:100%; display:block; aspect-ratio:4/3; object-fit:cover}
.opt .cap{padding:12px; color:#374151; font-weight:650}
.opt.sel{border-color:#ffbf7a; box-shadow:0 0 0 4px rgba(255,122,0,.18)}

/* ===== Accordion (Consent) ===== */
.acc{border-radius:14px; overflow:hidden; border:1px solid var(--line)}
.acc-item{border-top:1px solid var(--line)}
.acc-head{padding:14px 16px; background:#fff9f2; cursor:pointer; display:flex; justify-content:space-between; align-items:center}
.acc-body{padding:14px 16px; display:none; background:#fff}
.acc-item.open .acc-body{display:block}

/* ===== Print ===== */
@media print{
  body{background:#fff}
  .hero, .navbar, .btn, .btn-ghost {display:none !important}
  .card{box-shadow:none; border:1px solid #ddd}
}
</style>
</head>
<body>
  <!-- Header (brand + illustration) -->
  <header class="hero">
    <div class="hero-art" aria-hidden="true"></div>
    <div class="wrap">
      <div class="brand"><div class="dot"></div><span>바른미술학원 · 미술적성테스트</span></div>
      <div class="hero-wave" aria-hidden="true"></div>
    </div>
  </header>

  <!-- Main -->
  <div class="main">
    <!-- Step navigation -->
    <nav class="navbar" id="topnav">
      <!-- steps are injected by JS -->
    </nav>

    <!-- Page card -->
    <section class="card" id="app"></section>
  </div>

<script>
/* ==================== 필수 값 (TODO) ==================== */
// 1) 스프레드시트 문서 ID
const SHEET_ID = 'YOUR_SHEET_ID'; // ← TODO

// 2) Google Form formResponse 주소 (Results 저장)
const FORM_ACTION = 'https://docs.google.com/forms/d/e/【FORM_ID】/formResponse'; // ← TODO

// 3) Google Form 항목 매핑 (entry.xxx)
const F = {
  child_name:'entry.111111', // ← TODO
  age:'entry.222222',        // ← TODO
  grade:'entry.333333',      // ← TODO
  guardian:'entry.444444',   // ← TODO
  phone:'entry.555555',      // ← TODO
  campus:'entry.666666',     // ← TODO
  answers:'entry.777777',    // ← TODO
  scores:'entry.888888',     // ← TODO
  top3:'entry.999999',       // ← TODO
  resultId:'entry.123123',   // ← TODO
  timestamp:'entry.321321'   // ← (선택)
};
/* ======================================================== */

const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Questions&tqx=out:json`;
const DOMAINS = ["관찰력","서사력","디테일","구성력","색감각","공간감","도전성","소통력"];
const STEPS = [
  {key:'start',   label:'시작'},
  {key:'consent', label:'동의'},
  {key:'profile', label:'프로필'},
  {key:'test',    label:'테스트'},
  {key:'result',  label:'결과'}
];

const STATE = { step:'start', consent:false, consentMeta:null, profile:{}, questions:[], idx:0, answers:[], result:null };
const $ = id => document.getElementById(id);
const v = id => $(id)?.value?.trim() ?? '';
const app = () => $('app');

/* ---- Top step navigation ---- */
function renderNav(){
  const cur = STATE.step;
  const items = STEPS.map((s,i)=>{
    const active = s.key===cur ? 'active' : '';
    const done = (STEPS.findIndex(x=>x.key===cur) > i) ? 'done' : '';
    const disabled = (s.key==='result' && !STATE.result) ? 'style="pointer-events:none;opacity:.6"' : '';
    return `<div class="step ${active} ${done}" ${disabled} onclick="navGo('${s.key}')">
      <span class="num">${i+1}</span><span>${s.label}</span>
    </div>`;
  }).join('');
  $('topnav').innerHTML = items + `<div class="spacer"></div><a class="link-admin" href="./admin.html" target="_blank" rel="noopener">관리자</a>`;
}
function navGo(step){
  // 자유 이동 허용(결과만 예외: STATE.result 없으면 이동 불가)
  if(step==='result' && !STATE.result){ alert('아직 결과가 없습니다. 테스트를 완료해 주세요.'); return; }
  STATE.step = step;
  if(step==='test' && (!STATE.questions || STATE.questions.length===0)) startTest(); else render();
}

/* ---- Helpers ---- */
function parseGViz(text){
  const s=text.indexOf('{'), e=text.lastIndexOf('}'); if(s<0||e<0) return [];
  const obj=JSON.parse(text.slice(s,e+1));
  const cols=obj.table.cols.map(c=>c.label);
  return obj.table.rows.map(r=>r.c.map(c=>c?(c.f??c.v):'')).map(a=>Object.fromEntries(cols.map((k,i)=>[k,a[i]])));
}
async function loadQuestions(){
  const txt=await (await fetch(GVIZ_URL)).text();
  const rows=parseGViz(txt);
  const act=rows.filter(r=>String(r.active).toUpperCase()==='TRUE').sort((a,b)=>(+a.order - +b.order));
  STATE.questions=act.map(r=>({
    id:r.id, order:+r.order, prompt:r.prompt,
    options:['A','B','C','D'].map(k=>({
      key:k, label:r[`${k}_label`]||'', imageUrl:r[`${k}_image`]||'', alt:r[`${k}_label`]||'',
      weights: (function(){try{return JSON.parse(r[`${k}_weights`])||{}}catch{return{}}})()
    }))
  }));
}
function nowKST(){ const d=new Date(), p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())} KST`; }

/* ---- Views ---- */
function viewStart(){
  app().innerHTML = `
    <div class="row" style="gap:8px"><span class="btn-ghost" style="font-weight:850;border-radius:999px;background:#fff9f2;border-color:#ffe4c7">ART APTITUDE · BASIC</span><span class="muted small">6–8분 · 결과 즉시</span></div>
    <h1>미술적성테스트</h1>
    <p class="muted">아이의 강점을 발견하고, 집에서 오늘 바로 할 수 있는 15분 미션을 추천합니다.</p>
    <div class="row" style="margin-top:16px">
      <button class="btn" onclick="go('consent')">시작하기</button>
    </div>
  `;
}
function accItem(title, html){
  return `
  <div class="acc-item open">
    <div class="acc-head"><span>${title}</span>
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div class="acc-body small">${html}</div>
  </div>`;
}
function toggleAll(open){ document.querySelectorAll('.acc-item').forEach(it=>it.classList.toggle('open', !!open)); }
function viewConsent(){
  app().innerHTML = `
    <h2>보호자 개인정보 및 이용 동의서</h2>
    <p class="muted small">본 테스트는 <b>교육 가이드</b> 목적이며 <b>의학·임상 진단이 아닙니다.</b> 만 14세 미만은 보호자 동의가 필요합니다.</p>
    <div class="acc" id="acc">
      ${accItem('1. 수집·이용 목적', '미술적성테스트 제공, 결과 산출 및 맞춤 가이드 제공 / 상담·등록 안내 / 서비스 품질 개선(통계·분석)')}
      ${accItem('2. 수집 항목', '<b>필수</b>: 아동 이름·나이·학년 / 보호자 이름·연락처 / 테스트 응답<br/><b>자동수집</b>: 접속 일시·브라우저·쿠키·로그')}
      ${accItem('3. 보관·파기', '보관기간: 수집일로부터 <b>12개월</b> / 법령상 의무기간 종료 시까지<br/>파기방법: 전자파일 영구삭제, 출력물 분쇄')}
      ${accItem('4. 제3자 제공·처리위탁', 'Google(시트/드라이브/분석), Netlify/GitHub Pages(호스팅), (선택) 문자·메일 발송사 / 필요한 범위 내에서만 제공')}
      ${accItem('5. 동의 거부권', '동의 거부 가능하나 동의 없을 경우 테스트 이용이 제한될 수 있습니다.')}
      ${accItem('6. 이용자 권리', '열람·정정·삭제·처리정지·동의철회 / 고객센터로 요청 시 지체없이 조치')}
      ${accItem('7. 안전성 확보', '접근권한 최소화, HTTPS 암호화, 접근기록 보관, 정기 점검')}
      ${accItem('8. 연락처', 'JBM SOFT · 이메일: <b>jaewon@jbmsoft.co.kr</b> · 평일 10:00–18:00')}
      ${accItem('9. 고지', '본 동의서·처리방침은 변경될 수 있으며 변경 시 웹에 게시합니다.')}
    </div>

    <div class="section" style="margin-top:16px">
      <div class="grid grid-2">
        <div><label>보호자 성명(서명)</label><input id="consent_guardian" placeholder="예: 홍길동(서명)"></div>
        <div><label>연락처</label><input id="consent_phone" placeholder="010-0000-0000"></div>
        <div><label>동의일시</label><input id="consent_ts" readonly></div>
        <div><label>아동과의 관계</label>
          <select id="consent_relation"><option>부모</option><option>법정대리인</option><option>기타</option></select>
        </div>
      </div>
      <div style="margin-top:12px">
        <label><input type="checkbox" id="chk_required"> (필수) 개인정보 수집·이용에 동의합니다.</label><br/>
        <label><input type="checkbox" id="chk_minor"> (필수) 만 14세 미만 아동의 보호자로서 동의합니다.</label><br/>
        <label><input type="checkbox" id="chk_marketing"> (선택) 교육 소식 수신 동의(문자/이메일)</label>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <button class="btn" id="btn_consent" disabled>동의하고 진행</button>
      <div class="row" style="gap:8px">
        <button class="btn-ghost" onclick="toggleAll(true)">전문 펼치기</button>
        <button class="btn-ghost" onclick="toggleAll(false)">모두 접기</button>
      </div>
    </div>
    <p class="small muted" style="margin-top:8px">※ 본 결과는 교육 가이드 목적이며 <b>의학·임상 진단이 아닙니다.</b></p>
  `;
  $('consent_ts').value = nowKST();
  ['chk_required','chk_minor','consent_guardian','consent_phone'].forEach(id=>{
    $(id).addEventListener('input', evalConsentBtn); $(id).addEventListener('change', evalConsentBtn);
  });
  function evalConsentBtn(){
    const okReq = $('chk_required').checked && $('chk_minor').checked;
    const g = v('consent_guardian');
    const p = v('consent_phone');
    const phoneOK = /^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(p);
    $('btn_consent').disabled = !(okReq && g.length>=2 && phoneOK);
  }
  $('btn_consent').onclick = ()=>{
    STATE.consent = $('chk_required').checked && $('chk_minor').checked;
    STATE.consentMeta = {
      agreed: $('chk_required').checked, minor_guardian: $('chk_minor').checked, marketing: $('chk_marketing').checked,
      guardian: v('consent_guardian'), phone: v('consent_phone'), relation: v('consent_relation'), ts: $('consent_ts').value,
      version: "v1.0 (2025-08-23)"
    };
    if(!STATE.consent) return alert('필수 항목 동의가 필요합니다.');
    go('profile');
  };
  document.querySelectorAll('.acc-head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
  toggleAll(false);
}
function viewProfile(){
  app().innerHTML = `
    <h2>프로필 정보</h2>
    <div class="grid grid-2">
      <div><label>아동 이름</label><input id="cname" placeholder="예: 홍길동"></div>
      <div><label>나이</label><select id="age"><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select></div>
      <div><label>학년</label><select id="grade"><option>1학년</option><option>2학년</option><option>3학년</option><option>4학년</option></select></div>
      <div><label>보호자 이름</label><input id="gname" placeholder="예: 김보호자"></div>
      <div><label>연락처</label><input id="phone" placeholder="010-0000-0000"></div>
      <div><label>관심 캠퍼스(선택)</label><input id="campus" placeholder="예: 분당점"></div>
    </div>
    <div class="row" style="margin-top:16px">
      <button class="btn" onclick="startTest()">테스트 시작</button>
    </div>
  `;
}
async function startTest(){
  STATE.profile = { child_name:v('cname'), age:v('age'), grade:v('grade'), guardian:v('gname'), phone:v('phone'), campus:v('campus') };
  if(!STATE.profile.child_name || !/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(STATE.profile.phone||'')){
    alert('이름/연락처를 확인해 주세요.'); return;
  }
  await loadQuestions(); STATE.idx=0; STATE.answers=[];
  go('test');
}
function viewTest(){
  const q=STATE.questions[STATE.idx];
  const pct=Math.round(STATE.idx/STATE.questions.length*100);
  app().innerHTML = `
    <div class="row small muted"><div>Q${STATE.idx+1}/${STATE.questions.length}</div><div>${pct}%</div></div>
    <div class="progress"><div style="width:${pct}%"></div></div>
    <h2 style="margin-top:12px">${q.prompt}</h2>
    <div class="grid grid-2" style="margin-top:12px">
      ${q.options.map(o=>`
        <div class="opt" id="opt_${o.key}" onclick="choose('${o.key}')">
          <img src="${o.imageUrl}" alt="${o.alt}">
          <div class="cap">${o.label}</div>
        </div>`).join('')}
    </div>
    <div class="row" style="margin-top:18px">
      <button class="btn-ghost" onclick="prev()" ${STATE.idx===0?'disabled':''}>이전</button>
      <button class="btn" onclick="next()">다음</button>
    </div>
  `;
}
function choose(key){
  const q=STATE.questions[STATE.idx];
  ['A','B','C','D'].forEach(k=>document.getElementById(`opt_${k}`).classList.remove('sel'));
  document.getElementById(`opt_${key}`).classList.add('sel');
  const opt=q.options.find(o=>o.key===key);
  STATE.answers[STATE.idx]={ qid:q.id, key, weights:opt.weights };
}
function next(){ if(!STATE.answers[STATE.idx]) return alert('하나를 선택해 주세요.'); if(STATE.idx<STATE.questions.length-1){ STATE.idx++; viewTest(); } else submitAll(); }
function prev(){ if(STATE.idx>0){ STATE.idx--; viewTest(); } }

function aggregateScores(ans){
  const sum={}; DOMAINS.forEach(d=>sum[d]=0);
  ans.forEach(a=>Object.entries(a.weights||{}).forEach(([k,v])=>sum[k]=(sum[k]||0)+Number(v||0)));
  const qCount=ans.length||1, maxPerQ=1.0, max=qCount*maxPerQ;
  const scores={}; DOMAINS.forEach(d=>{ const v=(sum[d]||0)/max*4; scores[d]=Math.round(v*10)/10; }); return scores;
}
async function submitAll(){
  const scores=aggregateScores(STATE.answers);
  const top3=Object.keys(scores).sort((a,b)=>scores[b]-scores[a]).slice(0,3);
  const resultId=crypto.randomUUID();
  const answersWithMeta = { consent: STATE.consentMeta, questions: STATE.answers };

  const form=new FormData();
  form.append(F.child_name, STATE.profile.child_name);
  form.append(F.age, STATE.profile.age);
  form.append(F.grade, STATE.profile.grade);
  form.append(F.guardian, STATE.profile.guardian);
  form.append(F.phone, STATE.profile.phone);
  form.append(F.campus, STATE.profile.campus||'');
  form.append(F.answers, JSON.stringify(answersWithMeta));
  form.append(F.scores, JSON.stringify(scores));
  form.append(F.top3, top3.join(','));
  form.append(F.resultId, resultId);
  form.append(F.timestamp, nowKST());

  fetch(FORM_ACTION, { method:'POST', mode:'no-cors', body:form }).catch(()=>{});
  STATE.result={ scores, top3, resultId }; go('result');
}
function bar(name,val){
  const pct=Math.max(0,Math.min(100,(val/4)*100));
  return `
    <div class="row small"><div>${name}</div><div class="muted">${val}</div></div>
    <div class="progress"><div style="width:${pct}%"></div></div>
    <div style="height:8px"></div>`;
}
function viewResult(){
  const r=STATE.result, s=r.scores||{}; const keys=Object.keys(s);
  app().innerHTML = `
    <div class="row" style="gap:8px">
      <h2 style="margin:0">미술적성 결과</h2>
      <span class="btn-ghost" style="font-weight:850;border-radius:999px;background:#fff9f2;border-color:#ffe4c7">ID · ${r.resultId.slice(0,8)}</span>
    </div>
    <p><b>Top 3</b> : ${r.top3.join(', ')}</p>
    <h3>전체 영역 점수(0~4)</h3>
    ${keys.map(k=>bar(k,s[k])).join('')}
    <div class="row" style="margin-top:16px">
      <button class="btn" onclick="go('start')">처음으로</button>
      <!-- PDF 저장 버튼: 결과 페이지에만 -->
      <button class="btn-ghost" onclick="window.print()">PDF 저장</button>
    </div>
    <p class="small muted" style="margin-top:8px">※ 본 결과는 교육 가이드 목적이며 <b>의학·임상 진단이 아닙니다.</b></p>
  `;
}

/* ---- Router ---- */
function go(step){ STATE.step=step; render(); }
function render(){
  renderNav();
  if(STATE.step==='start')   return viewStart();
  if(STATE.step==='consent') return viewConsent();
  if(STATE.step==='profile') return viewProfile();
  if(STATE.step==='test')    return viewTest();
  if(STATE.step==='result')  return viewResult();
}
render();
</script>
</body>
</html>
