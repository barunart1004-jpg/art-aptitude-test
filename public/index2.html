<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë°”ë¥¸ë¯¸ìˆ í•™ì› Â· ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸ V2. ADVANCE</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<!-- Charts / Capture -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
/* ===== ADVANCE Dark Neon Theme ===== */
:root{
  --bg:#0b1220;         /* page background */
  --ink:#e8eef8;        /* base text on dark */
  --muted:#9aa6b2;
  --line:rgba(148,163,184,.18);

  --card:linear-gradient(180deg,#121a2e 0%,#0e1630 100%);
  --card-soft:linear-gradient(180deg,#111a33 0%,#0c1530 100%);
  --radius:22px;

  /* neon accents */
  --a: #6ee7ff; /* cyan */
  --b: #a78bfa; /* violet */
  --c: #10cdae; /* mint */
  --d: #ffb347; /* amber */
  --shadow:0 24px 80px rgba(0,0,0,.45);
  --soft:0 14px 40px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--ink);
  font-family:"Pretendard",ui-sans-serif,system-ui,"Noto Sans KR",Segoe UI,Roboto,Arial;
  background:
    radial-gradient(60% 80% at 10% -10%, rgba(103,232,249,.18), transparent 60%),
    radial-gradient(70% 85% at 100% 0%, rgba(167,139,250,.16), transparent 55%),
    #0b1220;
}

/* Container */
.container{min-height:100dvh;display:flex;flex-direction:column;align-items:center}
.main{width:100%;max-width:1100px;padding:18px;display:flex;flex-direction:column;gap:16px;margin:0 auto}
.header{width:100%;display:flex;justify-content:center}
.brand{
  width:100%;max-width:1100px;margin-top:10px;display:flex;align-items:center;gap:12px;
  padding:12px 16px;border-radius:999px;background:var(--card);border:1px solid var(--line);
  box-shadow:var(--soft)
}
.logo{width:28px;height:28px;border-radius:50%;
  background:conic-gradient(from 0deg,var(--a),var(--b),var(--c),var(--d),var(--a));
  animation:spin 9s linear infinite paused;filter:saturate(130%)
}
.brand:hover .logo{animation-play-state:running}
@keyframes spin{to{transform:rotate(360deg)}}
.brand span{font-weight:900;letter-spacing:.2px;display:flex;align-items:center;gap:8px}
.badge{font-size:11px;font-weight:900;padding:4px 8px;border-radius:999px;
  background:linear-gradient(90deg,var(--b),var(--a));
  color:#0b1220;border:1px solid rgba(255,255,255,.15)
}

/* Sticky progress */
.sticky{
  position:sticky;top:0;z-index:10;background:rgba(17,24,39,.75);
  backdrop-filter:blur(8px);
  border:1px solid var(--line);border-radius:16px;box-shadow:var(--soft);padding:8px 10px;display:flex;flex-direction:column;gap:10px
}
.navbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.step{
  display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;cursor:pointer;
  background:var(--card);color:#cbd5e1;font-weight:850;border:1px solid var(--line);box-shadow:var(--soft);transition:transform .12s,box-shadow .2s
}
.step:hover{transform:translateY(-1px)}
.step .num{width:20px;height:20px;border-radius:50%;display:inline-grid;place-items:center;background:#0f172a;border:1px solid var(--line);font-size:12px;color:#a3b2c6}
.step.active{background:linear-gradient(90deg,rgba(167,139,250,.25),rgba(110,231,255,.25));color:#fff;box-shadow:0 12px 30px rgba(167,139,250,.35)}
.step.done{background:linear-gradient(90deg,rgba(16,205,174,.18),rgba(110,231,255,.18));border-color:rgba(16,205,174,.35)}

.topprogress{--steps:20;position:relative;height:30px;background:#0f1b35;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
.topprogress .bar{position:absolute;inset:0 auto 0 0;width:0;background:linear-gradient(90deg,var(--b),var(--a),var(--c));border-radius:999px;z-index:1;transition:width .35s ease}
.topprogress::before{
  content:"";position:absolute;inset:0;z-index:2;pointer-events:none;
  background-image:linear-gradient(to right, rgba(148,163,184,.25) 0, rgba(148,163,184,.25) 1px, transparent 1px, transparent calc(100%/var(--steps)));
  background-size:calc(100%/var(--steps)) 100%;
}
.topprogress .toplabel{position:absolute;inset:0;display:grid;place-items:center;z-index:3;font-weight:900;font-size:14px;color:#dbeafe;text-shadow:0 0 6px rgba(167,139,250,.8)}
.statusline{font-size:12px;color:var(--muted);text-align:center}

/* Cards */
.card{
  background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:24px;
  box-shadow:var(--shadow);animation:fade .35s ease both
}
@keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
h1{font-size:34px;margin:0 0 6px}h2{font-size:24px;margin:0 0 10px}h3{font-size:18px;margin:16px 0 8px}
p{margin:8px 0}.small{font-size:13px}.muted{color:var(--muted)}.center{text-align:center}

/* Hero (dark neon) */
.hero{
  position:relative;padding:44px 22px;border-radius:22px;border:1px solid var(--line);
  background:
    radial-gradient(700px 260px at 15% -40%, rgba(110,231,255,.22) 0%, transparent 60%),
    radial-gradient(700px 260px at 85% -40%, rgba(167,139,250,.22) 0%, transparent 60%),
    var(--card-soft);
}
.hero .title{font-size:44px;font-weight:900;letter-spacing:.2px;margin:2px 0 6px;color:#fff}
.hero .sub{color:#c5d0dc;margin-bottom:18px}
.hero .ctaRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* Buttons (neon) */
.btn{
  --bg:linear-gradient(90deg,var(--a),var(--b));
  --glow:rgba(167,139,250,.45);
  background:var(--bg);color:#061122;border:none;padding:18px 28px;border-radius:18px;font-weight:900;cursor:pointer;
  box-shadow:0 20px 60px var(--glow), inset 0 0 0 1px rgba(255,255,255,.2);transition:transform .08s,filter .2s,font-variation-settings .2s;font-size:20px
}
.btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
.btn-ghost{background:transparent;color:#e2e8f0;border:1px solid var(--line);padding:12px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:var(--soft)}
.btn-mint{--bg:linear-gradient(90deg,var(--c),var(--a))}
.btn-accent{--bg:linear-gradient(90deg,var(--b),var(--a))}
.btn-xl{padding:22px 34px;font-size:22px;border-radius:22px}

/* Inputs */
input,select,textarea{
  width:100%;background:#0e1830;color:#e6edf7;border:1px solid var(--line);border-radius:12px;padding:12px;outline:none
}
input::placeholder{color:#798aa3}
input:focus,select:focus,textarea:focus{border-color:rgba(110,231,255,.5);box-shadow:0 0 0 6px rgba(110,231,255,.08)}
label{font-size:14px;color:#d2d9e4}
.section{background:linear-gradient(180deg,#0f1833,#0d1730);border:1px solid var(--line);border-radius:14px;padding:16px}

.grid{display:grid;gap:14px}.grid-2{grid-template-columns:1fr 1fr}
@media (max-width:860px){.grid-2{grid-template-columns:1fr}}

/* Options */
.opt{border:1px solid var(--line);border-radius:18px;overflow:hidden;cursor:pointer;background:#0f1833;box-shadow:var(--soft);transition:transform .12s,border-color .2s}
.opt:hover{transform:translateY(-2px)}
.opt img{width:100%;display:block;aspect-ratio:4/3;object-fit:cover;filter:saturate(1.05)}
.opt .cap{padding:12px 14px;color:#dbe6f5;font-weight:800;font-size:16px;line-height:1.35}
@media (min-width:1024px){
  .test-grid-4{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  .test-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  .sideNav{position:fixed;top:50%;transform:translateY(-50%);z-index:20}
  .sideNav.left{left:18px}.sideNav.right{right:18px}
  .sideBtn{background:linear-gradient(90deg,#0f1833,#0b1220);border:1px solid var(--line);width:46px;height:46px;border-radius:50%;display:grid;place-items:center;box-shadow:var(--soft);cursor:pointer;font-weight:900;color:#cbd5e1}
  .sideBtn:hover{transform:translateY(-1px)}
}
@media (max-width:1023px){.sideNav{display:none}}
.opt.sel{border-color:rgba(110,231,255,.6);box-shadow:0 0 0 6px rgba(110,231,255,.12)}

/* Accordion */
.acc{border-radius:14px;overflow:hidden;border:1px solid var(--line)}
.acc-item{border-top:1px solid var(--line)}
.acc-head{padding:14px 16px;background:#0f1833;cursor:pointer;display:flex;justify-content:space-between;align-items:center;color:#e8eef8}
.acc-head span{font-weight:900;font-size:17px}
.acc-body{padding:14px 16px;display:none;background:#0b1220;color:#cbd5e1}
.acc-item.open .acc-body{display:block}
.agreeList{display:grid;gap:10px;margin-top:10px}
.agree-row{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#0f1833}
.agree-row .txt{font-size:15px;color:#e3eaf7;line-height:1.55;font-weight:700}
.agree-row input[type="checkbox"]{width:20px;height:20px;accent-color:#6ee7ff}

/* Blocks & report sections */
.block{
  background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;
  box-shadow:0 10px 26px rgba(0,0,0,.35);page-break-inside:avoid;break-inside:avoid
}
.block h3{margin:0 0 10px;color:#fff}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{
  background:linear-gradient(90deg,var(--b),var(--a));
  color:#041222;border:1px solid rgba(255,255,255,.15);
  padding:8px 12px;border-radius:999px;font-weight:900
}

/* Report charts layout */
.report-grid{display:grid;grid-template-columns:3fr 2fr;gap:16px}
.right-stack{display:grid;grid-template-rows:1fr 1fr;gap:16px}
.chartBox{width:100%;height:100%}
.chartBox canvas{width:100% !important;height:100% !important}

/* Callout */
.callout{
  position:relative;background:linear-gradient(135deg,#0f1833,#0b1220);
  padding:22px;border-radius:18px;border:1px solid var(--line);box-shadow:0 18px 34px rgba(167,139,250,.15)
}
.callout:before{
  content:"";position:absolute;inset:-1px;border-radius:18px;padding:1px;
  background:linear-gradient(90deg,var(--b),var(--a),var(--c));
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude
}

/* page titles */
.pageTitle{font-size:22px;font-weight:900;margin:0 0 6px}
.subtle{color:#a8b5c6}

/* Print/PDF */
@media print{
  body{background:#fff}
  .header,.sticky,.btn,.btn-ghost,.sideNav,.no-pdf{display:none !important}
  .card{box-shadow:none;border:1px solid #ddd}
  .block{break-inside:avoid-page}
  .chip{color:#111}
}
.pdf-screen-width{width:794px;max-width:none;margin:0 auto}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:999}
.modal-backdrop.show{display:flex}
.modal{width:min(520px,92vw);background:#0f1833;border:1px solid var(--line);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.6);padding:18px;color:#e6edf7}
.modal h3{margin:0 0 10px}.modal .row{display:grid;gap:8px;margin:10px 0}.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<div class="container" id="appRoot">
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <span>ë°”ë¥¸ë¯¸ìˆ í•™ì› Â· ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸ <span class="badge">V2. ADVANCE</span></span>
    </div>
  </div>

  <main class="main" aria-live="polite">
    <div class="sticky">
      <nav class="navbar" id="topnav"></nav>
      <div class="topprogress" id="topprogress">
        <div id="topbar" class="bar"></div>
        <div id="toplabel" class="toplabel"></div>
      </div>
      <div class="statusline" id="statusline">ì§„í–‰ë¥  0%</div>
    </div>
    <section class="card" id="app"></section>
  </main>
</div>

<div class="sideNav left" id="sideLeft" style="display:none"><button class="sideBtn" onclick="prev()" aria-label="ì´ì „">â€¹</button></div>
<div class="sideNav right" id="sideRight" style="display:none"><button class="sideBtn" onclick="next()" aria-label="ë‹¤ìŒ">â€º</button></div>

<!-- ì´ë©”ì¼ ëª¨ë‹¬ -->
<div class="modal-backdrop" id="emailModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>ì´ë©”ì¼ë¡œ ê²°ê³¼ ë³´ë‚´ê¸°</h3>
    <div class="row">
      <label>ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼</label>
      <input type="email" id="emailTo" placeholder="example@email.com">
    </div>
    <div class="row">
      <label>ì œëª©</label>
      <input type="text" id="emailSubject" value="">
    </div>
    <div class="actions">
      <button class="btn-ghost" id="emailCancel">ì·¨ì†Œ</button>
      <button class="btn btn-accent" id="emailSend">ë³´ë‚´ê¸°</button>
    </div>
    <div class="small subtle" id="emailMsg" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* ===== Constants ===== */
const APP_TITLE='ë°”ë¥¸ë¯¸ìˆ í•™ì› Â· ë¯¸ìˆ ì ì„±í…ŒìŠ¤íŠ¸ V2. ADVANCE';
const SHEET_ID='14VLQBhDJtduxjCnfr7VEOstZ5ez8-CX3ArXy1OvYCQg';
const GVIZ_SHEET='question2';
const GVIZ_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(GVIZ_SHEET)}&tqx=out:json`;
const FORM_ACTION='https://docs.google.com/forms/d/e/1FAIpQLSeRWq5YKN50zL0simiaQA6EBRsn6VXN__ZmLplAgDz1I1hyQA/formResponse';
const EMAIL_FUNCTION_URL='/.netlify/functions/send-email';

/* Google Form mapping */
const F={child_name:'entry.684468179',age:'entry.1066070471',grade:'entry.1812672802',guardian:'entry.1666083184',phone:'entry.89824848',campus:'entry.490719219',answers:'entry.85364862',scores:'entry.1455508168',top3:'entry.2120338430',resultId:'entry.532514127',timestamp:'entry.1261684833'};

/* Domains (11 dims) */
const DOM={OBS:'ê´€ì°°ë ¥',COL:'ìƒ‰ì±„ê°ê°',NAR:'ì„œì‚¬ë ¥',SPA:'ê³µê°„ê°',DET:'ë””í…Œì¼',CHK:'ë„ì „ì„±',GRT:'ê¾¸ì¤€ì„±',SOC:'ì†Œí†µë ¥',CON:'ê°œë…í™”',CRT:'ë¹„íŒì  ë¶„ì„',EXP:'ìê¸°í‘œí˜„'};
const DOM_KEYS=Object.keys(DOM);

/* State */
const STEPS=[{key:'start',label:'ì‹œì‘'},{key:'consent',label:'ë™ì˜'},{key:'profile',label:'í”„ë¡œí•„'},{key:'test',label:'í…ŒìŠ¤íŠ¸'},{key:'result',label:'ê²°ê³¼'},{key:'details',label:'ìì„¸í•œ ê²°ê³¼'}];
const STATE={step:'start',consent:false,profile:{},questions:[],idx:0,answers:[],result:null};

const ASSET_BASE='/img';
const $=id=>document.getElementById(id); const app=()=>$('app');

/* Nav + progress */
function renderNav(){
  const cur=STEPS.findIndex(s=>s.key===STATE.step);
  $('topnav').innerHTML=STEPS.map((s,i)=>`<div class="step ${s.key===STATE.step?'active':''} ${cur>i?'done':''}" onclick="navGo('${s.key}')"><span class="num">${i+1}</span><span>${s.label}</span></div>`).join('')
}
function updateTopProgress(){
  const topbar=$('topbar'),toplabel=$('toplabel'),tp=$('topprogress'),status=$('statusline');
  if(STATE.step==='test'&&STATE.questions.length){
    status.style.display='none';
    const total=STATE.questions.length, curIndex=STATE.idx+1;
    const pct=Math.max(0, Math.min(100, Math.round((STATE.idx)/total*100)));
    topbar.style.width=pct+'%'; toplabel.textContent=`(${curIndex}/${total})`; tp.style.setProperty('--steps', String(total));
    $('sideLeft').style.display='block'; $('sideRight').style.display='block'; return;
  }
  $('sideLeft').style.display='none'; $('sideRight').style.display='none';
  toplabel.textContent=''; status.style.display='block';
  let pct=(STEPS.findIndex(s=>s.key===STATE.step))/(STEPS.length-1)*100;
  topbar.style.width=Math.round(pct)+'%';
  status.textContent=`ì§„í–‰ë¥  ${Math.round(pct)}%`;
}
function navGo(step){STATE.step=step;if(step==='test'&&STATE.questions.length===0){startTest();return;}render();}

/* GViz */
function parseGViz(text){const s=text.indexOf('{'),e=text.lastIndexOf('}');if(s<0||e<0)return[];const obj=JSON.parse(text.slice(s,e+1));const cols=obj.table.cols.map(c=>c.label);return obj.table.rows.map(r=>r.c.map(c=>c?(c.f??c.v):'')).map(a=>Object.fromEntries(cols.map((k,i)=>[k,a[i]])))}
async function loadQuestions(){
  try{
    const txt=await(await fetch(GVIZ_URL)).text();
    const rows=parseGViz(txt)||[];const act=rows.filter(r=>String(r.active).toUpperCase()==='TRUE').sort((a,b)=>(+a.order-+b.order));
    if(act.length){
      STATE.questions=act.map(r=>{
        const mkWeights=k=>{try{return JSON.parse(r[`${k}_weights`])||{}}catch{return{}}};
        const mkOpt=k=>({key:k,label:(r[`${k}_label`]||'').trim(),imageUrl:(r[`${k}_image`]||'').trim(),weights:mkWeights(k)});
        const opts=['A','B','C','D'].map(mkOpt).filter(o=>(o.label||o.imageUrl||Object.keys(o.weights||{}).length>0));
        const safe=opts.length>=2?opts:['A','B'].map(mkOpt);
        return{id:r.id||`q${r.order}`,order:+r.order,prompt:r.prompt||'',options:safe}
      });
      return;
    }
  }catch(e){}
  STATE.questions=localQuestions();
}

/* Start (dark mood) */
function startScreen(){
  return `
    <div class="hero">
      <div class="title center">${APP_TITLE}</div>
      <div class="sub center">20ë¬¸í•­ ì‹¬í™” ì§„ë‹¨ Â· 11ì°¨ì› í”„ë¡œíŒŒì¼ Â· PDF ë¦¬í¬íŠ¸(3â€“4p)</div>
      <div class="ctaRow">
        <button class="btn btn-xl" id="startBtn">ADVANCE í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸° â†’</button>
        <a class="btn-ghost" href="index.html">BASICìœ¼ë¡œ ì´ë™</a>
      </div>
    </div>
    <section style="margin:20px auto 8px;max-width:980px">
      <h2 class="center" style="font-weight:900;color:#fff">í…ŒìŠ¤íŠ¸ íŠ¹ì§•</h2>
      <p class="sub center subtle" style="margin:0 0 16px">CONÂ·CRTÂ·EXP í¬í•¨, ì‹¬ì¸µ ë¶„ì„ + ì„±ì¥ ë¡œë“œë§µ + ì§ì—… ì—°ê³„</p>
      <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:14px">
        <div class="card" style="display:flex;align-items:center;gap:12px">
          <div class="badge" style="font-size:18px">â±</div><div><b>20ë¬¸í•­</b><div class="small subtle">7â€“10ë¶„ ë‚´ ì™„ë£Œ</div></div>
        </div>
        <div class="card" style="display:flex;align-items:center;gap:12px">
          <div class="badge" style="font-size:18px">ğŸ¯</div><div><b>11ì°¨ì› ë¶„ì„</b><div class="small subtle">ìƒìœ„ ê°•ì Â·ì ì¬ë ¥</div></div>
        </div>
        <div class="card" style="display:flex;align-items:center;gap:12px">
          <div class="badge" style="font-size:18px">ğŸ§¾</div><div><b>ë¦¬í¬íŠ¸ PDF</b><div class="small subtle">ìš”ì•½+ì‹¬ì¸µ(3â€“4p)</div></div>
        </div>
      </div>
      <div class="small subtle center" style="margin-top:12px">â€» ë³¸ í…ŒìŠ¤íŠ¸ëŠ” <b>êµìœ¡ ê°€ì´ë“œ</b> ëª©ì ì´ë©°, ì˜í•™/ì„ìƒ ì§„ë‹¨ì´ ì•„ë‹™ë‹ˆë‹¤.</div>
    </section>`;
}
function viewStart(){app().innerHTML=startScreen();$('startBtn').onclick=()=>navGo('consent');window.scrollTo({top:0,behavior:'smooth'})}

/* Consent */
function accItem(t,html){return `<div class="acc-item open"><div class="acc-head"><span>${t}</span><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#93a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div class="acc-body small">${html}</div></div>`}
function viewConsent(){
  app().innerHTML=`<h2 class="center" style="color:#fff">ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ì„œ</h2>
  <p class="muted small center">ë³¸ í…ŒìŠ¤íŠ¸ëŠ” <b>êµìœ¡ ê°€ì´ë“œ</b> ëª©ì ì´ë©°, ì˜í•™/ì„ìƒ ì§„ë‹¨ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
  <div class="acc">
    ${accItem('<b>1) ëª©ì </b>','â‘  í…ŒìŠ¤íŠ¸ ì œê³µ ë° ê²°ê³¼ ì‚°ì¶œ â‘¡ ê²°ê³¼ ì•ˆë‚´Â·PDF ì €ì¥ ì§€ì› â‘¢ ìƒë‹´ í’ˆì§ˆ ê°œì„ ')}
    ${accItem('<b>2) ìˆ˜ì§‘ í•­ëª©</b>','ì•„ë™ ì´ë¦„Â·ë‚˜ì´Â·í•™ë…„ / ë³´í˜¸ì ì´ë¦„Â·ì—°ë½ì²˜ / ì‘ë‹µ ë‚´ìš© (ì´ë©”ì¼ì€ ì„ íƒ)')}
    ${accItem('<b>3) ë³´ê´€ ê¸°ê°„</b>','ìˆ˜ì§‘ì¼ë¡œë¶€í„° <b>12ê°œì›”</b> ë³´ê´€ í›„ íŒŒê¸°')}
    ${accItem('<b>4) ë³´ê´€/ì²˜ë¦¬</b>','Google Forms/Sheetsì— ì €ì¥Â·ì²˜ë¦¬')}
    ${accItem('<b>5) ê¶Œë¦¬</b>','ë™ì˜ ê±°ë¶€ ê°€ëŠ¥(ê±°ë¶€ ì‹œ ì„œë¹„ìŠ¤ ì œí•œ ê°€ëŠ¥)')}
    ${accItem('<b>6) ë¬¸ì˜</b>','barunart1004@gmail.com')}
  </div>
  <div class="section" style="margin-top:16px">
    <div class="agreeList">
      <div class="agree-row"><div class="txt">(í•„ìˆ˜) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— <b>ë™ì˜í•©ë‹ˆë‹¤.</b></div><input type="checkbox" id="chk_required" /></div>
      <div class="agree-row"><div class="txt">(í•„ìˆ˜) ë§Œ 14ì„¸ ë¯¸ë§Œ ì•„ë™ì˜ ë²•ì •ëŒ€ë¦¬ì¸ìœ¼ë¡œì„œ <b>ë™ì˜í•©ë‹ˆë‹¤.</b></div><input type="checkbox" id="chk_minor" /></div>
    </div>
  </div>
  <div class="center" style="margin-top:16px;display:flex;gap:8px;justify-content:center">
    <button class="btn" id="btn_consent" disabled>ë™ì˜í•˜ê³  ì§„í–‰</button>
    <button class="btn-ghost" id="btn_expand">ì „ë¬¸ í¼ì¹˜ê¸°</button>
    <button class="btn-ghost" id="btn_collapse">ëª¨ë‘ ì ‘ê¸°</button>
  </div>`;
  const validate=()=>{$('btn_consent').disabled=!( $('chk_required').checked && $('chk_minor').checked )};
  $('chk_required').addEventListener('change',validate);$('chk_minor').addEventListener('change',validate);
  $('btn_consent').onclick=()=>{STATE.consent=true;navGo('profile')};
  $('btn_expand').onclick=()=>document.querySelectorAll('.acc-item').forEach(it=>it.classList.add('open'));
  $('btn_collapse').onclick=()=>document.querySelectorAll('.acc-item').forEach(it=>it.classList.remove('open'));
  document.querySelectorAll('.acc-head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
}

/* Profile (age 12â€“15 only) */
const AGE_TO_GRADE={12:'ì´ˆ6',13:'ì¤‘1',14:'ì¤‘2',15:'ì¤‘3'};
const GRADE_TO_AGE=Object.fromEntries(Object.entries(AGE_TO_GRADE).map(([a,g])=>[g,a]));
const CAMPUSES=['ì••êµ¬ì •[ë³¸ì›]','ë°˜í¬ ìº í¼ìŠ¤','í•œë‚¨ ìº í¼ìŠ¤','ë°©ë°° ìº í¼ìŠ¤','ëª©ë™ ìº í¼ìŠ¤','ì†¡íŒŒ ìº í¼ìŠ¤','ì„œëŒ€ë¬¸ ìº í¼ìŠ¤','ì¼ì‚° ìº í¼ìŠ¤','ì†¡ë„ ìº í¼ìŠ¤','ë¶€ì‚° ìº í¼ìŠ¤'];

function viewProfile(){
  app().innerHTML=`<h2 class="center" style="color:#fff">í”„ë¡œí•„ ì •ë³´</h2>
  <div class="grid grid-2" style="margin-top:8px">
    <div class="section"><label>ì•„ë™ ì´ë¦„</label><input id="cname" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
    <div class="section"><label>ë³´í˜¸ì ì´ë¦„</label><input id="gname" placeholder="ì˜ˆ: ê¹€ë³´í˜¸ì"></div>
    <div class="section"><label>ë‚˜ì´ (ë§Œ)</label><select id="age">${[12,13,14,15].map(a=>`<option value="${a}">${a}</option>`).join('')}</select></div>
    <div class="section"><label>í•™ë…„</label><select id="grade">${Object.values(AGE_TO_GRADE).map(g=>`<option>${g}</option>`).join('')}</select></div>
    <div class="section"><label>ì—°ë½ì²˜</label><input id="phone" placeholder="010-0000-0000"></div>
    <div class="section"><label>ì´ë©”ì¼(ì„ íƒ, ê²°ê³¼ì§€ ì „ì†¡ìš©)</label><input id="email" placeholder="example@email.com"></div>
    <div class="section"><label>ìº í¼ìŠ¤</label><select id="campus">${CAMPUSES.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>
  </div>
  <div class="center" style="margin-top:16px"><button class="btn btn-mint" id="btn_starttest">í…ŒìŠ¤íŠ¸ ì‹œì‘</button></div>`;
  $('age').addEventListener('change',e=>{$('grade').value=AGE_TO_GRADE[e.target.value]});
  $('grade').addEventListener('change',e=>{$('age').value=GRADE_TO_AGE[e.target.value]});
  $('btn_starttest').onclick=startTest;
}
async function startTest(){
  STATE.profile={child_name:$('cname').value.trim(),guardian:$('gname').value.trim(),age:$('age').value,grade:$('grade').value,phone:$('phone').value.trim(),email:$('email').value.trim(),campus:$('campus').value};
  if(!STATE.profile.child_name){alert('ì•„ë™ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return;}
  if(!/^0\d{1,2}-?\d{3,4}-?\d{4}$/.test(STATE.profile.phone||'')){alert('ì—°ë½ì²˜ í˜•ì‹(010-0000-0000)ì„ í™•ì¸í•´ ì£¼ì„¸ìš”');return;}
  await loadQuestions();STATE.idx=0;STATE.answers=[];STATE.step='test';render();
}

/* Test UI */
function pcGridClassFor(n){if(window.matchMedia('(min-width:1024px)').matches){return n===2?'test-grid-2':'test-grid-4'}return'grid grid-2'}
function optionImageUrl(q,o){if(o.imageUrl)return o.imageUrl;const num=Number(q.order)||(STATE.idx+1);return `${ASSET_BASE}/${num}-${o.key}.png`}
function viewTest(){
  const q=STATE.questions[STATE.idx];if(!q){app().innerHTML='<h3 class="center">ë¬¸í•­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì— ë¬¸ì˜í•´ ì£¼ì„¸ìš”.</h3>';return;}
  const gridCls=pcGridClassFor(q.options.length);
  app().innerHTML=`<div class="center small subtle"><span class="chip">Q ${STATE.idx+1} / ${STATE.questions.length}</span></div>
    <h2 class="center" style="margin-top:10px;color:#fff">${q.prompt||''}</h2>
    <div class="${gridCls}" style="margin-top:12px">
      ${q.options.map(o=>`<div class="opt" id="opt_${o.key}" tabindex="0" role="button" aria-label="${o.label||o.key}" data-key="${o.key}">
        <img src="${optionImageUrl(q,o)}" alt="${o.label||o.key}" onerror="this.style.opacity=.2" loading="lazy">
        <div class="cap center">${o.label||o.key}</div>
      </div>`).join('')}
    </div>
    <div class="center" style="margin-top:18px;display:flex;gap:10px;justify-content:center">
      <button class="btn-ghost" id="btn_prev" ${STATE.idx===0?'disabled':''}>ì´ì „</button>
      <button class="btn" id="btn_next" disabled>ë‹¤ìŒ</button>
    </div>`;
  q.options.forEach(o=>{const el=document.getElementById(`opt_${o.key}`);el.onclick=()=>choose(o.key);el.onkeydown=e=>{if(e.key==='Enter'||e.key===' ')choose(o.key)}});
  $('btn_prev').onclick=prev;$('btn_next').onclick=next;
}
function choose(key){
  const q=STATE.questions[STATE.idx];
  q.options.forEach(k=>{const n=document.getElementById(`opt_${k.key}`);if(n)n.classList.remove('sel')});
  const node=document.getElementById(`opt_${key}`);if(node){node.classList.add('sel');node.animate([{transform:'scale(1)'},{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:160})}
  const opt=q.options.find(o=>o.key===key);STATE.answers[STATE.idx]={qid:q.id,key,weights:opt.weights||{}};$('btn_next').disabled=false;
}
function next(){if(STATE.step!=='test')return;if(!STATE.answers[STATE.idx]){alert('í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”');return;}if(STATE.idx<STATE.questions.length-1){STATE.idx++;render();}else{submitAllSafe();}}
function prev(){if(STATE.idx>0){STATE.idx--;render();}}
document.addEventListener('keydown',e=>{if(STATE.step!=='test')return;if(e.key==='ArrowRight')next();if(e.key==='ArrowLeft')prev();if(e.key==='Enter'){if(!$('btn_next').disabled)next();}});

/* Scoring */
function aggregateScores(ans){
  const sum={}; DOM_KEYS.forEach(k=>sum[k]=0);
  ans.forEach(a=>Object.entries(a.weights||{}).forEach(([k,v])=>{ if(sum[k]!=null) sum[k]+=Number(v||0) }));
  const n=ans.length||1; const raw={}; DOM_KEYS.forEach(k=>{const v=(sum[k]||0)/n*4; raw[k]=Math.max(0,Math.round(v*10)/10)});
  return raw;
}
const adjust=v=>Math.round((2+v/2)*10)/10;
function band(v){if(v>=3.6)return'S';if(v>=3.2)return'A';if(v>=2.8)return'A-';if(v>=2.4)return'B+';if(v>=2.0)return'B';if(v>=1.6)return'B-';if(v>=1.0)return'C+';return'C'}

const PRAISE={
  'S':k=>`ì™€, ${DOM[k]}ì—ì„œ <b>íƒ€ê³ ë‚œ ì¬ëŠ¥</b>ì´ ë‹ë³´ì…ë‹ˆë‹¤. ë†’ì€ ë‚œì´ë„ë„ ìŠ¤ìŠ¤ë¡œ ê¸°íší•´ë³¼ ìˆ˜ ìˆì–´ìš”.`,
  'A':k=>`${DOM[k]} ê°ê°ì´ <b>ë›°ì–´ë‚©ë‹ˆë‹¤</b>. í•œ ë‹¨ê³„ ë†’ì€ ê³¼ì œë„ ë¬´ë¦¬ ì—†ì´ ì†Œí™”í•©ë‹ˆë‹¤.`,
  'A-':k=>`${DOM[k]} ì‹¤ë ¥ì´ <b>íƒ„íƒ„</b>í•©ë‹ˆë‹¤. ì•½ê°„ì˜ ë‹¤ë“¬ê¸°ë¡œ ê¸ˆë°© ìƒìœ„ê¶Œì„ ë…¸ë ¤ìš”.`,
  'B+':k=>`${DOM[k]}ì´ ì•ˆì •ì ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ì‹œë„ì—ë„ ì˜ ì ì‘í•©ë‹ˆë‹¤.`,
  'B':k=>`${DOM[k]} ê¸°ë³¸ê¸°ê°€ ì¢‹ìŠµë‹ˆë‹¤. ë£¨í‹´ì„ ë„“íˆë©´ <b>ì„±ì¥ ê°€ì†</b>!`
};

const DETAIL={
  OBS:n=>`${n}ë‹˜ì€ ëŒ€ìƒì„ êµ¬ì¡°ì ìœ¼ë¡œ íŒŒì•…í•˜ê³  íŠ¹ì§•ì„ í¬ì°©í•˜ëŠ” ëˆˆì´ ì¢‹ì•„ìš”.`,
  COL:n=>`${n}ë‹˜ì€ ìƒ‰ì˜ ë¶„ìœ„ê¸°ì™€ ëŒ€ë¹„ë¥¼ ë¯¼ê°í•˜ê²Œ ì½ì–´ ì¡°í™”ë¡œìš´ íŒ”ë ˆíŠ¸ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.`,
  NAR:n=>`${n}ë‹˜ì€ ì¥ë©´ ì†ì— ì´ì•¼ê¸°ë¥¼ ì‹¬ê³  ê°ì • íë¦„ì„ ì„¤ë“ë ¥ ìˆê²Œ ë§Œë“­ë‹ˆë‹¤.`,
  SPA:n=>`${n}ë‹˜ì€ ì›ê·¼Â·ìŠ¤ì¼€ì¼ì„ í™œìš©í•´ ì•ˆì •ì ì¸ ê³µê°„ êµ¬ì„±ì„ ë§Œë“­ë‹ˆë‹¤.`,
  DET:n=>`${n}ë‹˜ì€ ì§ˆê°ê³¼ ë§ˆê°ì—ì„œ ì„¬ì„¸í•¨ì´ ë‹ë³´ì…ë‹ˆë‹¤.`,
  CHK:n=>`${n}ë‹˜ì€ ìƒˆë¡œìš´ ë„êµ¬Â·ê¸°ë²•ì— ì ê·¹ì ì´ë©° ì‹¤í—˜ì„ ì¦ê¹ë‹ˆë‹¤.`,
  GRT:n=>`${n}ë‹˜ì€ ë£¨í‹´ì„ ìœ ì§€í•˜ë©° ì™„ì„±ê¹Œì§€ ë°€ì–´ë¶™ì´ëŠ” ëˆê¸°ê°€ ê°•ì ì…ë‹ˆë‹¤.`,
  SOC:n=>`${n}ë‹˜ì€ ì˜ë„ì™€ ê³¼ì •ì„ ë§ë¡œ í’€ì–´ë‚´ê³  í”¼ë“œë°±ì„ ì˜ í™œìš©í•©ë‹ˆë‹¤.`,
  CON:n=>`${n}ë‹˜ì€ ì£¼ì œÂ·ë¬¸ì œë¥¼ ê°œë…í™”í•˜ê³  êµ¬ì¡°í™”í•˜ëŠ” ëŠ¥ë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.`,
  CRT:n=>`${n}ë‹˜ì€ ê·¼ê±°ë¥¼ ë“¤ì–´ íŒë‹¨í•˜ê³  ê°œì„ ì ì„ ì •í™•íˆ ì§šì–´ëƒ…ë‹ˆë‹¤.`,
  EXP:n=>`${n}ë‹˜ì€ ìì‹ ì˜ ê°ì •ê³¼ ìƒê°ì„ ì‹œê° ì–¸ì–´ë¡œ ì†”ì§í•˜ê²Œ í‘œí˜„í•©ë‹ˆë‹¤.`
};

/* Theory (short) */
const THEORY={
  COL:{theoryTitle:'Itten ìƒ‰ì±„ì´ë¡ ',theory:'ìƒ‰ìƒÂ·ëª…ë„Â·ì±„ë„ì˜ ì¡°í™” ì¸ì§€ ë° í™œìš© ëŠ¥ë ¥.',expert:'â€œìƒ‰ì±„ê°ê°ì€ ê°ì • í‘œí˜„ë ¥ê³¼ ë¯¸ì  ê°ìˆ˜ì„±ì„ ëŒì–´ì˜¬ë¦½ë‹ˆë‹¤.â€',direction:'ìƒ‰ìƒí™˜Â·ëŒ€ë¹„ ì‹¤í—˜, ìì—°ìƒ‰ ê´€ì°°'},
  DET:{theoryTitle:'ëª°ì…ì´ë¡ (Flow)',theory:'ì •ë°€ì„±Â·ì™„ê²°ì„± ì§€í–¥ì˜ ì§‘ì¤‘ë ¥.',expert:'â€œë””í…Œì¼ì€ ì™„ì„±ë„ë¥¼ ì¢Œìš°í•©ë‹ˆë‹¤.â€',direction:'ì„¸ë°€í™”, ê³µì˜ˆ, ë‹¨ê³„ì  ì™„ì„±'},
  NAR:{theoryTitle:'Bruner ì„œì‚¬ì  ì‚¬ê³ ',theory:'ì´ì•¼ê¸° êµ¬ì„±ê³¼ ì‹œê°ì  ì „ë‹¬.',expert:'â€œì„œì‚¬ë ¥ì€ ì–¸ì–´ì™€ ì‹œê°ì˜ ê²°í•© ëŠ¥ë ¥ì…ë‹ˆë‹¤.â€',direction:'ê·¸ë¦¼ì¼ê¸°, ë§Œí™”, ìŠ¤í† ë¦¬ë³´ë“œ'},
  SPA:{theoryTitle:'ì§€ê°ì‹¬ë¦¬Â·ì›ê·¼ë²•',theory:'ê¹Šì´Â·ë¹„ë¡€Â·êµ¬ë„ì˜ ì•ˆì •ì„±.',expert:'â€œê³µê°„ ê°ì€ ì¥ë©´ ëª°ì…ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.â€',direction:'ì†Œì‹¤ì  í›ˆë ¨, ë°•ìŠ¤ ë“œë¡œì‰'},
  OBS:{theoryTitle:'ê²ŒìŠˆíƒˆíŠ¸ ì§€ê°',theory:'í˜•íƒœ/ê·œì¹™ íƒì§€ë¡œ íŠ¹ì§• í¬ì°©.',expert:'â€œê´€ì°°ë ¥ì€ ë³€í˜• ì°½ì‘ì˜ ê¸°ë°˜ì…ë‹ˆë‹¤.â€',direction:'ê´‘ì›Â·ì¬ì§ˆ ê´€ì°°, í™•ëŒ€ ìŠ¤ì¼€ì¹˜'},
  CHK:{theoryTitle:'ì„±ì¥ ë§ˆì¸ë“œì…‹',theory:'ì‹¤íŒ¨ë¥¼ ìˆ˜ìš©í•œ ì‹œë„/íƒìƒ‰ ì„±í–¥.',expert:'â€œë„ì „ì„±ì€ ì°½ì˜ì  ëŒíŒŒì˜ í† ëŒ€ì…ë‹ˆë‹¤.â€',direction:'ìƒˆ ë„êµ¬ ì‹¤í—˜ ê¸°ë¡, ë³€í˜• ê³¼ì œ'},
  SOC:{theoryTitle:'ë¹„ì£¼ì–¼ ë¦¬í„°ëŸ¬ì‹œ',theory:'ì˜ë„ ì„¤ëª…Â·í”¼ë“œë°± ìˆ˜ìš© ëŠ¥ë ¥.',expert:'â€œì†Œí†µì€ ì‘í’ˆì˜ ë§¥ë½ì„ ê°•í™”í•©ë‹ˆë‹¤.â€',direction:'ì‘ê°€ë…¸íŠ¸Â·ë°œí‘œÂ·í”¼ë“œë°± ë°˜ì˜'},
  GRT:{theoryTitle:'ìê¸°ì¡°ì ˆ í•™ìŠµ',theory:'ê³„íš-ì‹¤í–‰-ì ê²€ ë£¨í‹´.',expert:'â€œê¾¸ì¤€ì„±ì€ ì¥ê¸° ì„±ì¥ì˜ í•µì‹¬ì…ë‹ˆë‹¤.â€',direction:'15ë¶„ ë£¨í‹´Â·ì²´í¬ë¦¬ìŠ¤íŠ¸'},
  CON:{theoryTitle:'ê°œë…í™”/ë¬¸ì œì •ì˜',theory:'ì£¼ì œ êµ¬ì¡°í™”Â·ì•„ì´ë””ì–´ ì¡°ì§.',expert:'â€œê°œë…í™”ëŠ” ê¸°íšì˜ í’ˆì§ˆì„ ì¢Œìš°í•©ë‹ˆë‹¤.â€',direction:'ë¸Œë¦¬í”„ ì‘ì„±Â·ë‹¤ì´ì–´ê·¸ë¨'},
  CRT:{theoryTitle:'ë¹„íŒì  ì‚¬ê³ ',theory:'ê·¼ê±° ê¸°ë°˜ íŒë‹¨Â·í‰ê°€.',expert:'â€œí‰ê°€ ê¸°ì¤€ì„ ì„¸ìš°ë©´ ì„±ì¥ ì†ë„ê°€ ë‚©ë‹ˆë‹¤.â€',direction:'ë£°ì‹œíŠ¸Â·ê·¼ê±°í‘œÂ·A/B í…ŒìŠ¤íŠ¸'},
  EXP:{theoryTitle:'ìê¸°í‘œí˜„',theory:'ì •ì„œÂ·ì •ì²´ì„±ì˜ ì‹œê°í™”.',expert:'â€œí‘œí˜„ì€ ë™ê¸°ì™€ ëª°ì…ì„ ì´‰ì§„í•©ë‹ˆë‹¤.â€',direction:'ê°ì • íŒ”ë ˆíŠ¸Â·ìƒì§• ì°¾ê¸°'}
};

/* Career map (by domain) */
const CAREERS={
  SPA:['ê±´ì¶•ê°€','ì‚°ì—…/ì œí’ˆ ë””ìì´ë„ˆ','ì¡°ê²½/ê³µê°„ ë””ìì´ë„ˆ'],
  DET:['í”„ë¡œë•íŠ¸ ë””ìì´ë„ˆ','í”„ë¡œí”„/ì†Œí’ˆ ë””ìì´ë„ˆ','3D ëª¨ë¸ëŸ¬'],
  COL:['ì»¨ì…‰ ì•„í‹°ìŠ¤íŠ¸','ì»¬ëŸ¬ë¦¬ìŠ¤íŠ¸','ë¸Œëœë”© ë””ìì´ë„ˆ'],
  NAR:['ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´í„°','ìŠ¤í† ë¦¬ë³´ë“œ ì•„í‹°ìŠ¤íŠ¸','ì• ë‹ˆë©”ì´ì…˜ ê¸°íš'],
  OBS:['ê³¼í•™ ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´í„°','ë‹¤í ë“œë¡œì‰ ì•„í‹°ìŠ¤íŠ¸'],
  CHK:['ë¯¸ë””ì–´ ì•„í‹°ìŠ¤íŠ¸','ì‹¤í—˜ ë¯¸ìˆ ê°€','í¬ë¦¬ì—ì´í‹°ë¸Œ í…Œí¬ë†€ë¡œì§€'],
  GRT:['í”„ë¡œë•ì…˜ ì•„í‹°ìŠ¤íŠ¸','ê²Œì„ ë¼ì´ë¸Œì˜¤í¼ ì•„íŠ¸','í”„ë¦¬í”„ë¡œë•ì…˜ í•¸ë“œ'],
  SOC:['ì•„íŠ¸ë””ë ‰í„°','ì „ì‹œ/êµìœ¡ íë ˆì´í„°','ì›Œí¬ìˆ í¼ì‹¤ë¦¬í…Œì´í„°'],
  CON:['UX ê¸°íšì','ì‹œê° ì „ëµê°€','ë””ìì¸ ë¦¬ì„œì²˜'],
  CRT:['í¬ë¦¬í‹±/ë¦¬ë·°ì–´','í”¼ë“œë°± ì½”ì¹˜','ë””ìì¸ ìŠ¤íŠœë””ì˜¤ PM'],
  EXP:['ì‘ê°€(íšŒí™”/ì„¤ì¹˜)','ë¹„ì£¼ì–¼ ìŠ¤í† ë¦¬í…”ëŸ¬','ì•„íŠ¸ í…Œë¼í”¼ ë³´ì¡°']
};

/* Submit */
function nowKST(){const d=new Date(),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())} KST`}
async function submitAllSafe(){
  const raw=aggregateScores(STATE.answers);
  const scores={}; DOM_KEYS.forEach(k=>scores[k]=adjust(raw[k]||0));
  const ordered=[...DOM_KEYS].sort((a,b)=>scores[b]-scores[a]);
  const top3=ordered.slice(0,3);
  const potential=ordered.slice(3,7); // ê°€ëŠ¥ì„± ì˜ì—­ í›„ë³´ 4ê°œ
  const resultId=crypto.randomUUID();
  const form=new FormData();
  form.append(F.child_name,STATE.profile.child_name);form.append(F.age,STATE.profile.age);form.append(F.grade,STATE.profile.grade);
  form.append(F.guardian,STATE.profile.guardian);form.append(F.phone,STATE.profile.phone);form.append(F.campus,STATE.profile.campus||'');
  form.append(F.answers,JSON.stringify({profile:STATE.profile,questions:STATE.answers,top3,version:'V2_ADVANCE'}));
  form.append(F.scores,JSON.stringify(scores));form.append(F.top3,top3.join(','));form.append(F.resultId,resultId);form.append(F.timestamp,nowKST());
  try{await fetch(FORM_ACTION,{method:'POST',mode:'no-cors',body:form});}catch(e){}
  STATE.result={scores,top3,potential,ordered,resultId};STATE.step='result';render();
}

let CHARTS=[];function destroyCharts(){CHARTS.forEach(c=>c.destroy?.());CHARTS=[]}

/* ===== Report (3â€“4 pages) ===== */
function viewResult(){
  const r=STATE.result||{scores:{},top3:[],potential:[]}, s=r.scores, name=STATE.profile.child_name;

  const ordered=[...DOM_KEYS].sort((a,b)=> (s[b]||0)-(s[a]||0));
  const top9=ordered.slice(0,9);
  const top3=r.top3||ordered.slice(0,3);
  const potential=r.potential||ordered.slice(3,7);

  const summary1=`${name}ë‹˜ì€ <b>${DOM[top3[0]]||'-'}</b>ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ <b>${DOM[top3[1]]||'-'}</b>, <b>${DOM[top3[2]]||'-'}</b>ì—ì„œ ìš°ìˆ˜í•œ ì„±í–¥ì„ ë³´ì…ë‹ˆë‹¤.`;
  const summary2=`ìƒˆë¡œìš´ ê³¼ì œì—ì„œë„ í•™ìŠµ ì „ì´ê°€ ë¹ ë¥´ë©°, <b>${DOM[top3[0]]}</b> ê¸°ë°˜ í™œë™ì—ì„œ ë†’ì€ ì™„ì„±ë„ë¥¼ ê¸°ëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
  const summary3=`<b>ê°€ëŠ¥ì„± ì˜ì—­</b>(${potential.map(k=>DOM[k]).join('Â·')})ì€ í˜„ì¬ ê°•ì ì„ í™•ì¥í•  ë•Œ í•¨ê»˜ ì„±ì¥í•  ì¶•ì…ë‹ˆë‹¤.`;

  app().innerHTML=`<div id="pdfArea" class="pdf-screen-width">
    <!-- Page 1: ìš”ì•½ -->
    <div class="block callout">
      <div class="pageTitle">ìš”ì•½ Â· ADVANCE ì§„ë‹¨ ê²°ê³¼</div>
      <div class="subtle">í•™ìƒ: <b>${name}</b> (${STATE.profile.age}ì„¸, ${STATE.profile.grade}) Â· ìº í¼ìŠ¤: ${STATE.profile.campus||'-'}</div>
      <div class="chips" style="margin-top:10px">${top3.map(k=>`<span class="chip">TOP: ${DOM[k]}</span>`).join('')}</div>
      <p class="subtle" style="margin-top:8px">${summary1}</p>
      <p class="subtle">${summary2}</p>
      <p class="subtle">${summary3}</p>
    </div>

    <!-- Page 2: 3 Charts ë ˆì´ì•„ì›ƒ (ì¢Œ ë ˆì´ë‹¤, ìš°ìƒ/ìš°í•˜ ë§‰ëŒ€) -->
    <div class="block">
      <div class="pageTitle">í”„ë¡œíŒŒì¼ & ì£¼ìš” ì§€í‘œ</div>
      <div class="report-grid" style="height:420px;margin-top:6px">
        <div class="chartBox" style="border:1px solid var(--line);border-radius:14px;padding:10px;background:#0f1833">
          <div class="subtle" style="font-weight:900;margin:0 0 6px">ì˜ì—­ë³„ ê´€ì‹¬ë„(ë ˆì´ë‹¤)</div>
          <canvas id="radar"></canvas>
        </div>
        <div class="right-stack">
          <div class="chartBox" style="border:1px solid var(--line);border-radius:14px;padding:10px;background:#0f1833">
            <div class="subtle" style="font-weight:900;margin:0 0 6px">ë›°ì–´ë‚œ ì˜ì—­ (TOP3)</div>
            <canvas id="barsTop3"></canvas>
          </div>
          <div class="chartBox" style="border:1px solid var(--line);border-radius:14px;padding:10px;background:#0f1833">
            <div class="subtle" style="font-weight:900;margin:0 0 6px">ê°€ëŠ¥ì„± ì˜ì—­ (ì°¨ìˆœ 4ê°œ)</div>
            <canvas id="barsPotential"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Page 3: ê°•ì  ì§„ë‹¨ & ë¡œë“œë§µ -->
    <div class="block">
      <div class="pageTitle">ê°•ì  ì§„ë‹¨ & ì„±ì¥ ë¡œë“œë§µ (90ì¼)</div>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:14px">
        ${top3.map(k=>`
        <div class="section" style="background:#0f1833">
          <div style="font-weight:900;color:#fff;margin-bottom:6px">${DOM[k]} â€¢ ê°•ì  ë¶„ì„</div>
          <div class="small subtle">${DETAIL[k](name)}</div>
          <div class="small subtle" style="margin-top:6px">${PRAISE[band(s[k]||0)]?.(k) || ''}</div>
          <div class="small subtle" style="margin-top:8px"><b>ì¶”ì²œ ë£¨í‹´</b> Â· 30/60/90ì¼
            <ul>
              <li>30ì¼: í•µì‹¬ ìŠ¤í‚¬ ë“œë¦´(15ë¶„/ì¼) Â· <i>${DOM[k]}</i> ì „ìš© ê³¼ì œ 6íšŒ</li>
              <li>60ì¼: ì¤‘ê°„ í”„ë¡œì íŠ¸ 1ê°œ ì™„ì„± Â· í”¼ë“œë°± 2íšŒ ìˆ˜ë ´</li>
              <li>90ì¼: í¬íŠ¸í´ë¦¬ì˜¤ìš© ì‘ì—… 1ê°œ + ê³¼ì • ê¸°ë¡(ê¸°íšâ†’ì™„ì„±)</li>
            </ul>
          </div>
        </div>`).join('')}
      </div>
      <div class="section" style="margin-top:14px;background:#0f1833">
        <div style="font-weight:900;color:#fff;margin-bottom:6px">ê°€ëŠ¥ì„± ì˜ì—­ í™œìš© ì „ëµ</div>
        <div class="small subtle">TOP3ì™€ì˜ ì¡°í•©ì„ ê³ ë ¤í•´ ${potential.map(k=>`<b>${DOM[k]}</b>`).join(', ')} ì—­ëŸ‰ì„ ë³´ì¡°ì¶•ìœ¼ë¡œ ì„¤ê³„í•˜ì„¸ìš”. ì˜ˆ: ${DOM[top3[0]]}Ã—${DOM[potential[0]]} í†µí•© ê³¼ì œ.</div>
      </div>
    </div>

    <!-- Page 4: ë¯¸ë˜ ì§ì—…êµ° ë§¤ì¹­ -->
    <div class="block">
      <div class="pageTitle">ë¯¸ë˜ ì§ì—…êµ°ê³¼ì˜ ì—°ê³„ì„±</div>
      <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:12px">
        ${top3.map(k=>{
          const jobs=(CAREERS[k]||[]).slice(0,3);
          return `<div class="section" style="background:#0f1833">
            <div style="font-weight:900;color:#fff;margin-bottom:6px">${DOM[k]} â†’ ìœ ë§ ì§ì—…</div>
            <ul class="small subtle" style="margin:6px 0">${jobs.map(j=>`<li>${j}</li>`).join('')}</ul>
            <div class="small subtle"><b>í¬íŠ¸í´ë¦¬ì˜¤ íŒíŠ¸</b>: ${DOM[k]}ì„ ë“œëŸ¬ë‚´ëŠ” 3ì‘í’ˆ(ê´€ì°°â†’ì‹¤í—˜â†’ì™„ì„±) ì„¸íŠ¸ë¥¼ êµ¬ì„±í•˜ì„¸ìš”.</div>
          </div>`
        }).join('')}
      </div>
      <div class="section" style="margin-top:14px;background:#0f1833">
        <div style="font-weight:900;color:#fff;margin-bottom:6px">í•™ê¸°ë³„ ë¡œë“œë§µ</div>
        <ol class="small subtle">
          <li>1ë¶„ê¸°: ê¸°ì´ˆ ìŠ¤í‚¬ ìŠ¤íƒ(ì£¼ 2íšŒ ë¯¸ë‹ˆ ì™„ì„±) Â· ê´€ì°°/ìƒ‰/ê³µê°„ ì¤‘ 1ì¶• ê³ ë„í™”</li>
          <li>2ë¶„ê¸°: í˜‘ì—…/í”¼ë“œë°± ë¼ìš´ë“œ ë„ì… Â· ë°œí‘œ 1íšŒ</li>
          <li>3ë¶„ê¸°: ì¥ê¸° í”„ë¡œì íŠ¸ 1ê°œ(8ì£¼) Â· ì „ì‹œ/ê³µëª¨ ì¤€ë¹„</li>
          <li>4ë¶„ê¸°: ê´€ì‹¬ ì§ì—…êµ° ì‹œë®¬ë ˆì´ì…˜ ê³¼ì œ Â· í¬íŠ¸í´ë¦¬ì˜¤ ì •ë¦¬</li>
        </ol>
      </div>
    </div>
  </div>

  <div class="center no-pdf" style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button class="btn-ghost" onclick="STATE.step='start'; render()">ì²˜ìŒìœ¼ë¡œ</button>
    <button class="btn btn-mint" id="btn_pdf">PDF ì €ì¥</button>
    <button class="btn btn-accent" id="btn_email">ì´ë©”ì¼ë¡œ ë³´ë‚´ê¸°</button>
    <button class="btn-ghost" onclick="STATE.step='details'; render()">ìì„¸í•œ ê²°ê³¼ ë³´ê¸°</button>
  </div>`;

  /* Charts */
  destroyCharts();

  // Radar (top9)
  const rctx=document.getElementById('radar').getContext('2d',{willReadFrequently:true});
  CHARTS.push(new Chart(rctx,{type:'radar',
    data:{labels:top9.map(k=>DOM[k]),
      datasets:[{data:top9.map(k=>s[k]||0),borderColor:'#a78bfa',backgroundColor:'rgba(167,139,250,.22)',borderWidth:2,pointRadius:2,fill:true}]},
    options:{
      animation:{duration:800},
      plugins:{legend:{display:false}},
      scales:{r:{
        suggestedMin:0,suggestedMax:4,
        angleLines:{color:'rgba(148,163,184,.25)'},
        grid:{color:'rgba(148,163,184,.18)'},
        ticks:{display:false},
        pointLabels:{color:'#e6edf7',font:{weight:700}}
      }}
    }
  }));

  // Bars: TOP3
  const b1=document.getElementById('barsTop3').getContext('2d',{willReadFrequently:true});
  CHARTS.push(new Chart(b1,{type:'bar',
    data:{labels:top3.map(k=>DOM[k]),
      datasets:[{data:top3.map(k=>s[k]||0),borderRadius:12,borderSkipped:false,
        backgroundColor:['#ffb347','#6ee7ff','#10cdae']}]
    },
    options:{animation:{duration:700},plugins:{legend:{display:false}},
      scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{color:'#9fb0c7'},grid:{color:'rgba(148,163,184,.18)'}},
              x:{ticks:{color:'#dbe6f5'},grid:{display:false}}}
  }));

  // Bars: Potential 4
  const b2=document.getElementById('barsPotential').getContext('2d',{willReadFrequently:true});
  CHARTS.push(new Chart(b2,{type:'bar',
    data:{labels:potential.map(k=>DOM[k]),
      datasets:[{data:potential.map(k=>s[k]||0),borderRadius:12,borderSkipped:false,
        backgroundColor:['#a78bfa','#6ee7ff','#10cdae','#ffd166']}]
    },
    options:{animation:{duration:700},plugins:{legend:{display:false}},
      scales:{y:{suggestedMin:0,suggestedMax:4,ticks:{color:'#9fb0c7'},grid:{color:'rgba(148,163,184,.18)'}},
              x:{ticks:{color:'#dbe6f5'},grid:{display:false}}}
  }));

  $('btn_pdf').onclick=handleSavePdf;$('btn_email').onclick=openEmailModal;
}

/* Details page (ì´ë¡  3ê°œ) */
function theoryItem(i,key){
  const t=THEORY[key]||{theoryTitle:'ì´ë¡ ',theory:'-',expert:'-',direction:'-'};
  return `<div class="section" style="background:#0f1833">
    <div style="font-weight:900;margin-bottom:6px;color:#fff">${i}. ${DOM[key]} <span style="font-size:12px;background:linear-gradient(90deg,var(--b),var(--a));color:#041222;border:1px solid rgba(255,255,255,.15);padding:4px 8px;border-radius:999px;font-weight:900">ê°•ì </span></div>
    <div class="small subtle"><b>ì´ë¡ </b>(${t.theoryTitle}) Â· ${t.theory}</div>
    <div class="small subtle" style="margin-top:6px"><b>ì „ë¬¸ê°€</b> Â· ${t.expert}</div>
    <div class="small subtle" style="margin-top:6px"><b>ë°œë‹¬ ë°©í–¥</b> Â· ${t.direction}</div>
  </div>`;
}
function viewDetails(){
  const r=STATE.result||{top3:[]};
  const topBlocks=(r.top3||[]).map((k,i)=>theoryItem(i+1,k)).join('');
  app().innerHTML=`<div class="block">
    <div class="pageTitle">ì „ë¬¸ê°€ í‰ê°€ ë° ì´ë¡ ì  ë°°ê²½</div>
    <p class="subtle"><b>${STATE.profile.child_name}</b>ì˜ ë¯¸ìˆ ì ì„± ì‹¬í™” ë¶„ì„</p>
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:14px">${topBlocks || '<div class="small subtle">ê°•ì  ì˜ì—­ ì‚°ì¶œ í›„ í‘œì‹œë©ë‹ˆë‹¤.</div>'}</div>
  </div>

  <div class="block" style="margin-top:14px">
    <div class="pageTitle">ìƒë‹´ ì•ˆë‚´</div>
    <div class="section" style="background:#0f1833">
      <div class="small subtle">í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ <b>ë§ì¶¤ ë¡œë“œë§µ</b>ê³¼ <b>í¬íŠ¸í´ë¦¬ì˜¤</b> êµ¬ì„±ì„ ìƒë‹´í•´ ë“œë¦½ë‹ˆë‹¤. (ë¬´ë£Œ, 60ë¶„)</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-mint no-pdf" onclick="alert('ìƒë‹´ ì˜ˆì•½ì€ ê³§ ì¤€ë¹„ë©ë‹ˆë‹¤!')">ìƒë‹´ ì˜ˆì•½í•˜ê¸°</button>
        <button class="btn-ghost" onclick="STATE.step='result'; render()">ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </div>`;
}

/* ===== PDF helpers ===== */
function buildPdfWrapperFrom(node){
  const wrap=document.createElement('div');
  wrap.style.position='fixed';wrap.style.left='-10000px';wrap.style.top='0';
  wrap.style.width='794px';wrap.style.background='#0b1220';wrap.style.zIndex='-1';
  const clone=node.cloneNode(true);
  clone.querySelectorAll('img').forEach(img=>{ img.setAttribute('crossorigin','anonymous'); img.referrerPolicy='no-referrer'; img.src=img.src; });
  const srcC=node.querySelectorAll('canvas');const dstC=clone.querySelectorAll('canvas');
  srcC.forEach((src,i)=>{const dst=dstC[i];if(!dst)return;dst.width=src.width;dst.height=src.height;dst.getContext('2d',{willReadFrequently:true}).drawImage(src,0,0)});
  wrap.appendChild(clone);document.body.appendChild(wrap);return wrap;
}
function waitForAssets(root){
  const imgs=[...root.querySelectorAll('img')];
  const imgPromises=imgs.map(img=>img.complete?Promise.resolve():new Promise(res=>{img.onload=()=>res();img.onerror=()=>res()}));
  const fontsReady=('fonts'in document)?document.fonts.ready:Promise.resolve();
  return Promise.all([fontsReady,...imgPromises]);
}
async function html2pdfBlob(wrapper){
  const opt={margin:[8,8,8,8],
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true,backgroundColor:'#0b1220',removeContainer:true,windowWidth:wrapper.scrollWidth,windowHeight:wrapper.scrollHeight},
    pagebreak:{mode:['css','legacy']},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
  return await html2pdf().set(opt).from(wrapper).output('blob');
}
async function canvasSlicerBlob(wrapper){
  const h2c=window.html2canvas;
  const canvas=await h2c(wrapper,{scale:2,useCORS:true,allowTaint:true,backgroundColor:'#0b1220',scrollX:0,scrollY:0,windowWidth:wrapper.scrollWidth,windowHeight:wrapper.scrollHeight});
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const pxToMm=210/canvas.width;
  const pageHeightPx=Math.floor(297/pxToMm);
  let y=0,page=0;
  while(y<canvas.height){
    const sliceHeight=Math.min(pageHeightPx,canvas.height-y);
    const pageCanvas=document.createElement('canvas');
    pageCanvas.width=canvas.width;pageCanvas.height=sliceHeight;
    const ctx=pageCanvas.getContext('2d',{willReadFrequently:true});
    ctx.drawImage(canvas,0,y,canvas.width,sliceHeight,0,0,canvas.width,sliceHeight);
    const img=pageCanvas.toDataURL('image/jpeg',0.98);
    const mmHeight=sliceHeight*pxToMm;
    if(page>0) pdf.addPage();
    pdf.addImage(img,'JPEG',0,0,210,mmHeight);
    y+=sliceHeight;page++;
  }
  return pdf.output('blob');
}
async function exportPdfBlob(node){
  const wrapper=buildPdfWrapperFrom(node);
  await waitForAssets(wrapper);
  try{
    let blob=await html2pdfBlob(wrapper);
    if(!blob || blob.size<5000){ blob=await canvasSlicerBlob(wrapper); }
    return blob;
  }catch(e){
    try{ return await canvasSlicerBlob(wrapper); }
    catch(e2){ throw e2; }
  }finally{ wrapper.remove(); }
}
async function handleSavePdf(){
  const node=$('pdfArea');
  node.classList.add('pdf-screen-width');
  await new Promise(r=>setTimeout(r,50));
  try{
    const blob=await exportPdfBlob(node);
    const filename=`${STATE.profile.child_name}_ADVANCE_ì§„ë‹¨ë¦¬í¬íŠ¸.pdf`;
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
  }catch(e){console.error(e);alert('PDF ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')}
  finally{node.classList.remove('pdf-screen-width');}
}

/* Email modal */
function setModalVisible(show){const m=$('emailModal');if(show){m.classList.add('show');m.setAttribute('aria-hidden','false');document.body.style.overflow='hidden'}else{m.classList.remove('show');m.setAttribute('aria-hidden','true');document.body.style.overflow=''}}
function openEmailModal(){setModalVisible(true);$('emailSubject').value=`${APP_TITLE} â€“ ${STATE.profile.child_name} ê²°ê³¼`;$('emailTo').value=STATE.profile.email||'';$('emailMsg').textContent=''}
$('emailCancel').onclick=()=>setModalVisible(false);document.addEventListener('keydown',e=>{if(e.key==='Escape')setModalVisible(false)})

function blobToBase64(blob){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onloadend=()=>resolve(reader.result.split(',')[1]);reader.onerror=reject;reader.readAsDataURL(blob)})}
$('emailSend').onclick=async()=>{
  const to=$('emailTo').value.trim();if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(to)){ $('emailMsg').textContent='ì´ë©”ì¼ í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.'; return; }
  $('emailMsg').textContent='PDF ìƒì„± ì¤‘...';
  let base64='';try{const blob=await exportPdfBlob($('pdfArea'));base64=await blobToBase64(blob)}catch(e){$('emailMsg').textContent='PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';return}
  $('emailMsg').textContent='ì´ë©”ì¼ ì „ì†¡ ì¤‘...';
  const subject=$('emailSubject').value.trim()||`${APP_TITLE} â€“ ${STATE.profile.child_name} ê²°ê³¼`;
  const htmlBody=`<div style="font-family:Pretendard,Apple SD Gothic Neo,Segoe UI,Arial;color:#0b1220">
    <h2 style="margin:0 0 8px">${APP_TITLE}</h2>
    <p><b>${STATE.profile.child_name}</b> ë‹˜ì˜ ê²°ê³¼ì§€ë¥¼ ì²¨ë¶€í–ˆìŠµë‹ˆë‹¤.</p>
    <p>ìº í¼ìŠ¤: ${STATE.profile.campus||'-'} / ì—°ë½ì²˜: ${STATE.profile.phone||'-'}</p>
    <p style="color:#6b7280;font-size:12px;margin-top:12px">ë³¸ ë©”ì¼ì€ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
  </div>`;
  try{
    const res=await fetch(EMAIL_FUNCTION_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to,subject,html:htmlBody,attachmentName:`${STATE.profile.child_name}_ADVANCE_ì§„ë‹¨ë¦¬í¬íŠ¸.pdf`,attachmentBase64:base64})});
    const ok=res.ok;const data=await res.json().catch(()=>({}));
    if(ok){$('emailMsg').textContent='ì „ì†¡ ì™„ë£Œ! ë©”ì¼í•¨ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.';setTimeout(()=>setModalVisible(false),1200)}
    else{$('emailMsg').textContent='ì „ì†¡ ì‹¤íŒ¨: '+(data.error||res.statusText)}
  }catch(err){$('emailMsg').textContent='ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
}

/* Router */
function render(){renderNav();updateTopProgress();if(STATE.step==='start')return viewStart();if(STATE.step==='consent')return viewConsent();if(STATE.step==='profile')return viewProfile();if(STATE.step==='test')return viewTest();if(STATE.step==='result')return viewResult();if(STATE.step==='details')return viewDetails()}
render();

/* ===== Fallback questions (20) ===== */
function W(w){const o={};DOM_KEYS.forEach(k=>o[k]=0);Object.entries(w).forEach(([k,v])=>{if(o[k]!=null)o[k]=v});return o}
function localQuestions(){
  const S=(i,p,a,b,c,d)=>({id:`q${i}`,order:i,prompt:p,options:[
    {key:'A',label:a[0],imageUrl:'',weights:W(a[1])},
    {key:'B',label:b[0],imageUrl:'',weights:W(b[1])},
    {key:'C',label:c[0],imageUrl:'',weights:W(c[1])},
    {key:'D',label:d[0],imageUrl:'',weights:W(d[1])}
  ]});
  const L=[
    S(1,'ì´ ê·¸ë¦¼ì„ ë³¼ ë•Œ, ê°€ì¥ ë¨¼ì € ì‹œì„ ì´ ê°€ëŠ” ê³³ì€ ì–´ë””ì¸ê°€ìš”?',
      ['ì „ì²´ êµ¬ë„ì™€ ë°°ì¹˜',{SPA:1}],['ë¶“í„°ì¹˜/ì„¸ë°€',{DET:1}],['ê°•ë ¬í•œ ìƒ‰ ì¡°í•©',{COL:1}],['ìˆ¨ì€ ìƒì§•/ì˜ë¯¸',{NAR:1}]),
    S(2,'â€˜ììœ â€™ë¥¼ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•œë‹¤ë©´?',
      ['í•˜ëŠ˜ê³¼ ìƒˆ',{NAR:1,EXP:0.6}],['ë³µì¡í•œ ì„ Â·ë„í˜•',{CON:1}],['ë¶ˆê·œì¹™í•œ ìƒ‰ ì¡°í•©',{COL:1,CHK:0.6}],['ì‹ ë‚˜ê²Œ ë›°ë…¸ëŠ” ì‚¬ëŒë“¤',{NAR:1,EXP:0.6}]),
    S(3,'â€˜ì‹œì‘ê³¼ ëâ€™ ì—°ì‘ í‘œí˜„ ë°©ì‹ì€?',
      ['ìƒì§• ì •ë¬¼ 2ì ',{CON:1,DET:0.6}],['ì„œì‚¬ 4ì»·',{NAR:1}],['ìƒ‰ë§Œ ë°”ê¾¸ëŠ” ì‹¤í—˜',{COL:1,CHK:0.6}],['ë²„ì „ ë°˜ë³µ ì™„ì„±',{GRT:1,DET:0.6}]),
    S(4,'ì¹œêµ¬ ì‘í’ˆ í”¼ë“œë°±ì—ì„œ ê°€ì¥ ë³¼ ì ì€?',
      ['ì´ì•¼ê¸°/ê°ì •',{NAR:1,EXP:0.6}],['í˜•íƒœ/êµ¬ë„ ì•ˆì •',{SPA:1}],['ì‚¬ì‹¤ì  ë¬˜ì‚¬',{DET:1}],['ìƒˆ ì‹œë„ ì—¬ë¶€',{CHK:1}]),
    S(5,'ì‘í’ˆ ì† ì£¼ì¸ê³µì´ë¼ë©´ ë§¡ê³  ì‹¶ì€ ì—­í• ì€?',
      ['ìˆ¨ì€ ì´ì•¼ê¸° ì „ë‹¬',{NAR:1,EXP:0.6}],['í©ë¿Œë ¤ì§€ëŠ” ì /ì„ ',{CHK:1,EXP:0.6}],['ì¡°í™”ë¡œìš´ ë°°ì¹˜',{SPA:1,SOC:0.6}],['ê°•ë ¬í•œ ìƒ‰ì±„',{COL:1}]),
    S(6,'ìƒˆ ì¬ë£Œë¥¼ ë°›ì•˜ì„ ë•Œ?',
      ['ë¨¼ì € ë§Œì ¸ë³´ê¸°',{CHK:1}],['êµ¬ìƒ/ê³„íš ì„¸ìš°ê¸°',{CON:1,SPA:0.6}],['ì£¼ë³€ ì°¸ê³ ',{SOC:1}],['ì§ˆê°Â·í˜•íƒœ íƒìƒ‰',{DET:1,OBS:0.6}]),
    S(7,'ì—†ëŠ” ê³µê°„ì„ ê·¸ë¦´ ë•Œ ê°€ì¥ ê³µ ë“¤ì¼ ë¶€ë¶„ì€?',
      ['ê°€ìƒì˜ ì¡´ì¬',{NAR:1,EXP:0.6}],['í˜„ì‹¤ê³¼ ë‹¤ë¥¸ ë””í…Œì¼',{DET:1,OBS:0.6}],['ë¹›ê³¼ ê·¸ë¦¼ì ë¶„ìœ„ê¸°',{SPA:1,COL:0.6}],['ìƒˆ ê¸°ë²• ì‹¤í—˜',{CHK:1}]),
    S(8,'â€œì˜ ê·¸ë ¸ë‹¤â€ì˜ ê°€ì¥ ì¤‘ìš”í•œ ìš”ì†ŒëŠ”?',
      ['ì •í™•í•œ í˜•íƒœ/ë¹„ë¡€',{DET:1,OBS:0.6}],['ë…íŠ¹í•œ ì•„ì´ë””ì–´',{CON:1,CHK:0.6}],['ê°ì •ì„ ì›€ì§ì´ëŠ” í˜',{EXP:1,NAR:0.6}],['ì•ˆì •ì  êµ¬ë„',{SPA:1}]),
    S(9,'ê²½ì‹œ ëŒ€íšŒì—ì„œ ë§ì³¤ë‹¤ë©´?',
      ['ì²˜ìŒë¶€í„° ë‹¤ì‹œ',{CHK:1}],['ìˆ˜ì •í•˜ì—¬ ì™„ì„±',{GRT:1,DET:0.6}],['ë‹¤ìŒ ì½˜ì…‰íŠ¸ êµ¬ìƒ',{CON:1}],['ì˜ê²¬ êµ¬í•˜ê¸°',{SOC:1}]),
    S(10,'ë¶€ëª¨ë‹˜ì´ â€œì´í•´í•˜ê¸° ì–´ë µë‹¤â€ í–ˆì„ ë•Œ ê¸°ë¶„ì€?',
      ['ë‚œí•´í–ˆë‚˜ ì†ìƒ',{CRT:1}],['ê°ì • ì˜¤í•´',{EXP:1}],['ì˜ë„ ì „ë‹¬ ê³ ë¯¼',{NAR:1,SOC:0.6}],['ë…íŠ¹/íŠ¹ë³„í•´ì„œ ê·¸ë˜',{EXP:1}]),
    S(11,'ê°€ì¥ í¥ë¯¸ë¡œìš´ ì§ì—…ì€?',
      ['ê±´ì¶•ê°€',{SPA:1,CON:0.6}],['ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´í„°',{NAR:1,DET:0.6}],['ì• ë‹ˆë©”ì´í„°',{EXP:1,NAR:0.6}],['ì¡°ê°ê°€',{SPA:1,DET:0.6}]),
    S(12,'í‰ë²”í•œ ì‹ ë°œì„ ë¹„ë²”í•˜ê²Œ ë§Œë“¤ê¸°',
      ['í•´ì²´/ì¬ì¡°í•©',{CON:1,CHK:0.6}],['ê·¹ì‚¬ì‹¤ ë¬˜ì‚¬',{DET:1,OBS:0.6}],['ìƒ‰/ë¬´ëŠ¬ ì¥ì‹',{COL:1}],['ìŠ¤í† ë¦¬ ë¶€ì—¬',{NAR:1}]),
    S(13,'ì‘í’ˆì„ ë³´ë©° ê°€ì¥ ë¨¼ì € ë“œëŠ” ìƒê°',
      ['ì–¼ë§ˆë‚˜ ì‹œê°„ ë“¤ì˜€ì„ê¹Œ',{GRT:1,DET:0.6}],['ë‹¤ë¥¸ ìƒ‰ ì“¸ ë“¯',{COL:1,CRT:0.6}],['ì˜ë„ì™€ ìŠ¤í† ë¦¬',{NAR:1,CON:0.6}],['ì‘ê°€ì˜ ì‚¶',{EXP:1,NAR:0.6}]),
    S(14,'ê°ì •ì„ ê°€ì¥ ì˜ í‘œí˜„í•˜ëŠ” ìš”ì†Œ',
      ['ì„  êµµê¸°/ê±°ì¹œ ì§ˆê°',{DET:1}],['ê°•/ë¶€ë“œëŸ¬ìš´ ìƒ‰',{COL:1,EXP:0.6}],['í‘œì •',{NAR:1,EXP:0.6}],['ë¶„ìœ„ê¸°/êµ¬ë„',{SPA:1}]),
    S(15,'1ë…„ ì¥ê¸° í”„ë¡œì íŠ¸, í¥ë¯¸ë¡œìš´ ì£¼ì œ',
      ['ë„ì‹œ í’ê²½ ì„¸ë°€ ê¸°ë¡',{OBS:1,GRT:0.6,DET:0.6}],['í•œ ì¸ë¬¼ì˜ ì¼ìƒ ì—°ì‘',{NAR:1,GRT:0.6}],['ìƒˆ ê¸°ë²• ì—°ì† ì‹¤í—˜',{CHK:1,GRT:0.6}],['ì‹¬ë¦¬ ë³€í™” ì‹œê°í™”',{EXP:1,CON:0.6}]),
    S(16,'ê°€ì¥ ì¤‘ìš”í•œ ì‘í’ˆì„ ê³ ë¥´ëŠ” ì´ìœ ',
      ['ê°•í•œ ê°ë™',{EXP:1}],['ì‚¬íšŒì  ë©”ì‹œì§€/ì•„ì´ë””ì–´',{CON:1,NAR:0.6}],['ì •êµÂ·ì‚¬ì‹¤ì  ë¬˜ì‚¬',{DET:1,OBS:0.6}],['ë…íŠ¹í•œ ìƒ‰/í˜•íƒœ',{COL:1,CHK:0.6}]),
    S(17,'â€˜ë‘ë ¤ì›€â€™ì„ í‘œí˜„í•œë‹¤ë©´',
      ['ë³µì¡í•œ ì„ /ëª¨ì–‘',{CHK:1,EXP:0.6}],['ì–´ë‘¡ê³  ì°¨ê°€ìš´ ìƒ‰',{COL:1,EXP:0.6}],['ì•„ì£¼ ì‘ì€ ì¸ë¬¼/ê´´ë¬¼',{DET:1,NAR:0.6,OBS:0.6}],['ë‚˜ë§Œì˜ ìƒì§•',{EXP:1,CON:0.6}]),
    S(18,'í° ì‘í’ˆì—ì„œ ê°€ì¥ í˜ë“  ì ',
      ['ê³„íšê³¼ ë‹¬ë¼ì§',{CON:1,CRT:0.6}],['ë°˜ë³µ ë¦¬í„°ì¹˜',{DET:1,GRT:0.6}],['ëì—†ì´ ëŠê»´ì§',{GRT:1}],['ì˜ë„ ì˜¤í•´ ë¶ˆì•ˆ',{SOC:1,EXP:0.6}]),
    S(19,'ì‹¬ì‚¬ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ë†’ì€ ì ìˆ˜',
      ['ê¸°ìˆ  ì™„ì„±ë„',{DET:1,GRT:0.6,OBS:0.6}],['ê³ ì •ê´€ë… íŒŒê´´',{CHK:1,CON:0.6}],['ê¹Šì€ ê°ë™',{EXP:1,NAR:0.6}],['ì—¬ëŸ¬ ì˜ë¯¸ì˜ ìƒê°ê±°ë¦¬',{CON:1,NAR:0.6}]),
    S(20,'ë³´ì´ì§€ ì•ŠëŠ” ê³µê¸°/ì†Œë¦¬/ëƒ„ìƒˆë¥¼ í‘œí˜„',
      ['ë„í˜•/ì„ ìœ¼ë¡œ',{SPA:1,CON:0.6}],['ìƒ‰ê³¼ ë¶„ìœ„ê¸°',{COL:1,EXP:0.6}],['íë¦„/ì›€ì§ì„',{NAR:1,SPA:0.6}],['ê³µê°„ ì±„ì›€ì˜ ë³µì¡ì„±',{DET:1,OBS:0.6,SPA:0.6}])
  ];
  return L;
}
</script>
</body>
</html>
